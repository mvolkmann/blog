<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Python testing</h2><aside><nav class="toc"><ol><li><a href="#unit-tests">Unit tests</a><ol><li><a href="#pytest">pytest</a><ol><li><a href="#overview">Overview</a></li><li><a href="#assertions">Assertions</a></li><li><a href="#running-tests">Running tests</a></li><li><a href="#type-checking">Type checking</a></li><li><a href="#custom-exceptions">Custom exceptions</a></li><li><a href="#setup-and-teardown">Setup and Teardown</a></li><li><a href="#parametrized-tests">Parametrized tests</a></li><li><a href="#skipping-tests">Skipping tests</a></li><li><a href="#fixtures">Fixtures</a></li><li><a href="#watching-files">Watching files</a></li></ol></li><li><a href="#alternatives">Alternatives</a></li></ol></li><li><a href="#code-coverage">Code coverage</a></li><li><a href="#end-to-end-tests">End-to-end tests</a></li></ol></nav></aside><article><p>Packages that support implementing tests for Python code are described below.</p><h2 id="unit-tests" tabindex="-1">Unit tests</h2><h3 id="pytest" tabindex="-1">pytest</h3><h4 id="overview" tabindex="-1">Overview</h4><p>The <a href="https://pytest.org?v=1.1.1" rel="noopener" target="_blank">pytest</a> framework runs unit tests of Python code and reports test results. It can also run tests written with the unittest and nose test frameworks.</p><p>To install pytest, enter <code>pip install pytest</code>.</p><p>The names of test source files should begin or end with <code>test</code> and often match the filename of the source file they test. For example, tests for <code>math_util.py</code> could go in <code>math_util_test.py</code>.</p><p>Inside test files, implement any number of functions whose names begin with <code>test_</code>. These functions execute the code to be tested and make assertions about the expected results.</p><h4 id="assertions" tabindex="-1">Assertions</h4><p>Assertions are made using the Python language <code>assert</code> keyword. This is followed by an expression that is evaluated as a boolean. If it evaluates to <code>True</code>, nothing happens. If it evaluates to <code>False</code>, an <code>AssertionError</code> is raised. Test frameworks like pytest catch these in order to report test failures. For example:</p><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_average</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">assert</span> average<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2.5</span><br>    <span class="token keyword">assert</span> average<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span></code></pre><p>If an <code>assert</code> throws, the remainder of the test function is not executed, but other test functions are executed.</p><p>The condition being asserted can be followed by a string that describes why the assertion might fail. For example:</p><pre class="language-python"><code class="language-python"><span class="token keyword">assert</span> average<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2.5</span><span class="token punctuation">,</span> <span class="token string">'incorrect result from average'</span></code></pre><p>Often added this string is unnecessary because pytest uses introspection to automatically generate reasonable messages.</p><p>To test code that is expected to raise an exception, use the <code>pytest.raises</code> function. For example:</p><pre class="language-python"><code class="language-python"><span class="token keyword">with</span> pytest<span class="token punctuation">.</span>raises<span class="token punctuation">(</span>ZeroDivisionError<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    average<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>When the code that should raise an exception is a call to a single function, <code>pytest.raises</code> can instead be called with the expected exception class, the function, and the arguments to be passed to the function. For example:</p><pre class="language-python"><code class="language-python">pytest<span class="token punctuation">.</span>raises<span class="token punctuation">(</span>statistics<span class="token punctuation">.</span>StatisticsError<span class="token punctuation">,</span> average<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><h4 id="running-tests" tabindex="-1">Running tests</h4><p>To run tests, enter <code>pytest</code>. By default this runs all the test files found in the current directory and in subdirectories. For more brief output, add the <code>--quiet</code> (<code>-q</code>) option. To report skipped tests (described later), add the <code>-rs</code> option.</p><p>To run specific test files, add their file paths as arguments to the <code>pytest</code> command.</p><p>By default anything written to stdout is &quot;captured&quot;. To avoid this and make the output is visible, add the <code>--captured=no</code> or <code>-s</code> option.</p><h4 id="type-checking" tabindex="-1">Type checking</h4><p>To make assertions about the types of variables or expressions in tests, use the <code>isinstance</code> built-in function. For example:</p><pre class="language-python"><code class="language-python"><span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>happy<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><br><span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><br><span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>age<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><br><span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>temperature<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><br><span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> Person<span class="token punctuation">)</span> <span class="token comment"># custom class</span></code></pre><h4 id="custom-exceptions" tabindex="-1">Custom exceptions</h4><p>Code being tested can define and raise custom errors. For example, the following is in <code>math_util.py</code>:</p><pre class="language-python"><code class="language-python"><span class="token comment"># Define a custom exception type.</span><br><span class="token keyword">class</span> <span class="token class-name">MathError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">pass</span><br><br><span class="token comment"># This is a contrived example because we can just use math.sqrt directly.</span><br><span class="token keyword">def</span> <span class="token function">square_root</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span><br>        <span class="token keyword">raise</span> MathError<span class="token punctuation">(</span><span class="token string">'cannot find square root of a negative number'</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>x<span class="token punctuation">)</span></code></pre><p>We can write a test that verifies that this error is raised when appropriate. For example, the following is in <code>math_util_test.py</code>:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> pytest<br><span class="token keyword">from</span> math_util <span class="token keyword">import</span> MathError<span class="token punctuation">,</span> square_root<br><br><span class="token keyword">def</span> <span class="token function">test_square_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">assert</span> square_root<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><br><br>    <span class="token keyword">with</span> pytest<span class="token punctuation">.</span>raises<span class="token punctuation">(</span>MathError<span class="token punctuation">)</span> <span class="token keyword">as</span> context<span class="token punctuation">:</span><br>       square_root<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><br>    <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>value<span class="token punctuation">,</span> MathError<span class="token punctuation">)</span><br>    <span class="token keyword">assert</span> <span class="token builtin">str</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'cannot find square root of a negative number'</span></code></pre><h4 id="setup-and-teardown" tabindex="-1">Setup and Teardown</h4><p>To run setup and teardown code, define the following functions that each have no parameters:</p><ul><li><code>setup_module</code> - run once before all the test functions</li><li><code>setup_function</code> - run once before each test function</li><li><code>teardown_function</code> - run once after each test function</li><li><code>teardown_module</code> - run once after all the test functions</li></ul><h4 id="parametrized-tests" tabindex="-1">Parametrized tests</h4><p>To run a test function repeatedly with different sets of inputs and expected results, use the <code>@pytest.mark.parametrize</code> decorator. For example:</p><pre class="language-python"><code class="language-python">add_inputs <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><br><span class="token punctuation">]</span><br><span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">'n1, n2, expected'</span><span class="token punctuation">,</span> add_inputs<span class="token punctuation">)</span><br><span class="token keyword">def</span> <span class="token function">test_add</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> expected<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">assert</span> add<span class="token punctuation">(</span><span class="token punctuation">[</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> expected</code></pre><h4 id="skipping-tests" tabindex="-1">Skipping tests</h4><p>To temporarily skip running a test function, add the following decorator to the function:</p><pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>skip</span><span class="token punctuation">(</span>reason<span class="token operator">=</span><span class="token string">'some reason why'</span><span class="token punctuation">)</span></code></pre><p>To temporarily skip running all the tests in a file, add the following near the top of the file:</p><pre class="language-python"><code class="language-python">pytest<span class="token punctuation">.</span>skip<span class="token punctuation">(</span><span class="token string">'some reason why'</span><span class="token punctuation">,</span> allow_module_level<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre><p>Another option is to mark test that are expected to fail, but should be run anyway, with the <code>@pytest.mark.xfail</code> decorator. These are counted separately from passing, failing, and skipped tests. It's not clear to me why this is a useful alternative to skipping tests.</p><p>For additional variations such as conditionally skipping tests, see <a href="https://docs.pytest.org/en/latest/skipping.html?v=1.1.1" rel="noopener" target="_blank">Skip and xfail</a>.</p><h4 id="fixtures" tabindex="-1">Fixtures</h4><p>Fixtures are special functions that provide data and functions to test functions. A function becomes a fixture when it is marked with the <code>@pytest.fixture</code> decorator.</p><p>Each fixture has an associated scope that controls whether a cached value is used after the initial call when it is used by multiple tests. The scope value is a string that can be <code>function</code> (default), <code>class</code>, <code>module</code>, <code>package</code>, or <code>session</code>. When all the tests in file can use the same fixture result, set the scope to <code>module</code>. For example:</p><pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">'module'</span><span class="token punctuation">)</span><br><span class="token keyword">def</span> <span class="token function">numbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><br><br><span class="token keyword">def</span> <span class="token function">test_add</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">assert</span> add<span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><br><br><span class="token keyword">def</span> <span class="token function">test_average</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">assert</span> average<span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><br></code></pre><p>Pytest provides some built-in fixtures. The <code>capsys</code> fixture enables writing test that asserts what a function will write to stdout or stderr, For example:</p><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_greet</span><span class="token punctuation">(</span>capsys<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    greet<span class="token punctuation">(</span><span class="token string">'Mark'</span><span class="token punctuation">)</span><br>    captured <span class="token operator">=</span> capsys<span class="token punctuation">.</span>readouterr<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">assert</span> captured<span class="token punctuation">.</span>out <span class="token operator">=</span> <span class="token string">'Hello, Mark!'</span></code></pre><p>For more detail, see <a href="https://docs.pytest.org/en/stable/fixture.html?v=1.1.1" rel="noopener" target="_blank">pytest fixtures</a>.</p><h4 id="watching-files" tabindex="-1">Watching files</h4><p>To watch files for changes and automatically rerun tests, use <a href="https://github.com/joeyespo/pytest-watch?v=1.1.1" rel="noopener" target="_blank">pytest-watch</a>. To install it, enter <code>pip install pytest-watch</code>. To run tests in watch mode, enter <code>ptw</code>. Options after <code>--</code> are passed on to <code>pytest</code>. For example, to run tests in quiet mode, enter <code>ptw -- -q</code>.</p><h3 id="alternatives" tabindex="-1">Alternatives</h3><p><a href="https://docs.python.org/3/library/unittest.html?v=1.1.1" rel="noopener" target="_blank">unittest</a> is another Python testing framework. It is notable in that it is included in the Python standard library, so does not need to be installed. However, it is more complicated and less popular than pytest.</p><p><a href="https://docs.nose2.io/en/latest/?v=1.1.1" rel="noopener" target="_blank">nose2</a> is another Python test framework that is less popular than pytest.</p><h2 id="code-coverage" tabindex="-1">Code coverage</h2><p><a href="https://coverage.readthedocs.io/en/coverage-5.3/?v=1.1.1" rel="noopener" target="_blank">Coverage.py</a> is a tool for reporting code coverage of Python tests.</p><p>To install this tool, enter <code>pip install coverage</code>.</p><p>To gather coverage information from running pytest tests, enter <code>coverage run -m pytest</code>.</p><p>To display a coverage report, enter <code>coverage report</code>. The output will be similar to the following:</p><pre class="language-text"><code class="language-text">Name                  Stmts   Miss  Cover<br>-----------------------------------------<br>math_util.py             12      3    75%<br>math_util_test.py        43      0   100%<br>string_util.py            4      0   100%<br>string_util_test.py      10      0   100%<br>-----------------------------------------<br>TOTAL                    69      3    96%</code></pre><p>To create an HTML test coverage report, enter <code>coverage html</code>. This generates files in a directory named <code>htmlcov</code>. To view the report, open the <code>index.html</code> in this directory in any web browser.</p><h2 id="end-to-end-tests" tabindex="-1">End-to-end tests</h2><p>There is nothing Python-specific about implementing end-to-end tests. For web applications, <a href="https://www.cypress.io/?v=1.1.1" rel="noopener" target="_blank">Cypress</a> is recommended.</p></article>