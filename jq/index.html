<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>jq</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#installing">Installing</a></li><li><a href="#basic-usage">Basic Usage</a></li><li><a href="#filtering">Filtering</a></li><li><a href="#transforming">Transforming</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p>JavaScript Object Notation (JSON) is a data format that is frequently returned by API services and read from files. Often this is not formatted for human readability and all the data is on a single line with no added spaces. The tool <a href="https://stedolan.github.io/jq/?v=1.0.20" rel="noopener" target="_blank">jq</a> helps with this.</p><p>jq pretty-prints JSON data. It can also filter, sort, and transform the data.</p><p>jq is practically a programming language. It has a long list of features including types, conditionals, regular expressions, math functions, custom function definitions, streaming, and more</p><h2 id="installing" tabindex="-1">Installing</h2><p>To install jq in macOX using Homebrew, enter <code>brew install jq</code>.</p><h2 id="basic-usage" tabindex="-1">Basic Usage</h2><p>To pretty-print the contents of a JSON file, enter <code>cat {file-path} | jq</code>. Another way to write this is <code>jq . {file-path)</code> where <code>.</code> is a filter that keeps the entire contents.</p><p>To pretty-print the response from an API service, enter <code>curl {service-url} | jq</code>. For example, we can view the JSON response from a public API that returns an object where the keys are dog breeds and the values are arrays of variety names.</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> https://dog.ceo/api/breeds/list/all <span class="token operator">|</span> jq</code></pre><p>A portion of the output is shown below.</p><p><img alt="jq dog breeds" style="width: 100%" src="/blog/assets/jq-dog-breeds.png?v=1.0.20" title="jq dog breeds"></p><p>To work repeatedly with the same JSON data returned from an API endpoint, consider capturing the data in a local file. For example:</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> https://dog.ceo/api/breeds/list/all <span class="token operator">></span> dogs.json</code></pre><h2 id="filtering" tabindex="-1">Filtering</h2><p>jq can filter the JSON data and output a subset. For example, the filter <code>.message.hound</code> assumes that the JSON data describes an object rather than an array, finds the top-level property named &quot;message&quot;, assumes its value is an object, and finds the property &quot;hound&quot; inside that object. To use this filter we can enter <code>jq -c .message.hound dogs.json</code>. This outputs the following which is a compact (<code>-c</code>) JSON array of all the hound varieties:</p><pre class="language-text"><code class="language-text">["afghan","basset","blood","english","ibizan","plott","walker"]</code></pre><h2 id="transforming" tabindex="-1">Transforming</h2><p>jq can transform the JSON data given to it into different data.</p><p><a href="https://openlibrary.org?v=1.0.20" rel="noopener" target="_blank">Open Library</a> supports an API for getting publications whose description contains a given word. For example, the following command captures JSON describing publications related to Svelte which is a web framework.</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"https://openlibrary.org/search.json?q=svelte"</span> <span class="token operator">></span> publications.json</code></pre><p>The structure of the JSON returned is as follows:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>    <span class="token property">"numFound"</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span><br>    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    <span class="token property">"numFoundExact"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    <span class="token property">"docs"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        ... publication objects go here ...<br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"num_found"</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span><br>    <span class="token property">"q"</span><span class="token operator">:</span> <span class="token string">"Svelte"</span><span class="token punctuation">,</span><br>    <span class="token property">"offset"</span><span class="token operator">:</span> <span class="token null keyword">null</span><br><span class="token punctuation">}</span></code></pre><p>Each publication in the <code>docs</code> array is described similar to the following:</p><pre class="language-json"><code class="language-json">        <span class="token punctuation">{</span><br>            <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"/works/OL21909240W"</span><span class="token punctuation">,</span><br>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"work"</span><span class="token punctuation">,</span><br>            <span class="token property">"seed"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"/books/OL36011260M"</span><span class="token punctuation">,</span><br>                <span class="token string">"/books/OL29882427M"</span><span class="token punctuation">,</span><br>                <span class="token string">"/works/OL21909240W"</span><span class="token punctuation">,</span><br>                <span class="token string">"/subjects/mathematics"</span><span class="token punctuation">,</span><br>                <span class="token string">"/authors/OL8370536A"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Svelte and Sapper in Action"</span><span class="token punctuation">,</span><br>            <span class="token property">"title_suggest"</span><span class="token operator">:</span> <span class="token string">"Svelte and Sapper in Action"</span><span class="token punctuation">,</span><br>            <span class="token property">"edition_count"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><br>            <span class="token property">"edition_key"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"OL36011260M"</span><span class="token punctuation">,</span><br>                <span class="token string">"OL29882427M"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"publish_date"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"2020"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"publish_year"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token number">2020</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"first_publish_year"</span><span class="token operator">:</span> <span class="token number">2020</span><span class="token punctuation">,</span><br>            <span class="token property">"number_of_pages_median"</span><span class="token operator">:</span> <span class="token number">475</span><span class="token punctuation">,</span><br>            <span class="token property">"lcc"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"QA-0076.76000000.A65"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"isbn"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"9781638350682"</span><span class="token punctuation">,</span><br>                <span class="token string">"163835068X"</span><span class="token punctuation">,</span><br>                <span class="token string">"9781617297946"</span><span class="token punctuation">,</span><br>                <span class="token string">"1617297941"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"last_modified_i"</span><span class="token operator">:</span> <span class="token number">1677546021</span><span class="token punctuation">,</span><br>            <span class="token property">"ebook_count_i"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>            <span class="token property">"ebook_access"</span><span class="token operator">:</span> <span class="token string">"no_ebook"</span><span class="token punctuation">,</span><br>            <span class="token property">"has_fulltext"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>            <span class="token property">"public_scan_b"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>            <span class="token property">"publisher"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"Manning Publications Co. LLC"</span><span class="token punctuation">,</span><br>                <span class="token string">"Manning Publications Company"</span><span class="token punctuation">,</span><br>                <span class="token string">"Manning Publications"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"language"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"eng"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"author_key"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"OL8370536A"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"author_name"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"Mark Volkmann"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"subject"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"Mathematics"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"publisher_facet"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"Manning Publications"</span><span class="token punctuation">,</span><br>                <span class="token string">"Manning Publications Co. LLC"</span><span class="token punctuation">,</span><br>                <span class="token string">"Manning Publications Company"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"subject_facet"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"Mathematics"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"_version_"</span><span class="token operator">:</span> <span class="token number">1759034499007512577</span><span class="token punctuation">,</span><br>            <span class="token property">"lcc_sort"</span><span class="token operator">:</span> <span class="token string">"QA-0076.76000000.A65"</span><span class="token punctuation">,</span><br>            <span class="token property">"author_facet"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"OL8370536A Mark Volkmann"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"subject_key"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"mathematics"</span><br>            <span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre><p>We can use <code>jq</code> to transform this JSON into a JSON array of objects that only provide the <code>date</code>, <code>author</code>, and <code>title</code> of each publication. The publication objects in the input JSON have <code>publish_date</code> and <code>author_name</code> properties whose values are arrays. We only care about the first element and we want to rename those properties to <code>date</code> and <code>author</code>. Wrapping the entire filter expression in square brackets causes a JSON array to be output.</p><pre class="language-bash"><code class="language-bash">jq <span class="token string">"[.docs[] | {date: .publish_date[0], author: .author_name[0], title}]"</span> publications.json</code></pre><p>Some of the <code>date</code> properties have a <code>null</code> value. To filter out those publications we can use the <code>select</code> function as follows:</p><pre class="language-bash"><code class="language-bash">jq <span class="token string">"[.docs[] | {date: .publish_date[0], author: .author_name[0], title} | select(.date != null)]"</span> publications.json</code></pre><p>To sort the objects on their <code>date</code> in reverse order we can use the <code>sort_by</code> function as follows:</p><pre class="language-bash"><code class="language-bash">jq <span class="token string">"[.docs[] | {date: .publish_date[0], author: .author_name[0], title} | select(.date != null)] | sort_by(.date) | reverse"</span> publications.json</code></pre><p>Some of the dates only specify a year while others also specify a month and day. This is bad for sorting. We can transform all dates to only include the year as follows.</p><p>TODO: Add this!</p><p>We can limit the number of array elements to be output by adding <code>| [limit(3; .[])]</code> which only outputs data for the first three publications. The <code>.[]</code> part specifies what we want to limit which in this case is the top-level array. The square brackets around the call to the <code>limit</code> function cause it to output a JSON array rather than just a set of objects.</p><pre class="language-bash"><code class="language-bash">jq <span class="token string">"[.docs[] | {date: .publish_date[0], author: .author_name[0], title} | select(.date != null)] | sort_by(.date) | reverse | [limit(3; .[])]"</span> publications.json</code></pre></article>