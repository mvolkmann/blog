<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Reflection</h2><aside><nav class="toc"><ol><li><a href="#getting-keywords-from-selectors">Getting Keywords from Selectors</a></li><li><a href="#operating-on-all-instances">Operating on All Instances</a></li><li><a href="#finding-the-method-for-a-selector">Finding the Method for a Selector</a></li><li><a href="#parsing-code">Parsing Code</a></li><li><a href="#questions">Questions</a></li></ol></nav></aside><article><p>Smalltalk provides many methods for getting information about classes and objects. The following table lists some of them.</p><table><thead><tr><th>Method</th><th>Answers</th></tr></thead><tbody><tr><td><code>object class</code></td><td>the class of <code>object</code></td></tr><tr><td><code>object instVarNamed: #varName</code></td><td>the value of an instance variable in <code>object</code></td></tr><tr><td><code>object instVarNamed: #varName</code> put: newValue</td><td>sets value of an instance variable in <code>object</code> and answers new value</td></tr><tr><td><code>SomeClass name</code></td><td>the name of the class as a <code>String</code></td></tr><tr><td><code>Smalltalk allClasses</code></td><td>an <code>Array</code> of all classes defined in the current image</td></tr><tr><td><code>Smalltalk allClassesImplementing: #selector</code></td><td>an <code>Array</code> of all classes that implement a given selector</td></tr><tr><td><code>SystemOrganization categoryOfElement: #SomeClass</code></td><td>name of the class category to which a given class belongs</td></tr><tr><td><code>SomeClass allClassVarNames</code></td><td>a <code>Set</code> of class variable names defined in this class</td></tr><tr><td><code>SomeClass allSelectors</code></td><td>an <code>IdentitySet</code> of all message selectors supported by this class, including selectors for inherited methods</td></tr><tr><td><code>SomeClass lookupSelector: #selector</code></td><td>the matching <code>CompiledMethod</code>, indicating where it is found</td></tr><tr><td><code>SomeClass allInstances</code></td><td>an <code>Array</code> of all existing instances of this class</td></tr><tr><td><code>SomeClass allInstVarNames</code></td><td>an <code>Array</code> of instance variable names defined in this class</td></tr><tr><td><code>SomeClass allInstVarNamesEverywhere</code></td><td>an <code>Array</code> of instance variable names defined in this class and inherited classes</td></tr><tr><td><code>SomeClass allMethodsInCategory: 'some-category'</code></td><td>an <code>Array</code> of instance methods in a given category, including those defined in this class and inherited</td></tr><tr><td><code>SomeClass allSubclasses</code></td><td>an <code>OrderedCollection</code> of subclasses</td></tr><tr><td><code>SomeClass superclass</code></td><td>a <code>Class</code> that is the superclass of this class</td></tr><tr><td><code>SomeClass withAllSuperclasses</code></td><td>an <code>OrderedCollection</code> containing all superclasses of this class going up the hierarchy</td></tr><tr><td><code>SomeClass allSuperclasses</code></td><td>an <code>OrderedCollection</code> of superclasses</td></tr><tr><td><code>SomeClass selectors</code></td><td>an <code>Array</code> of all instance method selectors of this class</td></tr><tr><td><code>SomeClass class</code></td><td>the <code>Metaclass</code> subclass of this class</td></tr><tr><td><code>SomeClass class selectors</code></td><td>an <code>Array</code> of all class method selectors of this class</td></tr><tr><td><code>SomeClass class allMethodsInCategory: 'some-category'</code></td><td>an <code>Array</code> of class methods in a given category, including those defined in this class and inherited</td></tr><tr><td><code>CodeListPackages installedPackages</code></td><td>an <code>Array</code> of <code>CodePackage</code> objects (appear in System Browser class category pane)</td></tr><tr><td><code>thisContext sender</code></td><td>a <code>MethodContext</code> describing the method that invoked the current one</td></tr><tr><td><code>someMethodContext receiver</code></td><td>the object that sent the message that invoked the <code>MethodContext</code></td></tr><tr><td><code>someMethodContext selector</code></td><td>the selector <code>Symbol</code> of the message that invoked the <code>MethodContext</code></td></tr><tr><td><code>someSelector keywords</code></td><td>an <code>Array</code> of the keywords in the selector</td></tr></tbody></table><h2 id="getting-keywords-from-selectors" tabindex="-1">Getting Keywords from Selectors</h2><p>The following examples demonstrate getting keywords from a message selector:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token symbol">#foo</span> keywords<span class="token punctuation">.</span> <span class="token comment">"#('foo')"</span><br><span class="token symbol">#foo</span><span class="token punctuation">:</span>bar<span class="token punctuation">:</span>baz<span class="token punctuation">:</span> keywords<span class="token punctuation">.</span> <span class="token comment">"#('foo:' 'bar:' 'baz:')"</span></code></pre><h2 id="operating-on-all-instances" tabindex="-1">Operating on All Instances</h2><p>To run code on every instance of a given class, send the <code>allInstancesDo:</code> message to the class.</p><p>For example, to delete all instances of a given class, run <code>SomeClass allInstancesDo: [:obj | obj delete]</code>.</p><h2 id="finding-the-method-for-a-selector" tabindex="-1">Finding the Method for a Selector</h2><p>There isn't a provided method that finds the nearest class in the inheritance hierarchy that implements a method with a given selector. I added the following method to do that. It is in the <code>Behavior</code> class in the method category &quot;*TypeCheck&quot;, so it is saved in the TypeCheck package.</p><pre class="language-smalltalk"><code class="language-smalltalk">lookupClassImplementingSelector<span class="token punctuation">:</span> selectorSymbol<br>    <span class="token comment">"Look up the given selector in my methodDictionary.<br>    Return the class that implements it if found.<br>    Otherwise chase the superclass chain and try again.<br>    Return nil if no implementing class is found."</span><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">class</span> <span class="token punctuation">|</span></span><br><br>    class <span class="token operator">:=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><br>    <span class="token punctuation">[</span>class <span class="token operator">==</span> <span class="token keyword">nil</span><span class="token punctuation">]</span> whileFalse<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>        class includesSelector<span class="token punctuation">:</span> selectorSymbol <span class="token punctuation">:</span><span class="token punctuation">:</span> ifTrue<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">^</span> class<span class="token punctuation">]</span><span class="token punctuation">.</span><br>        class <span class="token operator">:=</span> class superclass<br>    <span class="token punctuation">]</span><span class="token punctuation">.</span><br>    <span class="token operator">^</span> <span class="token keyword">nil</span></code></pre><h2 id="parsing-code" tabindex="-1">Parsing Code</h2><p>The <code>Compiler</code> class can compile strings of Smalltalk code. For example, <code>Compiler evaluate: '1+2'</code> answers <code>3</code>.</p><p>The class <code>Class</code> inherits from <code>ClassDescription</code> which inherits from <code>Behavior</code>. The <code>Behavior</code> class implements the method <code>sourceCodeAt:</code> which returns a <code>UnicodeString</code> containing the source code for the method with a given selector <code>Symbol</code>. The following code gets a string of source code from the <code>Dictionary</code> <code>#at:put:</code> method:</p><pre class="language-smalltalk"><code class="language-smalltalk">code <span class="token operator">:=</span> Dictionary sourceCodeAt<span class="token punctuation">:</span> <span class="token symbol">#at</span><span class="token punctuation">:</span>put<span class="token punctuation">:</span><span class="token punctuation">.</span></code></pre><p>The <code>code</code> variable will hold the following in a single string:</p><pre class="language-smalltalk"><code class="language-smalltalk">at<span class="token punctuation">:</span> key put<span class="token punctuation">:</span> anObject<br>    <span class="token comment">"Set the value at key to be anObject.<br>    If key is not found, create a new entry for key and set is value to anObject.<br>    If key is found, update the existing association.<br>    Answer anObject."</span><br><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">index</span> <span class="token variable">assoc</span> <span class="token punctuation">|</span></span><br>    index <span class="token operator">:=</span> <span class="token keyword">self</span> findElementOrNil<span class="token punctuation">:</span> key<span class="token punctuation">.</span><br>    assoc <span class="token operator">:=</span> array at<span class="token punctuation">:</span> index<span class="token punctuation">.</span><br>    assoc<br>        ifNil<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token keyword">self</span> atNewIndex<span class="token punctuation">:</span> index put<span class="token punctuation">:</span> <span class="token punctuation">(</span>Association key<span class="token punctuation">:</span> key value<span class="token punctuation">:</span> anObject<span class="token punctuation">)</span> <span class="token punctuation">]</span><br>        ifNotNil<span class="token punctuation">:</span> <span class="token punctuation">[</span> assoc value<span class="token punctuation">:</span> anObject <span class="token punctuation">]</span><span class="token punctuation">.</span><br>    <span class="token operator">^</span> anObject</code></pre><p>The <code>Parser</code> class parses a string of source code that describes an existing method in a given class. TODO: Is it required to be code from an existing method? It returns a <code>MethodNode</code> object that is the root of the parse tree (a.k.a abstract syntax tree). The following code parses the code from the previous example:</p><pre class="language-smalltalk"><code class="language-smalltalk">parser <span class="token operator">:=</span> Parser <span class="token keyword">new</span><span class="token punctuation">.</span><br>methodNode <span class="token operator">:=</span> parser parse<span class="token punctuation">:</span> code class<span class="token punctuation">:</span> Dictionary<span class="token punctuation">.</span></code></pre><p>The following code gets the names of the arguments that follow the keywords:</p><pre class="language-smalltalk"><code class="language-smalltalk">argNodes <span class="token operator">:=</span> methodNode arguments<span class="token punctuation">.</span><br>argNames <span class="token operator">:=</span> argNodes collect<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:node</span> <span class="token punctuation">|</span></span> node name<span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p><code>MethodNode</code> objects include the following instance varaibles and more:</p><ul><li><code>block</code> - a <code>BlockNode</code> object (described below)</li><li><code>comment</code> - an <code>OrderedCollection</code> of <code>UnicodeString</code> objects</li><li><code>properties</code> - an <code>AdditionalMethodState</code> object (has <code>selector</code> property)</li><li><code>sourceText</code> - a <code>UnicodeString</code> containing all the code for the method</li><li><code>temporaries</code> - an <code>OrderedCollection</code> of <code>TempVariableNode</code> objects</li></ul><p><code>BlockNode</code> objects include the following instance varaibles:</p><ul><li><code>arguments</code> - an <code>Array</code> of ?</li><li><code>returns</code> - a <code>Boolean</code> that indicates whether the method explicitly returns a value?</li><li><code>statements</code> - an <code>OrderedCollection</code> of nodes</li></ul><p>The class <code>ParseNode</code> is the superclass of all nodes produced by the <code>Parser</code>. This class is provided in Cuis and Squeak Smalltalk, but not in Pharo. It provides the child <code>comment</code> to all its subclasses.</p><p>They include:</p><ul><li><p><code>AssignmentNode</code> - assignment to a variable</p><p>The children are <code>variable</code> and <code>value</code>.</p></li><li><p><code>BacktickNode</code> - compound literal evaluated by compiler (surrounded by backticks)</p><p>The only child is <code>expression</code>.</p><p>This class is specific to Cuis Smalltalk.</p></li><li><p><code>BraceNode</code> - dynamic array with the syntax <code>{expr1. expr2. expr3}</code></p><p>The children are in <code>elements</code>.</p></li><li><p><code>CascadeNode</code> - cascade of messages using <code>;</code></p><p>The children are in <code>receiver</code> and <code>messages</code>.</p></li><li><p><code>CodeNode</code> - abstract class that provides shared methods to subclasses</p><p>This class is specific to Cuis Smalltalk, but it's subclasses <code>BlockNode</code> and <code>MethodNode</code> are also provided in Squeak Smalltalk.</p><ul><li><p><code>BlockNode</code> - block containing expressions to be evaluated later</p><p>The children are <code>arguments</code> and <code>statements</code>.</p></li><li><p><code>MethodNode</code> - method definition</p><p>The children are <code>temporaries</code>, <code>arguments</code>, and <code>block</code>.</p></li></ul></li><li><p><code>LeafNode</code> - abstract class that provides shared methods to subclasses</p><ul><li><p><code>LiteralNode</code> - literal number or string</p></li><li><p><code>SelectorNode</code> - message selector</p><p>The <code>key</code> property holds the selector <code>String</code>.</p><ul><li><code>SpecialSelectorNode</code> - special message selectors that have their own bytecode for efficiency</li></ul></li><li><p><code>VariableNode</code> - variable of any kind</p><p>This has a <code>name</code> instance varaible.</p><ul><li><p><code>InstanceVariableNode</code> - instance variable</p><ul><li><code>MaybeContextInstanceVariableNode</code> - performance optimization</li></ul></li><li><p><code>LiteralVariableNode</code> - constants and global identifiers</p><p>These include class names, global variables, and pool dictionary entries.</p></li><li><p><code>TempVariableNode</code> - temporary (local) variable</p><ul><li><code>RemoteTempVariableNode</code> - collection of temporary variables shared between closures</li></ul></li><li><p><code>UndeclaredVariableNode</code> - undeclared variable, perhaps used in a &quot;Do it&quot;</p></li></ul></li><li><p><code>MessageNode</code> - message sent to a receiver with optional arguments</p><p>The children are <code>receiver</code>, <code>selector</code>, and <code>arguments</code>.</p><p>The <code>precedence</code> instance variable is set to 1 for unary messages, 2 for binary messages, and 3 for keyword messages.</p><ul><li><code>MessageAsTempNode</code></li></ul></li></ul></li><li><p><code>NewArrayNode</code> - created by the <code>genPushNewArray:</code> opcode optimization</p></li><li><p><code>ReturnNode</code> - caret return of a specified value or implicit return of <code>self</code></p><p>This has an <code>expr</code> instance variable.</p></li><li><p><code>TemporariesDeclarationNode</code> - temporary variable declarations (plural) found at the start of a method or block</p><p>This class is specific to Cuis Smalltalk.</p></li><li><p><code>TemporaryDeclarationNode</code> - temporary variable declaration (singular) found at the start of a method or block</p><p>This class is specific to Cuis Smalltalk.</p></li></ul><p>Squeak Smalltalk adds the <code>ParseNode</code> subclasses <code>CommentNode</code>, <code>FieldNode</code>, and <code>FutureNode</code> which are not present in Cuis Smalltalk.</p><p>For an example of parsing Smalltalk code and printing a representation of the parse tree, see the GitHub repository <a href="https://github.com/mvolkmann/Cuis-Smalltalk-CodeParse" target="_blank">CodeParse</a>.</p><h2 id="questions" tabindex="-1">Questions</h2><p>TODO: Why does <code>allClassVarNames</code> return a <code>Set</code> when <code>allInstVarNames</code> returns an <code>Array</code>? TODO: Is there a way to get all the message categories used by a class?</p></article>