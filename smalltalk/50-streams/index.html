<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Streams</h2><aside><nav class="toc"><ol><li><a href="#positionablestream">PositionableStream</a></li><li><a href="#readstream">ReadStream</a></li><li><a href="#writestream">WriteStream</a></li><li><a href="#readwritestream">ReadWriteStream</a></li><li><a href="#creating-strings">Creating Strings</a></li><li><a href="#debugging">Debugging</a></li><li><a href="#file-i%2Fo">File I/O</a><ol><li><a href="#files">Files</a></li><li><a href="#directories">Directories</a></li></ol></li></ol></nav></aside><article><p>Streams provide a way to iterate over many kinds of collections and resources, including <code>String</code> objects. They also provide a way to write data.</p><p>The class <code>SequenceableCollection</code> which is a superclass of <code>Array</code> provides the methods <code>readStream</code>, <code>readStreamFrom:to:</code>, and <code>writeStream</code> that each return a stream.</p><p>The <code>readStream</code> method of <code>SequenceableCollection</code> returns a <code>ReadStream</code> which is a subclass of <code>Positionable</code> stream. It has a <code>position</code> instance variable that can be retrieved by sending <code>#position</code> and modified by sending <code>#position:</code>. It also has a <code>readLimit</code> instance variable that is intialized to the collection size.</p><h2 id="positionablestream" tabindex="-1">PositionableStream</h2><p>The <code>PositionableStream</code> class method <code>on:</code> takes a <code>Collection</code> and returns a stream over it. The <code>ReadStream</code> class method <code>on:from:to:</code> takes a <code>Collection</code> and two indexes, and returns a stream over that range of elements.</p><p>The following table describes commonly used methods in the <code>PositionableStream</code> class.</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>atEnd</code></td><td>answers true if <code>position</code> &gt;= <code>readLimit</code></td></tr><tr><td><code>atStart</code></td><td>answers true if <code>position</code> is zero</td></tr><tr><td><code>back</code></td><td>subtract 1 from <code>position</code> and answers that element</td></tr><tr><td><code>contents</code></td><td>answers copy of collection</td></tr><tr><td><code>isEmpty</code></td><td>answers true if <code>atEnd</code> and <code>position</code> is zero</td></tr><tr><td><code>next:</code></td><td>anwsers collection of next argument elements, advancing <code>position</code> for each</td></tr><tr><td><code>notEmpty</code></td><td>answers true if not <code>isEmpty</code></td></tr><tr><td><code>peek</code></td><td>answers element at <code>position</code></td></tr><tr><td><code>peekBack</code></td><td>answers element at <code>position</code> minus 1</td></tr><tr><td><code>position</code></td><td>answers the current value of <code>position</code></td></tr><tr><td><code>position:</code></td><td>sets <code>position</code> to argument if not greater than <code>readLimit</code></td></tr><tr><td><code>reset</code></td><td>sets <code>position</code> to zero</td></tr><tr><td><code>resetContents</code></td><td>sets <code>position</code> and <code>readLimit</code> to zero</td></tr><tr><td><code>setToEnd</code></td><td>sets <code>position</code> to <code>readLimit</code></td></tr><tr><td><code>skip</code></td><td>adds 1 to <code>position</code></td></tr><tr><td><code>skip:</code></td><td>adds argument to <code>position</code></td></tr><tr><td><code>skipBack</code></td><td>subtracts 1 from <code>position</code></td></tr><tr><td><code>skipTo:</code></td><td>advances position to element matching argument and answers whether found</td></tr></tbody></table><h2 id="readstream" tabindex="-1">ReadStream</h2><p>The following table describes commonly used methods in the <code>ReadStream</code> class.</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>next</code></td><td>adds 1 to <code>position</code> and answers that element</td></tr><tr><td><code>size</code></td><td>answers value of <code>readLimit</code></td></tr></tbody></table><p>The following code demonstrates using many of the methods described above. The <code>logAs:</code> method is defined in the &quot;Getting Started&quot; section &quot;Transcripts&quot;. When the end is reached, the <code>next</code> method returns <code>nil</code>.</p><pre class="language-smalltalk"><code class="language-smalltalk">arr <span class="token operator">:=</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token string">'apple'</span> <span class="token string">'banana'</span> <span class="token string">'cherry'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>stream <span class="token operator">:=</span> arr readStream<span class="token punctuation">.</span><br>stream position logAs<span class="token punctuation">:</span> <span class="token string">'position'</span><span class="token punctuation">.</span> <span class="token comment">"0"</span><br>stream size logAs<span class="token punctuation">:</span> <span class="token string">'readLimit'</span><span class="token punctuation">.</span> <span class="token comment">"3"</span><br>stream atStart logAs<span class="token punctuation">:</span> <span class="token string">'atStart'</span><span class="token punctuation">.</span> <span class="token comment">"true"</span><br>stream atEnd logAs<span class="token punctuation">:</span> <span class="token string">'atEnd'</span><span class="token punctuation">.</span> <span class="token comment">"false"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"position -> 1; apple"</span><br>stream peek print<span class="token punctuation">.</span> <span class="token comment">"position stays 1; banana"</span><br>stream peekBack print<span class="token punctuation">.</span> <span class="token comment">"position stays 1; apple"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"position -> 2; banana"</span><br>stream reset<span class="token punctuation">.</span> <span class="token comment">"position -> 0"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"position -> 1; apple"</span><br>stream position<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">.</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"position -> 3; cherry"</span><br>stream back<span class="token punctuation">.</span> <span class="token comment">"position -> 2"</span><br>stream peekBack print<span class="token punctuation">.</span> <span class="token comment">"banana"</span><br>stream peek print<span class="token punctuation">.</span> <span class="token comment">"cherry"</span><br>stream atStart logAs<span class="token punctuation">:</span> <span class="token string">'atStart'</span><span class="token punctuation">.</span> <span class="token comment">"false"</span><br>stream atEnd logAs<span class="token punctuation">:</span> <span class="token string">'atEnd'</span><span class="token punctuation">.</span> <span class="token comment">"true"</span></code></pre><p>The <code>readStreamFrom:to:</code> method returns a stream that can read the elements in a range of the collection.</p><pre class="language-smalltalk"><code class="language-smalltalk">arr <span class="token operator">:=</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token string">'apple'</span> <span class="token string">'banana'</span> <span class="token string">'cherry'</span> <span class="token string">'grape'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>stream <span class="token operator">:=</span> arr readStreamFrom<span class="token punctuation">:</span> <span class="token number">2</span> to<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"banana"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"cherry"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"nil"</span></code></pre><h2 id="writestream" tabindex="-1">WriteStream</h2><p>The <code>writeStream</code> method returns a <code>WriteStream</code> that can modify the collection. It adds the instance variable <code>writeLimit</code> which is initialized to the collection size.</p><p>This class is often used to write to a characters in a string.</p><p>The following table describes some of the commonly instance methods defined in the <code>WriteStream</code> class that write to the stream.</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>nextPut:</code></td><td>writes a single <code>Character</code></td></tr><tr><td><code>nextPutAll:</code></td><td>writes all the <code>Character</code> elements in a <code>String</code></td></tr><tr><td><code>newLine</code></td><td>writes a newline character</td></tr><tr><td><code>space</code></td><td>writes a space character</td></tr><tr><td><code>tab</code></td><td>writes a tab character</td></tr></tbody></table><p>Methods whose names begin with <code>nextPut*</code> write to the &quot;next&quot; position in the stream which is typically at the end. I kind of wish the method names were shortened to <code>put*</code>.</p><p>TODO: So far I can only get a <code>WriteStream</code> to modify existing elements, not add new ones. For example, this does not work:</p><pre class="language-smalltalk"><code class="language-smalltalk">coll <span class="token operator">:=</span> OrderedCollection newFrom<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token string">'apple'</span> <span class="token string">'banana'</span> <span class="token string">'cherry'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>stream <span class="token operator">:=</span> coll writeStream<span class="token punctuation">.</span><br>stream pastEndPut<span class="token punctuation">:</span> <span class="token string">'grape'</span><span class="token punctuation">.</span><br>coll print<span class="token punctuation">.</span></code></pre><h2 id="readwritestream" tabindex="-1">ReadWriteStream</h2><p>The <code>ReadWriteStream</code> class creates a stream that can read and write (modify) collection elements. Typically code only needs to read or write to a stream, not both, so this is rarely used.</p><pre class="language-smalltalk"><code class="language-smalltalk">coll <span class="token operator">:=</span> OrderedCollection newFrom<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token string">'apple'</span> <span class="token string">'banana'</span> <span class="token string">'cherry'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>stream <span class="token operator">:=</span> ReadWriteStream with<span class="token punctuation">:</span> coll<span class="token punctuation">.</span> <span class="token comment">"position is 3"</span><br>stream reset<span class="token punctuation">.</span> <span class="token comment">"position is 0"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"changes position to 1; outputs apple"</span><br>stream nextPut<span class="token punctuation">:</span> <span class="token string">'grape'</span><span class="token punctuation">.</span> <span class="token comment">"changes position to 2; changes element to grape"</span><br>coll print<span class="token punctuation">.</span> <span class="token comment">"apple grape cherry"</span></code></pre><h2 id="creating-strings" tabindex="-1">Creating Strings</h2><p>One use of streams is to efficiently build a <code>String</code>. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">stream <span class="token operator">:=</span> WriteStream on<span class="token punctuation">:</span> <span class="token punctuation">(</span>String <span class="token keyword">new</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>stream nextPutAll<span class="token punctuation">:</span> <span class="token string">'Hello'</span><span class="token punctuation">;</span> nextPutAll<span class="token punctuation">:</span> <span class="token string">', World'</span><span class="token punctuation">;</span> nextPut<span class="token punctuation">:</span> <span class="token char">$!</span><span class="token punctuation">;</span> newLine<span class="token punctuation">.</span><br>string <span class="token operator">:=</span> stream contents<span class="token punctuation">.</span> <span class="token comment">"Hello, World!\n"</span></code></pre><p><code>100</code> above is just a size estimate. It does not affect the size of the final <code>String</code>. More than 100 characters can be added, but doing that will be slightly less efficient because additional space will need to be allocated during execution of the <code>nextPut*</code> methods.</p><p>If the purpose of building a <code>String</code> is to write it to the Transcript, it is better to just use methods in the <code>Transcript</code> class. That class implements many of the same methods as the <code>WriteStream</code> class, but it is a subclass of <code>Object</code>, not any stream-related class. The <code>Transcript</code> stream-related methods are on the class side, whereas the corresponding <code>WriteStream</code> methods are on the instance side. The example above can be written as follows to write to the Transcript.</p><pre class="language-smalltalk"><code class="language-smalltalk">Transcript nextPutAll<span class="token punctuation">:</span> <span class="token string">'Hello'</span><span class="token punctuation">;</span> nextPutAll<span class="token punctuation">:</span> <span class="token string">', World'</span><span class="token punctuation">;</span> nextPut<span class="token punctuation">:</span> <span class="token char">$!</span><span class="token punctuation">;</span> cr<span class="token punctuation">.</span></code></pre><h2 id="debugging" tabindex="-1">Debugging</h2><p>When a stream variable is selected in the bottom panes of a debugger window, the current contents of the stream are displayed in the pane to its right. The current contents of a stream can also be displayed by selecting a stream variable and using &quot;Inspect&quot; or &quot;Explore&quot;.</p><h2 id="file-i%2Fo" tabindex="-1">File I/O</h2><h3 id="files" tabindex="-1">Files</h3><p>To create a <code>FileEntry</code> object, send the <code>#asFileEntry</code> message to a string that contains the file name. The file is assumed to be in the <code>\*-UserFiles</code> directory (ex. <code>Cuis-Smalltalk-Dev-UserFiles</code>). To see this, enter <code>DirectoryEntry currentDirectory</code> in a Workspace and &quot;Print it&quot;.</p><p>For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry <span class="token operator">:=</span> <span class="token string">'demo.txt'</span> asFileEntry<span class="token punctuation">.</span></code></pre><p>To write to a text file, overwriting any previous contents:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry forceWriteStreamDo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:fileStream</span> <span class="token punctuation">|</span></span><br>    fileStream nextPutAll<span class="token punctuation">:</span> <span class="token string">'line #1'</span><span class="token punctuation">.</span><br>    fileStream newLine<span class="token punctuation">.</span><br>    fileStream nextPutAll<span class="token punctuation">:</span> <span class="token string">'line #2'</span><br><span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>Another way to obtain a stream for writing and reading a file at a given path is the following:</p><pre class="language-smalltalk"><code class="language-smalltalk">stream <span class="token operator">:=</span> FileStream fileNamed<span class="token punctuation">:</span> <span class="token string">'some-file-path'</span></code></pre><p>To read the entire contents of a text file into a string:</p><pre class="language-smalltalk"><code class="language-smalltalk">contents <span class="token operator">:=</span> fileEntry fileContents<span class="token punctuation">.</span></code></pre><p>To read lines in a text file one at a time:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry <span class="token operator">:=</span> <span class="token string">'demo.txt'</span> asFileEntry<span class="token punctuation">.</span><br>stream <span class="token operator">:=</span> fileEntry readStream<span class="token punctuation">.</span><br>line <span class="token operator">:=</span> stream nextLine <span class="token comment">"do repeatedly to get each line"</span></code></pre><p>To write serialized objects to a file:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry writeStreamDo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:fileStream</span> <span class="token punctuation">|</span></span><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">refStream</span> <span class="token punctuation">|</span></span><br>    refStream <span class="token operator">:=</span> ReferenceStream on<span class="token punctuation">:</span> fileStream<span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br><span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>TODO: Do ReferenceStreams support circular object references?</p><p>To read serialized objects from a file:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry readStreamDo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:fileStream</span> <span class="token punctuation">|</span></span><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">object</span> <span class="token variable">refStream</span> <span class="token punctuation">|</span></span><br>    refStream <span class="token operator">:=</span> ReferenceStream on<span class="token punctuation">:</span> fileStream<span class="token punctuation">.</span><br>    <span class="token punctuation">[</span>refStream atEnd<span class="token punctuation">]</span> whileFalse<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>        object <span class="token operator">:=</span> refStream next<span class="token punctuation">.</span><br>        object print <span class="token comment">"writes to Transcript"</span><br>    <span class="token punctuation">]</span><br><span class="token punctuation">]</span></code></pre><p>To delete a file:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry delete<span class="token punctuation">.</span></code></pre><p>TODO: Harvest more information about file system operations from this video. <a href="https://youtu.be/stMoWMlLVzk?si=_3rmJFPkZ2g4ZIIV" target="_blank">squeak smalltalk tutorial: file handling part 1</a>.</p><h3 id="directories" tabindex="-1">Directories</h3><p>The following instance methods of the <code>DirectoryEntry</code> class iterate over its files and subdirectories:</p><p>| Method | Description | | ------------------- | --------------------------------------------------------------------------- | --- | | <code>allChildrenDo:</code> | iterates over all subdirectories and files recursively | | | <code>allDirectoriesDo:</code> | iterates over all subdirectories recursively | | <code>allFilesDo:</code> | iterates over all files in this directory and in subdirectories recursively | | <code>directoriesDo:</code> | iteraters over all subdirectories non-recursively | | <code>filesDo:</code> | iterates over all files in this directory | | <code>childrenDo:</code> | iterates over all subdirectories and files non-recursively | |</p><p>The following code iterates over all the files found in and below a given directory:</p><pre class="language-smalltalk"><code class="language-smalltalk">de <span class="token operator">:=</span> DirectoryEntry smalltalkImageDirectory<span class="token punctuation">.</span><br>de allFilesDo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:file</span> <span class="token punctuation">|</span></span> file name print<span class="token punctuation">]</span></code></pre></article>