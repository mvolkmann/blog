<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Streams</h2><aside><nav class="toc"><ol><li><a href="#file-i%2Fo">File I/O</a><ol><li><a href="#files">Files</a></li><li><a href="#directories">Directories</a></li></ol></li></ol></nav></aside><article><p>Streams provide a way to iterate over many kinds of collections and resources.</p><p>The class <code>SequenceableCollection</code> which is a superclass of <code>Array</code> provides the methods <code>readStream</code>, <code>readStreamFrom:to:</code>, and <code>writeStream</code> that each return a stream.</p><p>The <code>readStream</code> method returns a stream that can be used to read every element of the collection.</p><pre class="language-smalltalk"><code class="language-smalltalk">arr <span class="token operator">:=</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token string">'apple'</span> <span class="token string">'banana'</span> <span class="token string">'cherry'</span> <span class="token string">'grape'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>stream <span class="token operator">:=</span> arr readStream<span class="token punctuation">.</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"apple"</span><br><span class="token punctuation">(</span>stream next<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span> print<span class="token punctuation">.</span> <span class="token comment">"banana cherry"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"grape"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"nil"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"nil"</span></code></pre><p>The <code>readStreamFrom:to:</code> method returns a stream that can be used to read the elements in a range of the collection.</p><pre class="language-smalltalk"><code class="language-smalltalk">arr <span class="token operator">:=</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token string">'apple'</span> <span class="token string">'banana'</span> <span class="token string">'cherry'</span> <span class="token string">'grape'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>stream <span class="token operator">:=</span> arr readStreamFrom<span class="token punctuation">:</span> <span class="token number">2</span> to<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"banana"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"cherry"</span><br>stream next print<span class="token punctuation">.</span> <span class="token comment">"nil"</span></code></pre><p>The <code>writeStream</code> method returns a stream that can be used to</p><h2 id="file-i%2Fo" tabindex="-1">File I/O</h2><h3 id="files" tabindex="-1">Files</h3><p>To create a file, send the <code>#asFileEntry</code> message to a string that contains the file name. The file is assumed to be in the <code>\*-UserFiles</code> directory. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry <span class="token operator">:=</span> <span class="token string">'demo.txt'</span> asFileEntry<span class="token punctuation">.</span></code></pre><p>To write to a text file, overwriting any previous contents:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry forceWriteStreamDo<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token block-arguments"><span class="token variable">:fileStream</span> <span class="token punctuation">|</span></span><br>    fileStream nextPutAll<span class="token punctuation">:</span> <span class="token string">'line #1'</span><span class="token punctuation">.</span><br>    fileStream newLine<span class="token punctuation">.</span><br>    fileStream nextPutAll<span class="token punctuation">:</span> <span class="token string">'line #2'</span><br><span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>Another way to obtain a stream for writing and reading a file at a given path is the following:</p><pre class="language-smalltalk"><code class="language-smalltalk">stream <span class="token operator">:=</span> FileStream fileNamed<span class="token punctuation">:</span> <span class="token string">'some-file-path'</span></code></pre><p>To read the entire contents of a text file into a string:</p><pre class="language-smalltalk"><code class="language-smalltalk">contents <span class="token operator">:=</span> fileEntry fileContents<span class="token punctuation">.</span></code></pre><p>To write serialized objects to a file:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry writeStreamDo<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token block-arguments"><span class="token variable">:fileStream</span> <span class="token punctuation">|</span></span><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">refStream</span> <span class="token punctuation">|</span></span><br>    refStream <span class="token operator">:=</span> ReferenceStream on<span class="token punctuation">:</span> fileStream<span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">.</span><br>    refStream nextPut<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br><span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>TODO: Do ReferenceStreams support circular object references?</p><p>To read serialized objects from a file:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry readStreamDo<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token block-arguments"><span class="token variable">:fileStream</span> <span class="token punctuation">|</span></span><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">object</span> <span class="token variable">refStream</span> <span class="token punctuation">|</span></span><br>    refStream <span class="token operator">:=</span> ReferenceStream on<span class="token punctuation">:</span> fileStream<span class="token punctuation">.</span><br>    <span class="token punctuation">[</span> refStream atEnd <span class="token punctuation">]</span> whileFalse<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>        object <span class="token operator">:=</span> refStream next<span class="token punctuation">.</span><br>        object print <span class="token comment">"writes to Transcript"</span><br>    <span class="token punctuation">]</span><br><span class="token punctuation">]</span></code></pre><p>To delete a file:</p><pre class="language-smalltalk"><code class="language-smalltalk">fileEntry delete<span class="token punctuation">.</span></code></pre><p>TODO: Harvest more information about file system operations from this video. <a href="https://youtu.be/stMoWMlLVzk?si=_3rmJFPkZ2g4ZIIV" target="_blank">squeak smalltalk tutorial: file handling part 1</a>.</p><h3 id="directories" tabindex="-1">Directories</h3><p>The following instance methods of the <code>DirectoryEntry</code> class iterate over its files and subdirectories:</p><p>| Method | Description | | ------------------- | --------------------------------------------------------------------------- | --- | | <code>allChildrenDo:</code> | iterates over all subdirectories and files recursively | | | <code>allDirectoriesDo:</code> | iterates over all subdirectories recursively | | <code>allFilesDo:</code> | iterates over all files in this directory and in subdirectories recursively | | <code>directoriesDo:</code> | iteraters over all subdirectories non-recursively | | <code>filesDo:</code> | iterates over all files in this directory | | <code>childrenDo:</code> | iterates over all subdirectories and files non-recursively | |</p><p>The following code iterates over all the files found in and below a given directory:</p><pre class="language-smalltalk"><code class="language-smalltalk">de <span class="token operator">:=</span> DirectoryEntry smalltalkImageDirectory<span class="token punctuation">.</span><br>de allFilesDo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:file</span> <span class="token punctuation">|</span></span> file name print<span class="token punctuation">]</span></code></pre></article>