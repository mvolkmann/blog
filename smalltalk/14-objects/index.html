<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Objects</h2><aside><nav class="toc"><ol><li><a href="#object-and-protoobject">Object and ProtoObject</a></li><li><a href="#counting-objects">Counting Objects</a></li><li><a href="#deleting-objects">Deleting Objects</a></li><li><a href="#object-creation-detail">Object Creation Detail</a></li><li><a href="#method-dictionaries">Method Dictionaries</a></li><li><a href="#immutability">Immutability</a></li></ol></nav></aside><article><p>Code and data are both represented by objects. Code can be described by a method or block, both of which are kinds of objects.</p><p>Objects are created by sending a message to a class. In addition, some kinds of objects, such as numbers, strings, and arrays, can be created from a literal syntax.</p><p>Every class supports the class method <code>new</code>, which creates and returns a new instance of the class. If the class defines the instance method <code>initialize</code>, the <code>new</code> method will call it. The <code>initialize</code> method typically initializes each of the instance variables of the object.</p><p>Let's look at an example class named <code>Rect</code> with instance variables <code>height</code> and <code>width</code>. We chose the name <code>Rect</code> because the name <code>Rectangle</code> is used by a provided class in the &quot;Graphics-Primitives&quot; class category.</p><p>We can define the class method <code>height:width:</code> that provides an alternate way to create objects as follows:</p><pre class="language-smalltalk"><code class="language-smalltalk">height<span class="token punctuation">:</span> aHeight width<span class="token punctuation">:</span> aWidth<br>    <span class="token operator">^</span><span class="token keyword">self</span> <span class="token keyword">new</span> setHeight<span class="token punctuation">:</span> aHeight width<span class="token punctuation">:</span> aWidth</code></pre><p>We can then define the following instance methods:</p><pre class="language-smalltalk"><code class="language-smalltalk">initialize<br>    <span class="token keyword">super</span> initialize<span class="token punctuation">.</span><br>    height <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">.</span><br>    width <span class="token operator">:=</span> <span class="token number">1</span><br><br>setHeight<span class="token punctuation">:</span> aHeight width<span class="token punctuation">:</span> aWidth<br>    height <span class="token operator">:=</span> aHeight<span class="token punctuation">.</span><br>    width <span class="token operator">:=</span> aWidth<br><br>area<br>    <span class="token operator">^</span> height <span class="token operator">*</span> width</code></pre><p>It is recommended for <code>initialize</code> methods to begin by sending the <code>#initialize</code> message to <code>super</code> so the superclass will initialize its instance variables. Omitting this can produce unexpected results.</p><p>The <code>setHeight:width:</code> method should be in the &quot;private&quot; method category to indicate that it is not meant to invoked from outside this class.</p><p>We can use the <code>Rect</code> class as follows:</p><pre class="language-smalltalk"><code class="language-smalltalk">r1 <span class="token operator">:=</span> Rect <span class="token keyword">new</span><span class="token punctuation">.</span><br>Transcript show<span class="token punctuation">:</span> r1 area<span class="token punctuation">.</span> <span class="token comment">"1"</span><br><br>r2 <span class="token operator">:=</span> Rect height<span class="token punctuation">:</span> <span class="token number">2</span> width<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br>Transcript show<span class="token punctuation">:</span> r2 area<span class="token punctuation">.</span> <span class="token comment">"6"</span></code></pre><p>To determine the class of an object, send it the unary message <code>#class</code>. For example, <code>19 class</code> returns <code>SmallInteger</code>.</p><h2 id="object-and-protoobject" tabindex="-1">Object and ProtoObject</h2><p>The <code>Object</code> is a superclass of nearly every other class. It defines methods that are available on all objects. It is a subclass of the <code>ProtoObject</code> class. There are a small number of other classes that are subclasses of <code>ProtoObject</code> and not subclasses of <code>Object</code>. These include <code>BreakingMethodWrapper</code>, <code>MessageCatcher</code>, and <code>ProtoCatcher</code>.</p><p>To get a <code>String</code> representation of any object that is meaningful to a Smalltalk developer, send it the <code>#printString</code> message. The default implementation in the <code>Object</code> class returns &quot;a&quot; or &quot;an&quot; followed by a space and the class name. Classes can override the <code>printString</code> method to customize the <code>String</code> that is returned. For example, the following code prints <code>a Set(3 2 1)</code>, which is <code>String</code> representation of a <code>Set</code> of numbers, to a Transcript:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">set</span> <span class="token punctuation">|</span></span><br>set <span class="token operator">:=</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">1</span><span class="token punctuation">)</span> asSet<span class="token punctuation">.</span><br>set printString print</code></pre><p>TODO: See the comments in Object printString about overriding the <code>printOn:</code> method instead of this! Try this! Also see how the <code>withArticle</code> method is used in Object printOn: !</p><p>The following table describes some of the instance methods defined in the <code>ProtoObject</code> class.</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>ifNil:</code></td><td>never evaluates the argument block</td></tr><tr><td><code>ifNil:ifNotNil:</code></td><td>always evaluates the <code>ifNotNil:</code> block</td></tr><tr><td><code>ifNotNil:</code></td><td>always evalutes the argument block</td></tr><tr><td><code>ifNotNil:ifNil:</code></td><td>always evaluates the <code>ifNotNil:</code> block and never the <code>ifNil:</code> block</td></tr><tr><td><code>isNil</code></td><td>always answers <code>false</code></td></tr><tr><td><code>notNil</code></td><td>always answers <code>true</code></td></tr></tbody></table><p>The following table describes some of the instance methods defined in the <code>Object</code> class.</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>addDependent:</code></td><td>adds an object to be notified when this object is changed</td></tr><tr><td><code>asJsonString</code></td><td>answsers <code>String</code> JSON representation from `jsonWriteOn: method</td></tr><tr><td><code>asString</code></td><td>answsers <code>String</code> representation from <code>printString</code> method</td></tr><tr><td><code>assert:</code></td><td>signals <code>AssertionFailure</code> if block argument evaluates to <code>false</code></td></tr><tr><td><code>assert:description:</code></td><td>same as <code>assert:</code>, but with a custom message</td></tr><tr><td><code>breakDependents</code></td><td>removes all objects to be notified when this object is changed</td></tr><tr><td><code>changed</code></td><td>informs all dependents that an unspecified aspect of the object has changed</td></tr><tr><td><code>changed:</code></td><td>informs all dependents that a specified aspect of the object has changed</td></tr><tr><td><code>class</code></td><td>answers the class of this object</td></tr><tr><td><code>className</code></td><td>answers the class name of this object as a <code>String</code></td></tr><tr><td><code>confirm:</code></td><td>renders dialog that asks specified question with options &quot;Yes&quot; and &quot;No&quot;; returns <code>Boolean</code></td></tr><tr><td><code>confirm:orCancel:</code></td><td>similar to <code>confirm:</code>, but adds &quot;Cancel&quot; option and evalutes <code>orCancel:</code> block if selected</td></tr><tr><td><code>removeDependent:</code></td><td>removes an object to be notified when this object is changed</td></tr><tr><td>``</td><td></td></tr></tbody></table><p>TODO: Add more methods to the table above?</p><p>TODO: Show examples of using <code>confirm:</code> and <code>confirm:orCancel:</code>.</p><h2 id="counting-objects" tabindex="-1">Counting Objects</h2><p>To determine the number of objects that currently exist from a given class, not counting its subclasses, send the message <code>#allInstances</code> to the class. This answers an <code>Array</code> containing all the objects. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">Workspace allInstances size</code></pre><p>To determine the number of objects that currently exist from all the subclasses of a given class, send the message <code>#allSubclasses</code> to the class to get the subclasses and sum the instance counts from each of those. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">Morph allSubclasses sum<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:class</span> <span class="token punctuation">|</span></span> class allInstances size<span class="token punctuation">]</span></code></pre><p>To determine the number of objects that currently exist from all classes, use the approach above with the class <code>ProtoObject</code> which is a superclass of all classes.</p><pre class="language-smalltalk"><code class="language-smalltalk">ProtoObject allSubclasses sum<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:class</span> <span class="token punctuation">|</span></span> class allInstances size<span class="token punctuation">]</span></code></pre><h2 id="deleting-objects" tabindex="-1">Deleting Objects</h2><p>Variables defined in a Workspace hold references to their object values. Closing a Workspace removes those references, which makes it possible for them to be garbage collected.</p><p>Some classes such as <code>Morph</code> implement a <code>delete</code> method. To delete all instances of such classes, enter the following in Workspace and &quot;Do it&quot;:</p><pre class="language-smalltalk"><code class="language-smalltalk">SomeClass allInstancesDo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:obj</span> <span class="token punctuation">|</span></span> obj delete<span class="token punctuation">]</span></code></pre><h2 id="object-creation-detail" tabindex="-1">Object Creation Detail</h2><p>New objects can be created by sending the message <code>#new</code> or <code>#basicNew</code> to a class.</p><p>The diagram below shows the classes involved when sending the message <code>#new</code> to a class.</p><p><code>Circle</code> is a subclass of <code>Shape</code> which is a subclass of <code>Object</code> which is a subclass of <code>ProtoObject</code>. The superclass of <code>ProtoObject</code> is <code>nil</code>.</p><p>The asterisks in the diagram are placeholders for the class associated with an arrow. For example, sending the message <code>#superclass</code> to <code>Circle</code> gives <code>Shape</code> and sending the message <code>#class</code> to <code>Circle</code> gives <code>Circle class</code>.</p><p><img alt="Smalltalk class hierarchy:" style="width: 100%" src="/blog/assets/SmalltalkClassHierarchy.png?v=1.1.1"></p><p>Here are some important facts about the diagram above:</p><ul><li>Every class is represented by a pair of objects. One represents the class and the other represents its metaclass.</li><li>The instance methods of a metaclass are the class methods of the corresponding class.</li><li>When a class is selected in a System Browser, clicking the &quot;class&quot; button causes it to display its metaclass.</li><li>The name of each metaclass is the name of its corresponding class followed by &quot; class&quot;. For example, the name of the metaclass of the <code>Circle</code> class is <code>Circle class</code>.</li><li>There is only one instance of each metaclass.</li><li>The superclass of all metaclasses it <code>Metaclass</code>.</li><li><code>Metaclass</code> is subclass of <code>ClassDescription</code> which is a subclass of <code>Behavior</code> which is a subclass of <code>Object</code>.</li><li>The <code>Behavior</code> class defines the <code>new</code> method and many others including <code>allInstances</code>, <code>allSubclasses</code>, <code>allSuperclasses</code>, <code>instVarNames</code>, and <code>methodDict</code>.</li><li>The <code>Behavior</code> <code>new</code> method returns <code>self basicNew initialize</code>.</li><li>The <code>Object</code> metaclass implements the instance method <code>initialize</code> which does nothing, leaving all the instance variables initialized to <code>nil</code>.</li><li>Any class can implement the instance method <code>initialize</code> to set its instance variables to values other than <code>nil</code>.</li></ul><p>Let's walk through the steps to find the <code>new</code> method when evaluating <code>circle := Circle new</code>. The <code>#new</code> message is sent to the <code>Circle</code> class, not to an instance of the class.</p><ul><li>Look in <code>Circle class</code>.</li><li>Look in <code>Shape class</code>.</li><li>Look in <code>Object class</code>.</li><li>Look in <code>ProtoObject class</code>.</li><li>Look in <code>Class class</code>.</li><li>Look in <code>ClassDescription class</code>.</li><li>Look in <code>Behavior class</code> where it is found.</li></ul><p>Another way to discover where the <code>new</code> method is implemented is to enter the following in a Workspace and press cmd-p (Print it):</p><pre class="language-smalltalk"><code class="language-smalltalk">Circle class lookupSelector<span class="token punctuation">:</span> <span class="token symbol">#new</span></code></pre><p>The output is <code>(Behavior&gt;&gt;#new &quot;a CompiledMethod:48(357226)&quot;)</code>. The <code>Behavior</code> class defines the instance method <code>&gt;&gt;</code> which takes a <code>Symbol</code> selector and returns the <code>CompiledMethod</code> instance that handles the selector.</p><p>The <code>basicNew</code> method does not call the instance method <code>initialize</code>. The <code>basicNew</code> method should not be overridden in subclasses to do something different, but the <code>new</code> method can be overridden.</p><h2 id="method-dictionaries" tabindex="-1">Method Dictionaries</h2><p>Method dictionaries are used to process message sends. Their keys are symbols that are message selectors and their values are <code>CompiledMethod</code> objects. The processing for finding a matching method searches the <code>methodDict</code> instance variables found in the inheritance hierarchy of the receiver object.</p><p>The instance methods of a class are stored in the provided instance variable <code>methodDict</code> of the class. This can be viewed by sending the message <code>#methodDict</code> to a class or by selecting the class name and pressing cmd-shift-i (Explore it). The value of <code>methodDict</code> is an instance of <code>MethodDictionary</code> which is a subclass of <code>Dictionary</code>.</p><p>The class methods of a class are stored in the provided instance variable <code>methodDict</code> of the metaclass of the class. This can be viewed by sending the message <code>#methodDict</code> to a metaclass or by selecting the class name followed by &quot; class&quot; and pressing cmd-shift-i (Explore it). It is also an instance of <code>MethodDictionary</code>. One way to find a metaclass name so it can be selected is to select the class in a System Browser and click the &quot;class&quot; button.</p><h2 id="immutability" tabindex="-1">Immutability</h2><p>A class can enforce the immutability of its object by simply not implementing any methods that change its instance variable.</p><p>Another option is to use the &quot;Immutability&quot; package. It causes attempts to change any instance variable of a given object to result in a &quot;ModificationForbidden&quot; error. This opens a Debugger window that contains a stack trace which indicates where the modification attempt was made.</p><p>To install the &quot;Immutability&quot; package, enter <code>Feature require: 'Immutability'</code> and &quot;Do it&quot;. Among other things, this package adds the instance method <code>beImmutable</code> to the <code>Object</code> class.</p><p>To enforce a specific object to be immutable, send it the <code>#beImmutable</code> message. For example the <code>Rect</code> class described above could have the following class method for creating new instances:</p><pre class="language-smalltalk"><code class="language-smalltalk">height<span class="token punctuation">:</span> aHeight width<span class="token punctuation">:</span> aWidth<br>    <span class="token operator">^</span><span class="token keyword">self</span> <span class="token keyword">new</span> setHeight<span class="token punctuation">:</span> aHeight width<span class="token punctuation">:</span> aWidth<span class="token punctuation">;</span> beImmutable<span class="token punctuation">;</span> yourself</code></pre><p>Note the use of <code>yourself</code> to return the current object rather than the return value of the <code>beImmutable</code> method.</p></article>