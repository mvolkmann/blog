<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Web Development</h2><aside><nav class="toc"><ol><li><a href="#simple-example">Simple Example</a></li><li><a href="#sending-http-requests">Sending HTTP Requests</a></li><li><a href="#implementing-an-http-server">Implementing an HTTP Server</a></li><li><a href="#webclientplus-package">WebClientPlus package</a><ol><li><a href="#webserverplus-class">WebServerPlus class</a></li><li><a href="#webcontext-class">WebContext class</a></li><li><a href="#controlling-the-server">Controlling the server</a></li><li><a href="#testing-the-example-server">Testing the example server</a></li><li><a href="#webclientplus-class">WebClientPlus class</a></li></ol></li></ol></nav></aside><article><p>One package for implementing a web server is <a href="https://github.com/Cuis-Smalltalk/Cuis-Smalltalk-Dev/blob/master/Packages/Features/WebClient.pck.st" target="_blank">WebClient</a>. To install this, open a Workspace, enter <code>Feature require: 'WebClient'</code>, and &quot;Do it&quot;. This adds many classes in the &quot;WebClient - Core&quot; category including <code>WebClient</code>, <code>WebRequest</code>, <code>WebResponse</code>, <code>WebServer</code>, and <code>WebSocket</code>.</p><p>To enable sending and receiving requests with JSON bodies, open a Workspace, enter <code>Feature require: 'Json'</code>, and &quot;Do it&quot;.</p><p>The packages <a href="https://github.com/SeasideSt/Seaside" target="_blank">Seaside</a> and <a href="https://github.com/zeroflag/Teapot" target="_blank">Teapot</a> are often used with other Smalltalk distributions, but they do not support Cuis Smalltalk.</p><p>See the <a href="https://book.seaside.st/book" target="_blank">Seaside Book</a>.</p><h2 id="simple-example" tabindex="-1">Simple Example</h2><p>Here is a very simple use of the WebServer class that can be installed with <code>Feature require: 'WebClient'</code>. Create the class <code>BasicWebServer</code> as follows:</p><pre class="language-smalltalk"><code class="language-smalltalk">Object subclass<span class="token punctuation">:</span> <span class="token symbol">#BasicWebServer</span><br>    instanceVariableNames<span class="token punctuation">:</span> <span class="token string">'server'</span><br>    classVariableNames<span class="token punctuation">:</span> <span class="token string">''</span><br>    poolDictionaries<span class="token punctuation">:</span> <span class="token string">''</span><br>    category<span class="token punctuation">:</span> <span class="token string">'Volkmann'</span></code></pre><p>Add the following instance methods:</p><pre class="language-smalltalk"><code class="language-smalltalk">initialize<br>    server <span class="token operator">:=</span> WebServer <span class="token keyword">new</span><span class="token punctuation">.</span><br>    server addService<span class="token punctuation">:</span> <span class="token string">'/'</span> action<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:req</span> <span class="token punctuation">|</span></span> req send200Response<span class="token punctuation">:</span> <span class="token string">'Hello, World!'</span><span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>Create and start the web server with:</p><pre class="language-smalltalk"><code class="language-smalltalk">server <span class="token operator">:=</span> BasicWebServer <span class="token keyword">new</span><span class="token punctuation">.</span><br>server listenOn<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">.</span></code></pre><p>Browse localhost:3000 to see &quot;Hello, World!&quot;.</p><p>Stop the web server with <code>server destroy</code>.</p><h2 id="sending-http-requests" tabindex="-1">Sending HTTP Requests</h2><p>The <code>WebClient</code> class defines class methods that send HTTP requests. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">res <span class="token operator">:=</span> WebClient httpGet<span class="token punctuation">:</span> <span class="token string">'https://pokeapi.co/api/v2/pokemon/pikachu'</span><span class="token punctuation">.</span></code></pre><p>The variable <code>res</code> above will refer to a <code>WebResponse</code> object. This has many instance variables including:</p><ul><li><code>code</code> - status code such as 200</li><li><code>content</code> - response body</li><li><code>headers</code> - an <code>OrderedCollection</code> of <code>Association</code> objects that describe the HTTP response headers such as <code>content-type</code> with a value like <code>text/html; charset=utf-8</code> or <code>application/json; charset=utf-8</code></li><li><code>protocol</code> - such as the <code>String</code> <code>HTTP/1.1</code></li><li><code>status</code> - such as the <code>String</code> <code>HTTP/1.1 200 OK</code></li><li><code>url</code> - the URL to which the request was sent</li></ul><h2 id="implementing-an-http-server" tabindex="-1">Implementing an HTTP Server</h2><p>To start a web server, create a <code>WebServer</code> instance and send it the <code>listenOn:</code> message. this starts a Smalltalk process called &quot;WebServers's listener process&quot;. To kill it, open a &quot;Process Browser&quot;, select the process, and press cmd-t (Terminate).</p><h2 id="webclientplus-package" tabindex="-1">WebClientPlus package</h2><p>I created the package WebClientPlus to add features to the WebClient package. See the <a href="https://github.com/mvolkmann/Cuis-Smalltalk-WebClientPlus">GitHub repository</a>.</p><p>Let's walk through the classes this package defines and example routes that support CRUD (Create, Read, Update, Delete) operations on dogs.</p><h3 id="webserverplus-class" tabindex="-1">WebServerPlus class</h3><p>The class <code>WebServerPlus</code> is a subclass of <code>WebServer</code>, which is defined in the WebClient package. It adds:</p><ul><li>ability to serve static files with a &quot;Content-Type&quot; header that is appropriate for the file extension</li><li>an easier way to define routes</li><li>ability to access path parameters in route handlers</li><li>ability to access query parameters in route handlers</li></ul><p>To use the <code>WebServerPlus</code> class, define a subclass. The provided example <code>DogWebServer</code> does that. Its <code>initialize</code> instance method creates some initial data in a <code>Dictionary</code> where the keys are increasing integers and the values are <code>Dog</code> objects. It then registers several routes by sending the message <code>method:path:handler:</code> to <code>self</code>. Each route has a handler that is either a block or a method selector.</p><p>The route is passed a <code>WebContext</code> object that holds a <code>WebRequest</code> object and a <code>WebRoute</code> object. Passing a single object to a route handler that encapsulates everything needed to a handle a request is an idea that was copied from the Hono JavaScript framework.</p><pre class="language-smalltalk"><code class="language-smalltalk">initialize<br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">dog1</span> <span class="token variable">dog2</span> <span class="token punctuation">|</span></span><br><br>    <span class="token keyword">super</span> initialize<span class="token punctuation">.</span><br><br>    <span class="token comment">"Create some initial dogs."</span><br>    <span class="token comment">"The Dog class method name:breed: assigns an id."</span><br>    dog1 <span class="token operator">:=</span> Dog name<span class="token punctuation">:</span> <span class="token string">'Comet'</span> breed<span class="token punctuation">:</span> <span class="token string">'Whippet'</span><span class="token punctuation">.</span><br>    dog2 <span class="token operator">:=</span> Dog name<span class="token punctuation">:</span> <span class="token string">'Oscar'</span> breed<span class="token punctuation">:</span> <span class="token string">'German Shorthaired Pointer'</span><span class="token punctuation">.</span><br>    dogDict <span class="token operator">:=</span> Dictionary newFrom<span class="token punctuation">:</span> <span class="token punctuation">{</span><br>        dog1 id <span class="token operator">-</span><span class="token operator">></span> dog1<span class="token punctuation">.</span><br>        dog2 id <span class="token operator">-</span><span class="token operator">></span> dog2<br>    <span class="token punctuation">}</span><span class="token punctuation">.</span><br><br>    <span class="token comment">"Register routes."</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#GET</span> path<span class="token punctuation">:</span> <span class="token string">'/hello'</span> handler<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token block-arguments"><span class="token variable">:context</span> <span class="token punctuation">|</span></span><br>        context request send200Response<span class="token punctuation">:</span> <span class="token string">'Hello, World!'</span><br>    <span class="token punctuation">]</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#GET</span> path<span class="token punctuation">:</span> <span class="token string">'/dog'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#getDogs</span><span class="token punctuation">:</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#HEAD</span> path<span class="token punctuation">:</span> <span class="token string">'/dog'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#headDogs</span><span class="token punctuation">:</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#GET</span> path<span class="token punctuation">:</span> <span class="token string">'/dog/:id'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#getDogAsJson</span><span class="token punctuation">:</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#POST</span> path<span class="token punctuation">:</span> <span class="token string">'/dog'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#createDog</span><span class="token punctuation">:</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#PATCH</span> path<span class="token punctuation">:</span> <span class="token string">'/dog/:id'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#patchDog</span><span class="token punctuation">:</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#PUT</span> path<span class="token punctuation">:</span> <span class="token string">'/dog/:id'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#updateDog</span><span class="token punctuation">:</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#DELETE</span> path<span class="token punctuation">:</span> <span class="token string">'/dog/:id'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#deleteDog</span><span class="token punctuation">:</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> method<span class="token punctuation">:</span> <span class="token symbol">#DELETE</span> path<span class="token punctuation">:</span> <span class="token string">'/dog'</span> handler<span class="token punctuation">:</span> <span class="token symbol">#deleteAllDogs</span><span class="token punctuation">:</span><span class="token punctuation">.</span></code></pre><p>When defining routes where the handler is specified with a method selector, remember to include a colon at the end of the selector.</p><p>The following code is an example of defining route handler. It gets data describing a dog whose id found in a path parameter and it sends a response with a JSON body.</p><pre class="language-smalltalk"><code class="language-smalltalk">getDogAsJson<span class="token punctuation">:</span> aWebContext<br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">dog</span> <span class="token variable">id</span> <span class="token variable">req</span> <span class="token punctuation">|</span></span><br><br>    req <span class="token operator">:=</span> aWebContext request<span class="token punctuation">.</span><br>    id <span class="token operator">:=</span> aWebContext pathParameter<span class="token punctuation">:</span> <span class="token symbol">#id</span><span class="token punctuation">.</span><br>    id <span class="token operator">:=</span> <span class="token punctuation">[</span>id asNumber<span class="token punctuation">]</span> on<span class="token punctuation">:</span> Error do<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token block-arguments"><span class="token variable">:e</span> <span class="token punctuation">|</span></span> <span class="token operator">^</span> req send400Response<span class="token punctuation">:</span> e messageText<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>    dog <span class="token operator">:=</span> dogDict at<span class="token punctuation">:</span> id ifAbsent<span class="token punctuation">:</span> <span class="token keyword">nil</span><span class="token punctuation">.</span><br>    dog<br>        ifNil<span class="token punctuation">:</span> <span class="token punctuation">[</span> req send404Response <span class="token punctuation">]</span><br>        ifNotNil<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>            req<br>                send200Response<span class="token punctuation">:</span> <span class="token punctuation">(</span>Json render<span class="token punctuation">:</span> dog<span class="token punctuation">)</span><br>                contentType<span class="token punctuation">:</span> WebServerPlus jsonContentType<br>        <span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><h3 id="webcontext-class" tabindex="-1">WebContext class</h3><p>The route handler is passed a <code>WebContext</code> object that has the instance variables <code>request</code> (a <code>WebRequest</code> object) and <code>route</code> (a <code>WebRoute</code> object).</p><p>To get the value of a specific path parameter, send <code>#pathParameter:</code> with its name.</p><p>To get a <code>Dictionary</code> of query parameters, send <code>#queryParameters</code>.</p><p>To get the <code>WebRequest</code> object, send <code>#request</code>.</p><p>To get the value of a request header:</p><pre class="language-smalltalk"><code class="language-smalltalk">req <span class="token operator">:=</span> aWebContext request<span class="token punctuation">.</span><br>value <span class="token operator">:=</span> req headerAt<span class="token punctuation">:</span> <span class="token string">'header-name'</span><span class="token punctuation">.</span></code></pre><p>To set the value of a response header, use one of the methods defined in the <code>WebRequest</code> class whose name begins with <code>send*Response:</code> and ends with <code>do:</code>. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">req send200Response<span class="token punctuation">:</span> content do<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:res</span> <span class="token punctuation">|</span></span><br>    res headerAt<span class="token punctuation">:</span> <span class="token string">'X-Demo'</span> put<span class="token punctuation">:</span> <span class="token string">'custom header value'</span><span class="token punctuation">.</span><br><span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>To get the <code>WebRoute</code> object, send <code>#route</code>.</p><h3 id="controlling-the-server" tabindex="-1">Controlling the server</h3><p>To start the example server:</p><pre class="language-smalltalk"><code class="language-smalltalk">server <span class="token operator">:=</span> DogWebServer <span class="token keyword">new</span><span class="token punctuation">.</span><br>server listenOn<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">.</span></code></pre><p>To stop the server, send <code>#destroy</code> to the server object.</p><p>To get the port on which the server is listening, send <code>#listenerPort</code> to the server object.</p><p>To serve static files, send <code>#staticFilePath:</code> to the server object with a <code>String</code> argument that is a relative or absolute file path of the directory where the static files reside. This defaults to serving files from the <code>Cuis-Smalltalk-Dev-UserFiles</code> directory and relative file paths are relative to that directory.</p><h3 id="testing-the-example-server" tabindex="-1">Testing the example server</h3><p>To test the example server, open an SUnit Test Runner, select <code>DogWebServerTests</code>, and click the &quot;Run&quot; button. This will start the server if it is not already running.</p><p>To test the individual routes of the example server, send the requests described below, perhaps using a tool like Postman.</p><p>To get all the dogs, send GET <a href="http://localhost:3000/dog">http://localhost:3000/dog</a>. This returns HTML if the Accept header is &quot;text/html&quot; or JSON otherwise.</p><p>To get a specific dog as JSON, send GET <a href="http://localhost:3000/dog/%7Bid%7D">http://localhost:3000/dog/{id}</a>.</p><p>To get all the dogs and print query parameters in the Transcript, GET <a href="http://localhost:3000/dog?size=medium&amp;color=brindle">http://localhost:3000/dog?size=medium&amp;color=brindle</a>.</p><p>To create a new dog, send POST <a href="http://localhost:3000/dog">http://localhost:3000/dog</a> with JSON body { &quot;name&quot;: &quot;Snoopy&quot;, &quot;breed&quot;: &quot;Beagle&quot; }.</p><p>To update an existing dog, send PUT <a href="http://localhost:3000/dog/%7Bid%7D">http://localhost:3000/dog/{id}</a> with JSON body { &quot;name&quot;: &quot;Fireball&quot;, &quot;breed&quot;: &quot;Greyhound&quot; }.</p><p>To delete an existing dog, send DELETE <a href="http://localhost:3000/dog/%7Bid%7D">http://localhost:3000/dog/{id}</a>.</p><h3 id="webclientplus-class" tabindex="-1">WebClientPlus class</h3><p>The class <code>WebClientPlus</code> is a subclass of <code>WebClient</code> which is defined in the WebClient package. This simplifies sending HTTP requests by providing the following class methods:</p><pre class="language-smalltalk"><code class="language-smalltalk">method<span class="token punctuation">:</span>url<span class="token punctuation">:</span><br>method<span class="token punctuation">:</span>url<span class="token punctuation">:</span>content<span class="token punctuation">:</span><br>method<span class="token punctuation">:</span>url<span class="token punctuation">:</span>headers<span class="token punctuation">:</span><br>method<span class="token punctuation">:</span>url<span class="token punctuation">:</span>headers<span class="token punctuation">:</span>content<span class="token punctuation">:</span></code></pre><p>The first three of these methods all delegate to the last method.</p><p>These methods are used by the <code>DogWebServerTests</code> class to test each of the routes defined in the <code>DogWebServer</code> initialize method.</p></article>