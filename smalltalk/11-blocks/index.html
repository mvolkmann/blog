<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Blocks</h2><aside><nav class="toc"><ol><li><a href="#partial-application">Partial Application</a></li></ol></nav></aside><article><p>A block is closure (anonymous function) that can have parameters and contain many expressions. They are instances of the class <code>BlockClosure</code>. Their execution is deferred until they are sent a message like <code>value</code>.</p><p>The value of the block is the value of its last expression. If a block uses the caret operator (<code>^</code>) to return a value, the containing method will exit and return that value. This is referred to as a &quot;non-local return&quot;. Few programming languages support this. Languages that do include Common Lisp, Prolog, Ruby, Scala, Scheme, and Smalltalk.</p><p>Blocks take zero or more positional arguments, which is something methods cannot do. Parameter names appear at the beginning of a block and each name is preceded by a colon. (This syntax was most likely chosen to simplify parsing because it enables determining whether a block has any parameters without backtracking.) The parameter list is separated from the expressions by a vertical bar.</p><p>Blocks can be saved in variables, passed as arguments to methods and other blocks, returned from methods and other blocks, and can be evaluated multiple times. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">noArgBlock <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><br>singleArgBlock <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token punctuation">|</span></span> a <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><br>multipleArgBlock <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token variable">:b</span> <span class="token punctuation">|</span></span> a <span class="token operator">*</span> b<span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>Blocks support several messages that evaluate the block whose names begin with <code>value</code>. These messages enable providing zero to four arguments. For blocks with more than four parameters, send the message <code>#valueWithArguments:</code> and an array holding all the arguments. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">noArgBlock value<span class="token punctuation">.</span><br>singleArgBlock value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span><br>multiArgBlock value<span class="token punctuation">:</span> <span class="token number">1</span> value<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">.</span><br>multiArgBlock value<span class="token punctuation">:</span> <span class="token number">1</span> value<span class="token punctuation">:</span> <span class="token number">2</span> value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br>multiArgBlock value<span class="token punctuation">:</span> <span class="token number">1</span> value<span class="token punctuation">:</span> <span class="token number">2</span> value<span class="token punctuation">:</span> <span class="token number">3</span> value<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">.</span><br>multiArgBlock valueWithArguments<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span></code></pre><p>A block must be passed the same number of arguments as it has parameters. If a block is passed fewer or more arguments than it accepts, a Debug window will open.</p><p>Blocks can declare and use temporary (local) variables just like a method.</p><p>For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">average <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token variable">:b</span> <span class="token punctuation">|</span></span><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">sum</span> <span class="token punctuation">|</span></span><br>    sum <span class="token operator">:=</span> a <span class="token operator">+</span> b<span class="token punctuation">.</span><br>    sum <span class="token operator">/</span> <span class="token number">2.0</span></code></pre><p>Blocks are closures, meaning that they can access in-scope variables defined outside them. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">n <span class="token operator">:=</span> <span class="token number">19</span><span class="token punctuation">.</span><br>b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token punctuation">|</span></span> a <span class="token operator">+</span> n<span class="token punctuation">]</span><span class="token punctuation">.</span><br>b value<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment">"result is 21"</span></code></pre><p>To use a block as an iteration condition, use the methods <code>whileTrue:</code>, <code>whileFalse:</code>, <code>whileNotNil:</code>, and <code>whileNil:</code> that are defined in the <code>BlockClosure</code> class. Note that these are not methods in the <code>Boolean</code> class.</p><p>For example, the following code prints the integer values 1 through 10 in the Transcript:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">counter</span> <span class="token punctuation">|</span></span><br>counter <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">.</span><br><span class="token punctuation">[</span>counter <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">]</span> whileTrue<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>    counter print<span class="token punctuation">.</span><br>    counter <span class="token operator">:=</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">.</span><br><span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p>A block can call itself if it passes itself in as an argument. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">fact <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:block</span> <span class="token variable">:n</span> <span class="token punctuation">|</span></span><br>    n <span class="token operator">=</span> <span class="token number">1</span><br>        ifTrue<span class="token punctuation">:</span> <span class="token number">1</span><br>        ifFalse<span class="token punctuation">:</span> <span class="token punctuation">[</span>n <span class="token operator">*</span> <span class="token punctuation">(</span>block value<span class="token punctuation">:</span> block value<span class="token punctuation">:</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br><span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>fact value<span class="token punctuation">:</span> fact value<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment">"gives 120"</span></code></pre><h2 id="partial-application" tabindex="-1">Partial Application</h2><p>Partial application is the ability to pass a subset of the arguments required by a function to the function and get a new function that takes the remaining arguments.</p><p>Currying is similar, but only passes a single argument to the function.</p><p>The Smalltalk <code>BlockClosure</code> class supports a limited form of currying, handling up to four arguments. But it does not support partial application.</p><p>The following code demonstrates using currying with the <code>BlockClosure</code> class:</p><pre class="language-smalltalk"><code class="language-smalltalk">add2Numbers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token variable">:b</span> <span class="token punctuation">|</span></span> a <span class="token operator">+</span> b<span class="token punctuation">]</span><span class="token punctuation">.</span><br>add2Numbers value<span class="token punctuation">:</span> <span class="token number">2</span> value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span> <span class="token comment">"5"</span><br>block <span class="token operator">:=</span> add2Numbers withFirstArg<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">.</span><br>block argumentCount<span class="token punctuation">.</span> <span class="token comment">"1"</span><br>block value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span> <span class="token comment">"5"</span><br><br>add3Numbers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token variable">:b</span> <span class="token variable">:c</span> <span class="token punctuation">|</span></span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">]</span><span class="token punctuation">.</span><br>block1 <span class="token operator">:=</span> add3Numbers withFirstArg<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">.</span><br>block2 <span class="token operator">:=</span> block1 withFirstArg<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br><span class="token comment">"The withFirstArg: method always returns a block.<br> Send it the #value message to get the final value."</span><br><span class="token punctuation">(</span>block2 withFirstArg<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">)</span> value<span class="token punctuation">.</span></code></pre><p>We can implement unlimited currying and partial application. The <code>PartialBlock</code> class defined below does this.</p><p>Here are examples of using it:</p><pre class="language-smalltalk"><code class="language-smalltalk">pb <span class="token operator">:=</span> PartialBlock block<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token variable">:b</span> <span class="token punctuation">|</span></span> a <span class="token operator">+</span> b<span class="token punctuation">]</span><span class="token punctuation">.</span><br><span class="token comment">"All arguments supplied."</span><br>pb valueWithArguments<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">"5"</span><br><br><span class="token comment">"Single argument supplied"</span><span class="token punctuation">.</span><br>pb2 <span class="token operator">:=</span> pb value<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">.</span> <span class="token comment">"a new PartialBlock"</span><br>pb2 value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span> <span class="token comment">"5"</span><br><br>pb <span class="token operator">:=</span> PartialBlock block<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:a</span> <span class="token variable">:b</span> <span class="token variable">:c</span> <span class="token punctuation">|</span></span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br><span class="token comment">"Partial arguments supplied."</span><br>pb3 <span class="token operator">:=</span> pb valueWithArguments<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">"a new PartialBlock"</span><br><span class="token comment">"Remaining arguments supplied."</span><br>pb3 valueWithArguments<span class="token punctuation">:</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">"9"</span><span class="token operator">!</span></code></pre><p>Here is the defintion of the <code>PartialBlock</code> class:</p><pre class="language-smalltalk"><code class="language-smalltalk">Object subclass<span class="token punctuation">:</span> <span class="token symbol">#PartialBlock</span><br>    instanceVariableNames<span class="token punctuation">:</span> <span class="token string">'arguments block'</span><br>    classVariableNames<span class="token punctuation">:</span> <span class="token string">''</span><br>    poolDictionaries<span class="token punctuation">:</span> <span class="token string">''</span><br>    category<span class="token punctuation">:</span> <span class="token string">'Volkmann'</span><br><br><span class="token comment">"class method in private category"</span><br>block<span class="token punctuation">:</span> aBlock arguments<span class="token punctuation">:</span> anArray<br>    <span class="token operator">^</span> <span class="token keyword">self</span> <span class="token keyword">new</span><br>        setBlock<span class="token punctuation">:</span> aBlock<br>        arguments<span class="token punctuation">:</span> anArray<br><br><span class="token comment">"class method in instance creation category"</span><br>block<span class="token punctuation">:</span> aBlock<br>    <span class="token operator">^</span> <span class="token keyword">self</span> <span class="token keyword">new</span> setBlock<span class="token punctuation">:</span> aBlock<br><br><span class="token comment">"instance method in private category"</span><br>setBlock<span class="token punctuation">:</span> aBlock<br>    block <span class="token operator">:=</span> aBlock<span class="token punctuation">.</span><br>    arguments <span class="token operator">:=</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br><span class="token comment">"instance method in private category"</span><br>setBlock<span class="token punctuation">:</span> aBlock arguments<span class="token punctuation">:</span> anArray<br>    block <span class="token operator">:=</span> aBlock<span class="token punctuation">.</span><br>    arguments <span class="token operator">:=</span> anArray<br><br><span class="token comment">"instance method in evaluating category"</span><br>value<span class="token punctuation">:</span> anObject<br>    <span class="token operator">^</span> <span class="token keyword">self</span> valueWithArguments<span class="token punctuation">:</span> <span class="token punctuation">{</span> anObject <span class="token punctuation">}</span><br><br><span class="token comment">"instance method in evaluating category"</span><br>valueWithArguments<span class="token punctuation">:</span> anArray<br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">args</span> <span class="token punctuation">|</span></span><br>    <span class="token punctuation">(</span>anArray isMemberOf<span class="token punctuation">:</span> Array<span class="token punctuation">)</span> ifFalse<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>        <span class="token keyword">self</span> error<span class="token punctuation">:</span> <span class="token string">'valueWithArguments: requires an Array'</span><br>    <span class="token punctuation">]</span><span class="token punctuation">.</span><br>    args <span class="token operator">:=</span> arguments <span class="token operator">,</span> anArray<span class="token punctuation">.</span><br>    args logAs<span class="token punctuation">:</span> <span class="token string">'args'</span><span class="token punctuation">.</span><br>    anArray size <span class="token operator">=</span> <span class="token keyword">self</span> argumentCount ifTrue<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>        <span class="token operator">^</span> block valueWithArguments<span class="token punctuation">:</span> args<br>    <span class="token punctuation">]</span><span class="token punctuation">.</span><br>    anArray size <span class="token operator">></span> <span class="token keyword">self</span> argumentCount ifTrue<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>        <span class="token keyword">self</span> error<span class="token punctuation">:</span> <span class="token string">'too many arguments'</span><br>    <span class="token punctuation">]</span><span class="token punctuation">.</span><br>    <span class="token operator">^</span> PartialBlock<br>        block<span class="token punctuation">:</span> block<br>        arguments<span class="token punctuation">:</span> args<br><br><span class="token comment">"instance method in accessing category"</span><br>argumentCount<br>    <span class="token operator">^</span> block argumentCount <span class="token operator">-</span> arguments size</code></pre></article>