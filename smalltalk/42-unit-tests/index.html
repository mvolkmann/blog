<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Unit Tests</h2><aside><nav class="toc"><ol><li><a href="#basics">Basics</a></li><li><a href="#setup-and-teardown">SetUp and TearDown</a></li><li><a href="#logging">Logging</a></li><li><a href="#abstract-base-classes">Abstract Base Classes</a></li></ol></nav></aside><article><h2 id="basics" tabindex="-1">Basics</h2><p>Unit tests verify that the code is working as expected now. They can also be run again in the future to verify that the code has not regressed.</p><p>One way to learn how to write Smalltalk unit tests is to install some tests provided in the Smalltalk distribution. and study them. To do this:</p><ul><li>Open a &quot;File List&quot; from the World menu.</li><li>Navigate to and expand <code>Cuis-Smalltalk-Dev</code> or the name of your version of Cuis.</li><li>Navigate to and expand &quot;Packages&quot; and then &quot;Features&quot;.</li><li>Enter &quot;test&quot; in the filter input in the upper-left.</li><li>Select one of more of the packages whose names begin with &quot;Tests-&quot;.</li><li>Click the &quot;install package&quot; button.</li><li>View the code for those packages in a System Browser.</li></ul><p>Let's walk through the steps to create and run unit tests for a class.</p><p>The class we will test is <code>Pets</code> which is defined by the following:</p><pre class="language-smalltalk"><code class="language-smalltalk">Object subclass<span class="token punctuation">:</span> <span class="token symbol">#Pets</span><br>    instanceVariableNames<span class="token punctuation">:</span> <span class="token string">'dogs cats'</span><br>    classVariableNames<span class="token punctuation">:</span> <span class="token string">''</span><br>    poolDictionaries<span class="token punctuation">:</span> <span class="token string">''</span><br>    category<span class="token punctuation">:</span> <span class="token string">'Volkmann'</span></code></pre><p>The <code>Pets</code> class has the following instance methods:</p><pre class="language-smalltalk"><code class="language-smalltalk">initialize<br>    dogs <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">.</span><br>    cats <span class="token operator">:=</span> <span class="token number">0</span><br><br>addCat<br>    cats <span class="token operator">:=</span> cats <span class="token operator">+</span> <span class="token number">1</span><br><br>addDog<br>    dogs <span class="token operator">:=</span> dogs <span class="token operator">+</span> <span class="token number">1</span><br><br>cats<br>    <span class="token operator">^</span> cats<br><br>dogs<br>    <span class="token operator">^</span> dogs</code></pre><p>The supported assertion methods defined in the <code>TestCase</code> class include:</p><ul><li><p><code>assert:</code></p><p>This asserts that the value of the argument is <code>true</code> or is a block whose value is <code>true</code>.</p></li><li><p><code>assert:changes:</code></p><p>This asserts that value of the <code>changes:</code> block changes after evaluating the <code>assert:</code> block.</p></li><li><p><code>assert:changes:by</code></p><p>This asserts that value of the <code>changes:</code> block changes by <code>by:</code> after evaluating the <code>assert:</code> block.</p></li><li><p><code>assert:changes:from:to</code></p><p>This asserts that value of the <code>changes:</code> block changes from <code>from:</code> to <code>to:</code> after evaluating the <code>assert: block</code>.</p></li><li><p><code>assert:description</code></p><p>This asserts that the value of <code>assert:</code> is <code>true</code>. If not, the test files with the message <code>description:</code>.</p></li><li><p><code>assert:description:resumable</code></p><p>A resumable failure is one that opens a Debugging and allows the code to procced. TODO: Try this passing <code>true</code> for <code>resumable:</code> and see if a failing test opens a Debugger and allows using the &quot;Proceed&quot; button.</p></li><li><p><code>assert:doesNotChange</code></p><p>This is the opposite of <code>assert:changes:</code>. It asserts that value of the <code>doesNotChange:</code> block does not change after evaluating the <code>assert:</code> block.</p></li><li><p><code>assert:equals:</code></p><p>This asserts that the value of <code>assert:</code> (not a block) is equal to <code>equals:</code>.</p></li><li><p><code>assert:includes:</code></p><p>This asserts that the collection <code>assert:</code> includes an element equal to <code>includes:</code>.</p></li><li><p><code>should:raise:</code></p><p>This asserts that evaluating the <code>should:</code> block will raise the exception specified by <code>raise:</code>. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token keyword">self</span> should<span class="token punctuation">:</span> <span class="token punctuation">[</span>Todo unsupportedDBType<span class="token punctuation">]</span> raise<span class="token punctuation">:</span> ActiveRecordError<br><br><span class="token keyword">self</span><br>    should<span class="token punctuation">:</span> <span class="token punctuation">[</span>Todo unsupportedDBType<span class="token punctuation">]</span><br>    raise<span class="token punctuation">:</span> ActiveRecordError<br>    withExceptionDo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:exception</span> <span class="token punctuation">|</span></span><br>        <span class="token keyword">self</span> assert<span class="token punctuation">:</span><br>            <span class="token punctuation">(</span>exception messageText beginsWith<span class="token punctuation">:</span> <span class="token string">'unsupported database type '</span><span class="token punctuation">)</span><br>    <span class="token punctuation">]</span><span class="token punctuation">.</span><br><br><span class="token comment">"This tests the same condition as above, but more concisely."</span><br><span class="token keyword">self</span><br>    should<span class="token punctuation">:</span> <span class="token punctuation">[</span>Todo unsupportedDBType<span class="token punctuation">]</span><br>    raise<span class="token punctuation">:</span> ActiveRecordError<br>    withMessageText<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'unsupported database type '</span><span class="token operator">,</span> Todo dbType<span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre></li></ul><p>For comparing floating point numbers, consider adding the following instance methods to the <code>TestCase</code> class.</p><pre class="language-smalltalk"><code class="language-smalltalk">assert<span class="token punctuation">:</span> aNumber isCloseTo<span class="token punctuation">:</span> anotherNumber<br>    <span class="token comment">"This asserts that the value of `assert:` is<br>    within the default precision (0.0001) of `isCloseTo:`."</span><br><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> aNumber isCloseTo<span class="token punctuation">:</span> anotherNumber<br>        withPrecision<span class="token punctuation">:</span> <span class="token keyword">self</span> defaultPrecision<br><br>assert<span class="token punctuation">:</span> aNumber isCloseTo<span class="token punctuation">:</span> anotherNumber withPrecision<span class="token punctuation">:</span> aPrecision<br>    <span class="token comment">"This asserts that the value of `assert:`<br>    is within `withinPrecision:` of `isCloseTo:`."</span><br><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span><br>        <span class="token punctuation">(</span><span class="token keyword">self</span> is<span class="token punctuation">:</span> aNumber closeTo<span class="token punctuation">:</span> anotherNumber withPrecision<span class="token punctuation">:</span> aPrecision<span class="token punctuation">)</span><br><br>defaultPrecision<br>    <span class="token operator">^</span> <span class="token number">0.0001</span><br><br>is<span class="token punctuation">:</span> aNumber closeTo<span class="token punctuation">:</span> anotherNumber withPrecision<span class="token punctuation">:</span> aPrecision<br>    aNumber <span class="token operator">=</span> <span class="token number">0</span> ifTrue<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">^</span> anotherNumber abs <span class="token operator">&lt;</span> aPrecision<span class="token punctuation">]</span><span class="token punctuation">.</span><br>    <span class="token operator">^</span> <span class="token punctuation">(</span>aNumber <span class="token operator">-</span> anotherNumber<span class="token punctuation">)</span> abs <span class="token operator">&lt;</span><br>      <span class="token punctuation">(</span>aPrecision <span class="token operator">*</span> <span class="token punctuation">(</span>aNumber abs max<span class="token punctuation">:</span> anotherNumber abs<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>To create unit tests for the <code>Pets</code> class:</p><ul><li><p>Create a new class in the same class category as the class to be tested that is a subclass of <code>TestCase</code>. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">TestCase subclass<span class="token punctuation">:</span> <span class="token symbol">#PetsTests</span><br>    instanceVariableNames<span class="token punctuation">:</span> <span class="token string">''</span><br>    classVariableNames<span class="token punctuation">:</span> <span class="token string">''</span><br>    poolDictionaries<span class="token punctuation">:</span> <span class="token string">''</span><br>    category<span class="token punctuation">:</span> <span class="token string">'Volkmann'</span></code></pre></li><li><p>Add the instance message category &quot;testing&quot;.</p></li><li><p>Add instance methods in the &quot;testing&quot; category whose names begin with &quot;test&quot;. Each method can contain any number of assertions. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">testDogs<br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">demo</span> <span class="token punctuation">|</span></span><br>    demo <span class="token operator">:=</span> Pets <span class="token keyword">new</span><span class="token punctuation">.</span><br><br>    <span class="token comment">"dogs is now 0."</span><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo addDog<span class="token punctuation">]</span> changes<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo dogs<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>    <span class="token comment">"dogs is now 1."</span><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo addDog<span class="token punctuation">]</span> changes<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo dogs<span class="token punctuation">]</span> by<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span><br><br>    <span class="token comment">"dogs is now 2."</span><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo addDog<span class="token punctuation">]</span> changes<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo dogs<span class="token punctuation">]</span> from<span class="token punctuation">:</span> <span class="token number">2</span> to<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br><br>    <span class="token comment">"dogs is now 3."</span><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> demo dogs equals<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span><br><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo addCat<span class="token punctuation">]</span> doesNotChange<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo dogs<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>testCats<br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">demo</span> <span class="token punctuation">|</span></span><br>    demo <span class="token operator">:=</span> Pets <span class="token keyword">new</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> <span class="token punctuation">[</span>demo cats <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">]</span> description<span class="token punctuation">:</span> <span class="token string">'no cats'</span><span class="token punctuation">.</span><br><br>testCollections<br>    <span class="token comment">"This test isn't related to the Pets class."</span><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">coll</span> <span class="token punctuation">|</span></span><br>    coll <span class="token operator">:=</span> <span class="token symbol">#</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token number">5</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> coll includes<span class="token punctuation">:</span> <span class="token number">5</span><br><br>testNumbers<br>    <span class="token comment">"This test isn't related to the Pets class."</span><br>    <span class="token keyword">self</span> assert<span class="token punctuation">:</span> Float pi isCloseTo<span class="token punctuation">:</span> <span class="token number">3.14159</span></code></pre></li></ul><p>To run tests, select a test class, test method category, or test method, and press cmd-t (run tests). Alternatively, open a &quot;SUnit Test Runner&quot; from the World menu, select one or more test classes, and click the &quot;Run&quot; button. After adding new test classes, click the &quot;Refresh&quot; button to make the &quot;SUnit Test Runner&quot; window aware of them.</p><p><img alt="Cuis SUnit Test Runner" style="width: 90%" src="/blog/assets/cuis-sunit-test-runner.png?v=1.1.1"></p><h2 id="setup-and-teardown" tabindex="-1">SetUp and TearDown</h2><p>To run code before and after each test method, define the methods <code>setUp</code> and <code>tearDown</code>. Notice the uppercase <code>U</code> in <code>setUp</code> and the uppercase <code>D</code> in <code>tearDown</code>.</p><h2 id="logging" tabindex="-1">Logging</h2><p>By default, the following will be written to the Transcript before each test method runs:</p><pre class="language-text"><code class="language-text">Will run: SomeTestClass>>#someTestMethod</code></pre><p>Also, at the end of each test method run, &quot;finished.&quot; will be written to the Transcript.</p><p>To prevent this output, enter the following in a Workspace and &quot;Do it&quot;.</p><pre class="language-smalltalk"><code class="language-smalltalk">Preferences at<span class="token punctuation">:</span> <span class="token symbol">#transcriptLogVerbose</span> put<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">.</span></code></pre><h2 id="abstract-base-classes" tabindex="-1">Abstract Base Classes</h2><p>It can be useful to define multiple subclasses of <code>TestClass</code> that share a common base class so they can share test methods. For example, the classes in this hierarchy can be created:</p><ul><li>TestCase<ul><li>DatabaseAbstractTests<ul><li>MySQLTests</li><li>PostgresTests</li><li>SQLiteTests</li></ul></li></ul></li></ul><p>In &quot;SUnit Test Runner&quot;, selecting all the database-specific test classes and clicking the &quot;Run&quot; button can run all the test methods in those classes AND the ones defined in <code>DatabaseAbstractTests</code>.</p><p>To make this work it is required to:</p><ol><li>Add the following class method to <code>DatabaseAbstractTests</code>:</li></ol><pre class="language-smalltalk"><code class="language-smalltalk">isAbstract<br>    <span class="token operator">^</span><span class="token boolean">true</span></code></pre><ol><li>Add the following class method to each of its subclasses:</li></ol><pre class="language-smalltalk"><code class="language-smalltalk">isAbstract<br>    <span class="token operator">^</span><span class="token boolean">false</span></code></pre></article>