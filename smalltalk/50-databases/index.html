<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Databases</h2><aside><nav class="toc"><ol><li><a href="#odbc-package-for-cuis-smalltalk">ODBC Package for Cuis Smalltalk</a></li><li><a href="#macos-installs">macOS Installs</a></li><li><a href="#odbc-shared-library">ODBC Shared Library</a></li><li><a href="#database-specific-drivers">Database-specific Drivers</a></li><li><a href="#odbc-data-sources">ODBC Data Sources</a></li><li><a href="#database-access-from-smalltalk">Database Access from Smalltalk</a></li></ol></nav></aside><article><h2 id="odbc-package-for-cuis-smalltalk" tabindex="-1">ODBC Package for Cuis Smalltalk</h2><p>To install Cuis Smalltalk support for ODBC:</p><ul><li>Clone the Git repository at <a href="https://github.com/Cuis-Smalltalk/DatabaseSupport">https://github.com/Cuis-Smalltalk/DatabaseSupport</a> into the same directory where the <code>Cuis-Smalltalk-Dev</code> directory resides.</li><li>Open a Workspace.</li><li>Enter <code>Feature require: 'ODBC'</code> and &quot;Do it&quot;.</li></ul><h2 id="macos-installs" tabindex="-1">macOS Installs</h2><p>The recommended way to install shared libraries in macOS is to use <a href="https://brew.sh" target="_blank">Homebrew</a>.</p><p>If you used Homebrew on an Intel Mac and used &quot;Migration Assistant&quot; to migrate to an Apple Silicon Mac, libraries will not be installed in the correct directory. To verify this, open a terminal and enter <code>brew --prefix</code>. In Apple Silicon Macs this should output <code>/opt/homebrew</code>. If it outputs a different directory, you will need to uninstall Homebrew and reinstall it.</p><p>Uninstalling Homebrew will delete all the libraries you have already installed. Enter <code>brew list</code> before uninstalling Homebrew to get a list of the currently installed packages so they can be reinstalled after Homebrew is installed again.</p><p>To uninstall Homebrew, enter the following command in a terminal:</p><pre class="language-bash"><code class="language-bash">/bin/bash <span class="token parameter variable">-c</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh<span class="token variable">)</span></span>"</span></code></pre><p>To reinstall Homebrew, browse <a href="https://github.com/Homebrew/install">https://github.com/Homebrew/install</a>, click the link &quot;Homebrew's latest GitHub release&quot;, download the file <code>Homebrew-{version}.pkg</code>, and double-click that file to install Homebrew.</p><h2 id="odbc-shared-library" tabindex="-1">ODBC Shared Library</h2><p>The Smalltalk ODBC package requires the <code>libodbc</code> shared library. To install this in macOS, enter <code>brew install unixodbc</code> in a terminal. This also installs the <code>isql</code> command which can be used to test data source names (DSNs). This also installs the <code>odbcinst</code> command which can be used to output information about the ODBC installation.</p><p>If the files <code>isql</code> and <code>odbcinst</code> exist in the <code>/usr/local/bin</code> directory, delete them so the versions installed by Homebrew will be used instead:</p><h2 id="database-specific-drivers" tabindex="-1">Database-specific Drivers</h2><p>Download a database-specific driver for each kind of database being used.</p><p>In macOS, to access PostgreSQL databases, enter <code>brew install psqlodbc</code> in a terminal. This creates the files <code>psqlodbcw.so</code> and <code>psqlodbca.so</code> in the <code>/opt/homebrew/lib</code> direcory. The &quot;w&quot; stands for &quot;wide&quot;, meaning that it supports Unicode characters. The &quot;a&quot; stands for &quot;ASCII&quot;, meaning that it only supports 8-bit characters.</p><p>In macOS, to access SQLite databases, enter <code>brew install sqliteodbc</code> in a terminal. This creates the file <code>/opt/homebrew/lib/libsqlite3odbc.so</code>.</p><h2 id="odbc-data-sources" tabindex="-1">ODBC Data Sources</h2><p>ODBC requires defining data sources in a text file. To determine the directory where this file should reside and the expected file name, enter <code>odbcinst -j</code> in a terminal. Look for &quot;User Data Sources&quot; in the output. This will likely be <code>.odbc.ini</code> in your home directory. Create that file with contents similar to the following, which defines data sources for a PostgreSQL database and a SQLite database.</p><pre class="language-text"><code class="language-text">[PetsDSN]<br>Description = Postgres database for pets<br>Driver = PostgreSQL<br>Database = pets<br><br>[TodosDSN]<br>Description = SQLite database for a Todo app<br>Driver = /opt/homebrew/lib/libsqlite3odbc.so<br>Database = /Users/volkmannm/Documents/dev/lang/smalltalk/Cuis-Smalltalk-Dev-UserFiles/todos.db</code></pre><p>The file <code>/usr/local/etc/odbcinst.ini</code> associates driver names with paths to their shared libraries. In the <code>.odbc.ini</code> file above, the <code>Driver</code> values can be the absolute path to the driver shared library. But using driver names specfied in the <code>odbcinst.ini</code> file avoids needing to repeat the shared library paths for each data source that uses the same driver.</p><p>The following <code>odbcinst.ini</code> file specifies driver shared libraries for PostgreSQL and SQLite.</p><pre class="language-text"><code class="language-text">[PostgreSQL]<br>Description = PostgreSQL ODBC Driver<br>Driver = /opt/homebrew/lib/psqlodbcw.so<br><br>[SQLite]<br>Description = SQLite ODBC Driver<br>Driver = /opt/homebrew/lib/libsqlite3odbc.so</code></pre><p>To list all the registered data sources, enter <code>odbcinst -q -s</code>.</p><p>To view the details of a specific data source, enter <code>odbcinst -q -s -n {name}</code>.</p><p>To verify that the data source defined above can be accessed, enter <code>isql TodosDSN</code> and <code>select * from todos;</code>. Press ctrl-d to exit.</p><h2 id="database-access-from-smalltalk" tabindex="-1">Database Access from Smalltalk</h2><p>In macOS, start a Cuis Smalltalk image by entering <code>./RunCuisOnMacTerminal.sh</code> in a terminal. This script includes the command which is necessary to allow the Smalltalk ODBC package to find ODBC driver shared libraries:</p><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">DYLD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--prefix</span><span class="token variable">)</span></span>/lib:<span class="token variable">${DYLD_LIBRARY_PATH}</span>"</span></code></pre><p>This script also starts a Smalltalk VM using the base image. To use another image, copy and modify this script.</p><p>If an image is started in a way that does not set the <code>DYLD_LIBRARY_PATH</code> environment variable and an attempt is made to open an <code>ODBCConnetion</code>, the error message &quot;External module not found&quot; will be displayed.</p><p>TODO: In macOS, you may be able to set that environment variable in a way that makes it accessible to apps that are started by double-clicking them in the Finder. Try this:</p><pre class="language-bash"><code class="language-bash">launchctl setenv DYLD_LIBRARY_PATH <span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--prefix</span><span class="token variable">)</span></span>/lib</code></pre><p>Open an &quot;Installed Packages&quot; window and verify that the ODBC package is installed. If not, open a Workspace, enter <code>Feature require: 'ODBC'</code>, and &quot;Do it&quot;.</p><p>Open a Browser, select the ODBC class category, select the <code>ODBCConnection</code> class, click the &quot;class&quot; button, and see the sample code in the class method <code>dsn:user:password:query:</code>.</p><p>Enter code similar to the following in a Workspace to verify that your database can be queried:</p><pre class="language-smalltalk"><code class="language-smalltalk">queryString <span class="token operator">:=</span> <span class="token string">'select * from todos'</span><span class="token punctuation">.</span><br>conn <span class="token operator">:=</span> ODBCConnection dsn<span class="token punctuation">:</span> <span class="token string">'TodosDSN'</span> user<span class="token punctuation">:</span> <span class="token string">''</span> password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">.</span><br>stmt <span class="token operator">:=</span> conn query<span class="token punctuation">:</span> queryString<span class="token punctuation">.</span><br>rs <span class="token operator">:=</span> stmt execute<span class="token punctuation">.</span><br><br><span class="token string">'Columns'</span> print<span class="token punctuation">.</span><br>columns <span class="token operator">:=</span> rs columns<span class="token punctuation">.</span><br>columns do<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:column</span> <span class="token punctuation">|</span></span> column name print<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>rs do<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:row</span> <span class="token punctuation">|</span></span> row print<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>conn close<span class="token punctuation">.</span></code></pre></article>