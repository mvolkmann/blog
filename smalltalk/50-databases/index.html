<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Databases</h2><aside><nav class="toc"><ol><li><a href="#odbc-package-for-cuis-smalltalk">ODBC Package for Cuis Smalltalk</a></li><li><a href="#macos-installs">macOS Installs</a></li><li><a href="#odbc-shared-library">ODBC Shared Library</a></li><li><a href="#database-specific-drivers">Database-specific Drivers</a></li><li><a href="#odbc-data-sources">ODBC Data Sources</a></li><li><a href="#database-access-from-smalltalk">Database Access from Smalltalk</a></li></ol></nav></aside><article><h2 id="odbc-package-for-cuis-smalltalk" tabindex="-1">ODBC Package for Cuis Smalltalk</h2><p>To install Cuis Smalltalk support for ODBC:</p><ul><li>Clone the Git repository at <a href="https://github.com/Cuis-Smalltalk/DatabaseSupport">https://github.com/Cuis-Smalltalk/DatabaseSupport</a>.</li><li>Open a &quot;File List&quot; window.</li><li>Navigate to the &quot;DatabaseSupport&quot; directory.</li><li>Select the file <code>ODBC_pck.st</code>.</li><li>Click the &quot;install package&quot; button.</li></ul><p>This adds the class category &quot;ODBC&quot;.</p><p>TODO: Is the reason that this package cannot be installed by evaluating <code>Feature require: 'DatabaseSupport'</code> in a Workspace that the package file is not named <code>DatabaseSupport_pck.st</code>?</p><p>As of October 26, 2024, there is an issue in the <code>ODBCResultSet</code> <code>fetchRow</code> method. Replace the line</p><pre class="language-smalltalk"><code class="language-smalltalk">row <span class="token operator">:=</span> ODBCRow <span class="token keyword">new</span><span class="token punctuation">:</span> columns size<span class="token punctuation">.</span></code></pre><p>with this:</p><pre class="language-smalltalk"><code class="language-smalltalk">row <span class="token operator">:=</span> ODBCRow <span class="token keyword">new</span><span class="token punctuation">.</span></code></pre><h2 id="macos-installs" tabindex="-1">macOS Installs</h2><p>The recommended way to install shared libraries in macOS is to use <a href="https://brew.sh" target="_blank">Homebrew</a>.</p><p>If you used Homebrew on an Intel Mac and used &quot;Migration Assistant&quot; to migrate to an Apple Silicon Mac, libraries will not be installed in the correct directory. To verify this, open a terminal and enter <code>brew --prefix</code>. In Apple Silicon Macs this should output <code>/opt/homebrew</code>. If it outputs a different directory, you will need to uninstall Homebrew and reinstall it.</p><p>Unistalling Homebrew will delete all the libraries you have already installed. Enter <code>brew list</code> before uninstalling Homebrew to get a list of the currently installed packages so they can be reinstalled after Homebrew is installed again.</p><p>To uninstall Homebrew, enter the following command in a terminal:</p><pre class="language-bash"><code class="language-bash">/bin/bash <span class="token parameter variable">-c</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh<span class="token variable">)</span></span>"</span></code></pre><p>To reinstall Homebrew, browse <a href="https://github.com/Homebrew/install">https://github.com/Homebrew/install</a>, click the link &quot;Homebrew's latest GitHub release&quot;, download the file <code>Homebrew-{version}.pkg</code>, and double-click that file to install Homebrew.</p><h2 id="odbc-shared-library" tabindex="-1">ODBC Shared Library</h2><p>The Smalltalk ODBC package requires the <code>libodbc</code> shared library. To install this in macOS, enter <code>brew install unixodbc</code> in a terminal.</p><h2 id="database-specific-drivers" tabindex="-1">Database-specific Drivers</h2><p>Download a database-specific driver for each kind of database being used. In macOS, when using SQLite, enter <code>brew install sqliteodbc</code> in a terminal. Add the following line to each SQLite data source definition:</p><pre class="language-text"><code class="language-text">Driver = /usr/local/lib/libsqlite3odbc.dylib</code></pre><p>TODO: How do you install a driver for PostgreSQL databases?</p><h2 id="odbc-data-sources" tabindex="-1">ODBC Data Sources</h2><p>ODBC requires defining data sources in a text file. To determine the directory where this file should reside and the expected file name, enter <code>odbcinst -j</code> in a terminal. Look for &quot;User Data Sources&quot; in the output. This will likely be <code>.odbc.ini</code> in your home directory. Create that file with contents similar to the following:</p><pre class="language-text"><code class="language-text">[TodoDSN]<br>Description = SQLite database for a Todo app<br>Driver = /usr/local/lib/libsqlite3odbc.dylib<br>Database = /Users/volkmannm/Documents/dev/lang/smalltalk/Cuis-Smalltalk-Dev-UserFiles/todos.db<br>Timeout = 2000</code></pre><p>Verify that the data source defined above can be accessed by entering <code>isql TodoDSN</code> and <code>select * from todos;</code>. Press ctrl-d to exit.</p><h2 id="database-access-from-smalltalk" tabindex="-1">Database Access from Smalltalk</h2><p>Open a Browser, select the ODBC class category, select the <code>ODBCConnection</code> class, click the &quot;class&quot; button, and see the sample code in the class method <code>dsn:user:password:query:</code>.</p><p>Enter code similar to the following in a Workspace to verify that your database can be queried:</p><pre class="language-smalltalk"><code class="language-smalltalk">queryString <span class="token operator">:=</span> <span class="token string">'select * from todos'</span><span class="token punctuation">.</span><br>conn <span class="token operator">:=</span> ODBCConnection dsn<span class="token punctuation">:</span> <span class="token string">'TodoDSN'</span> user<span class="token punctuation">:</span> <span class="token string">''</span> password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">.</span><br>stmt <span class="token operator">:=</span> conn query<span class="token punctuation">:</span> queryString<span class="token punctuation">.</span><br>rs <span class="token operator">:=</span> stmt execute<span class="token punctuation">.</span><br><br><span class="token string">'Columns'</span> print<span class="token punctuation">.</span><br>columns <span class="token operator">:=</span> rs columns<span class="token punctuation">.</span><br>columns do<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:column</span> <span class="token punctuation">|</span></span> column name print<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>rs do<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:row</span> <span class="token punctuation">|</span></span> row print<span class="token punctuation">]</span><span class="token punctuation">.</span><br><br>conn close<span class="token punctuation">.</span></code></pre></article>