<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Deploying</h2><aside><nav class="toc"><ol><li><a href="#running-headless">Running Headless</a></li></ol></nav></aside><article><p>Smalltalk can be used to build command-line, desktop, and web applications. After writing and testing the code in a standard Smalltalk image, it is recommended to create a stripped down version of the image that only contains what is necessary for running the application.</p><p>All developer tools can be removed. For command-line and web applications, everything related to the Morphic GUI framework can be removed.</p><p>Stripping an image is a manual process that is described in the FAST 2024 conference video <a href="https://www.youtube.com/watch?v=MfAclig5XyI" target="_blank">Bootstrap: Creating Minimal Images from Scratch</a>.</p><p>Also see <a href="https://www.youtube.com/watch?v=b3oGOMCjKU8&list=PLu8vLCSA-4hklsvT9W6ruintbdx_K0DYW&index=2&t=53s" target="_blank">Make a standalone click-&amp;-run Smalltalk application for macOS</a>.</p><h3 id="running-headless" tabindex="-1">Running Headless</h3><p>To run Smalltalk programs that are command-line utilities, apps, or servers, use the Smalltalk VM that is bundled inside the macOS app <code>CuisVM.app</code> that is included in the Cuis-Smalltlk-Dev GitHub repository. This is actually a Squeak VM.</p><p>Squeak VMs can also be obtained from <a href="https://github.com/OpenSmalltalk/opensmalltalk-vm" target="_blank">OpenSmalltalk</a>. Under &quot;Releases&quot; on the right side, click &quot;Latest&quot;. Click the proper file for your operating system and processor. For example, <code>squeak.cog.spur_macos64ARMv8.dmg</code>. Double-click the downloaded file to install it.</p><p>To manually download and build a Squeak VM for macOS:</p><ol><li>Open a Terminal and cd to the directory where the VM will be created.</li><li>Enter <code>git clone https://github.com/OpenSmalltalk/opensmalltalk-vm.git</code></li><li>Enter <code>cd opensmalltalk-vm</code></li><li>Enter <code>./scripts/updateSCCSVersions</code></li><li>Enter <code>cd building</code></li><li><code>cd</code> to the appropriate subdirectory for the target OS and processor. For example, <code>macos64ARMv8</code>.</li><li>See the instructions in the file &quot;HowToBuild&quot;.</li><li>Enter <code>cd squeak.coq.spur</code></li><li>Enter <code>./mvm -A</code>. This will run for around 10 minutes and generate an extreme amount of output.</li><li>Enter <code>chmod a+x Squeak.app</code></li><li>Create a symbolic link to the VM that is inside this app by entering <code>ln -s &quot;./Squeak.app/Contents/MacOS/Squeak&quot; squeak-vm</code>.</li></ol><p>To simplify running files containing Smalltalk code from the command line, create a script named &quot;cuis&quot; in a directory that is in your PATH containing the following:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span><br><span class="token comment"># Runs a file containing Smalltalk code in headless mode using Cuis Smalltalk.</span><br><br><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><br>  <span class="token builtin class-name">echo</span> usage: cuis <span class="token punctuation">{</span>file-name<span class="token punctuation">}</span><br>  <span class="token builtin class-name">exit</span> <span class="token number">1</span><br><span class="token keyword">fi</span><br><br><span class="token assign-left variable">CUIS_DIR</span><span class="token operator">=</span><span class="token variable">$SMALLTALK_DIR</span>/Cuis-Smalltalk-Dev<br><span class="token assign-left variable">VM</span><span class="token operator">=</span><span class="token variable">$CUIS_DIR</span>/CuisVM.app/Contents/MacOS/Squeak<br><span class="token assign-left variable">IMAGE</span><span class="token operator">=</span><span class="token variable">$CUIS_DIR</span>/CuisImage/Cuis7.1-6452.image<br><span class="token variable">$VM</span> <span class="token parameter variable">-headless</span> <span class="token variable">$IMAGE</span> <span class="token parameter variable">-s</span> <span class="token variable">$1</span></code></pre><p>Create <code>.st</code> files containing Smalltalk code. For example, the file <code>demo.st</code> could contain the following:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">stdout</span> <span class="token punctuation">|</span></span><br>stdout <span class="token operator">:=</span> StdIOWriteStream<span class="token punctuation">.</span><br>stdout nextPutAll<span class="token punctuation">:</span> <span class="token string">'Hello, World!'</span><span class="token punctuation">;</span> newLine<span class="token punctuation">.</span><br>Smalltalk quit</code></pre><p>To run this, enter <code>cuis demo.st</code>.</p><p>TODO: This was working, but just hangs now. Why?</p><p>To get help on options, cd to your <code>Cuis-Smalltalk-Dev</code> directory and enter the following:</p><pre class="language-bash"><code class="language-bash">./CuisVM.app/Contents/MacOS/Squeak <span class="token parameter variable">-help</span></code></pre><p>For more detail see the <code>SystemDictionary</code> class <code>displayCommandLineUsageOn:</code> class method.</p></article>