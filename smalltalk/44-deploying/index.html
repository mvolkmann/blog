<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Deploying</h2><aside><nav class="toc"><ol><li><a href="#running-headless">Running Headless</a></li><li><a href="#building-a-mac-app">Building a Mac App</a></li><li><a href="#preparing-user-images">Preparing User Images</a></li><li><a href="#steps-to-deploy-todoapp">Steps to Deploy TodoApp</a></li><li><a href="#hilaire-fernandes-approach">Hilaire Fernandes Approach</a></li></ol></nav></aside><article><p>Smalltalk can be used to build command-line, desktop, and web applications. After writing and testing the code in a standard Smalltalk image, it is recommended to create a stripped down version of the image that only contains what is necessary for running the application.</p><p>All developer tools can be removed. For command-line and web applications, everything related to the Morphic GUI framework can be removed.</p><p>Stripping an image is a manual process that is described in the FAST 2024 conference video <a href="https://www.youtube.com/watch?v=MfAclig5XyI" target="_blank">Bootstrap: Creating Minimal Images from Scratch</a>.</p><p>Also see <a href="https://www.youtube.com/watch?v=b3oGOMCjKU8&list=PLu8vLCSA-4hklsvT9W6ruintbdx_K0DYW&index=2&t=53s" target="_blank">Make a standalone click-&amp;-run Smalltalk application for macOS</a>.</p><h3 id="running-headless" tabindex="-1">Running Headless</h3><p>To run Smalltalk programs that are command-line utilities, apps, or servers, use the Smalltalk VM that is bundled inside the macOS app <code>CuisVM.app</code> that is included in the Cuis-Smalltalk-Dev GitHub repository. This is actually a Squeak VM.</p><p>Squeak VMs can also be obtained from <a href="https://github.com/OpenSmalltalk/opensmalltalk-vm" target="_blank">OpenSmalltalk</a>. Under &quot;Releases&quot; on the right side, click &quot;Latest&quot;. Click the proper file for your operating system and processor. For example, <code>squeak.cog.spur_macos64ARMv8.dmg</code>. Double-click the downloaded file to install it.</p><p>To manually download and build a Squeak VM for macOS:</p><ol><li>Open a Terminal and cd to the directory where the VM will be created.</li><li>Enter <code>git clone https://github.com/OpenSmalltalk/opensmalltalk-vm.git</code></li><li>Enter <code>cd opensmalltalk-vm</code></li><li>Enter <code>./scripts/updateSCCSVersions</code></li><li>Enter <code>cd building</code></li><li><code>cd</code> to the appropriate subdirectory for the target OS and processor. For example, <code>macos64ARMv8</code>.</li><li>See the instructions in the file &quot;HowToBuild&quot;.</li><li>Enter <code>cd squeak.coq.spur</code></li><li>Enter <code>./mvm -A</code>. This will run for around 10 minutes and generate an extreme amount of output.</li><li>Enter <code>chmod a+x Squeak.app</code></li><li>Create a symbolic link to the VM that is inside this app by entering <code>ln -s &quot;./Squeak.app/Contents/MacOS/Squeak&quot; squeak-vm</code>.</li></ol><p>To simplify running files containing Smalltalk code from the command line, create a script named &quot;cuis&quot; in a directory that is in your PATH containing the following:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span><br><span class="token comment"># Runs a file containing Smalltalk code in headless mode using Cuis Smalltalk.</span><br><br><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><br>  <span class="token builtin class-name">echo</span> usage: cuis <span class="token punctuation">{</span>file-name<span class="token punctuation">}</span><br>  <span class="token builtin class-name">exit</span> <span class="token number">1</span><br><span class="token keyword">fi</span><br><br><span class="token assign-left variable">CUIS_DIR</span><span class="token operator">=</span><span class="token variable">$SMALLTALK_DIR</span>/Cuis-Smalltalk-Dev<br><span class="token assign-left variable">VM</span><span class="token operator">=</span><span class="token variable">$CUIS_DIR</span>/CuisVM.app/Contents/MacOS/Squeak<br><span class="token assign-left variable">IMAGE</span><span class="token operator">=</span><span class="token variable">$CUIS_DIR</span>/CuisImage/Cuis7.1-6452.image<br><span class="token variable">$VM</span> <span class="token parameter variable">-headless</span> <span class="token variable">$IMAGE</span> <span class="token parameter variable">-s</span> <span class="token variable">$1</span></code></pre><p>Create <code>.st</code> files containing Smalltalk code. For example, the file <code>demo.st</code> could contain the following:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">stdout</span> <span class="token punctuation">|</span></span><br>stdout <span class="token operator">:=</span> StdIOWriteStream<span class="token punctuation">.</span><br>stdout nextPutAll<span class="token punctuation">:</span> <span class="token string">'Hello, World!'</span><span class="token punctuation">;</span> newLine<span class="token punctuation">.</span><br>Smalltalk quit</code></pre><p>To run this, enter <code>cuis demo.st</code>.</p><p>TODO: This was working, but just hangs now. Why?</p><p>To get help on options, cd to your <code>Cuis-Smalltalk-Dev</code> directory and enter the following:</p><pre class="language-bash"><code class="language-bash">./CuisVM.app/Contents/MacOS/Squeak <span class="token parameter variable">-help</span></code></pre><p>For more detail see the <code>SystemDictionary</code> class <code>displayCommandLineUsageOn:</code> class method.</p><h2 id="building-a-mac-app" tabindex="-1">Building a Mac App</h2><p>See <a href="https://www.youtube.com/watch?v=T95k9m5zcX4&amp;list=PLu8vLCSA-4hklsvT9W6ruintbdx_K0DYW&amp;index=4">https://www.youtube.com/watch?v=T95k9m5zcX4&amp;list=PLu8vLCSA-4hklsvT9W6ruintbdx_K0DYW&amp;index=4</a></p><p>See <a href="https://www.youtube.com/watch?v=b3oGOMCjKU8&amp;list=PLu8vLCSA-4hklsvT9W6ruintbdx_K0DYW&amp;index=3">https://www.youtube.com/watch?v=b3oGOMCjKU8&amp;list=PLu8vLCSA-4hklsvT9W6ruintbdx_K0DYW&amp;index=3</a>.</p><p>The steps to create a double-clickable macOS app are:</p><ul><li><p>In the <code>/Applications</code> directory, create the directory structure <code>{app-name}.app/Contents/MacOS</code>.</p></li><li><p>To see what is inside this directory in the Finder, right-click the {app-name}.app file and select &quot;Show Package Contents&quot;.</p></li><li><p>Copy a Squeak VM into this directory. One can be found in Applications/Squeak.app/Contents/MacOS/Squeak.</p></li><li><p>Copy a Squeak image that implements the app into this directory with the name <code>{image-name}.image</code>.</p></li><li><p>Create the following shell script in this directory with the file name <code>{app-name}</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><br><span class="token assign-left variable">DIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">dirname</span> $0<span class="token variable">`</span></span><br><span class="token builtin class-name">exec</span> <span class="token variable">$DIR</span>/Squeak.app/Contents/MacOS/Squeak <span class="token variable">$DIR</span>/<span class="token punctuation">{</span>image-name<span class="token punctuation">}</span>.image<br><span class="token builtin class-name">exit</span> <span class="token number">0</span> <span class="token comment"># TODO: Is this needed?</span></code></pre></li><li><p>Make the shell script executable by running <code>chmod a+x {app-name}</code>.</p></li><li><p>Create the file <code>PkgInfo</code> into this directory containing &quot;APPL????&quot; with no newline character.</p></li><li><p>Add an app icon. Copy an image onto the clipboard. One source for app icons is <a href="https://www.macosicongallery.com">https://www.macosicongallery.com</a>. In the Finder, right-click the app in the Applications directory and select &quot;Get Info&quot;. Click the app icon in the upper-left of the dialog that appears and press cmd-v to paste the new icon.</p></li></ul><h2 id="preparing-user-images" tabindex="-1">Preparing User Images</h2><p>To create images that define applications to be used by non-developers, it is a good idea to disable and remove developer features. This the confusion that can arise when users accidentally open developer features and results in smaller images.</p><p>To hide the taskbar at the bottom of the World:</p><pre class="language-smalltalk"><code class="language-smalltalk">UISupervisor runningWorld hideTaskbar<span class="token punctuation">.</span></code></pre><p>To disable the World menu so clicking on the World background no longer opens it:</p><p>TODO: How is this done?</p><p>Perhaps the way to prevent MessageNotUnderstood and other errors from displaying a debugger window is to execute the following:</p><pre class="language-smalltalk"><code class="language-smalltalk">SystemDictionary removeKey<span class="token punctuation">:</span> <span class="token symbol">#Debugger</span></code></pre><p>The <code>SystemDictionary</code> class method <code>isDevelopmentEnvironmentPresent</code> checks for that key in the <code>SystemDictionary</code>.</p><h2 id="steps-to-deploy-todoapp" tabindex="-1">Steps to Deploy TodoApp</h2><ul><li><p>Open a base image (currently named <code>Cuis7.1-6713.image</code>).</p></li><li><p>Open a Workspace.</p></li><li><p>Enter <code>Feature require: 'UI-MetaProperties'</code> and &quot;Do it&quot; (perhaps not everything installed by this is needed).</p></li><li><p>Enter <code>Feature require: #TodoApp</code> and &quot;Do it&quot;.</p></li><li><p>Enter <code>TodoApp new.</code> and &quot;Do it&quot;.</p></li><li><p>Position and size the &quot;Todo App&quot; window as desired.</p></li><li><p>Close the Workspace and Transcript windows.</p></li><li><p>Remove the taskbar at the bottom.</p><ul><li>cmd-click the taskbar.</li><li>Click the menu halo button and select debug...inspect morph.</li><li>Enter <code>self delete</code> in the bottom pane and &quot;Do it&quot;.</li><li>Close the Inspect window.</li></ul></li><li><p>Open the World menu and pin it so it remains open.</p></li><li><p>Open a Browser.</p></li><li><p>Disable the World menu.</p><p>Use the Browser to modify the <code>WorldMorph</code> <code>getMenu</code> method to contain only the following:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token operator">^</span><span class="token keyword">nil</span></code></pre></li><li><p>Disable Morph halos.</p><p>Use the Browser to modify the <code>Morph</code> <code>mouseButton3Down:localPosition:</code> method so the following line is commented out:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token keyword">self</span> addHalo<span class="token punctuation">:</span> aMouseButtonEvent<span class="token punctuation">.</span></code></pre></li><li><p>Change error handling.</p><p>Display a simple error dialog instead of opening a Debug window. To do this, modify the <code>UnhandledError</code> <code>defaultAction</code> method to contain only the following:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token keyword">self</span> inform<span class="token punctuation">:</span> exception description</code></pre></li><li><p>Close the Browser.</p></li><li><p>Save the image with a new name.</p><ul><li>Click &quot;Save Image as...&quot; in the pinned World menu.</li><li>Enter a name for the app (ex. TodoApp).</li><li>Close the World menu.</li></ul></li><li><p>Quit the VM.</p></li><li><p>Create the following shell script in a file whose name is the app name (ex. <code>todoapp</code>). This assumes that the environment variable <code>SMALLTALK_DIR</code> is set to the path where the <code>Cuis-Smalltalk-Dev</code> local repository resides.</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env zsh</span><br><span class="token assign-left variable">CUIS_DIR</span><span class="token operator">=</span><span class="token variable">$SMALLTALK_DIR</span>/Cuis-Smalltalk-Dev<br><span class="token assign-left variable">VM</span><span class="token operator">=</span><span class="token variable">$CUIS_DIR</span>/CuisVM.app/Contents/MacOS/Squeak<br><span class="token assign-left variable">IMAGE</span><span class="token operator">=</span><span class="token variable">$CUIS_DIR</span>/CuisImage/TodoApp.image<br><span class="token variable">$VM</span> <span class="token variable">$IMAGE</span></code></pre></li><li><p>To run the app, open a Terminal, cd to the directory containing the script, and enter <code>./todoapp</code>.</p></li></ul><h2 id="hilaire-fernandes-approach" tabindex="-1">Hilaire Fernandes Approach</h2><p>This does not remove the World menu.</p><ul><li><p>cd to <code>Cuis-Smalltalk-Dev</code> directory</p></li><li><p>git clone <a href="https://github.com/hilaire/CuisApp.git">https://github.com/hilaire/CuisApp.git</a></p></li><li><p>Modify the value of the <code>cuisVersion</code> variable near the beginning of the file <code>CuisApp/build/makeBundle.sh</code> to something like &quot;7.1-6713&quot;.</p></li><li><p>Build an image for the app by entering <code>./CuisApp/build/makeBundle.sh --build</code> TODO: It's unclear whether this can run in macOS. I get the following:</p><pre class="language-text"><code class="language-text">CuisVM.app/Contents/Linux-x86_64/squeak: line 29: /usr/bin/ldd: No such file or directory<br>CuisVM.app/Contents/Linux-x86_64/squeak: line 29: /bin/fgrep: No such file or directory<br>Error. Could not determine platform's libc path for VM.<br>Try forcing $PLATFORMLIBDIR in CuisVM.app/Contents/Linux-x86_64/squeak, based on LIBC_SO.</code></pre><p>TODO: Where is the new image saved?</p></li><li><p>Create a bundle for macOS by entering <code>./CuisApp/build/makeBundle.sh --package mac</code></p></li><li><p>Create a bundle for Windows by entering <code>./CuisApp/build/makeBundle.sh --package windows</code></p></li><li><p>Create a bundle for GNU Linux by entering <code>./CuisApp/build/makeBundle.sh --package gnulinux</code></p></li></ul><p>To run a bundle ... TODO: Where is it saved?</p></article>