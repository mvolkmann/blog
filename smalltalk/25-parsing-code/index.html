<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Parsing Code</h2><aside></aside><article><p>The <code>Compiler</code> class can compile and evaluate strings of Smalltalk code. For example:</p><pre class="language-smalltalk"><code class="language-smalltalk">Compiler evaluate<span class="token punctuation">:</span> <span class="token string">'1 + 3'</span><span class="token punctuation">.</span> <span class="token comment">"answers 3"</span><br><br>Compiler evaluate<span class="token punctuation">:</span><br>    <span class="token string">'| s | s := Set new. s add: ''red''. s add: ''blue''. s'</span><span class="token punctuation">.</span><br>    <span class="token comment">"answers Set('blue' 'red')"</span></code></pre><p>The class <code>Class</code> inherits from <code>ClassDescription</code> which inherits from <code>Behavior</code>. The <code>Behavior</code> class implements the method <code>sourceCodeAt:</code> which returns a <code>UnicodeString</code> containing the source code for the method with a given selector <code>Symbol</code>. The following code gets a string of source code from the <code>Dictionary</code> <code>#at:put:</code> method:</p><pre class="language-smalltalk"><code class="language-smalltalk">code <span class="token operator">:=</span> Dictionary sourceCodeAt<span class="token punctuation">:</span> <span class="token symbol">#at</span><span class="token punctuation">:</span>put<span class="token punctuation">:</span><span class="token punctuation">.</span></code></pre><p>The <code>code</code> variable will hold the following in a single string:</p><pre class="language-smalltalk"><code class="language-smalltalk">at<span class="token punctuation">:</span> key put<span class="token punctuation">:</span> anObject<br>    <span class="token comment">"Set the value at key to be anObject.<br>    If key is not found, create a new entry for key and set is value to anObject.<br>    If key is found, update the existing association.<br>    Answer anObject."</span><br><br>    <span class="token temporary-variables"><span class="token punctuation">|</span> <span class="token variable">index</span> <span class="token variable">assoc</span> <span class="token punctuation">|</span></span><br>    index <span class="token operator">:=</span> <span class="token keyword">self</span> findElementOrNil<span class="token punctuation">:</span> key<span class="token punctuation">.</span><br>    assoc <span class="token operator">:=</span> array at<span class="token punctuation">:</span> index<span class="token punctuation">.</span><br>    assoc<br>        ifNil<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token keyword">self</span> atNewIndex<span class="token punctuation">:</span> index put<span class="token punctuation">:</span> <span class="token punctuation">(</span>Association key<span class="token punctuation">:</span> key value<span class="token punctuation">:</span> anObject<span class="token punctuation">)</span> <span class="token punctuation">]</span><br>        ifNotNil<span class="token punctuation">:</span> <span class="token punctuation">[</span> assoc value<span class="token punctuation">:</span> anObject <span class="token punctuation">]</span><span class="token punctuation">.</span><br>    <span class="token operator">^</span> anObject</code></pre><p>The <code>Parser</code> class parses a string of source code that describes a method that is associated with a given class. It returns a <code>MethodNode</code> object that is the root of the parse tree (a.k.a abstract syntax tree). The following code parses the code from the previous example:</p><pre class="language-smalltalk"><code class="language-smalltalk">parser <span class="token operator">:=</span> Parser <span class="token keyword">new</span><span class="token punctuation">.</span><br>methodNode <span class="token operator">:=</span> parser parse<span class="token punctuation">:</span> code class<span class="token punctuation">:</span> Dictionary<span class="token punctuation">.</span></code></pre><p>The following code gets the names of the arguments that follow the keywords:</p><pre class="language-smalltalk"><code class="language-smalltalk">argNodes <span class="token operator">:=</span> methodNode arguments<span class="token punctuation">.</span><br>argNames <span class="token operator">:=</span> argNodes collect<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token block-arguments"><span class="token variable">:node</span> <span class="token punctuation">|</span></span> node name<span class="token punctuation">]</span><span class="token punctuation">.</span></code></pre><p><code>MethodNode</code> objects include the following instance variables and more:</p><ul><li><code>block</code> - a <code>BlockNode</code> object (described below)</li><li><code>comment</code> - an <code>OrderedCollection</code> of <code>UnicodeString</code> objects</li><li><code>properties</code> - an <code>AdditionalMethodState</code> object (has <code>selector</code> instance variable)</li><li><code>sourceText</code> - a <code>UnicodeString</code> containing all the code for the method</li><li><code>temporaries</code> - an <code>OrderedCollection</code> of <code>TempVariableNode</code> objects</li></ul><p><code>BlockNode</code> objects include the following instance varaibles:</p><ul><li><code>arguments</code> - an <code>Array</code> of <code>TempVariableNode</code> instances</li><li><code>returns</code> - a <code>Boolean</code> that indicates whether the method explicitly returns using <code>^</code> which exits the containing method</li><li><code>statements</code> - an <code>OrderedCollection</code> of nodes</li></ul><p>The class <code>ParseNode</code> is the superclass of all nodes produced by the <code>Parser</code>. This class is provided in Cuis and Squeak Smalltalk, but not in Pharo. It provides the instance variable <code>comment</code> to all its subclasses.</p><p>The subclasese of <code>ParseNode</code> include:</p><ul><li><p><code>AssignmentNode</code> - assignment to a variable</p><p>The children are <code>variable</code> and <code>value</code>.</p></li><li><p><code>BacktickNode</code> - compound literal evaluated by compiler (surrounded by backticks)</p><p>The only child is <code>expression</code>.</p><p>This class is specific to Cuis Smalltalk.</p></li><li><p><code>BraceNode</code> - dynamic array with the syntax <code>{expr1. expr2. expr3}</code></p><p>The children are in <code>elements</code>.</p></li><li><p><code>CascadeNode</code> - cascade of messages using <code>;</code></p><p>The children are in <code>receiver</code> and <code>messages</code>.</p></li><li><p><code>CodeNode</code> - abstract class that provides shared methods to subclasses</p><p>This class is specific to Cuis Smalltalk, but it's subclasses <code>BlockNode</code> and <code>MethodNode</code> are also provided in Squeak Smalltalk.</p><ul><li><p><code>BlockNode</code> - block containing expressions to be evaluated later</p><p>The children are <code>arguments</code> and <code>statements</code>.</p></li><li><p><code>MethodNode</code> - method definition</p><p>The children are <code>temporaries</code>, <code>arguments</code>, and <code>block</code>.</p></li></ul></li><li><p><code>LeafNode</code> - abstract class that provides shared methods to subclasses</p><ul><li><p><code>LiteralNode</code> - literal number or string</p></li><li><p><code>SelectorNode</code> - message selector</p><p>The <code>key</code> instance variable holds the selector <code>String</code>.</p><ul><li><code>SpecialSelectorNode</code> - special message selectors that have their own bytecode for efficiency</li></ul></li><li><p><code>VariableNode</code> - variable of any kind</p><p>This has a <code>name</code> instance varaible.</p><ul><li><p><code>InstanceVariableNode</code> - instance variable</p><ul><li><code>MaybeContextInstanceVariableNode</code> - performance optimization</li></ul></li><li><p><code>LiteralVariableNode</code> - constants and global identifiers</p><p>These include class names, global variables, and pool dictionary entries.</p></li><li><p><code>TempVariableNode</code> - temporary (local) variable</p><ul><li><code>RemoteTempVariableNode</code> - collection of temporary variables shared between closures</li></ul></li><li><p><code>UndeclaredVariableNode</code> - undeclared variable, perhaps used in a &quot;Do it&quot;</p></li></ul></li><li><p><code>MessageNode</code> - message sent to a receiver with optional arguments</p><p>The children are <code>receiver</code>, <code>selector</code>, and <code>arguments</code>.</p><p>The <code>precedence</code> instance variable is set to 1 for unary messages, 2 for binary messages, and 3 for keyword messages.</p><ul><li><code>MessageAsTempNode</code></li></ul></li></ul></li><li><p><code>NewArrayNode</code> - created by the <code>genPushNewArray:</code> opcode optimization</p></li><li><p><code>ReturnNode</code> - caret return of a specified value or implicit return of <code>self</code></p><p>This has an <code>expr</code> instance variable that holds the expression whose value is returned.</p></li><li><p><code>TemporariesDeclarationNode</code> - temporary variable declarations (plural) found at the start of a method or block</p><p>This class is specific to Cuis Smalltalk.</p></li><li><p><code>TemporaryDeclarationNode</code> - temporary variable declaration (singular) found at the start of a method or block</p><p>This class is specific to Cuis Smalltalk.</p></li></ul><p>Squeak Smalltalk adds the <code>ParseNode</code> subclasses <code>CommentNode</code>, <code>FieldNode</code>, and <code>FutureNode</code> which are not present in Cuis Smalltalk.</p><p>For an example of parsing Smalltalk code and printing a representation of the parse tree, see the GitHub repository <a href="https://github.com/mvolkmann/Cuis-Smalltalk-CodeParse" target="_blank">CodeParse</a>.</p></article>