<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Saving Code</h2><aside><nav class="toc"><ol><li><a href="#fileout-and-filein">fileOut and fileIn</a></li><li><a href="#packages">Packages</a></li><li><a href="#pre-and-post-install-actions">Pre and Post Install Actions</a></li><li><a href="#restoring-changes-after-crash">Restoring Changes After Crash</a></li></ol></nav></aside><article><p>One way to save code that you develop is to save the image. While this works, it is not recommended for two main reasons.</p><ol><li><p>Corrupt images</p><p>On rare occassions, changes make to an image can render it unusable. If this happens and the code you developed has not be saved elsewhere, it could lost.</p></li><li><p>Code Sharing</p><p>The best ways to share Smalltalk code you have written are to create a &quot;fileOut&quot; or a package. Other developers can &quot;fileIn&quot; the fileOuts you create or they can install packages you create. Both are options described below.</p></li></ol><h2 id="fileout-and-filein" tabindex="-1">fileOut and fileIn</h2><p>&quot;fileOut&quot; can be used to save any of the following in a <code>.st</code> text file:</p><ul><li>a single method</li><li>all the methods in a single method category</li><li>a single class and all its methods</li><li>a single class category</li></ul><p>To create a fileOut:</p><ul><li>Open a System Browser.</li><li>Select a class category, class, method category, or method in the top row of panes.</li><li>Right-click and select &quot;fileOut&quot;.</li></ul><p>The file will be saved in <code>{distribution-name}-UserFiles/FileOuts/{name}.st</code>.</p><p>These files use the bang-separated &quot;chunked format&quot; which is human-readable. Package files with the extension <code>.pck.st</code> also use the chunked format. Each chunk is delimited by exclamation marks. A chunk can contain:</p><ul><li>a &quot;From&quot; line the gives the version of Smalltalk that create the file and the date and time at which the file was created</li><li>a &quot;classDefinition&quot; that associates a class or metaclass with a class category</li><li>a &quot;subclass: message send that creates a class</li><li>a &quot;methodsFor&quot; which states that the method definitions that follow are in a given method category</li><li>a method definition</li><li>a message send that creates an object that should exist in the environment</li><li>a message send that executes code for its side effects</li></ul><p>The following is an example fileOut for a <code>Dog</code> class:</p><pre class="language-smalltalk"><code class="language-smalltalk"><span class="token string">'From Cuis7.1 [latest update: #6464] on 12 June 2024 at 10:47:55 am'</span><span class="token operator">!</span><br><span class="token operator">!</span>classDefinition<span class="token punctuation">:</span> <span class="token symbol">#Dog</span> category<span class="token punctuation">:</span> <span class="token symbol">#Volkmann</span><span class="token operator">!</span><br>Object subclass<span class="token punctuation">:</span> <span class="token symbol">#Dog</span><br>    instanceVariableNames<span class="token punctuation">:</span> <span class="token string">'breed name'</span><br>    classVariableNames<span class="token punctuation">:</span> <span class="token string">'Count'</span><br>    poolDictionaries<span class="token punctuation">:</span> <span class="token string">''</span><br>    category<span class="token punctuation">:</span> <span class="token string">'Volkmann'</span><span class="token operator">!</span><br><br><span class="token operator">!</span>Dog methodsFor<span class="token punctuation">:</span> <span class="token string">'initialization'</span> stamp<span class="token punctuation">:</span> <span class="token string">'RMV 6/12/2024 10:47:34'</span><span class="token operator">!</span><br>initialize<br>    <span class="token keyword">super</span> initialize<span class="token punctuation">.</span><br>    Count <span class="token operator">:=</span> Count <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">!</span> <span class="token operator">!</span><br><br><span class="token operator">!</span>Dog methodsFor<span class="token punctuation">:</span> <span class="token string">'initialization'</span> stamp<span class="token punctuation">:</span> <span class="token string">'RMV 6/11/2024 20:00:43'</span><span class="token operator">!</span><br>setName<span class="token punctuation">:</span> aName breed<span class="token punctuation">:</span> aBreed<br>    name <span class="token operator">:=</span> aName<span class="token punctuation">.</span><br>    breed <span class="token operator">:=</span> aBreed<span class="token operator">!</span> <span class="token operator">!</span><br><br><br><span class="token operator">!</span>Dog methodsFor<span class="token punctuation">:</span> <span class="token string">'accessing'</span> stamp<span class="token punctuation">:</span> <span class="token string">'RMV 6/11/2024 20:03:03'</span><span class="token operator">!</span><br>breed<br>    <span class="token operator">^</span>breed<span class="token operator">!</span> <span class="token operator">!</span><br><br><span class="token operator">!</span>Dog methodsFor<span class="token punctuation">:</span> <span class="token string">'accessing'</span> stamp<span class="token punctuation">:</span> <span class="token string">'RMV 6/11/2024 20:02:57'</span><span class="token operator">!</span><br>name<br>    <span class="token operator">^</span>name<span class="token operator">!</span> <span class="token operator">!</span><br><br><span class="token comment">"-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- "</span><span class="token operator">!</span><br><br><span class="token operator">!</span>classDefinition<span class="token punctuation">:</span> <span class="token string">'Dog class'</span> category<span class="token punctuation">:</span> <span class="token symbol">#Volkmann</span><span class="token operator">!</span><br>Dog class<br>    instanceVariableNames<span class="token punctuation">:</span> <span class="token string">''</span><span class="token operator">!</span><br><br><span class="token operator">!</span>Dog class methodsFor<span class="token punctuation">:</span> <span class="token string">'accessing'</span> stamp<span class="token punctuation">:</span> <span class="token string">'RMV 6/12/2024 09:45:13'</span><span class="token operator">!</span><br>count<br>    <span class="token operator">^</span>Count<span class="token operator">!</span> <span class="token operator">!</span><br><br><br><span class="token operator">!</span>Dog class methodsFor<span class="token punctuation">:</span> <span class="token string">'initialization'</span> stamp<span class="token punctuation">:</span> <span class="token string">'RMV 6/12/2024 10:41:45'</span><span class="token operator">!</span><br>initialize<br>    <span class="token comment">"This must be explicitly called with Dog initialize."</span><br>    Count <span class="token operator">:=</span> <span class="token number">0</span><span class="token operator">!</span> <span class="token operator">!</span><br><br><span class="token operator">!</span>Dog class methodsFor<span class="token punctuation">:</span> <span class="token string">'initialization'</span> stamp<span class="token punctuation">:</span> <span class="token string">'RMV 6/12/2024 10:43:52'</span><span class="token operator">!</span><br>name<span class="token punctuation">:</span> aName breed<span class="token punctuation">:</span> aBreed<br>    <span class="token operator">^</span><span class="token keyword">self</span> <span class="token keyword">new</span> setName<span class="token punctuation">:</span> aName breed<span class="token punctuation">:</span> aBreed<span class="token operator">!</span> <span class="token operator">!</span><br><br><br>Dog initialize<span class="token operator">!</span></code></pre><p>To read a fileOut into the current image:</p><ul><li>Open the World menu.</li><li>Select &quot;Open...File List&quot;.</li><li>Locate and select a <code>.st</code> file created by a fileOut.</li><li>Right-click and select &quot;fileIn&quot;.</li><li>Enter your initials and then your name for tracking who performed the fileIn.</li></ul><p>All the class categories, classes, method categories, and methods defined in the fileOut will now be available in the current image.</p><h2 id="packages" tabindex="-1">Packages</h2><p>Cuis Smalltalk supports the ability to save code outside an image file as a &quot;package&quot; and load the package into running images. This is an alternative to <a href="https://wiki.squeak.org/squeak/1287" target="_blank">Monticello</a> which is used in Squeak and Pharo.</p><p>Packages are collections of Smalltalk code stored in files with a <code>.pck.st</code> file. The code consists of complete class definitions and methods added to classes in other categories.</p><p>When a package file is installed, if it defines new classes, they are placed in a new class category whose name is the package name. The new class category is visible in System Browsers. If the package defines methods to be added to a class in another class categories, a new method category name is added to the class whose name is an asterisk followed by the package name and an optional suffix (for example, <code>*Volkmann-printing</code>).</p><p>Package names are used as prefixes on class and method categories names. Package name abbreviations are often used as prefixes on class names.</p><p>The GitHub account &quot;Cuis-Smalltalk&quot; provides many package repositories, 32 as of June 2024. Sadly the documentation included in the <code>README.md</code> files of these packages is quite sparse. These repositories must be cloned in order to install them.</p><p>For additional packages, search GitHub for repositories whose names begin with &quot;Cuis-Smalltalk-&quot;. The names of your GitHub repositories for reusable Smalltalk code should also begin this way so others can easily find and install them.</p><p>There are three ways to install a package.</p><ol><li>Drag a package file onto the World and select &quot;install package&quot;.</li><li>Open a File List, locate a package file, select it, and click the &quot;install package&quot; button.</li><li>Open a Workspace, enter the command <code>Feature require: '{package-name}'</code>, and press cmd-d (Do it). This option only works if the package is in the same directory as the image file that is loaded.</li></ol><p>Installing a package also installs all of its dependencies.</p><p>Let's learn where the <code>Feature require:</code> method searches for packages.</p><ol><li><p>Browse the <code>Feature</code> class.</p></li><li><p>Click the <code>require</code> method on the class side.</p></li><li><p>Note that this sends the <code>#name:</code> message to the <code>FeatureRequirement</code> class to create an instance and then sends it the <code>#require</code> message.</p></li><li><p>Select the <code>FeatureRequirement</code> class.</p></li><li><p>Select the <code>require</code> method on the instance side.</p></li><li><p>Note that this sends the <code>#requireUnlessIn:main:requiringFeature:allRequiringFeatures:</code> message to <code>self</code>.</p></li><li><p>Select that method on the instance side.</p></li><li><p>Note that this sends the <code>#findPackageFileAsReqOf:</code> message to <code>self</code>.</p></li><li><p>Select that method on the instance side.</p></li><li><p>Note that this sends the <code>#placesToLookForPackagesDo:</code> message to <code>self</code>.</p></li><li><p>Select that method on the instance side.</p></li><li><p>Note the following comments in this code:</p><ul><li><p>&quot;Look inside my own folder&quot;</p><p>This is represented by the instance variable <code>pathName</code> which is <code>nil</code> by default. To set it, send <code>@pathName:</code> to</p></li><li><p>&quot;Look in codePackageFile folder&quot;</p><p>This is represented by the instance variable <code>codePackageName</code> which is <code>nil</code> for me.</p></li><li><p>&quot;Packages that come included with Cuis&quot;</p><p>These can be found under the <code>Cuis-Smalltalk-Dev/Packages</code> directory.</p></li><li><p>&quot;Packages created by user&quot;</p><p>These can be found under the <code>Cuis-Smalltalk-Dev-UserFiles/NewPackages</code> directory.</p></li><li><p>&quot;Packages in other folders or repos in the project directory&quot;</p><p>These can be found under the parent directory of the <code>Cuis-Smalltalk-Dev</code> directory.</p></li></ul></li></ol><p>See the earlier section &quot;Installed Packages Window&quot; for more details on working with packages.</p><p>By default packages are saved in a directory that is relative to the directory that holds the current image file. To determine this:</p><ul><li>Open a Workspace.</li><li>Enter <code>Smalltalk imagePath.</code></li><li>Press cmd-p to &quot;Print it&quot;.</li></ul><p>Determine the name and location of the directory that holds your Cuis Smalltalk installation. For me this is <code>~/Documents/dev/lang/smalltalk/Cuis-Smalltalk-Dev</code>. My base image file is in the subdirectory <code>CuisImage</code> in the file <code>Cuis7.1-6367.image</code>.</p><p>By default, packages I create go in a similar path which is <code>~/Documents/dev/lang/smalltalk/Cuis-Smalltalk-Dev-UserFiles/NewPackages/{package-name}.pck.st</code>.</p><p>To define new classes and save them in your package:</p><ul><li>Add a class category whose name is the same as the new package name.</li><li>Add classes in the new class category.</li><li>Add methods to the new classes in any method category.</li><li>Open an &quot;Installed Packages&quot; window and select the new package.</li><li>Click the &quot;Save&quot; button.</li></ul><p>To add or override methods in existing classes and save the changes in your package:</p><ul><li>Add a message category to an existing class whose name is an asterisk followed by the new package name. For example, I used &quot;*Volkmann&quot;. This can optionally be followed by &quot;-&quot; and a meaningful method category name. For example, &quot;*Volkmann-geometry&quot;.</li><li>Add new methods to the existing class in the new message category.</li><li>Open an &quot;Installed Packages&quot; window and select the package. An asterisk before the name indicates that it has unsaved changes.</li><li>Click the &quot;Save&quot; button.</li></ul><p>To verify that all this worked:</p><ul><li>Open the World menu and select &quot;Quit without saving&quot; so the changes are not saved in the current image.</li><li>Restart Cuis Smalltalk with the same image.</li><li>Verify that the classes and methods that were added are not present.</li><li>Install the package.</li><li>Verify that the classes and methods that were saved in the package are now present.</li></ul><p>There is no provided way to uninstall a package. TODO: Is this really true? The only way to remove it from the image is to start with a fresh image and only install the desired packages.</p><p>TODO: What does the &quot;delete/merge&quot; button in the &quot;Installed Packages&quot; window do? TODO: It does not uninstall the selected package or delete the file that defines it.</p><p>It is recommended to save packages in GitHub. For details on doing this, open the World menu and select Help...Using GitHub to host Cuis packages.</p><h2 id="pre-and-post-install-actions" tabindex="-1">Pre and Post Install Actions</h2><p>To register code to be executed after a package in installed, add the class method <code>initialize</code> to any classes in the package. Each of those will be executed after the package is installed.</p><p>For example, the class <code>Todo</code> in the the package &quot;TodoApp&quot; requires that the font &quot;KurintoSans&quot; be installed so it can display the wastebasket Unicode character. The following class method <code>initialize</code> does that:</p><pre class="language-smalltalk"><code class="language-smalltalk">initialize<br>    TrueTypeFontFamily readAllTrueTypeFontsIn<span class="token punctuation">:</span><br>        <span class="token punctuation">(</span>DirectoryEntry trueTypeFontsDirectory <span class="token operator">/</span> <span class="token string">'KurintoSans'</span><span class="token punctuation">)</span></code></pre><p>Another option that registers code to be executed before and/or after a given package (such as &quot;Foo&quot;) is installed is the following steps:</p><ul><li>Create a subclass of <code>CodePackage</code> named <code>FooPackage</code>.</li><li>Create the class methods <code>prePackageInstall</code> and/or <code>postPackageInstall</code>.</li><li>Add the code to be execute in those methods.</li><li>Save the changes to the package.</li><li>Uninstall the package by opening an &quot;Installed Packages&quot; window, selecting the package, and clicking the &quot;Delete/Merge&quot; button.</li><li>Restart the VM.</li><li>Open a Workspace.</li><li>Enter <code>Feature require: 'Foo'</code> and &quot;Do it&quot;.</li></ul><p>For example, the package &quot;TodoApp&quot; requires that the font &quot;KurintoSans&quot; be installed. The following <code>prePackageInstall</code> class method does this:</p><pre class="language-smalltalk"><code class="language-smalltalk">prePackageInstall<br>    TrueTypeFontFamily readAllTrueTypeFontsIn<span class="token punctuation">:</span><br>        <span class="token punctuation">(</span>DirectoryEntry trueTypeFontsDirectory <span class="token operator">/</span> <span class="token string">'KurintoSans'</span><span class="token punctuation">)</span></code></pre><h2 id="restoring-changes-after-crash" tabindex="-1">Restoring Changes After Crash</h2><p>If the VM crashes before changes are saved by a fileOut or saving in a package, they can still be recovered with the following steps. This does not include changes to the contents of Workspace windows.</p><ol><li>Restart the image.</li><li>Open the World menu.</li><li>Select Changes ... Recently logged Changes...</li><li>In the popup that appears, select a line with a date/time that indicates how far back in the history to examine.</li><li>In the &quot;Recent changes&quot; window that appears, click a row in the top panel to see the associated changes. They are ordered from the earliest to the most recent change.</li><li>Right-click in the top pane to get a menu containing many options for filtering the list of changes. For example, &quot;select new methods&quot; will select all the changes that add a new method.</li><li>Click one of the buttons ending in &quot;Diffs&quot; to view the changes in various ways. These include &quot;lineDiffs&quot;, &quot;wordDiffs&quot;, &quot;linePrettyDiffs&quot;, and &quot;wordPrettyDiffs&quot;. The &quot;Pretty&quot; options compare the old and new code after formatting each. The &quot;linePrettyDiffs&quot; seems to be the most useful.</li><li>For each change to be restored, right-click the row in the top panel and select &quot;fileIn selections&quot;. Alternatively, click the &quot;select all&quot; button and then the &quot;fileIn selections&quot; button to restore all the changes.</li></ol><p><img alt="Cuis Recent Changes window" style="width: 100%" src="/blog/assets/cuis-recent-changes.png?v=1.1.1"></p><p>TODO: When are unrestored changes deleted, if ever?</p><p>There is a option (disabled by default) to be automatically prompted to restore logged changes when the image is started. To enable it, enter the following in a Workspace and &quot;Do it&quot;:</p><pre class="language-smalltalk"><code class="language-smalltalk">Preferences at<span class="token punctuation">:</span> <span class="token symbol">#checkLostChangesOnStartUp</span> put<span class="token punctuation">:</span> <span class="token boolean">true</span></code></pre><p>With this enabled, if the VM crashes before changes are saved, it will display the following popup when restarted:</p><p><img alt="Cuis recover last changes" style="width: 50%" src="/blog/assets/cuis-recover-last-changes.png?v=1.1.1"></p><p>TODO: This DOES NOT WORK in macOS!</p><p>For more detail, see <a href="https://cuis-smalltalk.github.io/TheCuisBook/The-Change-Log.html" target="_blank">The Change Log</a>.</p></article>