<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Content Security Policy (CSP)</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#directives">Directives</a></li><li><a href="#example-header-values">Example Header Values</a></li><li><a href="#reporting">Reporting</a></li></ol></nav></aside><article><style>img {
    border: 1px solid gray;
  }</style><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">Content Security Policy</a> provides the ability to detect and prevent some types of attacks, including Cross-Site Scripting (XSS) and data injection. It can also report attack attempts.</p><p>There are two ways to enable CSP.</p><ol><li>&quot;Content-Security-Policy&quot; HTTP response header</li><li>HTML <code>meta</code> tag</li></ol><p>It both cases, the policy is specified by a list of directives separated by semicolons. Each directive is specified with a name and one or more values, all separated by a space. The values are allowed URL patterns or the keyword &quot;self&quot;.</p><p>The following <code>meta</code> tag is an example.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span><br>  <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span><br>  <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default-src 'self'; img-src https://*; script-src 'none';<span class="token punctuation">"</span></span><br><span class="token punctuation">/></span></span></code></pre><p>Some features can only be enabled in an HTTP header. Which?</p><p>can only execute scripts downloaded from approved domains using approved protocols (ex. HTTPS)</p><h2 id="directives" tabindex="-1">Directives</h2><p>Commonly used directives include:</p><ul><li><code>default-src</code>: restricts access to all kinds of resources</li><li><code>connect-src</code>: restricts use of <a>, fetch, XMLHttpRequest, WebSocket, and more</a></li><li><code>font-src</code>: restricts @font-face CSS at-rule</li><li><code>form-action</code>: restricts URLs used in <code>form</code> element <code>action</code> attributes</li><li><code>img-src</code>: restricts <code>&lt;img&gt;</code> elements</li><li><code>media-src</code>: restricts <code>&lt;audio&gt;</code> and <code>&lt;video&gt;</code> elements</li><li><code>object-src</code>: restricts <code>&lt;object&gt;</code> and <code>&lt;embed&gt;</code> elements</li><li><code>report-to</code>: specifies the URL where violation reports are sent (using a POST request?)</li><li><code>script-src-attr</code>: restricts sources for JavaScript inline event handlers like <code>onclick</code></li><li><code>script-src-elem</code>: restricts <code>&lt;script&gt;</code> elements</li><li><code>script-src</code>: compiles the previous two in one directive</li><li><code>worker-src</code>: restricts Worker, SharedWorker, and ServiceWorker scripts</li></ul><p>It is recommended to make <code>default-src</code> very restrictive (maybe just &quot;self&quot;) and used more specific directives to open access for specific kinds of resources.</p><h2 id="example-header-values" tabindex="-1">Example Header Values</h2><ul><li><p><code>Content-Security-Policy: default-src 'self' demo.com *.demo.com</code></p><p>This specifies that by default all resources must come from the same domain ss this request OR from <code>demo.com</code> or any domain that ends in <code>demo.com</code>.</p></li><li><p><code>Content-Security-Policy: default-src 'self'; img-src *; media-src my-media.org; script-src https://coder.io</code></p><p>This specifies that images can come from anywhere, audio and video can come from <code>my-media.org</code>, scripts can come from <code>coder.io</code> only using HTTPS, and all other resources must come from the same domain as this request. <code>default-src</code> specifies the policy for all resource types unless policies for specific resource types are also provided.</p></li></ul><h2 id="reporting" tabindex="-1">Reporting</h2><p>To report attempts to violate the CSP but not prevent them, use the <code>Content-Security-Policy-Report-Only</code> header. It seems odd to want only report these attempts.</p><p>Include the <code>report-to: {url}</code> directive to specify where violation reports should be sent. This must be specified in an HTTP response header, not in a <code>meta</code> tag.</p><p>The report is a JSON object with many properties including:</p><ul><li><code>blocked-uri</code> gives the URI that violated a policy.</li><li><code>disposition</code> will be &quot;enforce&quot; or &quot;report&quot;.</li><li><code>document-uri</code> gives the URI of the document that requested the resource.</li><li><code>effective-directive</code> gives the directive that was violated.</li><li><code>script-sample</code> gives the first 40 characters of violating script or CSS.</li></ul><p>Here is an example report:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"csp-report"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"blocked-uri"</span><span class="token operator">:</span> <span class="token string">"http://example.com/css/style.css"</span><span class="token punctuation">,</span><br>    <span class="token property">"disposition"</span><span class="token operator">:</span> <span class="token string">"report"</span><span class="token punctuation">,</span><br>    <span class="token property">"document-uri"</span><span class="token operator">:</span> <span class="token string">"http://example.com/signup.html"</span><span class="token punctuation">,</span><br>    <span class="token property">"effective-directive"</span><span class="token operator">:</span> <span class="token string">"style-src-elem"</span><span class="token punctuation">,</span><br>    <span class="token property">"original-policy"</span><span class="token operator">:</span> <span class="token string">"default-src 'none'; style-src cdn.example.com; report-to /_/csp-reports"</span><span class="token punctuation">,</span><br>    <span class="token property">"referrer"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><br>    <span class="token property">"status-code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span><br>    <span class="token property">"violated-directive"</span><span class="token operator">:</span> <span class="token string">"style-src-elem"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Try creating an endpoint that receives violation reports!</p><p>Specify both the <code>Content-Security-Policy</code> and <code>Content-Security-Policy-Report</code> headers to both prevent some violations and report some attempted violations. The policies specified in each can be the same or they can differ.</p><p>See <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">Content Security Policy</a> for a table of CSP directives that are supported by each browser.</p><p>Does using a CSP remove the need to sanitize HTML?</p><p>In &quot;stored cross-site scripting&quot;, script tags entered in text input get stored in databases and later displayed on pages. They are not executed if they are used as <code>textContent</code>, but are if they are used as <code>innerHTML</code>. There are other types of cross-site scripting attacks. What are they?</p></article>