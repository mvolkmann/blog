<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Content Security Policy (CSP)</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#directives">Directives</a></li><li><a href="#keywords">Keywords</a></li><li><a href="#example-csp-headers">Example CSP Headers</a></li><li><a href="#reporting">Reporting</a></li><li><a href="#example-web-app">Example Web App</a></li><li><a href="#integrity-attribute-in-script-tags">integrity Attribute in script tags</a></li><li><a href="#cross-site-scripting-attacks-(xss)">Cross-Site Scripting Attacks (XSS)</a><ol><li><a href="#reflected-xss">Reflected XSS</a></li><li><a href="#stored-xss">Stored XSS</a></li><li><a href="#dom-xss">DOM XSS</a></li></ol></li></ol></nav></aside><article><style>img {
    border: 1px solid gray;
  }</style><h2 id="overview" tabindex="-1">Overview</h2><p>A <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">Content Security Policy</a> provides the ability to detect and prevent some types of attacks, including Cross-Site Scripting (XSS). It can also report attempted attacks.</p><p>A CSP can be enabled with an HTTP response header or with an HTML <code>meta</code> tag. It both cases, the policy is specified by a list of directives separated by semicolons.</p><p>Each directive is specified with a name and one or more values, all separated by a space. The values are CSP-specific keywords (such as <code>self</code>) and/or allowed URL patterns.</p><p>The following <code>meta</code> tag provides an example. It specifies that by default all resource types can only be downloaded from the current origin. An exception is made for images which can come from any origin as long as HTTPS is used. No scripts are allowed to be loaded, even those from the current origin.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span><br>  <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span><br>  <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default-src 'self'; img-src https://*; script-src 'none';<span class="token punctuation">"</span></span><br><span class="token punctuation">/></span></span></code></pre><p>Using a CSP reduces, but does not eliminate the need to sanitize user-entered HTML.</p><h2 id="directives" tabindex="-1">Directives</h2><p>Commonly used directives include:</p><ul><li><code>default-src</code>: restricts access to all kinds of resources</li><li><code>connect-src</code>: restricts use of <a>, fetch, XMLHttpRequest, WebSocket, and more</a></li><li><code>font-src</code>: restricts @font-face CSS at-rule</li><li><code>form-action</code>: restricts URLs used in <code>form</code> element <code>action</code> attributes</li><li><code>img-src</code>: restricts <code>&lt;img&gt;</code> elements</li><li><code>media-src</code>: restricts <code>&lt;audio&gt;</code> and <code>&lt;video&gt;</code> elements</li><li><code>object-src</code>: restricts <code>&lt;object&gt;</code> and <code>&lt;embed&gt;</code> elements</li><li><code>report-uri</code>: specifies the URL where violation reports are sent</li><li><code>script-src-attr</code>: restricts sources for JavaScript inline event handlers like <code>onclick</code></li><li><code>script-src-elem</code>: restricts <code>&lt;script&gt;</code> elements</li><li><code>script-src</code>: combines the previous two in one directive</li><li><code>worker-src</code>: restricts Worker, SharedWorker, and ServiceWorker scripts</li></ul><p>It is recommended to make <code>default-src</code> very restrictive (often just <code>'self'</code>) and used more specific directives to open access for specific kinds of resources.</p><p>A small set of directives that are not commonly used can only be specified in HTTP headers and not in <code>meta</code> tags.</p><p>See <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">Content Security Policy</a> for a table of CSP directives that are supported by each browser.</p><h2 id="keywords" tabindex="-1">Keywords</h2><p>CSP Keywords are surrounded by single quotes to distinguish them from URL patterns.</p><p>The keywords that can be used in directive values include:</p><ul><li><p><code>inline-speculation-rules</code></p><p>This allows inclusion of &quot;speculation rules&quot; which are experimental.</p></li><li><p><code>nonce-*</code></p><p>This is a whitelist of inline scripts, indentified by a cryptographic nonce value, that are allowed.</p></li><li><p><code>none</code></p><p>This prevents loading any resources.</p></li><li><p><code>report-sample</code></p><p>This causes a sample of the violating code to be included in violation reports. It is used in <code>script-src</code> and <code>script-src-elem</code> directives.</p></li><li><p><code>self</code></p><p>This only allows loading resources from the current origin. It is the most commonly used keyword.</p></li><li><p><code>sha{algorithm}-{value}</code></p><p>This is used in <code>script-src</code> and <code>styles-src</code> directives to allow resources with a matching hash value.</p></li><li><p><code>strict-dynamic</code></p><p>This allows dynamically generated JavaScript code to be executed only if it is generated by a script that is whitelisted using the <code>nonce-*</code> keyword.</p></li><li><p><code>unsafe-eval</code></p><p>This enables use of the JavaScript <code>eval</code> function, the <code>Function</code> constructor, and passing strings of JavaScript code to the <code>setTimeout</code> and <code>setInterval</code> functions.</p></li><li><p><code>unsafe-inline</code></p><p>This enables evaluating inline <code>script</code> elements, <code>javascript:</code> URLs, inline event handlers, and inline <code>style</code> elements.</p></li><li><p><code>unsafe-hashes</code></p><p>This enables evaluating inline event handling functions, which is a subset of what <code>unsafe-inline</code> enables.</p></li><li><p><code>wasm-unsafe-eval</code></p><p>This enables loading and executing WebAssembly modules.</p></li></ul><h2 id="example-csp-headers" tabindex="-1">Example CSP Headers</h2><ul><li><p><code>Content-Security-Policy: default-src 'self' demo.com *.demo.com</code></p><p>This specifies that by default all resources must come from the same domain ss this request OR from <code>demo.com</code> or any domain that ends in <code>demo.com</code>.</p></li><li><p><code>Content-Security-Policy: default-src 'self'; img-src *; media-src my-media.org; script-src https://coder.io</code></p><p>This specifies that images can come from anywhere, audio and video can come from <code>my-media.org</code>, scripts can come from <code>coder.io</code> only using HTTPS, and all other resources must come from the same domain as this request. <code>default-src</code> specifies the policy for all resource types unless policies for specific resource types are also provided.</p></li></ul><h2 id="reporting" tabindex="-1">Reporting</h2><p>To report attempts to violate the CSP but not prevent them, use the <code>Content-Security-Policy-Report-Only</code> header. This may be useful during development to determine the CSP directives that are desired before going to production.</p><p>Violation attempts are reported by sending a JSON object in an HTTP POST request. To specify where reports will be sent add the <code>report-uri</code> directive with a value that is the URL where POST requests will be sent. This can be added to the value of the <code>Content-Security-Policy</code> or <code>Content-Security-Policy-Report</code> header. There is no need to supply both headers.</p><p>The <code>report-uri</code> directive must be specified in an HTTP response header, not in a <code>meta</code> tag.</p><p>The <code>report-uri</code> directive will be replaced by <code>report-to</code> in the future.</p><p>A report JSON object contains many properties including:</p><ul><li><p><code>blocked-uri</code></p><p>This gives the URI that violated a policy.</p></li><li><p><code>disposition</code></p><p>This will be &quot;enforce&quot; if triggered by a <code>Content-Security-Policy</code> header or &quot;report&quot; if triggered by a <code>Content-Security-Report-Policy</code> header.</p></li><li><p><code>document-uri</code></p><p>This gives the URI of the document that requested the resource.</p></li><li><p><code>effective-directive</code></p><p>This gives the directive that was violated.</p></li><li><p><code>script-sample</code></p><p>This gives the first 40 characters of the violating script or CSS.</p></li></ul><p>The following is an example report that describes an issue with getting an image from Unsplash. Note the properties &quot;effective-directive&quot; and &quot;blocked-uri&quot;.</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"csp-report"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"document-uri"</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/"</span><span class="token punctuation">,</span><br>    <span class="token property">"referrer"</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/"</span><span class="token punctuation">,</span><br>    <span class="token property">"violated-directive"</span><span class="token operator">:</span> <span class="token string">"img-src"</span><span class="token punctuation">,</span><br>    <span class="token property">"effective-directive"</span><span class="token operator">:</span> <span class="token string">"img-src"</span><span class="token punctuation">,</span><br>    <span class="token property">"original-policy"</span><span class="token operator">:</span> <span class="token string">"default-src 'self'; connect-src 'self' https://jsonplaceholder.typicode.com ws:; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com; media-src 'self' http://commondatastorage.googleapis.com; script-src-elem 'self' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; report-uri /csp-report"</span><span class="token punctuation">,</span><br>    <span class="token property">"disposition"</span><span class="token operator">:</span> <span class="token string">"report"</span><span class="token punctuation">,</span><br>    <span class="token property">"blocked-uri"</span><span class="token operator">:</span> <span class="token string">"https://images.unsplash.com/photo-1629985692757-48648f4f1fc1"</span><span class="token punctuation">,</span><br>    <span class="token property">"line-number"</span><span class="token operator">:</span> <span class="token number">55</span><span class="token punctuation">,</span><br>    <span class="token property">"source-file"</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/"</span><span class="token punctuation">,</span><br>    <span class="token property">"status-code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span><br>    <span class="token property">"script-sample"</span><span class="token operator">:</span> <span class="token string">""</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2 id="example-web-app" tabindex="-1">Example Web App</h2><p>The following code implements an HTTP server using the JavaScript-based server <a href="https://hono.dev" target="_blank">Hono</a> library. It also uses <a href="/blog/topics/#/blog/htmx/" target="_blank">htmx</a>.</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token keyword">type</span> <span class="token class-name">Context</span><span class="token punctuation">,</span> Hono<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">Next</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>serveStatic<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono/bun'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token string">'./reload-server.js'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> policies <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token comment">// Only resources from the current domain are allowed</span><br>  <span class="token comment">// unless overridden by a more specific directive.</span><br>  <span class="token string">"default-src 'self'"</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// This allows sending HTTP requests to the JSONPlaceholder API.</span><br>  <span class="token comment">// It also allows reload-client.js to create a WebSocket.</span><br>  <span class="token string">"connect-src 'self' https://jsonplaceholder.typicode.com ws:"</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// This allows getting Google fonts.</span><br>  <span class="token comment">// "link" tags for Google fonts have an href</span><br>  <span class="token comment">// that begins with https://fonts.googleapis.com.</span><br>  <span class="token comment">// The linked font file contains @font-face CSS rules</span><br>  <span class="token comment">// with a src URL beginning with https://fonts.gstatic.com.</span><br>  <span class="token string">"font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com"</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// This allows getting images from Unsplash.</span><br>  <span class="token string">"img-src 'self' https://images.unsplash.com"</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// This allows getting videos from googleapis.</span><br>  <span class="token string">"media-src 'self' http://commondatastorage.googleapis.com"</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// This specifies where POST requests for violation reports will be sent.</span><br>  <span class="token comment">// In the future, "report-uri" will be replaced by "report-to".</span><br>  <span class="token string">'report-uri /csp-report'</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// This allows downloading the htmx library from a CDN.</span><br>  <span class="token string">"script-src-elem 'self' 'report-sample' https://unpkg.com"</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// This allows htmx.min.js to insert style elements.</span><br>  <span class="token string">"style-src 'self' 'unsafe-inline' https://fonts.googleapis.com"</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> csp <span class="token operator">=</span> policies<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server.tsx: csp ='</span><span class="token punctuation">,</span> csp<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Serve static files from the public directory.</span><br><span class="token comment">// app.use('/*', serveStatic({root: './public'}));</span><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">,</span> next<span class="token operator">:</span> Next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  c<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span> csp<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Tell the browser that the site can only be accessed using HTTPS,</span><br>  <span class="token comment">// and that future attempts to access it using HTTP</span><br>  <span class="token comment">// should be automatically converted to HTTPS.</span><br>  <span class="token keyword">const</span> yearSeconds <span class="token operator">=</span> <span class="token number">31536000</span><span class="token punctuation">;</span><br>  c<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><br>    <span class="token string">'Strict-Transport-Security'</span><span class="token punctuation">,</span><br>    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">max-age=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>yearSeconds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; includeSubDomains</span><span class="token template-punctuation string">`</span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">serveStatic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>root<span class="token operator">:</span> <span class="token string">'./public'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/dom-xss'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"alert('A DOM XSS occurred!')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/reflective-xss'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('A reflective XSS occurred!');&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/version'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// Return a Response whose body contains</span><br>  <span class="token comment">// the version of Bun running on the server.</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'v'</span> <span class="token operator">+</span> Bun<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// This receives reports of CSP violations in a JSON object.</span><br>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/csp-report'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token keyword">await</span> c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  c<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'CSP violation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> app<span class="token punctuation">;</span></code></pre><p>The following HTML in <code>public/index.html</code> relies on the CSP defined in the server to access several resources.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>CSP Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br><br>    <span class="token comment">&lt;!-- This loads a Google font. --></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span><br>      <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><br>      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://fonts.googleapis.com/css?family=Kode+Mono<span class="token punctuation">"</span></span><br>    <span class="token punctuation">/></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br>    <span class="token comment">&lt;!-- This loads the htmx library from a CDN. --></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><br>      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/htmx.org@1.9.10<span class="token punctuation">"</span></span><br>      <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC<span class="token punctuation">"</span></span><br>      <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><br>    <span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>    <span class="token comment">&lt;!-- We could get the htmx library from<br>         a local copy instead of from a CDN. --></span><br>    <span class="token comment">&lt;!-- &lt;script src="htmx.min.js">&lt;/script> --></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>reload-client.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><br>    <span class="token comment">&lt;!-- &lt;script><br>      async function domXSS() {<br>        const res = await fetch('/dom-xss');<br>        const text = await res.text();<br>        eval(text);<br>      }<br>      window.onload = domXSS;<br>    &lt;/script> --></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>This demonstrates the Google font "Kode Mono".<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span><br>      <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Grand Prismatic Spring<span class="token punctuation">"</span></span><br>      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://images.unsplash.com/photo-1629985692757-48648f4f1fc1<span class="token punctuation">"</span></span><br>      <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span><br>    <span class="token punctuation">/></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span><br>      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4<span class="token punctuation">"</span></span><br>      <span class="token attr-name">controls</span><br>      <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span><br>    <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><br>      <span class="token comment">&lt;!-- When this button is clicked,<br>           an HTTP GET request is sent to /version.<br>           The text it returns replaces the innerHTML<br>           of the element with id "version". --></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/version<span class="token punctuation">"</span></span> <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#version<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Get Bun Version<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>version<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br><br>    <span class="token comment">&lt;!-- This should require the form-action CSP directive, but it doesn't. --></span><br>    <span class="token comment">&lt;!-- &lt;form method="post" action="https://jsonplaceholder.typicode.com/todos"> --></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><br>      <span class="token attr-name">hx-post</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://jsonplaceholder.typicode.com/todos<span class="token punctuation">"</span></span><br>      <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo<span class="token punctuation">"</span></span><br>    <span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>Title:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>Body:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/reflective-xss<span class="token punctuation">"</span></span> <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#reflective-xss<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      Reflective XSS<br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>reflective-xss<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h2 id="integrity-attribute-in-script-tags" tabindex="-1">integrity Attribute in script tags</h2><p>To prevent executing a script whose contents have been altered, perhaps maliciously, include an <code>integrity</code> attribute in the <code>script</code> tag. The value is a hash that is computed based on the contents of the script. This is referred to as &quot;SubResource Integrity&quot; (SRI).</p><p>Using SRI is especially important when scripts are obtained from a CDN. SRI is not typically enforced for scripts loaded from the same origin.</p><p>The <code>integrity</code> value must begin with a string that identifies the hash algorithm, followed by a dash and the hash. For an example, see the <code>script</code> tag for htmx in the HTML shown in the previous section.</p><p>One way to generate a hash for a trusted, online resource is to use the site <a href="https://www.srihash.org" target="_blank">SRI Hash Generator</a>.</p><p>One way to generate a hash for a trusted, local file is the use the <code>openssl</code> command. For example:</p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> public/my-script.js <span class="token operator">|</span> openssl dgst <span class="token parameter variable">-sha384</span> <span class="token parameter variable">-binary</span> <span class="token operator">|</span> openssl base64 <span class="token parameter variable">-A</span></code></pre><h2 id="cross-site-scripting-attacks-(xss)" tabindex="-1">Cross-Site Scripting Attacks (XSS)</h2><p>There are three types of XSS attacks.</p><h3 id="reflected-xss" tabindex="-1">Reflected XSS</h3><p>In this form of XSS, an HTTP endpoint returns a string containing one or more <code>script</code> tags. Client-side JavaScript then sets the <code>innerHTML</code> of some element to the string. That causes the <code>script</code> tags to be executed.</p><p>A CSP can prevent such scripts from being executed. The easiest way is to include the directive <code>default-src 'self'</code>. To intentionally allow executing such scripts, include <code>'unsafe-inline'</code> in the value of the <code>script-src</code> or <code>script-src-elem</code> directive.</p><p>For an example of an endpoint that returns a <code>script</code> tag, see the GET endpoint for <code>/reflective-xss</code> above.</p><h3 id="stored-xss" tabindex="-1">Stored XSS</h3><p>In this form of XSS, user-entered content is stored, perhaps in a database. The content is later used in generated web pages.</p><p>This can be dangerous if users enter <code>script</code> tags and the content is later added as <code>innerHTML</code> because the scripts will be executed. On the other hand, adding the content as <code>textContent</code> will display <code>script</code> tags, but not execute them.</p><h3 id="dom-xss" tabindex="-1">DOM XSS</h3><p>In this form of XSS, JavaScript running in a browser gets a string from a source such as the page URL or a fetch request, and executes it. One way to execute the string as JavaScript code is to pass it to the <code>eval</code> function. Another way is to set the <code>innerHTML</code> of a DOM element to the string.</p><p>With a strict default CSP in place, calling the <code>fetch</code> function from an inline script (such as a <code>script</code> tag that contains JavaScript code) is only allowed if the <code>script-src</code> or <code>script-src-elem</code> directive includes <code>'unsafe-inline'</code>. In addition, calling the <code>eval</code> function is only allowed if the <code>script-src</code> directive includes <code>'unsafe-eval'</code>.</p><p>For an example of an endpoint that returns a string of JavaScript code, see the GET endpoint for <code>/dom-xss</code> above.</p><p>The following HTML uses the <code>fetch</code> function to send a GET request to that endpoint. It then passes the string of JavaScript that is returned oto the <code>eval</code> function.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">domXSS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/dom-xss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">eval</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  window<span class="token punctuation">.</span>onload <span class="token operator">=</span> domXSS<span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></article>