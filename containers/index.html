<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Containers</h2><aside><nav class="toc"><ol><li><a href="#why-containers%3F">Why Containers?</a></li><li><a href="#rancher-desktop">Rancher Desktop</a></li><li><a href="#dockerfile">Dockerfile</a></li><li><a href="#images">Images</a></li><li><a href="#containers">Containers</a></li><li><a href="#docker-hub">Docker Hub</a></li><li><a href="#volumes">Volumes</a></li><li><a href="#sveltekit">SvelteKit</a></li><li><a href="#restricting-network-access">Restricting Network Access</a></li></ol></nav></aside><article><p>Containers are packages of application and dependency code. These can be executed on all the popular operating systems.</p><p>For many years <a href="https://www.docker.com?v=1.1.1" rel="noopener" target="_blank">Docker</a> has been the most popular tool for creating and running containers. In 2022 Docker licensing changed so that it is no longer free to use.</p><p>A <a href="https://www.docker.com/blog/do-the-new-terms-of-docker-desktop-apply-if-you-dont-use-the-docker-desktop-ui/?v=1.1.1" rel="noopener" target="_blank">blog post</a> on the Docker web site says the following: &quot;Docker Desktop now requires a per-user paid subscription (Pro, Team, or Business) for professional use in larger companies (larger than 250 employees OR greater than $10 million in annual revenue).&quot;</p><p>A popular alternative to Docker is to use <a href="https://buildah.io?v=1.1.1" rel="noopener" target="_blank">Buildah</a> to create containers and <a href="https://podman.io?v=1.1.1" rel="noopener" target="_blank">podman</a> to run them. Unfortunately, Buildah only runs on Linux systems and cannot be used on macOS and Windows.</p><p>Another alternative that works on Linux, macOS, and Windows is <a href="https://rancherdesktop.io?v=1.1.1" rel="noopener" target="_blank">Rancher Desktop</a>.</p><h2 id="why-containers%3F" tabindex="-1">Why Containers?</h2><p>Using containers to package and run apps avoids the issues of:</p><ul><li>missing files</li><li>software version mismatches</li><li>differing configuration settings, including environment variables</li></ul><p>Using containers makes it much easier to:</p><ul><li>get new developers started quickly with minimal configuration (<code>docker-compose up</code>)</li><li>deploy apps</li><li>remove the container for an app and all of its dependencies (<code>docker-compose down --rmi all</code>)</li></ul><p>A container is an isolated environment/process for running an application image. This includes:</p><ul><li>a minimal version of an operation system</li><li>a runtime environment such as Node.js</li><li>application files</li><li>libraries used by the application files</li><li>environment variables</li></ul><p>Docker images can be pushed to a registry like &quot;Docker Hub&quot;. The images can then be download on different machines and run.</p><h2 id="rancher-desktop" tabindex="-1">Rancher Desktop</h2><p>To install Rancher Desktop, browse the link above, scroll to the &quot;Download Rancher Desktop&quot; section, and click the link for your operating system. This is a large download, so it may take several minutes to finish. On macOS this is a .dmg file that can be double-clicked to complete the installation.</p><p>Double-click the &quot;Rancher Desktop&quot; app in the Applications directory to start it. The first time this is done it will prompt to confirm some settings.</p><p>An icon will be added to the macOS menu bar. Click this provides Kubernetes status, enables changing preferences, and enables changing the active Kubernetes context . Open &quot;Preferences&quot;, and select &quot;Kubernetes Settings&quot;. Under &quot;Container Runtime&quot; select &quot;dockerd&quot;.</p><p>Once installed, <code>docker</code> commands can be entered in a terminal. To verify that this is working, enter <code>docker run hello-world</code>.</p><h2 id="dockerfile" tabindex="-1">Dockerfile</h2><p>To run an app in Docker, create a file named <code>Dockerfile</code>. This defines everything that must be included in an &quot;image&quot; in order to run.</p><p>Publicly available images can be found at <a href="https://hub.docker.com?v=1.1.1" rel="noopener" target="_blank">DockerHub</a>. This site requires creating a free account. These images can be used as the base for creating an application-specific image.</p><p>Let's walk through a basic example where all we want to do is execute a Node.js script that outputs a message.</p><p>Here is the Node.js script in the file <code>index.js</code>:</p><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, Docker!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Here is the <code>Dockerfile</code>.</p><pre class="language-text"><code class="language-text"># This uses the latest version of Node.js running in Alpine,<br># which is a small Linux distribution.<br>FROM node:alpine<br><br># This copies all files in current directory<br># into the app directory of the image.<br>COPY . /app<br><br># This similar to the UNIX cd command for<br># changing the current directory within the image.<br>WORKDIR /app<br><br># This specifies a command to run inside the image.<br>CMD node index.js</code></pre><p>To create an image, enter <code>docker build -t hello-docker .</code> where <code>-t</code> specifies a tag for the image and <code>.</code> indicates that <code>Dockerfile</code> is in the current directory.</p><p>To run this image in a container, enter <code>docker run hello-docker</code>.</p><h2 id="images" tabindex="-1">Images</h2><p>To list the current images, enter <code>docker images</code> or <code>docker image ls</code>.</p><p>To run an image in a container, enter <code>docker run {image-name}</code>.</p><p>To delete an image, enter <code>docker rmi {image-id}</code> or <code>docker rmi {image-name}</code>.</p><h2 id="containers" tabindex="-1">Containers</h2><p>To list the current containers, enter <code>docker ps -a</code> or <code>docker container ls</code>.</p><p>To delete a container, enter <code>docker rm {container-id-prefix}</code>.</p><p>To run a container, enter <code>docker run {container-id}</code>. To run in interactive mode, add the <code>-it</code> flag.</p><h2 id="docker-hub" tabindex="-1">Docker Hub</h2><p>To upload a Docker image to Docker Hub:</p><ul><li>browse <a href="https://hub.docker.com">https://hub.docker.com</a></li><li>if you do not already have an account, create one</li><li>otherwise click &quot;Sign In&quot; and login</li><li>in the top nav, click &quot;Repositories&quot;</li><li>click the &quot;Create Repository&quot; button</li><li>enter a name for the repository</li><li>choose between Public and Private</li><li>enter <code>docker push {user-name}/{repository-name}:{tag-name}</code>.</li><li>TODO: I could not get this to work!</li></ul><p>To download a Docker image from Docker Hub, enter <code>docker pull {user-name}/{repository-name}:{tag-name}</code>.</p><h2 id="volumes" tabindex="-1">Volumes</h2><p>A volume is a directory or file on the host file system that is accessible from a container. Volumes allow an image to read or write data not found inside the container. Writing to a volume allows data to outlive the container. Volumes can also be used to share data between containers.</p><p>Here is a simple Node.js example that writes to the file <code>$HOME/demo.txt</code> and then reads from it.</p><p>The file <code>index.js</code> contains:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token string">'/data/test.txt'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token string">'Hello, World!'</span><span class="token punctuation">;</span><br>fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'write was successful'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> buf</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'read got:'</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The file <code>Dockerfile</code> contains:</p><pre class="language-text"><code class="language-text">FROM node:alpine<br>COPY . /<br>WORKDIR /<br>CMD ["npm", "start"]</code></pre><p>To build the image, enter <code>docker build -t volume-demo .</code></p><p>To run the image in a container, enter <code>docker run --rm -v $HOME/data:/data volume-demo</code>. The <code>-v</code> flag says that the file path <code>/data</code> inside the container should be mapped to the file path <code>$HOME/data</code> outside the container.</p><p>Include the <code>-v</code> flag with a mapping once per volume to be shared.</p><p>Another way to use a volume is to explicitly define it.</p><ul><li>cd to the local directory to be shared.</li><li>Create a volume by entering <code>docker volume create data</code> where &quot;data&quot; is the name to assign to the volume.</li><li>List the defined volumes by entering <code>docker volume ls</code>.</li><li>Run the image in a container with the <code>--mount</code> flag as follows: <code>docker run --rm --mount source=data,target=/data volume-demo</code></li></ul><p>Include the <code>--mount</code> flag with a mapping once per volume to be shared.</p><h2 id="sveltekit" tabindex="-1">SvelteKit</h2><p>To run a SvelteKit server in a Docker container:</p><ul><li><p>Modify <code>sveltekit.config.js</code>.</p><p>Instead of importing the adapter <code>@sveltejs/adapter-auto</code>, import <code>@sveltejs/adapter-node</code>. Change the line that creates an adapter instance from <code>adapter()</code> to <code>adapter({ out: 'build' })</code>.</p></li><li><p>Create the following <code>Dockerfile</code>:</p><pre class="language-text"><code class="language-text">FROM node:alpine<br><br>COPY package.json package-lock.json ./<br>RUN npm ci<br><br>COPY . /app<br>WORKDIR /app<br>RUN npm run build<br><br>EXPOSE 3000<br>CMD ["node", "./build"]</code></pre></li><li><p>Create a Docker image by entering <code>docker build -t {image-name} .</code></p></li><li><p>Run this in a container by entering <code>docker run -p 4000:3000 {image-name}</code> which exposes port 3000 inside the container</p></li><li><p>Browse localhost:4000.</p></li><li><p>Find the id of the container by entering <code>docker container ls</code>.</p></li><li><p>Stop the container by entering <code>docker stop {container-id}</code>. This can take around 10 seconds to complete.</p></li></ul><h2 id="restricting-network-access" tabindex="-1">Restricting Network Access</h2><p>TODO: Coming soon.</p></article>