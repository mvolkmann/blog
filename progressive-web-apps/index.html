<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Progressive Web Apps (PWAs)</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#running-and-installing-a-pwa">Running and Installing a PWA</a></li><li><a href="#security">Security</a></li><li><a href="#advantages-over-native-apps">Advantages Over Native Apps</a></li><li><a href="#manifest-file">Manifest File</a></li><li><a href="#evaluating-readiness">Evaluating Readiness</a></li><li><a href="#service-workers">Service Workers</a></li><li><a href="#caching-strategies">Caching Strategies</a></li><li><a href="#offline-support">Offline Support</a></li><li><a href="#service-worker-events">Service Worker Events</a></li><li><a href="#managing-service-workers-in-chrome">Managing Service Workers in Chrome</a></li><li><a href="#development-tips">Development Tips</a></li><li><a href="#resources">Resources</a></li></ol></nav></aside><article><style>img {
    border: 1px solid gray;
  }</style><p><img alt="PWA logo" style="border: none; width: 30%" src="/blog/assets/pwa-logo.svg?v=1.1.1" title="PWA logo"></p><h2 id="overview" tabindex="-1">Overview</h2><p>Progressive Web Apps (PWAs) enable using web technologies to implement mobile apps.</p><p>PWAs can provide many of the features typically associated with native applications. These include the ability to:</p><ul><li>continue working while offline, possibly with reduced functionality and delayed transactions</li><li>install a home screen icon that can be used to launch the application</li><li>launch quickly without requiring download of files from the internet</li><li>communicate with users via dialog boxes, even after they have left the application, to reengage them (using the Push API and the Notifications API)</li><li>look like native apps by running without browser &quot;chrome&quot; or in full-screen mode</li><li>support multiple operating systems with a single code base, reducing development costs</li></ul><p>Supported features include background sync, bluetooth, camera access, contact access, device motion, file access, geolocation, offline mode, push notifications, and touch gestures.</p><h2 id="running-and-installing-a-pwa" tabindex="-1">Running and Installing a PWA</h2><p>The steps to run a new PWA for the first time are:</p><ol><li>Open a web browser.</li><li>Search for the application or enter its URL.</li><li>Click its link.</li><li>Optionally install the PWA which downloads all the require files. This also adds an app icon to the home screen so in the future the app can be launched by double-clicking its icon. The app will still run in the mobile web browser, but the app can choose to hide the browser chrome so it appears more like a native app.</li></ol><p>Often the first three steps are replaced by clicking a link that is found in another way such as in an email message or a social media site. In this case a new PWA can be launched with a single click.</p><p>Production PWAs must be downloaded using HTTPS in order to use service workers. In development it is possible to configure the browser to allow using service workers with localhost URLs that use HTTP.</p><h2 id="security" tabindex="-1">Security</h2><p>When a PWA attempts to access device features, such as contacts or the camera, the user will be prompted to grant permission.</p><h2 id="advantages-over-native-apps" tabindex="-1">Advantages Over Native Apps</h2><p>The advantages that PWAs have over native mobile apps include the ability to:</p><ul><li>allow users to access apps by URL instead of needing to download from an app store</li><li>bypass app store review</li><li>avoid app store cut of purchase prices (such as Apple's 30% cut)</li><li>provide automatic app updates</li><li>implement using widely known web technologies</li><li>run on web, Android, and iOS with a single code base</li></ul><h2 id="manifest-file" tabindex="-1">Manifest File</h2><p>Service workers require a <code>manifest.json</code> file. These are typically located at the top of the <code>public</code> directory along with <code>index.html</code>.</p><p>There are many properties that can be set in the manifest file. TODO: See the O'Reilly book &quot;Building Progressive Web Apps&quot;, pages 176-181 for details.</p><p>The following properties are required:</p><ul><li><code>name</code> and/or <code>short_name</code></li><li><code>start_url</code></li><li><code>icons</code></li><li><code>display</code></li></ul><p>Other properties that can be set include:</p><ul><li><code>description</code></li><li><code>orientation</code></li><li><code>theme_color</code></li><li><code>background_color</code></li><li><code>scope</code></li><li><code>dir</code></li><li><code>lang</code></li><li><code>prefer_related_applications</code></li><li><code>related_applications</code></li></ul><p>Once a service worker has been registered, its manifest can be examined in Chrome devtools by clicking the &quot;Application&quot; tab and clicking &quot;Manifest&quot; in the left nav.</p><h2 id="evaluating-readiness" tabindex="-1">Evaluating Readiness</h2><p>To determine if a web app can be used as a PWA:</p><ul><li>Use a desktop computer or laptop to open the app in the Chrome web browser.</li><li>Open the DevTools.</li><li>Click on the &quot;Lighthouse&quot; tab.</li><li>Click the &quot;Analyze page load&quot; button.</li><li>Look for the &quot;Progressive Web App&quot; score.</li></ul><h2 id="service-workers" tabindex="-1">Service Workers</h2><p>Service workers are the key to many PWA features. A service worker is a kind of web worker. This means that its functionality is defined in a JavaScript source file and it runs in a background thread. The window or tab in which the associated web app is running can be closed and associated service workers can continue executing.</p><p>Service workers have many use cases:</p><ul><li>enable offline functionality by acting as a proxy between a web app and the network, deciding how to handle each resource request</li><li>listen for external events</li><li>periodically fetch data</li><li>send notifications to associated web apps using push notifications</li></ul><p>A PWA can register any number of service workers, but typically only one is used.</p><p>Service workers can allow parts of a web application to continue functioning after network connectivity is lost. They do this by returning cached responses for requests when requests for inaccessible resources are received.</p><p>Common tasks performed by service workers include:</p><ul><li>creating caches</li><li>storing resources in caches</li><li>intercepting network requests and deciding how to respond</li></ul><p>There is a limit to the amount of data each application domain can cache and a limit to the amount of data that can be cached across all domains. The limits differ across web browsers, but are mostly consistent for Chrome, Edge, and Firefox. The limit for a single domain is 20% of the overall limit. Typically the limits are based on the available space as shown in the following table.</p><table><thead><tr><th>Available Space</th><th>Total Cache Limit</th></tr></thead><tbody><tr><td>up to 8 GB</td><td>50 MB</td></tr><tr><td>8 to 32 GB</td><td>500 MB</td></tr><tr><td>32 to 128 GB</td><td>4% of volume size</td></tr><tr><td>over 128 GB</td><td>smaller of 20 GB or 4% of volume size</td></tr></tbody></table><p>Safari is an outlier. It limits each application to 50 MB of cache storage regardless of the available space, and it purges this after two weeks of not being used. An alternative is to use IndexedDB, which has a limit of 500 MB per application domain in Safari.</p><p>When the total limit is reached, some browsers (Chrome and Firefox) remove the least recently used caches to make room for new caches.</p><p>Service Workers do not have access to the DOM of their associated web app, so they cannot directly change what is rendered in the browser. However, they can communicate with the web app via message passing. The <code>Worker</code> <code>postMessage</code> method is used to send a message from a web worker to the web app or from the web app to a web worker.</p><p>For example, the following sequence of events can occur:</p><ul><li>web app posts a message to a service worker</li><li>service worker sends a request to an API endpoint to fetch data</li><li>service worker posts a message to the web app to send it some of the fetched data</li><li>web app updates the DOM using the received data</li></ul><h2 id="caching-strategies" tabindex="-1">Caching Strategies</h2><p>Services workers can implement many caching strategies, perhaps based on the kinds of resources that will be requested. Resources can be files with content such as HTML, CSS, JavaScript, JSON, and image data. Resources can also be the results of API calls.</p><p>The diagram below is helpful in describing the various caching strategies. The descriptions below refer to the letters in this diagram.</p><p><img alt="Service Workers" style="border: 0; width: 60%" src="/blog/assets/service-workers.png?v=1.1.1" title="Service Workers"></p><p>Possible caching strategies include:</p><ul><li><p>Network Only</p><p>This strategy is applicable when using cached versions of a resource is unacceptable. For example, a banking app might decide it is better to let the user know when they are offline and not show stale data.</p><p>All resource requests are forwarded to the network, and only resources obtained from the network are returned. No caching is used. In the diagram above, this is represented by the path A-B-C-F.</p></li><li><p>Cache Only</p><p>This strategy is applicable for resources that never change or that change very rarely. Examples include a CSS file that defines site styling or an image file for a company logo.</p><p>The service worker is responsible for initially populating the caches and thereafter only returns resources from the caches. Resource requests are never forwarded to the network. In the diagram above, this is represented by the path A-D-E-F.</p></li><li><p>Network or Cache</p><p>This strategy is applicable when having the latest data is preferred, but it is acceptable to use previously fetched data. For example, a site that reports basketball scores prefers to show the latest scores, but showing the last known scores is better than showing no scores.</p><p>Resource requests are first forwarded to the network. If a response is obtained from the network, that is returned. Then the cache is updated with the response, so it can be used again later if the same resource is requested while offline. If no response is obtained from the network and a previously cached response is available, that is returned. In the diagram above, this is represented by the path A-B-C-(D-E)-F where steps D and E are optional.</p><p>The following service worker code implements this strategy.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'pwa-demo'</span><span class="token punctuation">;</span><br><br><span class="token comment">// No fetch events are generated in the initial load of the web app.</span><br><span class="token comment">// A second visit (or refresh) is required to cache all the resources.</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span><br>    <span class="token keyword">let</span> resource<span class="token punctuation">;</span><br><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Get from network.</span><br>      <span class="token comment">// Note that resources coming from a local HTTP server</span><br>      <span class="token comment">// can be fetched even when offline.</span><br>      <span class="token comment">// To use cached versions of those, stop the local HTTP server.</span><br>      resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from network'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token comment">// Save in cache for when we are offline later.</span><br>      <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker cached'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Get from cache.</span><br>      resource <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> resource<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Cache and Update</p><p>This strategy is applicable when fast responses are prioritized over having the latest data. It’s difficult to think of a case when this strategy might be preferred, but the next strategy augments this to make it more applicable.</p><p>If the requested resource is available in a cache, that is returned. Then the request is forwarded to the network to obtain an up-to-date value. If the network returns a different value, the cache is updated so the next request for the same resource will receive the updated value. This is great for performance but has the downside of potentially using stale data. In the diagram above, this is represented by the path A-D-E-F-B-C-D.</p><p>The following service worker code implements this strategy.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'pwa-demo-v1'</span><span class="token punctuation">;</span><br><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">deleteOldCaches</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> keyList <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><br>      keyList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> cacheName <span class="token operator">?</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// No fetch events are generated in the initial load of the web app.</span><br><span class="token comment">// A second visit is required to cache all the resources.</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span><br>    <span class="token keyword">let</span> resource<span class="token punctuation">;</span><br><br>    <span class="token comment">// Get from cache.</span><br>    resource <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Get from network.</span><br>        resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from network'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Save in cache for when we are offline later.</span><br>        <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker cached'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service worker failed to get'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> resource<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Cache, Update, and Refresh</p><p>This strategy starts the same way as the &quot;cache and update&quot; strategy, but after new data is received from the network, the UI is triggered to refresh using the new data.</p><p>For example, a theatre website might use this approach to quickly display the known shows and ticket availability from the cache. As soon as new data becomes available, it can update this information in the browser.</p></li><li><p>Embedded Fallback</p><p>In this strategy, the service worker provides default responses for cases when the resource cannot be obtained from the network or a cache. For example, a service worker that returns photos of specific dogs can return stock images that match the breeds of requested dogs when the requested photos are unavailable. This, of course, assumes that the stock images have already been cached.</p><p>This strategy can be employed as a supplement to the previously described strategies to provide an alternative to returning a &quot;Not Found&quot; (404) status.</p><p>The following service worker code implements this strategy.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'pwa-demo-v1'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> filesToCache <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token comment">// need in order to hit web app with domain only</span><br>  <span class="token string">'/demo.css'</span><span class="token punctuation">,</span><br>  <span class="token string">'/demo.js'</span><span class="token punctuation">,</span><br>  <span class="token string">'/images/avatar.jpg'</span><span class="token punctuation">,</span><br>  <span class="token string">'/images/birthday-192.jpg'</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">deleteOldCaches</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> keyList <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><br>      keyList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> cacheName <span class="token operator">?</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">cacheAll</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>filesToCache<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">cacheAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// No fetch events are generated in the initial load of the web app.</span><br><span class="token comment">// A second visit is required to cache all the resources.</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span><br>    <span class="token keyword">const</span> isAvatar <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'githubusercontent.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> resource<span class="token punctuation">;</span><br><br>    <span class="token comment">// Get from cache.</span><br>    resource <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Get from network.</span><br>        resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from network'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAvatar<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token comment">// Save in cache for when we are offline later.</span><br>          <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker cached'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAvatar<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker using generic avatar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          resource <span class="token operator">=</span> Response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/images/avatar.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service worker failed to get'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> resource<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul><h2 id="offline-support" tabindex="-1">Offline Support</h2><p>Web applications can determine whether they currently have network connectivity by checking the value of <code>navigator.onLine</code>. It's odd that the &quot;L&quot; is uppercase since &quot;online&quot; is a word!</p><p>For some web applications it is possible to define a subset of functionality that can be supported for offline use and then only cache resources related to that. For example, a todo app can cache the latest todo items so they can be displayed, but disallow adding, modifying, and deleting todo items while offline.</p><p>For some web applications it is acceptable to accumulate transactions when offline and execute them later when online again. For example, suppose a time sheet web app allows users to enter the hours they worked on various projects. If network connectivity is lost, the app can save the hours entered in a cache. When connectivity is restored, it can read data from the cache, make the appropriate API calls to save it on a server, and delete the data from the cache.</p><p>This can be challenging to implement due to special cases that must be considered. For example, what should be done in the time sheet app if we are saving hours for a project that has been deleted by someone else after network connectivity was lost for the user that entered the hours? Perhaps the new hours should just be ignored, or perhaps the project should be recreated and the hours should be applied to it. There can be many such cases to consider.</p><h2 id="service-worker-events" tabindex="-1">Service Worker Events</h2><p>Service workers listen for events and act on them.</p><p>The first event received is <code>install</code>. This is a one-time event. One way to handle this event is to do the following:</p><ul><li>Open a cache whose name is <code>cache</code> concatenated with the value of the <code>timestamp</code> variable. If this cache does not exist, it is created.</li><li>Add some files to the cache that will always be served from the cache. They will be available without a network connection after the app is initially loaded from the network.</li></ul><p>The second event received is <code>activate</code>. This is also a one-time event. One way to handle this event is to delete any old caches for this app that were created when previous builds of the app were run. This can be determined by checking whether their names contain the current value of the <code>timestamp</code> variable.</p><p>The third event type received is <code>fetch</code>. This can be received many times. The caching strategy is implemented here. One way to handle this event is to evaluates each request using the following steps in this sequence:</p><ul><li>Only process <code>GET</code> requests.</li><li>Don’t process requests asking for just part of a document, using an HTTP &quot;Range&quot; header (not commonly used).</li><li>Only process URLs with a protocol beginning with &quot;http&quot;. For example, URLs with the &quot;data&quot; protocol are ignored.</li><li>Serve all static files from the cache.</li><li>If the file is not found in the cache and the request has a <code>cache</code> property of <code>only-if-cached</code>, don't attempt to find the file using the network.</li><li>Otherwise, attempt to satisfy the request using the network.</li><li>If found, add the file to the cache and return its contents.</li><li>If not found and a match for the URL is in the cache, return that content.</li></ul><p>This caching strategy means that the results of API service calls are cached. Later, if the same request is made again and the service is offline, the cached value will be returned.</p><h2 id="managing-service-workers-in-chrome" tabindex="-1">Managing Service Workers in Chrome</h2><p>The Chrome DevTools provide a way to interact with service workers and the caches they create.</p><p>To view service workers for the current site, click the DevTools Application tab. Then click Service Workers in the left nav. The main area will display information about each of the service workers for the site.</p><p><img alt="Service Workers in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-service-workers.png?v=1.1.1" title="Service Workers in Chrome DevTools"></p><p>The status of a service worker is displayed after the Status label. For example, it may say “activated and is running.” To stop the service worker, click the Stop link after the status. The Stop link will change to Start, and this can be clicked to restart it.</p><p>Unregistering a service worker allows it to run through its lifecycle again one time, when the page is refreshed. This includes processing the <code>install</code> and <code>activate</code> events again. This is useful for debugging the code that handles those events. To do this, click the Unregister link to the right of a service worker description.</p><p>To cause service workers to install and activate again every time the page is reloaded, and without creating a new build, check the Update on Reload check box at the top of the main area, and refresh the page.</p><p>To view the source code for a service worker, click the link after the Source label. This switches to the Sources tab and displays the code. Typically the code will have been minified.</p><p><img alt="Minimized service worker code in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-service-worker-code-minimized.png?v=1.1.1" title="Minimized service worker code in Chrome DevTools"></p><p>To see a pretty-printed version of this, click the “{}” at the bottom.</p><p><img alt="Pretty-printed service worker code in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-service-worker-code-pretty-printed.png?v=1.1.1" title="Pretty-printed service worker code in Chrome DevTools"></p><p>To see the files that have been cached, click the DevTools Application tab. Then click the disclosure triangle before Cache Storage in the left nav. This will display a list of all the current caches for the site. The caches that Sapper apps create by default have names that begin with “cache” and “offline” and end with a build timestamp.</p><p>Click one of these to see a list of the files that it has cached. Click a file to see its contents at the bottom of the main area.</p><p><img alt="Cached files in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-cache.png?v=1.1.1" title="Cached files in Chrome DevTools"></p><p>To remove an individual file from a cache, select the file in the main area and press the Delete key or click the “X” above the list of files. To delete an entire cache, right-click a cache name and select Delete.</p><p>To simulate being offline, click Service Workers in the left nav and check the Offline check box at the top of the main area. This is an alternative to going to the Network tab and changing the Online drop-down to Offline. A warning icon will appear in the Network tab to remind you that you are offline. This is useful for testing the ability of service workers to use cached files.</p><p><img alt="Simulating being offline in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-offline.png?v=1.1.1" title="Simulating being offline in Chrome DevTools"></p><p>To bypass the use of service workers, causing all requests to go to the network, check the Bypass for Network check box at the top of the main area. This, of course, requires being online.</p><p>The list of requested files in the Network tab has a gear icon before each file that was loaded from a cache (see figure 19.8). This is useful for determining whether specific files were served from the network or from a cache.</p><p><img alt="Files loaded from cache in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-network-files-from-cache.png?v=1.1.1" title="Files loaded from cache in Chrome DevTools"></p><p>To clear many things at once, click the Application tab and click Clear Storage (preceded by a trashcan icon) in the left nav. This displays a series of check boxes in the main area for categories of things that can be cleared. By default, all the check boxes are checked. This includes Unregister Service Workers and Cache Storage. Click the Clear Site Data button to clear the data associated with every checked category.</p><p><img alt="Clearing storage in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-clear-storage.png?v=1.1.1" title="Clearing storage in Chrome DevTools"></p><p>A great video covering most of the topics in this section, created by the Chrome team, can be found at <a href="http://mng.bz/oPwp?v=1.1.1" rel="noopener" target="_blank">Debugging Service Workers in Chrome</a>.</p><p>A similar video for Firefox from the same team can be found at <a href="http://mng.bz/nPw2?v=1.1.1" rel="noopener" target="_blank">Debugging Service Workers in Firefox</a>.</p><h2 id="development-tips" tabindex="-1">Development Tips</h2><p>During development it is often necessary to force certain files to be reloaded. Files cached by a service worker are not cleared by clearing the browser cache.</p><p>In Chrome, one approach to force files to be reloaded on the next browser refresh is to open the devtools, click the &quot;Application&quot; tab, and check the &quot;Update on reload&quot; checkbox.</p><p>To force reloading for a specific service worker, select the &quot;Application&quot; tab, select &quot;Service Workers&quot;, and click the &quot;Unregister&quot; link for the service worker.</p><h2 id="resources" tabindex="-1">Resources</h2><ul><li><a href="https://web.dev/explore/progressive-web-apps?v=1.1.1" rel="noopener" target="_blank">web.dev</a> on PWAs</li></ul></article>