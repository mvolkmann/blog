<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Progressive Web Apps (PWAs)</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#advantages-over-native-apps">Advantages Over Native Apps</a></li><li><a href="#service-workers">Service Workers</a></li><li><a href="#registering-a-service-worker">Registering a Service Worker</a></li><li><a href="#manifest-file">Manifest File</a></li><li><a href="#generating-icons">Generating Icons</a><ol><li><a href="#storage-limits">Storage Limits</a></li></ol></li><li><a href="#evaluating-readiness">Evaluating Readiness</a><ol><li><a href="#message-passing">Message Passing</a></li></ol></li><li><a href="#caching-strategies">Caching Strategies</a></li><li><a href="#offline-support">Offline Support</a></li><li><a href="#service-worker-events">Service Worker Events</a><ol><li><a href="#install-event">install Event</a></li><li><a href="#activate-event">activate Event</a></li><li><a href="#message-event">message Event</a></li><li><a href="#fetch-event">fetch Event</a></li><li><a href="#sync-event">sync Event</a></li><li><a href="#push-event">push Event</a></li></ol></li><li><a href="#running-and-installing-a-pwa">Running and Installing a PWA</a></li><li><a href="#security">Security</a></li><li><a href="#managing-service-workers">Managing Service Workers</a><ol><li><a href="#updating-a-service-worker">Updating a Service Worker</a></li><li><a href="#viewing-source-code">Viewing Source Code</a></li><li><a href="#cached-files">Cached Files</a></li><li><a href="#clearing-everything">Clearing Everything</a></li><li><a href="#simulating-offline">Simulating Offline</a></li><li><a href="#bypassing-service-workers">Bypassing Service Workers</a></li><li><a href="#service-workers-in-macos-safari">Service Workers in macOS Safari</a></li><li><a href="#service-workers-in-ios-safari">Service Workers in iOS Safari</a></li></ol></li><li><a href="#push-notifications">Push Notifications</a></li><li><a href="#workbox">Workbox</a></li><li><a href="#resources">Resources</a></li><li><a href="#outstanding-questions">Outstanding Questions</a></li></ol></nav></aside><article><style>img {
    border: 1px solid gray;
  }</style><p><img alt="PWA logo" style="border: none; width: 30%" src="/blog/assets/pwa-logo.svg?v=1.1.1" title="PWA logo"></p><h2 id="overview" tabindex="-1">Overview</h2><p>Progressive Web Apps (PWAs) enable using web technologies to implement mobile applications.</p><p>PWAs can provide many of the features typically associated with native applications. These include the ability to:</p><ul><li>continue working while offline, possibly with reduced functionality and delayed transactions</li><li>install a home screen icon that can be used to launch the application</li><li>launch quickly without requiring download of files from the internet</li><li>communicate with users via dialog boxes, even after they have left the application, to reengage them (using the Push API and the Notifications API)</li><li>look like native apps by running without browser &quot;chrome&quot; or in full-screen mode</li><li>support multiple operating systems with a single code base, reducing development costs</li></ul><p>Supported features include background sync, bluetooth, camera access, contact access, device motion, file access, geolocation, offline mode, push notifications, and touch gestures.</p><h2 id="advantages-over-native-apps" tabindex="-1">Advantages Over Native Apps</h2><p>The advantages that PWAs have over native mobile apps include the ability to:</p><ul><li>implement using widely known web technologies</li><li>bypass app store review</li><li>allow users to access apps by URL rather than downloading them from an app store</li><li>avoid app store cut of purchase prices (such as Apple's 30% cut)</li><li>run on the web, Android, and iOS with a single code base</li><li>provide automatic app updates</li></ul><p>TODO: Fix the order of the remaining sections.</p><h2 id="service-workers" tabindex="-1">Service Workers</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API?v=1.1.1" rel="noopener" target="_blank">Service Workers</a> are the key to many PWA features.</p><p>A service worker is a kind of <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API?v=1.1.1" rel="noopener" target="_blank">Web Worker</a>. This means that its functionality is defined in a JavaScript source file and it runs in a background thread.</p><p>Each of the windows and tabs associated with the web app share access to the service workers of the app. Even if the window and tabs are closed, the service workers of the app can continue executing. Viewing a service worker in Chrome DevTools will list each of these windows and tabs as &quot;Clients&quot; below the &quot;Status&quot;.</p><p>Service workers have many use cases:</p><ul><li>enable offline functionality</li><li>listen for external events</li><li>periodically fetch data</li><li>send push notifications to the associated web app</li></ul><p>A PWA can register any number of service workers, but typically only one is used.</p><p>Service workers can allow parts of a web application to continue functioning after network connectivity is lost.</p><p>Common tasks performed by service workers include:</p><ul><li>creating caches</li><li>storing resources in caches</li><li>intercepting network requests and deciding how to respond, including responding with cached values</li></ul><h2 id="registering-a-service-worker" tabindex="-1">Registering a Service Worker</h2><p>Each page of a web app that wished to utilize a service worker must register the service worker. The following code does this for a service worker defined in the file <code>service-worker.js</code>.</p><pre class="language-js"><code class="language-js"><span class="token comment">// This can be used to post messages to the service worker.</span><br><span class="token keyword">let</span> serviceWorker<span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    serviceWorker <span class="token operator">=</span> reg<span class="token punctuation">.</span>installing <span class="token operator">||</span> reg<span class="token punctuation">.</span>waiting <span class="token operator">||</span> reg<span class="token punctuation">.</span>active<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service worker registered failed:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Your browser does not support service workers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Services workers for each site are only loaded and registered once. However, if their source file is modified then they will automatically load and register again.</p><p>To see this, add a <code>console.log</code> call in the service worker JavaScript file. Refresh the site in a browser and note the output in the DevTools Console. Refresh the page again and the output will not appear. Modify the service worker JavaScript file to change what the <code>console.log</code> call outputs. Refresh the page again and this time the output will appear.</p><h2 id="manifest-file" tabindex="-1">Manifest File</h2><p>Service workers require a <code>manifest.json</code> file. These are typically located at the top of the <code>public</code> directory along with <code>index.html</code>.</p><p>There are many properties that can be set in the manifest file. TODO: See the O'Reilly book &quot;Building Progressive Web Apps&quot;, pages 176-181 for details.</p><p>The following properties are required:</p><ul><li><code>name</code> and/or <code>short_name</code></li><li><code>start_url</code></li><li><code>icons</code></li><li><code>display</code></li></ul><p>Other properties that can be set include:</p><ul><li><code>description</code></li><li><code>orientation</code></li><li><code>theme_color</code></li><li><code>background_color</code></li><li><code>scope</code></li><li><code>dir</code></li><li><code>lang</code></li><li><code>prefer_related_applications</code></li><li><code>related_applications</code></li></ul><p>Once a service worker has been registered, its manifest can be examined in Chrome devtools by clicking the &quot;Application&quot; tab and clicking &quot;Manifest&quot; in the left nav.</p><h2 id="generating-icons" tabindex="-1">Generating Icons</h2><p>The Node package <a href="https://github.com/elegantapp/pwa-asset-generator?v=1.1.1" rel="noopener" target="_blank">pwa-asset-generator</a> generates all the icons required by a PWA from a single image file. To use this:</p><ul><li>Create the file <code>public/images/logo.png</code>.</li><li>Enter <code>bunx pwa-asset-generator public/images/logo.png public/icons</code>.</li><li>This will generate many images files in the <code>public/icons</code> directory.</li><li>Copy the JSON array this outputs and paste it into <code>manifest.json</code> as the value of the <code>icons</code> property.</li><li>Remove &quot;public/&quot; from the beginning of each icon <code>src</code> value.</li></ul><h3 id="storage-limits" tabindex="-1">Storage Limits</h3><p>There is a limit to the amount of data each application domain can cache and a limit to the amount of data that can be cached across all domains. The limits differ across web browsers, but are mostly consistent for Chrome, Edge, and Firefox. The limit for a single domain is 20% of the overall limit. Typically the limits are based on the available space as shown in the following table.</p><table><thead><tr><th>Available Space</th><th>Total Cache Limit</th></tr></thead><tbody><tr><td>up to 8 GB</td><td>50 MB</td></tr><tr><td>8 to 32 GB</td><td>500 MB</td></tr><tr><td>32 to 128 GB</td><td>4% of volume size</td></tr><tr><td>over 128 GB</td><td>smaller of 20 GB or 4% of volume size</td></tr></tbody></table><p>Safari is an outlier. It limits each application to 50 MB of cache storage regardless of the available space, and it purges this after two weeks of not being used. An alternative is to use IndexedDB, which has a limit of 500 MB per application domain in Safari.</p><p>When the total limit is reached, some browsers (Chrome and Firefox) remove the least recently used caches to make room for new caches.</p><h2 id="evaluating-readiness" tabindex="-1">Evaluating Readiness</h2><p>To determine if a web app can be used as a PWA:</p><ul><li>Use a desktop computer or laptop to open the app in the Chrome web browser.</li><li>Open the DevTools.</li><li>Click on the &quot;Lighthouse&quot; tab.</li><li>Click the &quot;Analyze page load&quot; button.</li><li>Click the &quot;Progressive Web App&quot; circle and address any issues identified.</li></ul><h3 id="message-passing" tabindex="-1">Message Passing</h3><p>Service Workers do not have access to the DOM of their associated web app, so they cannot directly change what is rendered in the browser. However, they can communicate with the web app via message passing. The <code>Worker</code> <code>postMessage</code> method is used to send a message from a web worker to the web app or from the web app to a web worker.</p><p>For example, the following sequence of events can occur:</p><ul><li>web app posts a message to a service worker</li><li>service worker sends a request to an API endpoint to fetch data</li><li>service worker posts a message to the web app to send it some of the fetched data</li><li>web app updates the DOM using the received data</li></ul><p>TODO: Implement message passing between a page and a service worker and in the other direction. Then document the required code here.</p><h2 id="caching-strategies" tabindex="-1">Caching Strategies</h2><p>Services workers can implement many caching strategies, perhaps based on the kinds of resources that will be requested. Resources can be files with content such as HTML, CSS, JavaScript, JSON, and image data. Resources can also be the results of API calls.</p><p>The diagram below is helpful in describing the various caching strategies. The descriptions below refer to the letters in this diagram.</p><p><img alt="Service Workers" style="border: 0; width: 60%" src="/blog/assets/service-workers.png?v=1.1.1" title="Service Workers"></p><p>Possible caching strategies include:</p><ul><li><p>Network Only</p><p>This strategy is applicable when using cached versions of a resource is unacceptable. For example, a banking app might decide it is better to let the user know when they are offline and not show stale data.</p><p>All resource requests are forwarded to the network, and only resources obtained from the network are returned. No caching is used. In the diagram above, this is represented by the path A-B-C-F.</p></li><li><p>Cache Only</p><p>This strategy is applicable for resources that never change or that change very rarely. Examples include a CSS file that defines site styling or an image file for a company logo.</p><p>The service worker is responsible for initially populating the caches and thereafter only returns resources from the caches. Resource requests are never forwarded to the network. In the diagram above, this is represented by the path A-D-E-F.</p></li><li><p>Network or Cache</p><p>This strategy is applicable when having the latest data is preferred, but it is acceptable to use previously fetched data. For example, a site that reports basketball scores prefers to show the latest scores, but showing the last known scores is better than showing no scores.</p><p>Resource requests are first forwarded to the network. If a response is obtained from the network, that is returned. Then the cache is updated with the response, so it can be used again later if the same resource is requested while offline. If no response is obtained from the network and a previously cached response is available, that is returned. In the diagram above, this is represented by the path A-B-C-(D-E)-F where steps D and E are optional.</p><p>The following service worker code implements this strategy.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'pwa-demo'</span><span class="token punctuation">;</span><br><br><span class="token comment">// No fetch events are generated in the initial load of the web app.</span><br><span class="token comment">// A second visit (or refresh) is required to cache all the resources.</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span><br>    <span class="token keyword">let</span> resource<span class="token punctuation">;</span><br><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Get from network.</span><br>      <span class="token comment">// Note that resources coming from a local HTTP server</span><br>      <span class="token comment">// can be fetched even when offline.</span><br>      <span class="token comment">// To use cached versions of those, stop the local HTTP server.</span><br>      resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from network'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token comment">// Save in cache for when we are offline later.</span><br>      <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker cached'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Get from cache.</span><br>      resource <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> resource<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Cache and Update</p><p>This strategy is applicable when fast responses are prioritized over having the latest data. It’s difficult to think of a case when this strategy might be preferred, but the next strategy augments this to make it more applicable.</p><p>If the requested resource is available in a cache, that is returned. Then the request is forwarded to the network to obtain an up-to-date value. If the network returns a different value, the cache is updated so the next request for the same resource will receive the updated value. This is great for performance but has the downside of potentially using stale data. In the diagram above, this is represented by the path A-D-E-F-B-C-D.</p><p>The following service worker code implements this strategy.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'pwa-demo-v1'</span><span class="token punctuation">;</span><br><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">deleteOldCaches</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> keyList <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><br>      keyList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> cacheName <span class="token operator">?</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// No fetch events are generated in the initial load of the web app.</span><br><span class="token comment">// A second visit is required to cache all the resources.</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span><br>    <span class="token keyword">let</span> resource<span class="token punctuation">;</span><br><br>    <span class="token comment">// Get from cache.</span><br>    resource <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Get from network.</span><br>        resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from network'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Save in cache for when we are offline later.</span><br>        <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker cached'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service worker failed to get'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> resource<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Cache, Update, and Refresh</p><p>This strategy starts the same way as the &quot;cache and update&quot; strategy, but after new data is received from the network, the UI is triggered to refresh using the new data.</p><p>For example, a theatre website might use this approach to quickly display the known shows and ticket availability from the cache. As soon as new data becomes available, it can update this information in the browser.</p></li><li><p>Embedded Fallback</p><p>In this strategy, the service worker provides default responses for cases when the resource cannot be obtained from the network or a cache. For example, a service worker that returns photos of specific dogs can return stock images that match the breeds of requested dogs when the requested photos are unavailable. This, of course, assumes that the stock images have already been cached.</p><p>This strategy can be employed as a supplement to the previously described strategies to provide an alternative to returning a &quot;Not Found&quot; (404) status.</p><p>The following service worker code implements this strategy.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'pwa-demo-v1'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> filesToCache <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token comment">// need in order to hit web app with domain only</span><br>  <span class="token string">'/demo.css'</span><span class="token punctuation">,</span><br>  <span class="token string">'/demo.js'</span><span class="token punctuation">,</span><br>  <span class="token string">'/images/avatar.jpg'</span><span class="token punctuation">,</span><br>  <span class="token string">'/images/birthday-192.jpg'</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">deleteOldCaches</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> keyList <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><br>      keyList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> cacheName <span class="token operator">?</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">cacheAll</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>filesToCache<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">cacheAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// No fetch events are generated in the initial load of the web app.</span><br><span class="token comment">// A second visit is required to cache all the resources.</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span><br>    <span class="token keyword">const</span> isAvatar <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'githubusercontent.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> resource<span class="token punctuation">;</span><br><br>    <span class="token comment">// Get from cache.</span><br>    resource <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Get from network.</span><br>        resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'from network'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAvatar<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token comment">// Save in cache for when we are offline later.</span><br>          <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker cached'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAvatar<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker using generic avatar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          resource <span class="token operator">=</span> Response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/images/avatar.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service worker failed to get'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> resource<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul><h2 id="offline-support" tabindex="-1">Offline Support</h2><p>Web applications can determine whether they currently have network connectivity by checking the value of <code>navigator.onLine</code>. It's odd that the &quot;L&quot; is uppercase since &quot;online&quot; is a word!</p><p>For some web applications it is possible to define a subset of functionality that can be supported for offline use and then only cache resources related to that. For example, a todo app can cache the latest todo items so they can be displayed, but disallow adding, modifying, and deleting todo items while offline.</p><p>For some web applications it is acceptable to accumulate transactions when offline and execute them later when online again. For example, suppose a time sheet web app allows users to enter the hours they worked on various projects. If network connectivity is lost, the app can save the hours entered in a cache. When connectivity is restored, it can read data from the cache, make the appropriate API calls to save it on a server, and delete the data from the cache.</p><p>This can be challenging to implement due to special cases that must be considered. For example, what should be done in the time sheet app if we are saving hours for a project that has been deleted by someone else after network connectivity was lost for the user that entered the hours? Perhaps the new hours should just be ignored, or perhaps the project should be recreated and the hours should be applied to it. There can be many such cases to consider.</p><h2 id="service-worker-events" tabindex="-1">Service Worker Events</h2><p>Service workers listen for events and act on them.</p><h3 id="install-event" tabindex="-1">install Event</h3><p>The first event received is <code>install</code>. This is a one-time event. One way to handle this event is to do the following:</p><ul><li>Open a cache whose name is <code>cache</code> concatenated with the value of the <code>timestamp</code> variable. If this cache does not exist, it is created.</li><li>Add some files to the cache that will always be served from the cache. They will be available without a network connection after the app is initially loaded from the network.</li></ul><h3 id="activate-event" tabindex="-1">activate Event</h3><p>The second event received is <code>activate</code>. This is also a one-time event. One way to handle this event is to delete any old caches for this app that were created when previous builds of the app were run. This can be determined by checking whether their names contain the current value of the <code>timestamp</code> variable.</p><h3 id="message-event" tabindex="-1">message Event</h3><p>A <code>message</code> event occurs when a controlled page calls <code>ServiceWorker.postMessage(message)</code> to send a message to a specific service worker. The service worker can optionally send a response back by calling <code>Client.postMessage(message)</code>.</p><h3 id="fetch-event" tabindex="-1">fetch Event</h3><p>The third event type received is <code>fetch</code>. This can be received many times. The caching strategy is implemented here. One way to handle this event is to evaluates each request using the following steps in this sequence:</p><ul><li>Only process <code>GET</code> requests.</li><li>Don’t process requests asking for just part of a document, using an HTTP &quot;Range&quot; header (not commonly used).</li><li>Only process URLs with a protocol beginning with &quot;http&quot;. For example, URLs with the &quot;data&quot; protocol are ignored.</li><li>Serve all static files from the cache.</li><li>If the file is not found in the cache and the request has a <code>cache</code> property of <code>only-if-cached</code>, don't attempt to find the file using the network.</li><li>Otherwise, attempt to satisfy the request using the network.</li><li>If found, add the file to the cache and return its contents.</li><li>If not found and a match for the URL is in the cache, return that content.</li></ul><p>This caching strategy means that the results of API service calls are cached. Later, if the same request is made again and the service is offline, the cached value will be returned.</p><h3 id="sync-event" tabindex="-1">sync Event</h3><p>This event is used to determine when data can be synchronized between a web page and service worker. It relies on a <code>SyncManager</code> which is experimental. It is supported by Chrome and Edge, but not by Safari or Firefox.</p><h3 id="push-event" tabindex="-1">push Event</h3><p>A <code>push</code> event occurs when a push notification is received. TODO: Try implementing push notifications.</p><h2 id="running-and-installing-a-pwa" tabindex="-1">Running and Installing a PWA</h2><p>To run a PWA, browse its URL. This can be done by clicking a link received in an email or chat message. It can also be done by searching for the app in web browser or manually entering the URL in the browser location bar.</p><p>Installing a PWA is optional. The steps to do so vary based on operating system. In iOS, tap the share button and select &quot;Add to Home Screen&quot;.</p><p>Installing a PWA downloads all the required files. It also adds an app icon to the home screen so in the future the app can be launched by tapping its icon. The app will still run in the mobile web browser, but the app can choose to hide the browser chrome so it appears more like a native app.</p><p>In development, PWA can be run from URLs that being with <code>http://localhost</code>. But in production, PWAs must be run from URLS that use HTTPS in order to utilize service workers.</p><h2 id="security" tabindex="-1">Security</h2><p>When a PWA attempts to access device features, such as contacts or the camera, the user will be prompted to grant permission.</p><h2 id="managing-service-workers" tabindex="-1">Managing Service Workers</h2><p>The Chrome DevTools provide ways to interact with service workers and the caches they create.</p><p>To view service workers for the current site, click the DevTools Application tab. Then click Service Workers in the left nav. The main area will display information about each of the service workers for the site.</p><p><img alt="Service Workers in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-service-workers.png?v=1.1.1" title="Service Workers in Chrome DevTools"></p><p>The status of a service worker is displayed after the Status label. For example, it may say “activated and is running.” To stop the service worker, click the Stop link after the status. The Stop link will change to Start, and this can be clicked to restart it.</p><h3 id="updating-a-service-worker" tabindex="-1">Updating a Service Worker</h3><p>By default, changes to service worker code are not loaded by refreshing the browser.</p><p>Unregistering a service worker allows it to run through its lifecycle again when the page is refreshed. This includes processing the <code>install</code> and <code>activate</code> events again. This is useful for debugging the code that handles those events.</p><p>To unregister a service worker in Chrome, click the &quot;Unregister&quot; link to the right of a service worker description and refresh the page (twice?).</p><p>In Chrome, to enable page refreshes to reload service workers during development, check the &quot;Update on reload&quot; checkbox and refresh the page.</p><p><img alt="Service Workers Update on reload" style="width: 100%" src="/blog/assets/service-workers-update-on-reload.png?v=1.1.1" title="Service Workers Update on reload"></p><p>By default, changes to deployed service workers will not take effect for users until they close all browser tabs that are using the previous service workers and open new tabs.</p><p>To force existing tabs that are browsing a site to activate service worker updates, add the following code in the service worker.</p><pre class="language-js"><code class="language-js">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// This causes a newly installed service worker to</span><br>  <span class="token comment">// progress to the activating state, regardless of</span><br>  <span class="token comment">// whether there is already an active service worker.</span><br>  self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In order for this change to take effect, users must close existing tabs for the site and open a new one. TODO: After this is done, do users have to refresh the page to load service worker updates?</p><h3 id="viewing-source-code" tabindex="-1">Viewing Source Code</h3><p>To view the source code for a service worker, click the link after the Source label. This switches to the Sources tab and displays the code. Typically the code will have been minified.</p><p><img alt="Minimized service worker code in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-service-worker-code-minimized.png?v=1.1.1" title="Minimized service worker code in Chrome DevTools"></p><p>To see a pretty-printed version of this, click the “{}” at the bottom.</p><p><img alt="Pretty-printed service worker code in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-service-worker-code-pretty-printed.png?v=1.1.1" title="Pretty-printed service worker code in Chrome DevTools"></p><h3 id="cached-files" tabindex="-1">Cached Files</h3><p>The list of requested files in the Network tab has a very small gear icon before each file that was loaded from a cache. This is useful for determining whether specific files were served from the network or from a cache.</p><p><img alt="Files loaded from cache in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-network-files-from-cache.png?v=1.1.1" title="Files loaded from cache in Chrome DevTools"></p><p>To see the space being used by the current application domain, click the Application tab and click &quot;Storage&quot; in the left nav. This displays the amount of space currently occupied by cache storage, service workers, and IndexedDB. It also displays a series of check boxes for categories of things hat can be cleared including &quot;Unregistered service workers&quot;, &quot;Local and session storage&quot;, &quot;IndexedDB&quot;, &quot;Web SQL&quot; (deprecated), &quot;Cookies&quot;, and &quot;Cache storage&quot;.</p><p>By default, all the check boxes are checked. Click the &quot;Clear Site Data&quot; button above the checkboxes to clear the data associated with every checked category.</p><p><img alt="Clearing storage in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-clear-storage.png?v=1.1.1" title="Clearing storage in Chrome DevTools"></p><p>A great video covering most of the topics in this section, created by the Chrome team, can be found at <a href="http://mng.bz/oPwp?v=1.1.1" rel="noopener" target="_blank">Debugging Service Workers in Chrome</a>.</p><p>A similar video for Firefox from the same team can be found at <a href="http://mng.bz/nPw2?v=1.1.1" rel="noopener" target="_blank">Debugging Service Workers in Firefox</a>.</p><p>To see the files that have been cached, click the DevTools &quot;Application&quot; tab. Then click the disclosure triangle before &quot;Cache storage&quot; in the left nav. This will show a list of all the current caches for the site in the left nav. Click one of the cache names to see a list of the files that it has cached in the main area. Click a file to see its contents at the bottom of the main area.</p><p><img alt="Cached files in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-cache.png?v=1.1.1" title="Cached files in Chrome DevTools"></p><p>There are several ways to remove an individual file from a cache.</p><ol><li>Right-click a file name and select delete.</li><li>Click a file name to select it and press the Delete key.</li><li>Click a file name to select it and click the “X” at the top.</li></ol><p>To delete an entire cache, right-click a cache name and select Delete.</p><h3 id="clearing-everything" tabindex="-1">Clearing Everything</h3><p>The Chrome Devtools provide a way to clear many things associated with the current application domain with a single click. This includes service worker registrations, local and session storage, IndexedDB databases, cookies, and cached files. To do this, open the DevTools, click the &quot;Application Tab&quot;, click &quot;Storage&quot; near the top of the left nav, verify that all the checkboxes at the bottom are checked, and click the &quot;Clear site data&quot; button.</p><p><img alt="Chrome Clear site data button" style="width: 100%" src="/blog/assets/chrome-clear-site-data.png?v=1.1.1" title="Cached files in Chrome DevTools"></p><h3 id="simulating-offline" tabindex="-1">Simulating Offline</h3><p>In order to test the ability of service workers to use cached files, it is useful to simulate being offline. To do this, open Chrome Devtools, click the &quot;Application&quot; tab, click Service Workers in the left nav, and check the &quot;Offline&quot; check box at the top of the main area. This is an alternative to going to the Network tab and changing the &quot;No throttling&quot; drop-down to &quot;Offline&quot;. A warning icon will appear in the Network tab to remind you that you are offline.</p><p><img alt="Simulating being offline in Chrome DevTools" style="width: 100%" src="/blog/assets/devtools-offline.png?v=1.1.1" title="Simulating being offline in Chrome DevTools"></p><h3 id="bypassing-service-workers" tabindex="-1">Bypassing Service Workers</h3><p>To bypass the use of service workers, causing all requests to go to the network, check the Bypass for Network check box at the top of the main area. This, of course, requires being online.</p><h3 id="service-workers-in-macos-safari" tabindex="-1">Service Workers in macOS Safari</h3><p>To see service workers in Safari, click the &quot;Develop&quot; menu, hover over &quot;Service Workers&quot; to reveal a menu that lists them, and click one of the service workers. This opens a window with three tabs at the top ... &quot;Console&quot;, &quot;Sources&quot;, and &quot;Network&quot;.</p><p>Output from <code>console</code> methods like <code>console.log</code> do not appear in the Web Inspector Console. Instead they appear in the Console tab of the service worker window.</p><p>Safari does not provide an easy way to unregister service workers. To unregister all of them for a given site, browse the site, open the &quot;Web Inspector&quot;, click the &quot;Console&quot; tab, and enter the following code.</p><pre class="language-js"><code class="language-js">navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">getRegistrations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registrations</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> registration <span class="token keyword">of</span> registrations<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    registration<span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To also delete a specific IndexedDB database, enter the following.</p><pre class="language-js"><code class="language-js">indexedDB<span class="token punctuation">.</span><span class="token function">deleteDatabase</span><span class="token punctuation">(</span><span class="token string">'db-name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="service-workers-in-ios-safari" tabindex="-1">Service Workers in iOS Safari</h3><p>The following steps enable debugging PWAs running in iOS Safari.</p><ol><li>Attach the device (iPhone or iPad) to a Mac using a USB cable.</li><li>A &quot;Trust This Computer?&quot; dialog will appear on the device.</li><li>Tap &quot;Trust&quot;.</li><li>Enter the device passcode.</li><li>Launch Safari on the device.</li><li>Browse the URL of a PWA.</li><li>Launch Safari on the Mac.</li><li>Click the &quot;Develop&quot; menu.</li><li>Hover over the device name that appears.</li><li>Click &quot;Use for Development...&quot;</li><li>A &quot;Trust This Computer?&quot; dialog will appear again on the device.</li><li>Tap &quot;Trust&quot; again.</li><li>Enter the device passcode again.</li><li>Click the &quot;Develop&quot; menu again.</li><li>Hover over the device name that appears again.</li><li>If it says &quot;Pairing Denied, Reconnect Device to Continue&quot;, disconnect the USB cable and connect it again.</li><li>Click the &quot;Develop&quot; menu again.</li><li>Hover over the device name that appears again.</li><li>Select the URL of the PWA to open a &quot;Web Inspector&quot; window that can be used to interact with the device and see its output in the Console tab.</li><li>Select ? to open a &quot;Service Worker&quot; window that can be used to interact with the Service Worker running on the device and see its output in this separate Console tab.</li></ol><h2 id="push-notifications" tabindex="-1">Push Notifications</h2><p>Web app client-side code can create subscriptions to push notifications and send them to a server via an HTTP request. The server can save these subscriptions in a database so they are not lost when the server is restarted. Servers can continue sending push notifications to clients even after the browser windows that created the subscriptions have been closed. The messages are queued so if the browser is closed, they can be sent later when the browser is reopened.</p><p>Chrome has excellent support for push notifications. Safari uses a non-standard push notifications API, so supporting both browsers is difficult.</p><p>The app at <a href="https://github.com/mvolkmann/pwa-cloudflare-demo?v=1.1.1" rel="noopener" target="_blank">pwa-cloudflare-demo</a>? whose demonstrates all the steps required to handle push notifications in Chrome. While the name includes &quot;cloudflare&quot;, it does not currently support running in a Cloudflare Worker. The reason is that the app uses the <a href="https://github.com/web-push-libs/web-push?v=1.1.1" rel="noopener" target="_blank">web-push</a> library which does not work in Cloudflare Workers.</p><p>The steps to support push notifications are described below. Each step indicates where the corresponding code is found in the demo app.</p><ol><li><p>Obtain public and private keys</p><p>These are required to send push notifications. One way to obtain them by entering <code>npx web-push generate-vapid-keys</code> or <code>bunx web-push generate-vapid-keys</code>. &quot;vapid&quot; stands for &quot;Voluntary APplication server IDentification&quot;. and is used for Web Push.</p></li><li><p>Create the file <code>.env</code> in the project root directory and copy the keys into it. For example:</p><pre class="language-text"><code class="language-text">WEB_PUSH_PRIVATE_KEY = 'V4kcH_A4Pdv_DmxvxjBU2YIhFcAYBA3_Wp8zLds9ALE'<br>WEB_PUSH_PUBLIC_KEY = 'BMx8QagkN_EidkH7D8jdZaz5BM2Hh-d3RQ5W1iWOfh32KRdbxu7fATv5ozLPUfQasRIZo7JQ6ULGVKgfUX3HO7A'</code></pre></li><li><p>Install the &quot;web-push&quot; package.</p><p>Enter <code>npm install web-push</code> or <code>bun add web-push</code>.</p></li><li><p>Setup use of the &quot;web-push&quot; package.</p><p>For details, see <a href="https://github.com/web-push-libs/web-push?v=1.1.1" rel="noopener" target="_blank">web-push</a>.</p><p>In the main source file that implements the server (<code>src/server.tsx</code>), add the following:</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> webPush <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'web-push'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>webPush<span class="token punctuation">.</span><span class="token function">setVapidDetails</span><span class="token punctuation">(</span><br>  <span class="token string">'mailto:r.mark.volkmann@gmail.com'</span><span class="token punctuation">,</span><br>  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">WEB_PUSH_PUBLIC_KEY</span><span class="token punctuation">,</span><br>  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">WEB_PUSH_PRIVATE_KEY</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Install the SQLite database.</p><p>This will be used to store subscriptions to push notifications. It enables the server to be restarted without losing subscriptions.</p></li><li><p>Create a SQLite database for storing subscriptions.</p><pre class="language-sh"><code class="language-sh">sqlite3 pwa.db<br>sqlite<span class="token operator">></span> create table subscriptions<span class="token punctuation">(</span>id integer primary key autoincrement, json string<span class="token punctuation">)</span><span class="token punctuation">;</span><br>sqlite<span class="token operator">></span> .exit</code></pre></li><li><p>Create the file <code>src/server.tsx</code> containing the following. This file uses TypeScript types. The file extension &quot;tsx&quot; enables using JSX to generate HTML, but that is not utilized in the code shown here.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>Database<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'bun:sqlite'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>Context<span class="token punctuation">,</span> Hono<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>serveStatic<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono/bun'</span><span class="token punctuation">;</span><br><br><span class="token comment">// We cannot use the following import because the web-push package</span><br><span class="token comment">// does not currently work with Cloudflare Workers!</span><br><span class="token comment">// See https://github.com/web-push-libs/web-push/issues/718</span><br><span class="token comment">// and https://github.com/aynh/cf-webpush.</span><br><span class="token comment">// import {serveStatic} from 'hono/cloudflare-workers';</span><br><br><span class="token comment">// Prepare to use a SQLite database.</span><br><span class="token keyword">type</span> <span class="token class-name">DBSubscription</span> <span class="token operator">=</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> json<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Database</span><span class="token punctuation">(</span><span class="token string">'pwa.db'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>create<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> deleteTodoPS <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'delete from subscriptions where id = ?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> getAllSubscriptions <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select * from subscriptions;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> insertSubscription <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><br>  <span class="token string">'insert into subscriptions (json) values (?)'</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Restore previous subscriptions from database.</span><br><span class="token keyword">const</span> dbSubscriptions <span class="token operator">=</span> getAllSubscriptions<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> DBSubscription<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">let</span> subscriptions <span class="token operator">=</span> dbSubscriptions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>dbSub <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dbSub<span class="token punctuation">.</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  subscription<span class="token punctuation">.</span>id <span class="token operator">=</span> dbSub<span class="token punctuation">.</span>id<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> subscription<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> webPush <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'web-push'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>webPush<span class="token punctuation">.</span><span class="token function">setVapidDetails</span><span class="token punctuation">(</span><br>  <span class="token string">'mailto:r.mark.volkmann@gmail.com'</span><span class="token punctuation">,</span><br>  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">WEB_PUSH_PUBLIC_KEY</span><span class="token punctuation">,</span><br>  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">WEB_PUSH_PRIVATE_KEY</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// This demonstrates triggering push notifications from a server.</span><br><span class="token comment">// It sends a new push notification every 5 seconds.</span><br><span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptions<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    count<span class="token operator">++</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      title<span class="token operator">:</span> <span class="token string">'From server.tsx'</span><span class="token punctuation">,</span><br>      body<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">count = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>      icon<span class="token operator">:</span> <span class="token string">'subscribe.png'</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">pushNotification</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * This sends a push notifications to all subscribers.<br> */</span><br><span class="token keyword">function</span> <span class="token function">pushNotification</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptions<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> badSubscriptions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token constant">TTL</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token comment">// max time in seconds for push service to retry delivery</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> subscription <span class="token keyword">of</span> subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// This will fail if the subscription is no longer valid.</span><br>      <span class="token keyword">await</span> webPush<span class="token punctuation">.</span><span class="token function">sendNotification</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> message <span class="token operator">=</span> error<span class="token punctuation">.</span>body <span class="token operator">||</span> error<span class="token punctuation">;</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'server.tsx pushNotification:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      badSubscriptions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> subscription <span class="token keyword">of</span> badSubscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Remove the subscription from the database.</span><br>    deleteTodoPS<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    subscriptions <span class="token operator">=</span> subscriptions<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">=></span> s<span class="token punctuation">.</span>id <span class="token operator">!==</span> subscription<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Serve static files from the public directory.</span><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">,</span> <span class="token function">serveStatic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>root<span class="token operator">:</span> <span class="token string">'./public'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Additional app-specific endpoints can be defined here.</span><br><br><span class="token comment">/**<br> * This endpoint saves a push notification subscription.<br> */</span><br>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/save-subscription'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token keyword">await</span> c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  subscriptions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Save subscriptions in the SQLite database so</span><br>  <span class="token comment">// they are not lost when the server restarts.</span><br>  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  insertSubscription<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> app<span class="token punctuation">;</span></code></pre></li><li><p>Create the file <code>public/setup.js</code> containing the following. This file uses JSDoc comments to specify TypeScript types.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">registerServiceWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// All modern browsers support service workers.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Your browser does not support service workers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Register a service worker for this web app.</span><br>    <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'service-worker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'module'</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'setup.js registerServiceWorker:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token function">registerServiceWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * This asks the user for permission to send push notifications<br> * if they have not already granted or denied this.<br> *<br> * It is recommended to wait to ask for permission until the user has<br> * entered the site is made aware of why they would receive notifications.<br> * Perhaps provide a "Enable Notifications" button that calls this function.<br> */</span><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestNotificationPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> permission <span class="token operator">=</span> <span class="token keyword">await</span> Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">===</span> <span class="token string">'granted'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// service-worker.js listens for this message.</span><br>    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'subscribe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Notifications are disabled.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// Update the UI to reflect the new permission.</span><br>  location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * This can be called by client-side code to send a push notification.<br> * It's debatable whether triggering these from the client-side is useful.<br> * @param {string} title<br> * @param {string} body<br> * @param {string} icon<br> */</span><br><span class="token keyword">function</span> <span class="token function">sendNotification</span><span class="token punctuation">(</span><span class="token parameter">title<span class="token punctuation">,</span> body<span class="token punctuation">,</span> icon</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token punctuation">{</span>body<span class="token punctuation">,</span> icon<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Register to receive messages from the service worker.</span><br><span class="token comment">// These are sent with "client.postMessage" in the service worker.</span><br><span class="token comment">// They are not push notifications.</span><br>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> message <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'ready'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Determine if a service worker is already controlling this page.</span><br>    <span class="token keyword">const</span> haveServiceWorker <span class="token operator">=</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// If not then we must have just installed a new service worker.</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>haveServiceWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Give the new service worker time to really be ready.</span><br>      <span class="token comment">// In some apps it is useful to reload the page so</span><br>      <span class="token comment">// data only available from the service worker can be loaded.</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></li><li><p>Create the file <code>public/service-worker.js</code> containing the following:</p><pre class="language-js"><code class="language-js"><span class="token comment">/// &lt;reference lib="webworker" /></span><br><br><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'pwa-demo-v1'</span><span class="token punctuation">;</span><br><br><span class="token comment">// This value was copied from the .env file.</span><br><span class="token keyword">const</span> publicKey <span class="token operator">=</span><br>  <span class="token string">'BLqlJ1001ZxraUEtFPKGDJTBm8Cmk6i44-mtv8i2p8ReAU8orbyC90zdjeJL-hCRooyPRcQoKBquc4sQ1uIlh0E'</span><span class="token punctuation">;</span><br><br><span class="token comment">// We aren't currently caching .css files and certain .js files</span><br><span class="token comment">// because we want changes to be reflected without clearing the cache.</span><br><span class="token keyword">const</span> fileExtensionsToCache <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'webp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * This converts a base64 string to a Uint8Array.<br> * @param {string} base64String<br> * @returns a Uint8Array<br> */</span><br><span class="token keyword">function</span> <span class="token function">base64StringToUint8Array</span><span class="token punctuation">(</span><span class="token parameter">base64String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Add equal signs to the end so the length is a multiple of 4.</span><br>  <span class="token comment">// See https://base64.guru/learn/base64-characters.</span><br>  <span class="token comment">//</span><br>  <span class="token comment">// The following site says "The base64 Decode converter does not support</span><br>  <span class="token comment">// dash("-") and underscore("_") characters, therefore it is necessary to</span><br>  <span class="token comment">// replace those characters before doing the Base64 decoding.</span><br>  <span class="token comment">// Use "+" instead of "-" and "/" instead of "_"."</span><br>  <span class="token comment">// https://docshield.kofax.com/RPA/en_US/10.6.0_p2wddr4n2j/help/kap_help/reference/c_basedecode.html</span><br>  <span class="token keyword">const</span> padding <span class="token operator">=</span> <span class="token string">'='</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">-</span> <span class="token punctuation">(</span>base64String<span class="token punctuation">.</span>length <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> base64 <span class="token operator">=</span> <span class="token punctuation">(</span>base64String <span class="token operator">+</span> padding<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> binary <span class="token operator">=</span> <span class="token function">atob</span><span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> outputArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    outputArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> outputArray<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * This deletes all the keys from a given cache.<br> * It is not currently used.<br> * @param {string} cacheName<br> * @returns {Promise&lt;void>}<br> */</span><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deleteCache</span><span class="token punctuation">(</span><span class="token parameter">cacheName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// @type {string[]}</span><br>  <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><br>    keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">(</span>key <span class="token operator">===</span> cacheName <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * This attempts to get a resource from the cache.<br> * If it is not found in the cache, it is retrieved from the network.<br> * If it is a kind of resource we want to cache, it is added to the cache.<br> * @param {Request} request<br> * @returns {Promise&lt;Response | undefined>} that contains the resource<br> */</span><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> log <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// set to true for debugging</span><br>  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>href<span class="token punctuation">,</span> pathname<span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">;</span><br><br>  <span class="token comment">// Attempt to get the resource from the cache.</span><br>  <span class="token comment">/** @type {Response | undefined} */</span><br>  <span class="token keyword">let</span> resource <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> href<span class="token punctuation">,</span> <span class="token string">'from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Get the resource from the network.</span><br>      resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker got'</span><span class="token punctuation">,</span> href<span class="token punctuation">,</span> <span class="token string">'from network'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldCache</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Save in the cache to avoid unnecessary future network requests</span><br>        <span class="token comment">// and supports offline use.</span><br>        <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker cached'</span><span class="token punctuation">,</span> href<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service-worker.js getResource:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service worker failed to fetch'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> resource<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * This determines if the current browser is Safari.<br> * @returns {boolean} true if Safari; false otherwise<br> */</span><br><span class="token keyword">function</span> <span class="token function">inSafari</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>userAgent<span class="token punctuation">}</span> <span class="token operator">=</span> navigator<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userAgent<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Safari'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token operator">!</span>userAgent<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * This determines whether the file at a given path should be cached<br> * based on its file extension.<br> * @param {string} pathname<br> * @returns {boolean} true to cache; false otherwise<br> */</span><br><span class="token keyword">function</span> <span class="token function">shouldCache</span><span class="token punctuation">(</span><span class="token parameter">pathname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'setup.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> index <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> extension <span class="token operator">=</span> index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> pathname<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> fileExtensionsToCache<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * This is called when a "subscribe" message is received from setup.js.<br> */</span><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">subscribeToPushNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inSafari</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>      <span class="token string">'service-worker.js: Safari uses a non-standard push notification API that this app does not support.'</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// This fails if the user has not already granted</span><br>    <span class="token comment">// permission to receive push notifications, so only</span><br>    <span class="token comment">// call this function after they grant permission.</span><br>    <span class="token comment">// WARNING: If the "Update on reload" checkbox in the Chrome DevTools</span><br>    <span class="token comment">// Application tab is checked, the following line will not work.</span><br>    <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token keyword">await</span> registration<span class="token punctuation">.</span>pushManager<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      <span class="token literal-property property">applicationServerKey</span><span class="token operator">:</span> <span class="token function">base64StringToUint8Array</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">userVisibleOnly</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// false allows silent push notifications</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Save the subscription on the server so it can</span><br>    <span class="token comment">// send push notifications to this service worker.</span><br>    <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/save-subscription'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service-worker.js subscribeToPushNotifications:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">//-----------------------------------------------------------------------------</span><br><br><span class="token comment">/**<br> * This registers a listener for the "install" event of this service worker.<br> */</span><br><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service-worker.js: installing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// This allows existing browser tabs to use an</span><br>  <span class="token comment">// updated version of this service worker.</span><br>  <span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * This registers a listener for the "activate" event of this service worker.<br> */</span><br><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service-worker.js: activating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// We could choose to delete the current cache every time</span><br>  <span class="token comment">// a new version of the service worker is activated.</span><br>  <span class="token comment">// event.waitUntil(deleteCache(cacheName));</span><br><br>  <span class="token comment">// This gets an estimate for the amount of storage available</span><br>  <span class="token comment">// to this service worker.</span><br>  <span class="token comment">// Safari says "The operation is not supported." for the "estimate" method.</span><br>  <span class="token comment">// const estimate = await navigator.storage.estimate();</span><br>  <span class="token comment">// console.log('service-worker.js: storage estimate =', estimate);</span><br><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Let browser clients know that the service worker is ready.</span><br>    <span class="token keyword">const</span> matches <span class="token operator">=</span> <span class="token keyword">await</span> clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">includeUncontrolled</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> client <span class="token keyword">of</span> matches<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// setup.js listens for this message.</span><br>      client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service-worker.js:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * This registers a listener for the "fetch" event of this service worker.<br> * It responds with a resource for accessing data at a requested URL.<br> */</span><br><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>pathname<span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> match <span class="token operator">=</span> dogRouter<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method<span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> promise <span class="token operator">=</span> match<br>    <span class="token operator">?</span> match<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>match<span class="token punctuation">.</span>params<span class="token punctuation">,</span> request<span class="token punctuation">)</span><br>    <span class="token operator">:</span> <span class="token function">getResource</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * This registers a listener for the "message" event of this service worker.<br> */</span><br><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> message <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span><br>  <span class="token comment">// This message is sent by the "postMessage" call in setup.js.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">subscribeToPushNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service-worker.js: unexpected message ='</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * This registers a listener for the "push" event of this service worker.<br> * One way to test this is to trigger a push from Chrome DevTools.<br> * Click the "Application" tab, click "Service workers" in the left nav,<br> * enter a message in the Push input, and click the "Push" button.<br> * A push notification should appear.<br> * Push notifications automatically disappear after about five seconds.<br> */</span><br><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">'granted'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> title<span class="token punctuation">,</span> body<span class="token punctuation">,</span> icon<span class="token punctuation">;</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// If the event data is JSON, expect it</span><br>      <span class="token comment">// to have title, body, and icon properties.</span><br>      <span class="token keyword">const</span> <span class="token punctuation">{</span>title<span class="token punctuation">,</span> body<span class="token punctuation">,</span> icon<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token punctuation">{</span>body<span class="token punctuation">,</span> icon<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Otherwise assume the event data is text</span><br>      <span class="token comment">// that can be used as the notification title.</span><br>      <span class="token keyword">const</span> title <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'service-worker.js: push permission not granted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ol><p>TODO: Clean up the remaining content in this section.</p><p>To send a push notification ...</p><p>The icon specified in a push notification appears in Chrome, but not in Safari.</p><p>Push notifications can only be sent if users grant permission. It is recommended to wait to ask for permission until the user has entered the site is made aware of why they would receive notifications. Consider providing an &quot;Enable Notifications&quot; button that calls the following function when it is clicked.</p><p>/**</p><ul><li>This asks the user for permission to send push notifications</li><li>if they have not already granted or denied this.</li><li>The choice is remembered by the browser.</li><li>The value will be &quot;granted&quot;, &quot;denied&quot;, or &quot;default&quot; (no choice made). */ async function requestNotificationPermission() { const permission = await Notification.requestPermission(); if (permission === 'granted') { // service-worker.js listens for this message. navigator.serviceWorker.controller.postMessage('subscribe'); } else { alert('Notifications are disabled.'); } // Update the UI to reflect the new permission. location.reload(); }</li></ul><p>Each web browser provides a different wayx for users to enable push notifications.</p><p>To reset back to &quot;default&quot; in Chrome:</p><ul><li>Click the circled &quot;i&quot; on the left end of the address bar.</li><li>Click the &quot;Reset Permissions&quot; button.</li></ul><p><img alt="Chrome Notification Permissions" style="; width: 40%" src="/blog/assets/chrome-notification-permissions.png?v=1.1.1" title="Chrome Notification Permissions"></p><p>To reset back to &quot;default&quot; in Safari:</p><ul><li>Click &quot;Safari&quot; in the menu bar.</li><li>Click &quot;Settings...&quot; in the menu.</li><li>Click &quot;Notifications&quot; in the left nav of the dialog that appears.</li><li>Scroll to the website domain in the main area of the dialog.</li><li>Select it and click the &quot;Remove&quot; button.</li></ul><p><img alt="Safari Notification Permissions" style="; width: 60%" src="/blog/assets/safari-notification-permissions.png?v=1.1.1" title="Safari Notification Permissions"></p><h2 id="workbox" tabindex="-1">Workbox</h2><p><a href="https://web.dev/learn/pwa/workbox?v=1.1.1" rel="noopener" target="_blank">Workbox</a> is a set of open-source libraries that help with implementing PWA caching strategies in service workers.</p><p>The easiest way to use Workbox is to open a terminal, cd to the project root, and enter <code>bunx workbox-cli wizard</code>. This will ask a series of questions about the PWA.</p><p>This will create the file <code>workbox-config.js</code> with content like the following:</p><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">globDirectory</span><span class="token operator">:</span> <span class="token string">'public/'</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">globPatterns</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/*.{js,png,jpg,gif,html,json,css}'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">swDest</span><span class="token operator">:</span> <span class="token string">'public/sw.js'</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">ignoreURLParametersMatching</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^utm_</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^fbclid$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Create the file <code>public/sw.js</code> with content like the following:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>registerRoute<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-routing'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>CacheFirst<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-strategies'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>CacheableResponsePlugin<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-cacheable-response'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> pageStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token comment">// Put all cached files in a cache named 'pages'</span><br>  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'pages'</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token comment">// Only requests that return with a 200 status are cached</span><br>    <span class="token keyword">new</span> <span class="token class-name">CacheableResponsePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      <span class="token literal-property property">statuses</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Cache page navigations (HTML) with a Cache First strategy</span><br><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>request<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> request<span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token string">'navigate'</span><span class="token punctuation">,</span> pageStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>TODO: Describe how to load this service worker from a script!</p><h2 id="resources" tabindex="-1">Resources</h2><ul><li><a href="https://web.dev/explore/progressive-web-apps?v=1.1.1" rel="noopener" target="_blank">web.dev</a> on PWAs</li></ul><p>TODO: For more content, see <a href="https://github.com/mvolkmann/pwa-demo/blob/master/pwa.md">https://github.com/mvolkmann/pwa-demo/blob/master/pwa.md</a>.</p><p>See demo app at <a href="https://github.com/mvolkmann/pwa-cloudflare-demo">https://github.com/mvolkmann/pwa-cloudflare-demo</a>.</p><h2 id="outstanding-questions" tabindex="-1">Outstanding Questions</h2><p>Demonstrate sending messages between the app and a service worker.</p><p>How can mobile clients get app updates without restarting the app?</p><p>Do push notifications work in iOS now?</p><p>Should you use the workbox and workbox-cli libraries to simplify service worker code?</p></article>