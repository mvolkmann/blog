<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Cloudflare Workers</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#projects">Projects</a></li><li><a href="#wrangler">Wrangler</a></li><li><a href="#using-hono">Using Hono</a><ol><li><a href="#src%2Findex.ts">src/index.ts</a></li><li><a href="#src%2Fdog-router.ts">src/dog-router.ts</a></li></ol></li><li><a href="#viewing-workers">Viewing Workers</a></li><li><a href="#kv-stores">KV Stores</a></li><li><a href="#htmx">htmx</a></li></ol></nav></aside><article><style>img {
    border: 1px solid gray;
  }</style><p><img alt="Hono logo" style="border: none; width: 30%" src="/blog/assets/cloudflare-workers-logo.svg?v=1.1.1" title="Hono logo"></p><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://workers.cloudflare.com?v=1.1.1" rel="noopener" target="_blank">Cloudflare Workers</a> host edge functions.</p><p>Features provided include:</p><ul><li><p>automatic scaling</p><p>There is no need to configure auto-scaling or load balancers.</p></li><li><p>high performance global network</p><p>Cloudflare workers run in a network of data centers that use V8 isolates that have very low latency (approximately 25ms in my testing).</p></li><li><p>write in a variety of programming languages, including JavaScript, TypeScript, Rust, C, and C++.</p></li><li><p>run instantly without cold starts</p></li><li><p>affordable</p><p>The first 100,000 requests each day are free. After that the cost is $5 USD per 10 million requests.</p></li><li><p>no servers to maintain</p></li><li><p>provides edge storage of static assets using &quot;Workers KV&quot;</p></li><li><p>can generate assets at runtime, including images, SVGs, PDFs, and more</p></li></ul><h2 id="projects" tabindex="-1">Projects</h2><p>To create a new project that uses Hono, enter <code>npm create cloudflare -- {app-name}</code>. This will prompt for:</p><ul><li><p>Need to install the following packages: ... Ok to proceed?</p></li><li><p>In which directory do you want to create you application?</p></li><li><p>What type of application do you want to execute?</p><ul><li>&quot;Hello World&quot; Worker   - Website or web app    - Example router &amp; proxy Worker    - Scheduled Worker (Cron Trigger)    - Queue consumer &amp; producer Worker    - ChatGPT plugin    - OpenAPI 3.1</li></ul></li><li><p>Do you want to use TypeScript?</p></li><li><p>Do you want to use git for version control?</p></li><li><p>Do you want to deploy your application?</p><p>This will open a browser window where you can sign up for an account or log in if you already have an account. You will also be prompted in a browser window to allow &quot;wrangler&quot; to make changes in your account.</p></li></ul><p>If you chose to deploy the application, it will be opened in a new browser window.</p><p>When it finishes, the target directory will be created and will contain the following files:</p><ul><li><code>node_modules</code> directory</li><li><code>package.json</code></li><li><code>package-lock.json</code></li><li><code>src/index.ts</code></li><li><code>tsconfig.json</code></li><li><code>wrangler.toml</code></li></ul><p>To start a local server, enter <code>npm run dev</code>.</p><p>To see the app, browse localhost:8787. The server provides hot reloading of only itself, not the web browser.</p><p>To deploy app again after making local changes, enter <code>npm run deploy</code>.</p><h2 id="wrangler" tabindex="-1">Wrangler</h2><p>The <code>wrangler</code> command supports creating, testing, and deploying Cloudflare Worker apps. To install it globally, enter <code>npm install -g wrangler</code>.</p><p>TODO: Is direct use of this command deprecated?</p><h2 id="using-hono" tabindex="-1">Using Hono</h2><p>This section walks through creating a Cloudflare Worker project that uses <a href="https://hono.dev/?v=1.1.1" rel="noopener" target="_blank">Hono</a> for request routing.</p><ul><li><p>Create a new project named &quot;hono-dogs&quot; as described above.</p></li><li><p>Install Hono dependencies by entering the following commands:</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hono`<br><span class="token function">npm</span> <span class="token function">install</span> @hono/zod-validator</code></pre></li><li><p>Make the following modifications in <code>tsconfig.json</code>:</p><pre class="language-json"><code class="language-json"><span class="token property">"jsx"</span><span class="token operator">:</span> <span class="token string">"react-jsx"</span><span class="token punctuation">,</span><br><span class="token property">"jsxImportSource"</span><span class="token operator">:</span> <span class="token string">"hono/jsx"</span><span class="token punctuation">,</span></code></pre></li><li><p>Create the two files described below:</p></li><li><p>Test the site locally.</p><p>Start a local server by entering <code>npm run dev</code>. Browse localhost:8787/dog to see a JSON object describing dogs.</p></li><li><p>Deploy the app by entering <code>npm run deploy</code>.</p><p>The URL will be output after the line that begins with &quot;Published&quot;.</p></li></ul><h3 id="src%2Findex.ts" tabindex="-1">src/index.ts</h3><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>Hono<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> dogRouter <span class="token keyword">from</span> <span class="token string">'./dog-router'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> c <span class="token operator">=></span> c<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/dog'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/dog'</span><span class="token punctuation">,</span> dogRouter<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> app<span class="token punctuation">;</span></code></pre><h3 id="src%2Fdog-router.ts" tabindex="-1">src/dog-router.ts</h3><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>Hono<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">Context</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>z<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'zod'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>zValidator<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@hono/zod-validator'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">interface</span> <span class="token class-name">NewDog</span> <span class="token punctuation">{</span><br>  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><br>  breed<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">interface</span> <span class="token class-name">Dog</span> <span class="token keyword">extends</span> <span class="token class-name">NewDog</span> <span class="token punctuation">{</span><br>  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">let</span> lastId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><br><span class="token comment">// The dogs are maintained in memory.</span><br><span class="token keyword">const</span> dogMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token operator">:</span> Dog<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">addDog</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> breed<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> Dog <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token operator">++</span>lastId<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> breed<span class="token punctuation">}</span><span class="token punctuation">;</span><br>  dogMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> dog<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> dog<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">addDog</span><span class="token punctuation">(</span><span class="token string">'Comet'</span><span class="token punctuation">,</span> <span class="token string">'Whippet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">addDog</span><span class="token punctuation">(</span><span class="token string">'Oscar'</span><span class="token punctuation">,</span> <span class="token string">'German Shorthaired Pointer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// This gets all the dogs as either JSON or HTML.</span><br><span class="token keyword">const</span> getAllRoute <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>dogMap<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// This gets one dog by its id as JSON.</span><br><span class="token keyword">const</span> idSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  id<span class="token operator">:</span> z<span class="token punctuation">.</span>coerce<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> idValidator <span class="token operator">=</span> <span class="token function">zValidator</span><span class="token punctuation">(</span><span class="token string">'param'</span><span class="token punctuation">,</span> idSchema<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> getOneRoute <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> idValidator<span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> dog <span class="token operator">=</span> dogMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span><br>  c<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>dog <span class="token operator">?</span> <span class="token number">200</span> <span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>dog<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// This creates a new dog.</span><br><span class="token keyword">const</span> dogSchema <span class="token operator">=</span> z<br>  <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    id<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    name<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    breed<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// no extra properties allowed</span><br><span class="token keyword">const</span> dogValidator <span class="token operator">=</span> <span class="token function">zValidator</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">,</span> dogSchema<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> createRoute <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> dogValidator<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> NewDog<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token function">addDog</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">,</span> data<span class="token punctuation">.</span>breed<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  c<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>dog<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// This updates the dog with a given id.</span><br><span class="token keyword">const</span> updateRoute <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><br>  <span class="token string">'/:id'</span><span class="token punctuation">,</span><br>  idValidator<span class="token punctuation">,</span><br>  dogValidator<span class="token punctuation">,</span><br>  <span class="token keyword">async</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> NewDog<span class="token punctuation">;</span><br>    <span class="token keyword">const</span> dog <span class="token operator">=</span> dogMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dog<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      dog<span class="token punctuation">.</span>name <span class="token operator">=</span> data<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br>      dog<span class="token punctuation">.</span>breed <span class="token operator">=</span> data<span class="token punctuation">.</span>breed<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    c<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>dog <span class="token operator">?</span> <span class="token number">200</span> <span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>dog<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// This deletes the dog with a given id.</span><br><span class="token keyword">const</span> deleteRoute <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> idValidator<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> dog <span class="token operator">=</span> dogMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dog<span class="token punctuation">)</span> <span class="token keyword">delete</span> dogMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span><br>  c<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>dog <span class="token operator">?</span> <span class="token number">200</span> <span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">CreateType</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> createRoute<span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">DeleteType</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> deleteRoute<span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">GetAllType</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> getAllRoute<span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">GetOneType</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> getOneRoute<span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">UpdateType</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> updateRoute<span class="token punctuation">;</span></code></pre><h2 id="viewing-workers" tabindex="-1">Viewing Workers</h2><p>To view your workers, browse <a href="https://cloudflare.com">https://cloudflare.com</a>.</p><p>Login to see the dashboard page.</p><p>Click &quot;Workers &amp; Pages&quot; in the left nav to display a list of the deployed workers.</p><p>For each worker, the number of requests sent to it and the number of errors logged will be displayed.</p><p>Click a worker to see detail about it, including its deployed URL.</p><h2 id="kv-stores" tabindex="-1">KV Stores</h2><p>TODO: Document how to use these. TODO: Can you store the map of dogs for your demo in a KV store?</p><p>See <a href="https://developers.cloudflare.com/workers/wrangler/migration/v1-to-v2/wrangler-legacy/commands/#kv">https://developers.cloudflare.com/workers/wrangler/migration/v1-to-v2/wrangler-legacy/commands/#kv</a>.</p><h2 id="htmx" tabindex="-1">htmx</h2><p>A complete web app developed with htmx could be deployed to a Cloudflare Worker! TODO: Try this!</p></article>