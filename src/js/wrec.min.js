class WrecError extends Error{}const CSS_PROPERTY_RE=/([a-zA-Z-]+)\s*:\s*([^;}]+)/g,FIRST_CHAR="a-zA-Z_$",OTHER_CHAR="a-zA-Z_$0-9",IDENTIFIER=`[a-zA-Z_$][${OTHER_CHAR}]*`,HTML_COMMENT_TEXT_RE=/<!--\s*(.*?)\s*-->/,HTML_ELEMENT_TEXT_RE=/<(\w+)(?:\s[^>]*)?>((?:[^<]|<(?!\w))*?)<\/\1>/g,REF_RE=new RegExp(`^this\\.${IDENTIFIER}$`),REFS_RE=new RegExp(`this\\.${IDENTIFIER}(\\.${IDENTIFIER})*`,"g"),REFS_TEST_RE=new RegExp(`this\\.${IDENTIFIER}(\\.${IDENTIFIER})*`),SKIP=5;export function createElement(t,e,s){const r=document.createElement(t);if(e)for(const[t,s]of Object.entries(e))r.setAttribute(t,s);return s&&(r.innerHTML=s),r}const defaultForType=t=>t===String?"":t===Number?0:t!==Boolean&&(t===Array?[]:t===Object?{}:void 0);function getElementById(t,e){if(t.id===e)return t;const{shadowRoot:s}=t;if(s)for(const t of Array.from(s.children)){const s=getElementById(t,e);if(s)return s}for(const s of Array.from(t.children)){const t=getElementById(s,e);if(t)return t}return null}const getPropName=t=>t.substring(5).split(".")[0];function interpolate(t,e){let s=t[0];return e.forEach((e,r)=>{s+=e+t[r+1]}),s}function isPrimitive(t){const e=typeof t;return"string"===e||"number"===e||"boolean"===e}const removeHtmlComments=t=>t.replace(/<!--[\s\S]*?-->/g,"");function replace(t,e,s,r){return t.slice(0,e)+r+t.slice(e+s)}function stringToNumber(t){const e=Number(t);if(isNaN(e))throw new WrecError(`Cannot convert "${t}" to a number.`);return e}function updateAttribute(t,e,s){if(isPrimitive(s)&&"boolean"!=typeof s){t.getAttribute(e)!==s&&t.setAttribute(e,String(s))}else{t[Wrec.getPropName(e)]=s}}function updateValue(t,e,s){t instanceof CSSRule?t.style.setProperty(e,s):updateAttribute(t,e,s)}class Wrec extends HTMLElement{static#t=new Map;static#e=new Map;static#s=new Map;static css="";static html="";static formAssociated=!1;static properties={};static propToComputedMap=null;static propToExprsMap=null;static template=null;#r=this.constructor;#o=new Map;#n;#i=null;#a=new Map;#c=new Map;#p=new Map;constructor(){super(),this.attachShadow({mode:"open"});const t=this.#r;t.properties||(t.properties={}),t.propToComputedMap||(t.propToComputedMap=new Map),t.propToExprsMap||(t.propToExprsMap=new Map),t.formAssociated&&(this.#i=this.attachInternals(),this.#n=new FormData,this.#i.setFormValue(this.#n))}attributeChangedCallback(t,e,s){const r=Wrec.getPropName(t),o=this.#l(r,String(s));this[r]=o,this.#h(r,String(o)),this.propertyChangedCallback(r,e,s)}#u(t,e,s,r){t.addEventListener(r,t=>{const s=t.target,{value:r}=s,{type:o}=this.#r.properties[e];this[e]=o===Number?stringToNumber(r):r});let o=this.#a.get(e);o||(o=[],this.#a.set(e,o)),o.push(s?{element:t,attrName:s}:t)}#f(){const t=this.#r;let e=t.template;if(!e){e=t.template=document.createElement("template");let s=t.css?`<style>${t.css}</style>`:"";s+=t.html,e.innerHTML=s}this.shadowRoot?.replaceChildren(e.content.cloneNode(!0))}changed(t,e,s,r){const o=`${t.toString()}:${e}`,n=this.#p.get(o);n&&(this[n]=r)}connectedCallback(){this.#m(),this.#d(),this.#f(),requestAnimationFrame(()=>{this.shadowRoot&&(this.#E(this.shadowRoot),this.#g(this.shadowRoot),Wrec.#T()),this.#b()})}#b(){const t=this.#r,{properties:e}=t;for(const[t,{computed:s}]of Object.entries(e))s&&(this[t]=this.#y(s))}static dataForId(t){const e=crypto.randomUUID();return Wrec.#e.set(e,t),e}#d(){const t=this.#r,{observedAttributes:e,properties:s}=t;for(const[t,r]of Object.entries(s))this.#R(t,r,e)}#R(t,e,s){const r=Wrec.getAttrName(t),o=this.hasAttribute(r);e.required&&!o&&this.#M(this,t,"is a required attribute");const{type:n,value:i}=e,a=n===Boolean?i||o:s.includes(r)&&o?this.#C(t,r):i||defaultForType(n),c="#"+t;this[c]=a,e.computed&&this.#P(t,e),Object.defineProperty(this,t,{enumerable:!0,get(){return this[c]},set(s){n===Number&&"string"==typeof s&&(s=stringToNumber(s));const o=this[c];if(s===o)return;this.#v(t,n,s),this[c]=s;const{state:i,stateProp:a}=this.#r.properties[t];a&&(i[a]=s),this.#x(t),this.#S(t,n,s,r),this.#A(t),this.#N(t,s),isPrimitive(s)&&this.#h(t,s),this.propertyChangedCallback(t,o,s),e.dispatch&&this.dispatch("change",{propName:t})}})}disconnectedCallback(){this.#o.clear(),this.#c.clear(),this.#p.clear()}dispatch(t,e){this.dispatchEvent(new CustomEvent(t,{bubbles:!0,composed:!0,detail:e}))}displayIfSet(t,e="block"){return`display: ${t?e:"none"}`}static elementName(){return this.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}#w(t){const e=t instanceof Wrec;for(const s of t.getAttributeNames()){const r=t.getAttribute(s),o=this.#I(t,r);if(o){const r=this[o];void 0===r&&this.#$(t,s,o),t[o]=r;let[n,i]=s.split(":");if("value"===n){if(i){if(void 0===t["on"+i]){const e="refers to an unsupported event name";this.#M(t,s,e)}t.setAttribute(n,this[o])}else i="change";this.#u(t,o,n,i)}e&&t.#c.set(Wrec.getPropName(n),o)}this.#_(r,t,s)}}#y(t){return new Function("return "+t).call(this)}#F(t){const{localName:e}=t;if("style"===e){const{sheet:e}=t,s=e?.cssRules??[],r=Array.from(s);for(const t of r)if(t.constructor===CSSStyleRule){const e=Array.from(t.style);for(const s of e)if(s.startsWith("--")){const e=t.style.getPropertyValue(s);this.#_(e,t,s)}}}else{let s="";if("textarea"===e){const e=t.textContent?.match(HTML_COMMENT_TEXT_RE);e&&(s=e[1])}else{const e=Array.from(t.childNodes).find(t=>t.nodeType===Node.COMMENT_NODE);e&&(s=e.textContent?.trim()??"")}if(s){const r=this.#I(t,s);"textarea"===e&&r?(this.#u(t,r,null,"change"),t.textContent=this[r]):this.#_(s,t)}}}static getAttrName(t){let e=Wrec.#s.get(t);return e||(e=t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),Wrec.#s.set(t,e)),e}static getPropName(t){let e=Wrec.#t.get(t);return e||(e=t.replace(/-([a-z])/g,(t,e)=>e.toUpperCase()),Wrec.#t.set(t,e)),e}#g(t){const e=Array.from(t.querySelectorAll("*"));for(const t of e)this.#w(t),t.firstElementChild||this.#F(t)}static get observedAttributes(){return Object.keys(this.properties||{}).map(Wrec.getAttrName)}propertyChangedCallback(t,e,s){}#I(t,e){if(!e||!REF_RE.test(e))return;const s=getPropName(e);return void 0===this[s]&&this.#$(t,"",s),s}#A(t){const e=this.#r.propToExprsMap.get(t)||[];for(const t of e){const e=this.#y(t),s=this.#o.get(t)??[];for(const t of s)t instanceof HTMLElement?this.#L(t,e):t instanceof CSSStyleRule||updateValue(t.element,t.attrName,e)}requestAnimationFrame(()=>{this.#W(t)})}static register(){const t=this.elementName();customElements.get(t)||customElements.define(t,this)}#P(t,e){const{computed:s,uses:r}=e,o=this.#r.propToComputedMap;function n(e,s){let r=o.get(e);r||(r=[],o.set(e,r)),r.push([t,s])}const i=s.match(REFS_RE)||[];for(const e of i){const r=e.substring(5);void 0===this[r]&&this.#$(null,t,r),"function"!=typeof this[r]&&n(r,s)}if(r)for(const t of r.split(","))n(t,s)}#_(t,e,s=void 0){if(!t)return;const r=this.#O(e,s,t);if(!r){const r=t.replaceAll("this..","this.");return void(s?updateValue(e,s,r):"textContent"in e&&(e.textContent=r))}const o=this.#r;r.forEach(e=>{const s=getPropName(e);if("function"==typeof this[s])return;const r=o.propToExprsMap;let n=r.get(s);n||(n=[],r.set(s,n)),n.includes(t)||n.push(t)});for(const[t,e]of this.#o.entries())for(const s of e){const r=s instanceof HTMLElement||s instanceof CSSStyleRule?s:s.element;r instanceof CSSStyleRule||(r.isConnected||this.#o.set(t,e.filter(t=>t!==s)))}let n=this.#o.get(t);n||(n=[],this.#o.set(t,n)),n.push(s?{element:e,attrName:s}:e);const i=this.#y(t);s?updateValue(e,s,i):this.#L(e,i)}#h(t,e){this.#n&&(this.#n.set(t,e),this.#i?.setFormValue(this.#n))}static#T(){for(const[t,e]of Wrec.#e.entries()){const s=getElementById(document.body,t);if(s)for(const[t,r]of Object.entries(e))s[t]=r}}#M(t,e,s){const r=this.#r,o=t instanceof HTMLElement?t.localName:"CSS rule";throw new WrecError(`component ${r.elementName()}`+(t?`, element "${o}"`:"")+(e?`, attribute "${e}"`:"")+` ${s}`)}#$(t,e,s){this.#M(t,e,`refers to missing property "${s}"`)}#C(t,e){return this.#l(t,this.getAttribute(e))}#l(t,e){if(e?.match(REFS_RE))return e;const s=this.#r,{type:r}=s.properties[t];return r||this.#M(null,t,"does not specify its type"),r===String?e:r===Number?stringToNumber(e):r===Boolean?"true"===e||"false"!==e&&"null"!==e&&(e&&e!==t&&this.#M(null,t,"is a Boolean attribute, so its value must match attribute name or be missing"),e===t):void 0}#S(t,e,s,r){if(isPrimitive(s)&&this.hasAttribute(r)){s!==(e===Boolean?this.hasAttribute(r):this.#C(t,r))&&updateAttribute(this,t,s)}}#W(t){const e=this[t],s=this.#a.get(t)||[];for(const t of s)if(t instanceof HTMLElement)"textarea"===t.localName?t.value=e:t.textContent=e;else if(t instanceof CSSStyleRule);else{const{element:s,attrName:r}=t;if(s instanceof HTMLElement){s[Wrec.getPropName(r)]=e}else s instanceof CSSStyleRule&&s.style.setProperty(r,e)}}#x(t){const e=this.#r.propToComputedMap.get(t)||[];for(const[t,s]of e)this[t]=this.#y(s)}#L(t,e){if(void 0===e)return;const s=t instanceof HTMLElement,r=s?t.localName:"",o=typeof e;"string"!==o&&"number"!==o&&this.#M(t,void 0," computed content is not a string or number"),"textarea"===r?t.value=e:s&&"string"===o&&e.trim().startsWith("<")?(t.innerHTML=e,this.#E(t),this.#g(t)):s&&(t.textContent=e)}#N(t,e){const s=this.#c.get(t);if(!s)return;const r=this.getRootNode();if(!(r instanceof ShadowRoot))return;const{host:o}=r;if(!o)return;o[s]=e}useState(t,e){for(const[s,r]of Object.entries(e)){const e=`${t.id.toString()}:${s}`;this.#p.set(e,r);const o=t[s];void 0!==o&&(this[r]=o);const n=this.#r.properties[r];n.state=t,n.stateProp=s}t.addListener(this,Object.keys(e))}#m(){const t=this.#r,e=new Set(Object.keys(t.properties));for(const t of this.getAttributeNames())"id"!==t&&(t.startsWith("on")||e.has(Wrec.getPropName(t))||this.#M(null,t,"is not a supported attribute"))}#O(t,e,s){const r=s.match(REFS_RE);if(r)return r.forEach(s=>{const r=getPropName(s);void 0===this[r]&&this.#$(t,e,r)}),r}#v(t,e,s){if(s instanceof e)return;let r=typeof s;if("object"===r){const{constructor:o}=s;r=o.name,o!==e&&this.#M(null,t,`was set to a ${r}, but must be a ${e.name}`)}r!==e.name.toLowerCase()&&this.#M(null,t,`was set to a ${r}, but must be a ${e.name}`)}#E(t){const e=Array.from(t.querySelectorAll("*"));for(const t of e){const e=[];for(const s of Array.from(t.attributes)){const r=s.name;if(r.startsWith("on")){let o=r.slice(2);o=o[0].toLowerCase()+o.slice(1).toLowerCase();const n=s.value;let i;this.#O(t,r,n),"function"==typeof this[n]?i=t=>this[n](t):(this.#O(t,r,n),i=()=>this.#y(n)),t.addEventListener(o,i),e.push(r)}}for(const s of e)t.removeAttribute(s)}}}export default Wrec;export function css(t,...e){let s=interpolate(t,e);for(;;){const t=CSS_PROPERTY_RE.exec(s);if(!t)break;const e=t[2];if(REFS_TEST_RE.test(e)){const r=t[1];if(!r.startsWith("--")){const o=`--${r}: ${e};\n        ${r}: var(--${r});`;s=replace(s,t.index,t[0].length,o)}}}return s}export function html(t,...e){let s=interpolate(t,e);for(;;){const t=HTML_ELEMENT_TEXT_RE.exec(s);if(!t)break;const e=removeHtmlComments(t[2]);if(REFS_TEST_RE.test(e)){const r=`\x3c!-- ${e.trim()} --\x3e`;s=replace(s,t.index+t[0].indexOf(">")+1,e.length,r)}}return s}export class State{#H=Symbol("objectId");#D=[];#k;constructor(){const t={set:(t,e,s)=>{const r=t[e];return t[e]=s,this.#B(e,r,s),!0}};this.#k=new Proxy({},t)}addListener(t,e=[]){const s=new Set(e);this.#D.push({listener:t,propertySet:s})}addProperty(t,e){Object.defineProperty(this,t,{enumerable:!0,get(){return this.#k[t]},set(e){this.#k[t]=e}}),this.#k[t]=e}get id(){return this.#H}#B(t,e,s){for(const{listener:r,propertySet:o}of this.#D)o&&!o.has(t)||r.changed(this.#H,t,e,s)}removeListener(t){this.#D=this.#D.filter(e=>e.listener!==t)}}