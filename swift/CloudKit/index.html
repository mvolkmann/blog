<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>CloudKit</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#terminology">Terminology</a></li><li><a href="#sample-code">Sample Code</a></li><li><a href="#adding-cloudkit-to-a-project">Adding CloudKit to a Project</a></li><li><a href="#cloudkit-console">CloudKit Console</a><ol><li><a href="#schemas">Schemas</a></li><li><a href="#adding-indexes">Adding Indexes</a></li><li><a href="#querying">Querying</a></li><li><a href="#records">Records</a></li><li><a href="#assets">Assets</a></li><li><a href="#zones">Zones</a></li></ol></li><li><a href="#subscriptions">Subscriptions</a></li><li><a href="#push-notifications">Push Notifications</a></li><li><a href="#simulator-testing">Simulator Testing</a></li><li><a href="#production-containers">Production Containers</a></li><li><a href="#cloudkit-in-code">CloudKit in Code</a></li><li><a href="#key-value-storage">Key-value Storage</a></li><li><a href="#icloud-documents">iCloud Documents</a></li><li><a href="#subscriptions-1">Subscriptions</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p>CloudKit is an Apple-provided cloud-based database solution that is similar to Firebase. It provides a generous amount of free storage. Developers need an Apple Developer account in order to use CloudKit in an app.</p><p>Users of apps that use CloudKit must have an Apple ID. On each device that will run the app, users must open the Settings app, sign in to their iCloud account, and enable &quot;iCloud Drive&quot;.</p><p>CloudKit supports three kinds of databases.</p><ul><li><p>Public</p><p>These are for databases that are shared between all users of an application. The space used counts against the iCloud limit of the app.</p></li><li><p>Private</p><p>These are for databases that are only accessible by the current user of an application. The space used counts against the iCloud limit of each user.</p></li><li><p>Shared</p><p>These are for sharing specific records in a private database with other users.</p></li></ul><p>Applications that use CloudKit do not need to include a login screen because users are authenticated based on their Apple ID.</p><p>The record type &quot;Users&quot; is provided by default and is a collection of iCloud user accounts.</p><p>The web-based CloudKit Console supports querying, creating, updating, and deleting records.</p><h2 id="terminology" tabindex="-1">Terminology</h2><ul><li><p>Container</p><p>A CloudKit container is a collection of one, two, or three databases where one is public, one is private, and one shared. Each of these can have a development and production version.</p><p>An app can have its own container or it can share a container with other apps. An app can access multiple containers.</p></li><li><p>Database</p><p>A CloudKit database is a collection of records where each has a specific record type. Record types are similar to relational database tables and NoSQL database collections.</p></li><li><p>Record Type</p><p>Each record type is defined by a collection of fields that have a name and a data type.</p></li><li><p>Record</p><p>A CloudKit record is a collection of field values whose types are defined by a record type.</p></li><li><p>Index</p><p>Indexes improve query performance, removing the need to search through records sequentially.</p></li><li><p>Reference</p><p>A CloudKit reference is a field type that is used to refer to one record from another. The target record can have a different record type or the same record type.</p></li><li><p>Security Roles</p><p>Security Roles restrict database access.</p></li><li><p>Subscriptions</p><p>Subscriptions allow apps to subscribe to a database in order to be notified about changes. This enables synchronizing changes across devices. For example, a user with an iPhone and an iPad can enter data on one device and have it automatically appear on the other.</p></li><li><p>Operation</p><p>A CloudKit operation describes a specific operation on a database. To perform multiple operations as a group (a.k.a. batch), see <a href="https://developer.apple.com/documentation/cloudkit/ckoperationgroup?v=1.0.20" rel="noopener" target="_blank">CKOperationGroup</a>.</p><p>CloudKit provides convenience APIs to simplify code, but for full power subclasses of <a href="https://developer.apple.com/documentation/cloudkit/ckoperation?v=1.0.20" rel="noopener" target="_blank">CKOperation</a> can be used. These include the following:</p><ul><li><p><a href="https://developer.apple.com/documentation/cloudkit/ckfetchrecordsoperation?v=1.0.20" rel="noopener" target="_blank">CKFetchRecordsOperation</a></p><p>This is used to fetch complete records or a subset of their fields (<code>desiredKeys</code>) by the unique ids of the records.</p></li><li><p><a href="https://developer.apple.com/documentation/cloudkit/ckmodifyrecordsoperation?v=1.0.20" rel="noopener" target="_blank">CKModifyRecordsOperation</a></p><p>This is used to create, modify, and delete records.</p></li><li><p><a href="https://developer.apple.com/documentation/cloudkit/ckqueryoperation?v=1.0.20" rel="noopener" target="_blank">CKQueryOperation</a></p><p>This is used to fetch complete records or a subset of their fields (<code>desiredKeys</code>) using query predicates specified with a <a href="https://developer.apple.com/documentation/cloudkit/ckquery?v=1.0.20" rel="noopener" target="_blank">CKQuery</a> object.</p></li></ul></li><li><p>Zones</p><p>Zones are used to segregate the data in private databases, not public or shared. Zones support operating on related records in batches. For example, all records in a zone can be deleted with a single call to <code>database.delete(withRecordZoneID: zoneID)</code>. A default zone named &quot;_defaultZone&quot; is provided. There is no requirement to create additional zones but doing so can be useful.</p></li></ul><h2 id="sample-code" tabindex="-1">Sample Code</h2><p>See the app <a href="https://github.com/mvolkmann/CloudKitDemo?v=1.0.20" rel="noopener" target="_blank">CloudKitDemo</a> which demonstrates performing all the CRUD operations on records in a CloudKit database.</p><h2 id="adding-cloudkit-to-a-project" tabindex="-1">Adding CloudKit to a Project</h2><p>To add the use of CloudKit to a project:</p><ol><li><p>Click the top item in the Navigator.</p></li><li><p>Click the main target.</p></li><li><p>Click the &quot;Signing and Capabilities&quot; tab.</p></li><li><p>Click the &quot;+&quot; in the upper-right to add a capability.</p></li><li><p>Double-click &quot;iCloud&quot;.</p></li><li><p>Under &quot;Services&quot;, check the checkboxes for the desired services. Typically only &quot;CloudKit&quot; is checked. The options are:</p><ul><li>&quot;Key-value storage&quot; holds up to 1024 key/value pairs and is sometimes use to store user preferences.</li><li>&quot;iCloud Documents&quot; stores data as files that are accessed using <code>UIDocument</code> (for iOS) or <code>NSDocument</code> (for macOS). This is similar to a file system with a directory hierarchy.</li><li>&quot;CloudKit&quot; stores records defined by a record types. These records can contain references to other records. This is similar to a relational database. These records can be used directly or they can mirror the use of Core Data.</li></ul></li><li><p>Click the &quot;+&quot; under &quot;Containers&quot; and enter a name for the new container. This needs to be unique among all CloudKit containers, so consider using using the app bundle ID. The prefix &quot;iCloud-&quot; will be automatically added to the container name. Sadly containers cannot be deleted, so if you create one with a name you don't like, just create another one and don't use the previous container. You can hide containers from appearing in the &quot;CloudKit Console&quot; dropdown. To do this, click the dropdown, click &quot;Manage Containers&quot;, and toggle off any containers you wish to hide.</p></li><li><p>Periodically click the refresh button below the list of containers until the new container name changes color from red to white, indicating that the container has been created. This can take a couple of minutes.</p></li><li><p>Click the &quot;CloudKit Console&quot; button to open the website at <a href="https://icloud.developer.apple.com/dashboard/home/teams/%7Byour-team-id%7D">https://icloud.developer.apple.com/dashboard/home/teams/{your-team-id}</a>.</p></li><li><p>Sign in using your Apple Developer account</p></li><li><p>Click the big &quot;CloudKit Database&quot; button.</p></li></ol><h2 id="cloudkit-console" tabindex="-1">CloudKit Console</h2><p>To view the web-based CloudKit Console, click the &quot;CloudKit Console&quot; button in Xcode as described above OR follow these steps:</p><ol><li>Browse <code>developer.apple.com</code>.</li><li>Click &quot;Account&quot;.</li><li>Sign in.</li><li>In the left nav, click &quot;CloudKit Console&quot;.</li><li>Click the &quot;CloudKit Database&quot; button.</li></ol><p>Now that you are browsing the console:</p><ol><li>Click the container dropdown at the top and select a container name being used by the app.</li><li>Select a database type: Public, Private, or Shared</li></ol><h3 id="schemas" tabindex="-1">Schemas</h3><p>In the left nav under &quot;Schema&quot;, click &quot;Record Types&quot;.</p><p>To define a new record type:</p><ol><li><p>Click the &quot;+&quot; after &quot;Record Types&quot;.</p></li><li><p>Enter a camel case name that begins uppercase and is plural (ex. &quot;People&quot; or &quot;Pets&quot;).</p></li><li><p>Click the &quot;Save&quot; button or press the return key.</p></li><li><p>For each field in the record type:</p><ol><li><p>Click the &quot;+&quot; after &quot; Record Fields&quot;.</p></li><li><p>Enter a camel case name that begins lowercase.</p></li><li><p>Select a type from the &quot;Type&quot; dropdown.</p><p>The supported types are limited to those that conform to <code>CKRecordValueProtocol</code>. These include:</p><ul><li>Asset (for data such as images, audio, and video)</li><li>Bytes</li><li>Location</li><li>Double</li><li>Int(64)</li><li>Reference</li><li>String</li><li>Date/Time</li><li>Encrypted Bytes</li><li>Encrypted String</li></ul><p>Most of these also have a &quot;(List)&quot; option for a collection of values.</p><p>There does not seem to be a way to require a field to have a value that is unique across all records.</p></li><li><p>Click the &quot;Done&quot; button.</p></li></ol></li><li><p>Click the &quot;Save&quot; button.</p></li></ol><p>To view and edit the schema for an existing record type, click the name of a record type.</p><p>To add a field to a selected record type:</p><ol><li>Click the &quot;+&quot; after &quot;Record Fields&quot;.</li><li>Enter a name.</li><li>Select a type from the &quot;Type&quot; dropdown.</li></ol><p>To edit or delete a field in the selected record type, click the ellipsis at the end of the row for the field and select &quot;Edit&quot; or &quot;Delete&quot;.</p><p>To delete a record type and all records of that type:</p><ol><li>Click the name of a record type.</li><li>Click the ellipsis in the upper right.</li><li>Select &quot;Delete Record Type...&quot;.</li><li>Click the &quot;Delete&quot; button.</li></ol><h3 id="adding-indexes" tabindex="-1">Adding Indexes</h3><p>To make records of a particular record type queryable:</p><ol><li><p>Open the &quot;CloudKit Console&quot;.</p></li><li><p>In the left nav under &quot;Schemas&quot;, click &quot;Indexes&quot;.</p></li><li><p>Click the name of the new record type.</p></li><li><p>Click &quot;Add Basic Index&quot;.</p></li><li><p>In the &quot;Select an option&quot; dropdown, select the field to index.</p></li><li><p>In the dropdown under the &quot;INDEX TYPE&quot; column, select the index type which can be &quot;Queryable&quot;, &quot;Searchable&quot;, or &quot;Sortable&quot;.</p><ul><li>Queryable indexes are used to find records based on a field value.</li><li>Searchable indexes are used to perform full text searches on a string field using the <code>CONTAINS</code> predicate operator.</li><li>Sortable indexes are used to sort query results on a field.</li></ul></li><li><p>When finished adding indexes, click the &quot;Save Changes&quot; button.</p></li></ol><p>To make a record type queryable, its &quot;recordName&quot; field, which holds the unique id of each record, must have an index with the type &quot;Queryable&quot;.</p><h3 id="querying" tabindex="-1">Querying</h3><p>To view (query) all the records of a given record type:</p><ol><li>In the left nav under &quot;Data&quot;, click &quot;Records&quot;.</li><li>In the database dropdown, select &quot;Public Database&quot;, &quot;Private Database&quot;, or &quot;Shared Database&quot;. This always resets to &quot;Public&quot; rather than remembering the last selection.</li><li>In the &quot;RECORD TYPE&quot; dropdown, select a record type.</li><li>Click the &quot;Query Records&quot; button.</li></ol><p>Values in the &quot;NAME&quot; column are returned in a property named &quot;recordID&quot;. There is no conflict if a record type has a field named &quot;name&quot;.</p><p>Values of fields with a type of &quot;Asset&quot; can be downloaded from here.</p><h3 id="records" tabindex="-1">Records</h3><p>To create a new record of a given currently selected record type:</p><ol><li>In the left nav under &quot;Data&quot;, click &quot;Records&quot;.</li><li>Click the &quot;+&quot; after &quot;Records&quot;.</li><li>Select &quot;Create New Record&quot;.</li><li>In the right pane, enter values for each of the fields. Typically the fields under &quot;Metadata&quot; should not be modified.</li><li>Click the &quot;Save&quot; button.</li></ol><p>The new record will not automatically appear in the displayed list of records. To see it, click the &quot;Query Records&quot; button again.</p><p>To update an existing record:</p><ol><li>Click the unique id of the record to update which is in the first column labelled &quot;NAME&quot;.</li><li>Modify any of the field values that appear in the right pane.</li><li>Click the blue &quot;Save&quot; button at the bottom of the right pane.</li></ol><p>To delete an existing record:</p><ol><li>Click the unique id of the record to delete which is in the first column labelled &quot;NAME&quot;.</li><li>Click the red &quot;Delete&quot; button at the bottom of the right pane.</li><li>In the confirmation dialog that appears, click the blue &quot;Delete&quot; button.</li></ol><h3 id="assets" tabindex="-1">Assets</h3><p>Records can have fields with a type of &quot;Asset&quot;. This is useful for data such as images, audio, and video. The data for asset fields is stored outside of the record data and is referenced from records by URLs.</p><p>TODO: Try this.</p><h3 id="zones" tabindex="-1">Zones</h3><p>One reason to create a custom zone and create records in it can be deleted while the default zone cannot. This provides an easy way to clear the database.</p><p>To create a new zone:</p><ol><li>In the left nav under &quot;Data&quot;, click &quot;Records&quot;.</li><li>Click the &quot;+&quot; after &quot;Zones&quot;.</li><li>In the right pane, select a database type such as &quot;Private Database&quot;.</li><li>Enter a zone name.</li><li>Click the blue &quot;Save&quot; button.</li></ol><h2 id="subscriptions" tabindex="-1">Subscriptions</h2><p>To enable use of subscriptions from Xcode:</p><ol><li>Click the top item in the Navigator.</li><li>Click the first target.</li><li>Click the &quot;Signing and Capabilities&quot; tab.</li><li>Click the &quot;+&quot; in the upper-right to add a capability.</li><li>Double-click &quot;Background Modes&quot;.</li><li>Under &quot;Modes&quot;, check the &quot;Background fetch&quot; and &quot;Remote notifications&quot; checkboxes.</li></ol><p>For a good example of using CloudKit including performing CRUD operations and subscribing to be notified of changes see <a href="https://github.com/mvolkmann/CloudKitDemo?v=1.0.20" rel="noopener" target="_blank">CloudKitDemo</a>.</p><h2 id="push-notifications" tabindex="-1">Push Notifications</h2><p>It is possible receive a push notification every time a record of a specific record type is created, updated, or deleted. This can be used to keep multiple devices in sync.</p><p>Push notifications are only sent to apps running in real devices, not to apps running in the Simulator.</p><h2 id="simulator-testing" tabindex="-1">Simulator Testing</h2><p>In order to test apps that use CloudKit in the Simulator, it is necessary to sign in to your iCloud account. To do this:</p><ul><li>Open the Settings app within the Simulator.</li><li>Click &quot;Sign in to your iPhone&quot;.</li><li>Enter your Apple ID and password.</li><li>When prompted about merging contacts, click &quot;Don't Merge&quot;.</li></ul><h2 id="production-containers" tabindex="-1">Production Containers</h2><p>When an app that uses CloudKit is ready for production use, perhaps being released to the App Store, deploy the container to production. Apps in the App Store can only access production containers.</p><p>From <a href="https://developer.apple.com/documentation/cloudkit/managing_icloud_containers_with_the_cloudkit_database_app/deploying_an_icloud_container_s_schema?v=1.0.20" rel="noopener" target="_blank">Managing iCloud Containers</a>, &quot;Deploying the schema copies its record types, fields, and indexes to the production environment, but doesn’t copy any records.&quot;</p><p>To deploy a container to production:</p><ul><li>Browse the container in the CloudKit Console.</li><li>Near the bottom the left nav, click &quot;Deploy Schema Changes...&quot;.</li><li>Review the Record Types, Indexes, and Security Roles to be deployed.</li><li>Click the blue &quot;Deploy&quot; button.</li><li>Change the dropdown in the upper-left from &quot;Development&quot; to &quot;Production&quot; to view the production container.</li></ul><p>Records in the development container will remain.</p><p>The <a href="https://developer.apple.com/documentation/cloudkit/managing_icloud_containers_with_the_cloudkit_database_app/deploying_an_icloud_container_s_schema?v=1.0.20" rel="noopener" target="_blank">Managing iCloud Containers</a>, page also says: &quot;To prevent conflicts, you can’t delete record types or fields that are already in production. Every time you deploy the development schema, its additive changes merge into the production schema. For testing purposes, your app in development can access either the development or the production environment.&quot; This means that once a container deployed to production, it is no longer possible to delete record types or delete fields in record types. New record types can still be added and new fields can be added to existing record types by making the changes in the development container and redeploying the schema changes to production.</p><h2 id="cloudkit-in-code" tabindex="-1">CloudKit in Code</h2><p>The following code is a heavily modified version of <a href="https://github.com/SwiftfulThinking/SwiftUI-Advanced-Learning/blob/main/SwiftfulThinkingAdvancedLearning/CloudKitBootcamps/CloudKitUtility.swift?v=1.0.20" rel="noopener" target="_blank">CloudKitUtility.swift</a> from Nick Sarno of Swiftful Thinking.</p><p>Define a class corresponding to each record type that conforms to the <code>CloudKitable</code> protocol defined below. The class name should be singular. For example, the class for the <code>People</code> record type should be <code>Person</code>. An example of such a class follows:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">CloudKit</span><br><br><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token punctuation">,</span> <span class="token class-name">Hashable</span><span class="token punctuation">,</span> <span class="token class-name">Identifiable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>firstName<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        record <span class="token operator">=</span> <span class="token class-name">CloudKit</span><span class="token punctuation">.</span><span class="token function">createRecord</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"People"</span></span><span class="token punctuation">)</span><br>        record<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"firstName"</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> firstName<br>        record<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"lastName"</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> lastName<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">self</span><span class="token punctuation">.</span>record <span class="token operator">=</span> record<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> firstName<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span><br>        <span class="token keyword">get</span> <span class="token punctuation">{</span> record<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"firstName"</span></span><span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">String</span> <span class="token operator">??</span> <span class="token string-literal"><span class="token string">""</span></span> <span class="token punctuation">}</span><br>        <span class="token keyword">set</span> <span class="token punctuation">{</span> record<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"firstName"</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> newValue <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> id<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> record<span class="token punctuation">.</span>recordID<span class="token punctuation">.</span>recordName <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> lastName<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span><br>        <span class="token keyword">get</span> <span class="token punctuation">{</span> record<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"lastName"</span></span><span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">String</span> <span class="token operator">??</span> <span class="token string-literal"><span class="token string">""</span></span> <span class="token punctuation">}</span><br>        <span class="token keyword">set</span> <span class="token punctuation">{</span> record<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"lastName"</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> newValue <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><br><br>    <span class="token comment">// The Hashable protocol conforms to the Equatable protocol.</span><br>    <span class="token comment">// This is required by the Equatable protocol.</span><br>    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token operator">==</span> <span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span><br>        lhs<span class="token punctuation">.</span>record <span class="token operator">==</span> rhs<span class="token punctuation">.</span>record<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// When present, this method is used by the Hashable protocol.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">hash</span><span class="token punctuation">(</span>into hasher<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Hasher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        hasher<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>The <code>CloudKit</code> struct below provides methods for interacting with a CloudKit database.</p><p>Note that when new records are created or records are updated, it can take up to a minute for CloudKit to index the changes. The new/modified records are not returned by subsequent queries until indexing is completed.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">CloudKit</span><br><br><span class="token keyword">protocol</span> <span class="token class-name">CloudKitable</span> <span class="token punctuation">{</span><br>    <span class="token comment">// This is used in the retrieve and retrieveMore methods below.</span><br>    <span class="token comment">// See the lines `objects.append(T(record: record))`.</span><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">var</span> record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">CloudKit</span> <span class="token punctuation">{</span><br>    <span class="token keyword">typealias</span> <span class="token class-name">Cursor</span> <span class="token operator">=</span> <span class="token class-name">CKQueryOperation</span><span class="token punctuation">.</span><span class="token class-name">Cursor</span><br><br>    <span class="token comment">// Using a custom zone enables performing batch operations</span><br>    <span class="token comment">// such as deleting all the records of every record type.</span><br>    <span class="token comment">// See the deleteZone method below.</span><br>    <span class="token keyword">static</span> <span class="token keyword">var</span> zone <span class="token operator">=</span> <span class="token class-name">CKRecordZone</span><span class="token punctuation">(</span>zoneName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"my-zone"</span></span><span class="token punctuation">)</span><br><br>    <span class="token comment">// MARK: - Initializer</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>usePublic<span class="token punctuation">:</span> <span class="token class-name">Bool</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// The detail container is the one selected in</span><br>        <span class="token comment">// Signing &amp; Capabilities ... iCloud ... Containers.</span><br>        container <span class="token operator">=</span> <span class="token class-name">CKContainer</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>        database <span class="token operator">=</span> usePublic <span class="token operator">?</span><br>            container<span class="token punctuation">.</span>publicCloudDatabase <span class="token punctuation">:</span><br>            container<span class="token punctuation">.</span>privateCloudDatabase<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// MARK: - Properties</span><br><br>    <span class="token keyword">var</span> container<span class="token punctuation">:</span> <span class="token class-name">CKContainer</span><span class="token operator">!</span><br>    <span class="token keyword">var</span> database<span class="token punctuation">:</span> <span class="token class-name">CKDatabase</span><span class="token operator">!</span><br><br>    <span class="token comment">// MARK: - Non-CRUD Methods</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">createOperation</span><span class="token punctuation">(</span><br>        recordType<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token class-name">RecordType</span><span class="token punctuation">,</span><br>        predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span><span class="token punctuation">,</span><br>        sortDescriptors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">NSSortDescriptor</span><span class="token punctuation">]</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span><br>        resultsLimit<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><br>    <span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">CKQueryOperation</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token class-name">CKQuery</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> recordType<span class="token punctuation">,</span> predicate<span class="token punctuation">:</span> predicate<span class="token punctuation">)</span><br>        query<span class="token punctuation">.</span>sortDescriptors <span class="token operator">=</span> sortDescriptors<br>        <span class="token keyword">let</span> operation <span class="token operator">=</span> <span class="token class-name">CKQueryOperation</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> query<span class="token punctuation">)</span><br>        <span class="token keyword">if</span> <span class="token keyword">let</span> limit <span class="token operator">=</span> resultsLimit <span class="token punctuation">{</span> operation<span class="token punctuation">.</span>resultsLimit <span class="token operator">=</span> limit <span class="token punctuation">}</span><br>        <span class="token keyword">return</span> operation<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">statusText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span><br>        <span class="token keyword">switch</span> <span class="token keyword">try</span> <span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">accountStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>available<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"available"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>couldNotDetermine<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"could not determine"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>noAccount<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"no account"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>restricted<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"restricted"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>temporarilyUnavailable<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"temporarily unavailable"</span></span><br>        <span class="token keyword">default</span><span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"unknown"</span></span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// See https://nemecek.be/blog/31/how-to-setup-cloudkit-subscription-to-get-notified-for-changes.</span><br>    <span class="token comment">// This requires adding the "Background Modes" capability</span><br>    <span class="token comment">// and checking "Remote notifications".</span><br>    <span class="token comment">// Supposedly subscriptions do not work in the Simulator.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">subscribe</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token class-name">RecordType</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> subscription <span class="token operator">=</span> <span class="token class-name">CKQuerySubscription</span><span class="token punctuation">(</span><br>            recordType<span class="token punctuation">:</span> recordType<span class="token punctuation">,</span><br>            predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// all records</span><br>            options<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>                <span class="token punctuation">.</span>firesOnRecordCreation<span class="token punctuation">,</span><br>                <span class="token punctuation">.</span>firesOnRecordDeletion<span class="token punctuation">,</span><br>                <span class="token punctuation">.</span>firesOnRecordUpdate<br>            <span class="token punctuation">]</span><br>        <span class="token punctuation">)</span><br><br>        <span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token class-name">CKSubscription</span><span class="token punctuation">.</span><span class="token class-name">NotificationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        info<span class="token punctuation">.</span>shouldSendContentAvailable <span class="token operator">=</span> <span class="token boolean">true</span><br>        info<span class="token punctuation">.</span>alertBody <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span> <span class="token comment">// if this isn't set, pushes aren't always sent</span><br>        subscription<span class="token punctuation">.</span>notificationInfo <span class="token operator">=</span> info<br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// MARK: - CRUD Methods</span><br><br>    <span class="token comment">// "C" in CRUD.</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">create</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">CloudKitable</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>record<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">createRecord</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">CKRecord</span> <span class="token punctuation">{</span><br>        <span class="token class-name">CKRecord</span><span class="token punctuation">(</span><br>            recordType<span class="token punctuation">:</span> recordType<span class="token punctuation">,</span><br>            recordID<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span>zoneID<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span>zoneID<span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">createZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> zone <span class="token operator">=</span> <span class="token class-name">CKRecordZone</span><span class="token punctuation">(</span>zoneID<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span>zoneID<span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">recreateZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">deleteZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">createZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// "D" in CRUD.</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">delete</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">CloudKitable</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">deleteRecord</span><span class="token punctuation">(</span>withID<span class="token punctuation">:</span> item<span class="token punctuation">.</span>record<span class="token punctuation">.</span>recordID<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">deleteAll</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token keyword">await</span> withCheckedThrowingContinuation <span class="token punctuation">{</span> continuation <span class="token keyword">in</span><br>            database<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>withRecordZoneID<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span>zoneID<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span><span class="token punctuation">,</span> error <span class="token keyword">in</span><br>                <span class="token keyword">if</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span><br>                    continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> error<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">deleteZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token keyword">await</span> withCheckedThrowingContinuation <span class="token punctuation">{</span> continuation <span class="token keyword">in</span><br>            <span class="token comment">// In iOS 16, this method still requires a completion handler.</span><br>            database<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>withRecordZoneID<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span>zoneID<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span><span class="token punctuation">,</span> error <span class="token keyword">in</span><br>                <span class="token keyword">if</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span><br>                    continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> error<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// "R" in CRUD.</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">retrieve</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token operator">></span><span class="token punctuation">(</span><br>        recordType<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token class-name">RecordType</span><span class="token punctuation">,</span><br>        predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span> <span class="token operator">=</span> <span class="token class-name">NSPredicate</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// gets all</span><br>        sortDescriptors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">NSSortDescriptor</span><span class="token punctuation">]</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span><br>        resultsLimit<span class="token punctuation">:</span> <span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token class-name">CKQueryOperation</span><span class="token punctuation">.</span>maximumResults<br>    <span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token class-name">CKQuery</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> recordType<span class="token punctuation">,</span> predicate<span class="token punctuation">:</span> predicate<span class="token punctuation">)</span><br>        query<span class="token punctuation">.</span>sortDescriptors <span class="token operator">=</span> sortDescriptors<br>        <span class="token keyword">let</span> <span class="token punctuation">(</span>results<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span><br>            matching<span class="token punctuation">:</span> query<span class="token punctuation">,</span><br>            inZoneWith<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span>zoneID<span class="token punctuation">,</span><br>            resultsLimit<span class="token punctuation">:</span> resultsLimit<br>        <span class="token punctuation">)</span><br><br>        <span class="token keyword">var</span> objects<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token keyword">in</span> results <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">try</span> result<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            objects<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> record<span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">retrieveMore</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>objects<span class="token punctuation">)</span><br><br>        <span class="token keyword">return</span> objects<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// This uses a cursor to recursively retrieve all the requested records.</span><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">retrieveMore</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token operator">></span><span class="token punctuation">(</span><br>        <span class="token omit keyword">_</span> cursor<span class="token punctuation">:</span> <span class="token class-name">Cursor</span><span class="token operator">?</span><span class="token punctuation">,</span><br>        <span class="token omit keyword">_</span> objects<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><br>    <span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">guard</span> <span class="token keyword">let</span> cursor <span class="token operator">=</span> cursor <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span><br><br>        <span class="token keyword">let</span> <span class="token punctuation">(</span>results<span class="token punctuation">,</span> newCursor<span class="token punctuation">)</span> <span class="token operator">=</span><br>            <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span>continuingMatchFrom<span class="token punctuation">:</span> cursor<span class="token punctuation">)</span><br><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token keyword">in</span> results <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">try</span> result<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            objects<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> record<span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Recursive call.</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">retrieveMore</span><span class="token punctuation">(</span>newCursor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>objects<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// "U" in CRUD.</span><br><br>    <span class="token comment">// func update&lt;T: CloudKitable>(item: T) async throws {</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">CloudKitable</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>record<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Below are examples of using the <code>CloudKit</code> struct above to perform CRUD operations with the <code>Person</code> class and the <code>People</code> record type: After running this code, browse the CloudKit Console and query records in private database and in the zone &quot;my-zone&quot;.</p><p>When new records are created or records are updated, it can take up to a minute for CloudKit to index the changes. The new/modified records are not returned by subsequent queries until indexing is completed.</p><pre class="language-swift"><code class="language-swift"><span class="token class-name">Task</span> <span class="token punctuation">{</span><br>    <span class="token keyword">do</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> ck <span class="token operator">=</span> <span class="token class-name">CloudKit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">recreateZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>        <span class="token comment">// Create some records.</span><br><br>        <span class="token keyword">let</span> tami <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>firstName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Tamara"</span></span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Volkmann"</span></span><span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> tami<span class="token punctuation">)</span><br><br>        <span class="token keyword">let</span> amanda <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>firstName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Amanda"</span></span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Nelson"</span></span><span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> amanda<span class="token punctuation">)</span><br><br>        <span class="token keyword">let</span> jeremy <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>firstName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Jeremy"</span></span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Volkmann"</span></span><span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> jeremy<span class="token punctuation">)</span><br><br>        <span class="token comment">// Pet is a class similar to Person above.</span><br>        <span class="token comment">// Each instance holds name and ownedBy properties.</span><br>        <span class="token comment">// The ownedBy property holds a reference to a Person.</span><br>        <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token class-name">Reference</span><span class="token punctuation">(</span><br>            recordID<span class="token punctuation">:</span> tami<span class="token punctuation">.</span>record<span class="token punctuation">.</span>recordID<span class="token punctuation">,</span><br>            action<span class="token punctuation">:</span> <span class="token punctuation">.</span>deleteSelf<br>        <span class="token punctuation">)</span><br>        <span class="token keyword">let</span> comet <span class="token operator">=</span> <span class="token class-name">Pet</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Comet"</span></span><span class="token punctuation">,</span> ownedBy<span class="token punctuation">:</span> ref<span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> comet<span class="token punctuation">)</span><br><br>        <span class="token comment">// Retrieve some records.</span><br>        <span class="token comment">// WARNING: As explained above, the new records</span><br>        <span class="token comment">// will not be available immediately!</span><br><br>        <span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><br>            recordType<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"People"</span></span><br>        <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span><span class="token class-name">Person</span><span class="token punctuation">]</span><br>        <span class="token keyword">for</span> person <span class="token keyword">in</span> people <span class="token punctuation">{</span><br>            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"person ="</span></span><span class="token punctuation">,</span> person<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> person<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">let</span> pets <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><br>            recordType<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Pets"</span></span><br>        <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span><span class="token class-name">Pet</span><span class="token punctuation">]</span><br>        <span class="token keyword">for</span> pet <span class="token keyword">in</span> pets <span class="token punctuation">{</span><br>            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"pet ="</span></span><span class="token punctuation">,</span> pet<span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Delete a record.</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>        <span class="token comment">// Update a record.</span><br>        <span class="token keyword">let</span> item <span class="token operator">=</span> pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>        item<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"Fireball"</span></span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> ck<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> item<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"CRUD error:"</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>When querying for records, all the fields are returned by default. To limit the fields included in the returned data, set the <code>desiredKeys</code> property on the <code>CKQueryOperation</code> object to an array of property name strings.</p><h2 id="key-value-storage" tabindex="-1">Key-value Storage</h2><p>An iCloud container can hold a collection of key-value pairs. They are accessed from code using the <a href="https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestore?v=1.0.20" rel="noopener" target="_blank">NSUbiquitousKeyValueStore</a> class.</p><p>This class is similar to <a href="https://developer.apple.com/documentation/foundation/userdefaults?v=1.0.20" rel="noopener" target="_blank">UserDefaults</a> class. The main difference is that <code>UseDefaults</code> data only resides on the device where the app runs, whereas <code>NSUbiquitousKeyValueStore</code> data resides in iCloud and is shared between all the devices of a user.</p><p>The class <code>NSUbiquitousKeyValueStore</code> has the following limits:</p><ul><li>A single key cannot exceed 64 bytes using UTF-8 encoding.</li><li>A single key-value pair cannot exceed 1 MB.</li><li>A maximum of 1024 key-value pairs can be saved.</li><li>The total storage limit is 1 MB.</li></ul><p>TODO: Try this in your CloudKitDemo2 project!</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">var</span> kvStore <span class="token operator">=</span> <span class="token class-name">NSUbiquitousKeyValueStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>kvStore<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"some-key"</span></span><span class="token punctuation">)</span><br>kvStore<span class="token punctuation">.</span><span class="token function">synchronize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">let</span> value <span class="token operator">=</span> kvStore<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"data"</span></span><span class="token punctuation">)</span></code></pre><h2 id="icloud-documents" tabindex="-1">iCloud Documents</h2><p>TODO: Document using this kind of CloudKit storage.</p><h2 id="subscriptions-1" tabindex="-1">Subscriptions</h2><p>TODO: Can you subscribe to all three kinds of stores?</p><p>TODO: Add examples.</p></article>