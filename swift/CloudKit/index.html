<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>CloudKit</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#terminology">Terminology</a></li><li><a href="#sample-code">Sample Code</a></li><li><a href="#adding-cloudkit-to-a-project">Adding CloudKit to a Project</a></li><li><a href="#cloudkit-console">CloudKit Console</a><ol><li><a href="#schemas">Schemas</a></li></ol></li><li><a href="#making-records-queryable">Making Records Queryable</a></li><li><a href="#querying">Querying</a><ol><li><a href="#records">Records</a></li><li><a href="#assets">Assets</a></li></ol></li><li><a href="#subscriptions">Subscriptions</a></li><li><a href="#push-notifications">Push Notifications</a></li><li><a href="#simulator-testing">Simulator Testing</a></li><li><a href="#production-databases">Production Databases</a></li><li><a href="#cloudkit-in-code">CloudKit in Code</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p>CloudKit is an Apple-provided cloud-based database solution that is similar to Firebase. It provides a generous amount of free storage. Developers need an Apple Developer account in order to use CloudKit in an app. Users of the app need an Apple ID and must configure the use of iCloud in the Settings app of their devices.</p><p>CloudKit supports three kinds of databases.</p><ul><li><p>Public</p><p>These are for databases that are shared between all users of an application. The space used counts against the iCloud limit of the app.</p></li><li><p>Private</p><p>These are for databases that are only accessible by the current user of an application. The space used counts against the iCloud limit of each user.</p></li><li><p>Shared</p><p>These are for sharing specific records in a private database with other users.</p></li></ul><p>Applications that use CloudKit do not need to include a login screen because users are authenticated based on their Apple ID.</p><p>The record type &quot;Users&quot; is provided by default and is a collection of iCloud user accounts.</p><p>The web-based CloudKit Console supports querying, creating, updating, and deleting records.</p><h2 id="terminology" tabindex="-1">Terminology</h2><ul><li><p>Container</p><p>A CloudKit container is a collection of one, two, or three databases where one is public, one is private, and one shared. Each of these can have a development and production version.</p><p>An app can have its own container or it can share a container with other apps. An app can access multiple containers.</p></li><li><p>Database</p><p>A CloudKit database is a collection of records where each has a specific record type. Record types are similar to relational database tables and NoSQL database collections.</p></li><li><p>Record Type</p><p>Each record type is defined by a collection of fields that have a name and a data type.</p></li><li><p>Record</p><p>A CloudKit record is a collection of field values whose types are defined by a record type.</p></li><li><p>Index</p><p>Indexes improve query performance, removing the need to search through records sequentially.</p></li><li><p>Reference</p><p>A CloudKit reference is a field type that is used to refer to one record from another. The target record can have a different record type or the same record type.</p></li><li><p>Security Roles</p><p>Security Roles restrict database access.</p></li><li><p>Subscriptions</p><p>Subscriptions allow apps to subscribe to a database in order to be notified about changes. This enables synchronizing changes across devices. For example, a user with an iPhone and an iPad can enter data on one device and have it automatically appear on the other.</p></li><li><p>Operation</p><p>A CloudKit operation describes a specific operation on a database. To perform multiple operations as a group (a.k.a. batch), see <a href="https://developer.apple.com/documentation/cloudkit/ckoperationgroup?v=1.0.20" rel="noopener" target="_blank">CKOperationGroup</a>.</p><p>CloudKit provides convenience APIs to simplify code, but for full power subclasses of <a href="https://developer.apple.com/documentation/cloudkit/ckoperation?v=1.0.20" rel="noopener" target="_blank">CKOperation</a> can be used. These include the following:</p><ul><li><p><a href="https://developer.apple.com/documentation/cloudkit/ckfetchrecordsoperation?v=1.0.20" rel="noopener" target="_blank">CKFetchRecordsOperation</a></p><p>This is used to fetch complete records or a subset of their fields (<code>desiredKeys</code>) by the unique ids of the records.</p></li><li><p><a href="https://developer.apple.com/documentation/cloudkit/ckmodifyrecordsoperation?v=1.0.20" rel="noopener" target="_blank">CKModifyRecordsOperation</a></p><p>This is used to create, modify, and delete records.</p></li><li><p><a href="https://developer.apple.com/documentation/cloudkit/ckqueryoperation?v=1.0.20" rel="noopener" target="_blank">CKQueryOperation</a></p><p>This is used to fetch complete records or a subset of their fields (<code>desiredKeys</code>) using query predicates specified with a <a href="https://developer.apple.com/documentation/cloudkit/ckquery?v=1.0.20" rel="noopener" target="_blank">CKQuery</a> object.</p></li></ul></li><li><p>Zones</p><p>Zones are used to segregate the data in private databases, not public or shared. They support saving related records in batches. A default zone named &quot;_defaultZone&quot; is provided. There is no requirement to create additional zones.</p></li></ul><h2 id="sample-code" tabindex="-1">Sample Code</h2><p>See the app <a href="https://github.com/mvolkmann/CloudKitDemo?v=1.0.20" rel="noopener" target="_blank">CloudKitDemo</a> which demonstrates performing all the CRUD operations on records in a CloudKit database.</p><h2 id="adding-cloudkit-to-a-project" tabindex="-1">Adding CloudKit to a Project</h2><p>To add the use of CloudKit to a project:</p><ol><li><p>Click the top item in the Navigator.</p></li><li><p>Click the main target.</p></li><li><p>Click the &quot;Signing and Capabilities&quot; tab.</p></li><li><p>Click the &quot;+&quot; in the upper-right to add a capability.</p></li><li><p>Double-click &quot;iCloud&quot;.</p></li><li><p>Under &quot;Services&quot;, check the checkboxes for the desired services. Typically only &quot;CloudKit&quot; is checked. The options are:</p><ul><li>&quot;Key-value storage&quot; holds up to 1024 key/value pairs and is sometimes use to store user preferences.</li><li>&quot;iCloud Documents&quot; stores data as files that are accessed using <code>UIDocument</code> (for iOS) or <code>NSDocument</code> (for macOS). This is similar to a file system with a directory hierarchy.</li><li>&quot;CloudKit&quot; stores records defined by a record types. These records can contain references to other records. This is similar to a relational database. These records can be used directly or they can mirror the use of Core Data.</li></ul></li><li><p>Click the &quot;+&quot; under &quot;Containers&quot; and enter a name for the new container. This needs to be unique among all CloudKit containers, so consider using using the app bundle ID. The prefix &quot;iCloud-&quot; will be automatically added to the container name. Sadly containers cannot be deleted, so if you create one with a name you don't like, just create another one and don't use the previous container.</p></li><li><p>Periodically click the refresh button below the list of containers until the new container name changes color from red to white, indicating that the container has been created. This can take a couple of minutes.</p></li><li><p>Click the &quot;CloudKit Console&quot; button to open the website at <a href="https://icloud.developer.apple.com/dashboard/home/teams/%7Byour-team-id%7D">https://icloud.developer.apple.com/dashboard/home/teams/{your-team-id}</a>.</p></li><li><p>Sign in using your Apple Developer account</p></li><li><p>Click the big &quot;CloudKit Database&quot; button.</p></li></ol><h2 id="cloudkit-console" tabindex="-1">CloudKit Console</h2><p>To view the web-based CloudKit Console, click the &quot;CloudKit Console&quot; button in Xcode as described above OR follow these steps:</p><ol><li>Browse <code>developer.apple.com</code>.</li><li>Click &quot;Account&quot;.</li><li>Sign in.</li><li>In the left nav, click &quot;CloudKit Console&quot;.</li><li>Click the &quot;CloudKit Database&quot; button.</li></ol><p>Now that you are browsing the console:</p><ol><li>Click the container dropdown at the top and select a container name being used by the app.</li><li>Select a database type: Public, Private, or Shared</li></ol><h3 id="schemas" tabindex="-1">Schemas</h3><p>In the left nav under &quot;Schema&quot;, click &quot;Record Types&quot;.</p><p>To define a new record type:</p><ul><li><p>Click the &quot;+&quot; after &quot;Record Types&quot;.</p></li><li><p>Enter a name.</p></li><li><p>For each field</p><ul><li><p>Click the &quot;+&quot; after &quot;Fields&quot;.</p></li><li><p>Enter a name.</p></li><li><p>Select a type from the &quot;Type&quot; dropdown.</p><p>The supported types are limited to those that conform to <code>CKRecordValueProtocol</code>. These include:</p><ul><li>Asset</li><li>Bytes</li><li>Location</li><li>Double</li><li>Int(64)</li><li>Reference</li><li>String</li><li>Date/Time</li><li>Encrypted Bytes</li><li>Encrypted String</li></ul><p>Most of these also have a &quot;(List)&quot; option for a collection of values.</p><p>There does not seem to be a way to require a field to have a value that is unique across all records.</p></li><li><p>Click the &quot;Done&quot; button.</p></li></ul></li><li><p>Click the &quot;Save&quot; button.</p></li></ul><p>To view and edit the schema for an existing record type, click the name of a record type.</p><p>To add a field to a selected record type:</p><ul><li>Click the &quot;+&quot; after &quot;Record Fields&quot;.</li><li>Enter a name.</li><li>Select a type from the &quot;Type&quot; dropdown.</li></ul><p>To edit or delete a field in the selected record type, click the ellipsis at the end of the row for the field and select &quot;Edit&quot; or &quot;Delete&quot;.</p><p>To delete a record type and all records of that type:</p><ul><li>Click the name of a record type.</li><li>Click the ellipsis in the upper right.</li><li>Select &quot;Delete Record Type...&quot;.</li><li>Click the &quot;Delete&quot; button.</li></ul><h2 id="making-records-queryable" tabindex="-1">Making Records Queryable</h2><p>After the first record is saved in the container, make the records of that type queryable.</p><ol><li>Click the top item in the Navigator.</li><li>Click the first target.</li><li>Click the &quot;Signing and Capabilities&quot; tab.</li><li>Click the &quot;CloudKit Console&quot; button</li><li>In the left nav under &quot;Schemas&quot;, click &quot;Indexes&quot;.</li><li>Click the name of the new record type.</li><li>Click &quot;Add Basic Index&quot;.</li><li>In the &quot;Select an option&quot; dropdown, select &quot;recordName&quot;.</li><li>It should be marked as &quot;Queryable&quot;.</li><li>Click the &quot;Save Changes&quot; button.</li><li>In the left nav under &quot;Data&quot;, click &quot;Records&quot;.</li><li>In the &quot;Record Types&quot; dropdown, select the new record name.</li><li>Click the &quot;Query Records&quot; button to display all the records of that type.</li></ol><h2 id="querying" tabindex="-1">Querying</h2><p>When querying for records, to limit the fields included in the returned data, set the <code>desiredKeys</code> property on the <code>CKQueryOperation</code> object to an array of property name strings.</p><h3 id="records" tabindex="-1">Records</h3><p>To view (query) all the records of a given type:</p><ul><li>In the left nav under &quot;Data&quot;, click &quot;Records&quot;.</li><li>Select the database to be used: Public, Private, or Shared. This always resets to &quot;Public&quot; rather than remembering the last selection.</li><li>Select a record type from the &quot;RECORD TYPE&quot; dropdown.</li><li>Click the &quot;Query Records&quot; button.</li></ul><p>Values in the &quot;NAME&quot; column are returned in a property named &quot;recordID&quot;. There is no conflict if a record type has a field named &quot;name&quot;.</p><p>Values of fields with a type of &quot;Asset&quot; can be downloaded from here.</p><p>To create a new record of the selected record type:</p><ul><li>Click the &quot;+&quot; after &quot;Records&quot;.</li><li>Select &quot;Create New Record&quot;.</li><li>In the area that appears on the right side, enter values for each of the fields. Typically the fields under &quot;Metadata&quot; should not be modified.</li><li>Click the &quot;Save&quot; button.</li></ul><p>To update an existing record in the CloudKit Console, select a record to display its details in a right pane, change any of the field values, and click the blue &quot;Save&quot; button at the bottom of the right pane.</p><p>To update an existing record in code see the &quot;CloudKit in Code&quot; section below.</p><p>To delete an existing record in the CloudKit Console, select a record to display its details in a right pane and click the red &quot;Delete&quot; button at the bottom of the right pane.</p><p>To delete an existing record in code see the &quot;CloudKit in Code&quot; section below.</p><h3 id="assets" tabindex="-1">Assets</h3><p>Records can have fields with a type of &quot;Asset&quot;. The data for these is stored outside of the record data and is referenced from records by URLs.</p><p>TODO: Try this.</p><h2 id="subscriptions" tabindex="-1">Subscriptions</h2><p>To enable use of subscriptions:</p><ol><li>Click the top item in the Navigator.</li><li>Click the first target.</li><li>Click the &quot;Signing and Capabilities&quot; tab.</li><li>Click the &quot;+&quot; in the upper-right to add a capability.</li><li>Double-click &quot;Background Modes&quot;.</li><li>Under &quot;Modes&quot;, check the &quot;Background fetch&quot; and &quot;Remote notifications&quot; checkboxes.</li></ol><p>For a good example of using CloudKit including performing CRUD operations and subscribing to be notified of changes see <a href="https://github.com/mvolkmann/CloudKitDemo?v=1.0.20" rel="noopener" target="_blank">CloudKitDemo</a>.</p><h2 id="push-notifications" tabindex="-1">Push Notifications</h2><p>It is possible receive a push notification every time a record of a specific record type is created, updated, or deleted. This can be used to keep multiple devices in sync.</p><p>Push notifications are only sent to apps running in real devices, not to apps running in the Simulator.</p><h2 id="simulator-testing" tabindex="-1">Simulator Testing</h2><p>When testing in the Simulator, sign in to your iCloud by opening the Settings app within the Simulator, clicking &quot;Sign in to your iPhone&quot;, and entering your Apple ID and password. When prompted about merging contacts, click &quot;Don't Merge&quot;.</p><h2 id="production-databases" tabindex="-1">Production Databases</h2><p>Once a database has been switched from &quot;Development&quot; to &quot;Production&quot;, it is no longer possible to delete record types. New record types can be added and existing record types can be modified. TODO: Can fields in records be deleted?</p><h2 id="cloudkit-in-code" tabindex="-1">CloudKit in Code</h2><p>The following code is a heavily modified version of <a href="https://github.com/SwiftfulThinking/SwiftUI-Advanced-Learning/blob/main/SwiftfulThinkingAdvancedLearning/CloudKitBootcamps/CloudKitUtility.swift?v=1.0.20" rel="noopener" target="_blank">CloudKitUtility.swift</a> from Nick Sarno of Swiftful Thinking. It requires defining a class for each record type that conforms to the <code>CloudKitable</code> protocol. An example of such a class, named <code>Person</code>, follows this code.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">CloudKit</span><br><span class="token keyword">import</span> <span class="token class-name">UIKit</span><br><br><span class="token keyword">protocol</span> <span class="token class-name">CloudKitable</span> <span class="token punctuation">{</span><br>    <span class="token comment">// This must be an optional initializer</span><br>    <span class="token comment">// due to this line in the retrieve method:</span><br>    <span class="token comment">// guard let item = T(record: record) else { return }</span><br>    <span class="token keyword">init</span><span class="token operator">?</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">var</span> record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">CloudKit</span> <span class="token punctuation">{</span><br>    <span class="token keyword">typealias</span> <span class="token class-name">Cursor</span> <span class="token operator">=</span> <span class="token class-name">CKQueryOperation</span><span class="token punctuation">.</span><span class="token class-name">Cursor</span><br><br>    <span class="token comment">// MARK: - Initializer</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>containerId<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> usePublic<span class="token punctuation">:</span> <span class="token class-name">Bool</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// TODO: This doesn't result in pointing to the correct container.  Why?</span><br>        <span class="token comment">// container = CKContainer.default()</span><br><br>        <span class="token comment">// I discovered the container identifier by looking in CloudKitDemo.entitlements.</span><br>        <span class="token comment">// "CloudKit Console" button in "Signing &amp; Capabilities"</span><br>        <span class="token comment">// under "Ubiquity Container Identifiers".</span><br>        <span class="token comment">// TODO: Why did it use this identifier instead of the one</span><br>        <span class="token comment">// TODO: specified in Signing &amp; Capabilities ... Containers?</span><br><br>        container <span class="token operator">=</span> <span class="token class-name">CKContainer</span><span class="token punctuation">(</span>identifier<span class="token punctuation">:</span> containerId<span class="token punctuation">)</span><br><br>        database <span class="token operator">=</span> usePublic <span class="token operator">?</span><br>            container<span class="token punctuation">.</span>publicCloudDatabase <span class="token punctuation">:</span><br>            container<span class="token punctuation">.</span>privateCloudDatabase<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// MARK: - Properties</span><br><br>    <span class="token keyword">var</span> container<span class="token punctuation">:</span> <span class="token class-name">CKContainer</span><span class="token operator">!</span><br>    <span class="token keyword">var</span> database<span class="token punctuation">:</span> <span class="token class-name">CKDatabase</span><span class="token operator">!</span><br><br>    <span class="token comment">// MARK: - Non-CRUD Methods</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">createOperation</span><span class="token punctuation">(</span><br>        recordType<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token class-name">RecordType</span><span class="token punctuation">,</span><br>        predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span><span class="token punctuation">,</span><br>        sortDescriptors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">NSSortDescriptor</span><span class="token punctuation">]</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span><br>        resultsLimit<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><br>    <span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">CKQueryOperation</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token class-name">CKQuery</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> recordType<span class="token punctuation">,</span> predicate<span class="token punctuation">:</span> predicate<span class="token punctuation">)</span><br>        query<span class="token punctuation">.</span>sortDescriptors <span class="token operator">=</span> sortDescriptors<br>        <span class="token keyword">let</span> operation <span class="token operator">=</span> <span class="token class-name">CKQueryOperation</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> query<span class="token punctuation">)</span><br>        <span class="token keyword">if</span> <span class="token keyword">let</span> limit <span class="token operator">=</span> resultsLimit <span class="token punctuation">{</span> operation<span class="token punctuation">.</span>resultsLimit <span class="token operator">=</span> limit <span class="token punctuation">}</span><br>        <span class="token keyword">return</span> operation<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">statusText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span><br>        <span class="token keyword">switch</span> <span class="token keyword">try</span> <span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">accountStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>available<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"available"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>couldNotDetermine<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"could not determine"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>noAccount<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"no account"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>restricted<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"restricted"</span></span><br>        <span class="token keyword">case</span> <span class="token punctuation">.</span>temporarilyUnavailable<span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"temporarily unavailable"</span></span><br>        <span class="token keyword">default</span><span class="token punctuation">:</span><br>            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"unknown"</span></span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// See https://nemecek.be/blog/31/how-to-setup-cloudkit-subscription-to-get-notified-for-changes.</span><br>    <span class="token comment">// This requires adding the "Background Modes" capability</span><br>    <span class="token comment">// and checking "Remote notifications".</span><br>    <span class="token comment">// Supposedly subscriptions do not work in the Simulator.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">subscribe</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token class-name">RecordType</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> subscription <span class="token operator">=</span> <span class="token class-name">CKQuerySubscription</span><span class="token punctuation">(</span><br>            recordType<span class="token punctuation">:</span> recordType<span class="token punctuation">,</span><br>            predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// all records</span><br>            options<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>                <span class="token punctuation">.</span>firesOnRecordCreation<span class="token punctuation">,</span><br>                <span class="token punctuation">.</span>firesOnRecordDeletion<span class="token punctuation">,</span><br>                <span class="token punctuation">.</span>firesOnRecordUpdate<br>            <span class="token punctuation">]</span><br>        <span class="token punctuation">)</span><br><br>        <span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token class-name">CKSubscription</span><span class="token punctuation">.</span><span class="token class-name">NotificationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        info<span class="token punctuation">.</span>shouldSendContentAvailable <span class="token operator">=</span> <span class="token boolean">true</span><br>        info<span class="token punctuation">.</span>alertBody <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span> <span class="token comment">// if this isn't set, pushes aren't always sent</span><br>        subscription<span class="token punctuation">.</span>notificationInfo <span class="token operator">=</span> info<br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// MARK: - CRUD Methods</span><br><br>    <span class="token comment">// "C" in CRUD.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">create</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token operator">></span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>record<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// "R" in CRUD.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">retrieve</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token operator">></span><span class="token punctuation">(</span><br>        recordType<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">.</span><span class="token class-name">RecordType</span><span class="token punctuation">,</span><br>        predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span> <span class="token operator">=</span> <span class="token class-name">NSPredicate</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// gets all</span><br>        sortDescriptors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">NSSortDescriptor</span><span class="token punctuation">]</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span><br>        resultsLimit<span class="token punctuation">:</span> <span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token class-name">CKQueryOperation</span><span class="token punctuation">.</span>maximumResults<br>    <span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token class-name">CKQuery</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> recordType<span class="token punctuation">,</span> predicate<span class="token punctuation">:</span> predicate<span class="token punctuation">)</span><br>        query<span class="token punctuation">.</span>sortDescriptors <span class="token operator">=</span> sortDescriptors<br>        <span class="token keyword">let</span> <span class="token punctuation">(</span>results<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span><br>            matching<span class="token punctuation">:</span> query<span class="token punctuation">,</span><br>            resultsLimit<span class="token punctuation">:</span> resultsLimit<br>        <span class="token punctuation">)</span><br><br>        <span class="token keyword">var</span> objects<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token keyword">in</span> results <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">try</span> result<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            objects<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> record<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">retrieveMore</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>objects<span class="token punctuation">)</span><br><br>        <span class="token keyword">return</span> objects<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">retrieveMore</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token operator">></span><span class="token punctuation">(</span><br>        <span class="token omit keyword">_</span> cursor<span class="token punctuation">:</span> <span class="token class-name">Cursor</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> objects<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><br>    <span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">guard</span> <span class="token keyword">let</span> cursor <span class="token operator">=</span> cursor <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span><br><br>        <span class="token keyword">let</span> <span class="token punctuation">(</span>results<span class="token punctuation">,</span> newCursor<span class="token punctuation">)</span> <span class="token operator">=</span><br>            <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span>continuingMatchFrom<span class="token punctuation">:</span> cursor<span class="token punctuation">)</span><br><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token keyword">in</span> results <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">try</span> result<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            objects<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> record<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Recursive call.</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">retrieveMore</span><span class="token punctuation">(</span>newCursor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>objects<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// "U" in CRUD.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">update</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token operator">></span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>record<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// "D" in CRUD.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">delete</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token operator">></span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span><span class="token function">deleteRecord</span><span class="token punctuation">(</span>withID<span class="token punctuation">:</span> item<span class="token punctuation">.</span>record<span class="token punctuation">.</span>recordID<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Here is a example of a class that conforms to the <code>CloudKitable</code> protocol.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">CloudKit</span><br><br><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">:</span> <span class="token class-name">CloudKitable</span><span class="token punctuation">,</span> <span class="token class-name">Hashable</span><span class="token punctuation">,</span> <span class="token class-name">Identifiable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">self</span><span class="token punctuation">.</span>record <span class="token operator">=</span> record<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> id<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> record<span class="token punctuation">:</span> <span class="token class-name">CKRecord</span><br><br>    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> record<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"name"</span></span><span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">String</span> <span class="token operator">??</span> <span class="token string-literal"><span class="token string">""</span></span> <span class="token punctuation">}</span><br><br>    <span class="token comment">// This is required by the Equatable protocol.</span><br>    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token operator">==</span> <span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token class-name">Area</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token class-name">Area</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span><br>        lhs<span class="token punctuation">.</span>name <span class="token operator">==</span> rhs<span class="token punctuation">.</span>name<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// This is used by the Hashable protocol.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">hash</span><span class="token punctuation">(</span>into hasher<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Hasher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        hasher<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></article>