<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Vapor</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#alternatives">Alternatives</a></li><li><a href="#installing">Installing</a></li><li><a href="#project-creation">Project Creation</a></li><li><a href="#running-server">Running Server</a></li><li><a href="#directory-structure">Directory Structure</a></li><li><a href="#defining-routes">Defining Routes</a></li><li><a href="#error-types">Error Types</a></li><li><a href="#json-support">JSON Support</a></li><li><a href="#database-support">Database Support</a></li><li><a href="#html-generation">HTML Generation</a></li><li><a href="#request-validation">Request Validation</a></li><li><a href="#sending-http-requests">Sending HTTP Requests</a></li><li><a href="#environments">Environments</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://vapor.codes?v=1.1.0" rel="noopener" target="_blank">Vapor</a> is a web server framework for macOS that is written in Swift. It is under active development as of March 11, 2023.</p><h2 id="alternatives" tabindex="-1">Alternatives</h2><p>Alternatives to Vapor include:</p><ul><li><a href="https://www.kitura.dev?v=1.1.0" rel="noopener" target="_blank">Kitura</a> (last commit on Oct. 7, 2022)</li><li><a href="https://perfect.org?v=1.1.0" rel="noopener" target="_blank">Perfect</a> (last commit on Feb. 8, 2021)</li></ul><h2 id="installing" tabindex="-1">Installing</h2><ol><li>Install <a href="https://brew.sh?v=1.1.0" rel="noopener" target="_blank">Homebrew</a>.</li><li>Enter <code>brew install vapor</code></li><li>Add a package dependency to the Xcode project.<ol><li>Click the top entry in the Navigator.</li><li>Click the project name.</li><li>Click the &quot;Package Dependencies&quot; tab.</li><li>Search for the URL <a href="https://github.com/vapor/vapor">https://github.com/vapor/vapor</a>.</li><li>Click the &quot;Add Package&quot; button. TODO: I thought this would add Vapor code completions and access to its source code, but it didnt!</li><li>In the dialog that appears, click the &quot;Add Package&quot; button again.</li></ol></li></ol><h2 id="project-creation" tabindex="-1">Project Creation</h2><p>To create a Vapor project, enter <code>vapor new {project-name}</code></p><p>If not using a database, enter &quot;N&quot; for &quot;use Fluent?&quot;.</p><p>If not generating HTML, enter &quot;N&quot; for &quot;use Leaf?&quot;.</p><p>To edit code in the project, cd to the newly created project directory and enter <code>vapor xcode</code> to open the project in Xcode. This will trigger the necessary downloads.</p><h2 id="running-server" tabindex="-1">Running Server</h2><p>To run the server, enter <code>vapor run</code>. The server listens on port 8080 by default.</p><p>To verify that it is working, browse localhost:8080/ which outputs &quot;It works!&quot; or browse localhost:8080/hello which outputs &quot;Hello, world!&quot;. These routes are defined in the provided <code>Sources/App/routes.swift</code> file.</p><p>There does not seem to be support for listening for code changes and automatically restarting the server (like nodemon in Node.js).</p><h2 id="directory-structure" tabindex="-1">Directory Structure</h2><p>The provided directory structure is:</p><ul><li><code>Sources</code><ul><li><code>App</code><ul><li><code>Controllers</code><ul><li><code>routes.swift</code> - implements <code>route</code> function that defines endpoints</li></ul></li><li><code>Migrations</code> - for database migrations</li><li><code>Models</code> - for model objects that map to database tables/collections</li><li><code>configure.swift</code> - implements <code>configure</code> function that configures database access and calls the <code>routes</code> function</li></ul></li><li><code>Run</code><ul><li><code>main.swift</code> - entry point that calls the <code>configure</code> function</li></ul></li></ul></li><li><code>Tests</code><ul><li><code>AppTests</code><ul><li><code>AppTests.swift</code> - implements unit tests using XCTest and XCTVapor</li></ul></li></ul></li></ul><h2 id="defining-routes" tabindex="-1">Defining Routes</h2><p>To define new routes (or endpoints), edit <code>Sources/App/routes.swift</code>. The <code>route</code> function defined here is called by the <code>configure</code> function that is defined in <code>Sources/App/configure.swift</code>. The <code>configure</code> function is called by <code>Sources/Run/main.swift</code>.</p><p>The route helper methods that map to HTTP methods are <code>get</code>, <code>post</code>, <code>patch</code>, <code>put</code>, and <code>delete</code>. The route helper method <code>on</code> accepts an HTTP method as a parameter.</p><p>The following code is from the <code>routes.swift</code> file. It demonstrates defining routes that use both path parameters and query parameters.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">Vapor</span><br><br><span class="token keyword">func</span> <span class="token function-definition function">routes</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> app<span class="token punctuation">:</span> <span class="token class-name">Application</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>    <span class="token comment">// route is /</span><br>    app<span class="token punctuation">.</span><span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span><br>        <span class="token string-literal"><span class="token string">"It works!"</span></span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// route is /hello</span><br>    <span class="token comment">// Return type of the function passed to `app.get`</span><br>    <span class="token comment">// specifies the kind of data returned.</span><br>    app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"hello"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token keyword">in</span><br>        <span class="token string-literal"><span class="token string">"Hello, world!"</span></span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// This demonstrates using path parameters.</span><br>    <span class="token comment">// route example is /greet/Tami</span><br>    <span class="token comment">// The `get` method takes any number of string arguments</span><br>    <span class="token comment">// that each represent a path part that can be</span><br>    <span class="token comment">// constant (like "greet") or variable (like ":name").</span><br>    <span class="token comment">// "*" matches any value.</span><br>    <span class="token comment">// "**" matches any number of path parts with any values.</span><br>    <span class="token comment">// (Can "**" only be used as the last argument?)</span><br>    app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"greet"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">":name"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> req <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token keyword">in</span><br>        <span class="token comment">// This demonstrates getting the String value</span><br>        <span class="token comment">// of a variable path parameter.</span><br>        <span class="token comment">// These are never be nil, so a forced unwrap is safe.</span><br>        <span class="token keyword">guard</span> <span class="token keyword">let</span> name <span class="token operator">=</span> req<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"name"</span></span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token class-name">Abort</span><span class="token punctuation">(</span><span class="token punctuation">.</span>badRequest<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// This demonstrates getting the non-String value</span><br>        <span class="token comment">// of a variable path parameter.</span><br>        <span class="token comment">// If an incompatible value is provided,</span><br>        <span class="token comment">// a "not found" response will be returned.</span><br>        <span class="token comment">/*<br>        guard let age = req.parameters.get("age", as: Int.self) else {<br>            // This is one of the many supported error types.<br>            // For more, see the error types section below.<br>            throw Abort(.badRequest)<br>        }<br>        */</span><br><br>        <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"Hello, </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">!"</span></span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// This demonstrates using query parameters.</span><br>    app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"divide"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> req <span class="token operator">-></span> <span class="token class-name">Double</span> <span class="token keyword">in</span><br>        <span class="token keyword">guard</span> <span class="token keyword">let</span> dividend<span class="token punctuation">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"dividend"</span></span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token class-name">Abort</span><span class="token punctuation">(</span><span class="token punctuation">.</span>badRequest<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">guard</span> <span class="token keyword">let</span> divisor<span class="token punctuation">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"divisor"</span></span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token class-name">Abort</span><span class="token punctuation">(</span><span class="token punctuation">.</span>badRequest<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">return</span> dividend <span class="token operator">/</span> divisor<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// This demonstrates another approach for using query parameters.</span><br>    <span class="token comment">// The struct below describes the supported query parameters.</span><br>    <span class="token comment">// They can be required or optional (by using `?`).</span><br>    <span class="token keyword">struct</span> <span class="token class-name">Divide</span><span class="token punctuation">:</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> dividend<span class="token punctuation">:</span> <span class="token class-name">Double</span><br>        <span class="token keyword">var</span> divisor<span class="token punctuation">:</span> <span class="token class-name">Double</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// This uses the struct above to decode the query parameters.</span><br>    app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"divide2"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> req <span class="token operator">-></span> <span class="token class-name">Double</span> <span class="token keyword">in</span><br>        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">try</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Divide</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><br>        <span class="token keyword">return</span> query<span class="token punctuation">.</span>dividend <span class="token operator">/</span> query<span class="token punctuation">.</span>divisor<br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2 id="error-types" tabindex="-1">Error Types</h2><p>Errors thrown from Vapor routes can use the <a href="https://apple.github.io/swift-nio/docs/current/NIOHTTP1/Enums/HTTPResponseStatus.html?v=1.1.0" rel="noopener" target="_blank">HTTPResponseStatus</a> enumeration defined by the <a href="https://apple.github.io/swift-nio/docs/current/NIOCore/?v=1.1.0" rel="noopener" target="_blank">SwiftNIO</a> library (see the NIOHTTP1 module).</p><h2 id="json-support" tabindex="-1">JSON Support</h2><p>The <a href="https://docs.vapor.codes/basics/content/?v=1.1.0" rel="noopener" target="_blank">Content</a> API supports parsing JSON in request bodies and generating JSON for response bodies.</p><p>The following code is from the <code>routes.swift</code> file. It demonstrates defining routes that return JSON.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">Vapor</span><br><br><span class="token keyword">func</span> <span class="token function-definition function">routes</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> app<span class="token punctuation">:</span> <span class="token class-name">Application</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>    <span class="token comment">// The Content protocol combines</span><br>    <span class="token comment">// Decodable, Encodable, and RequestDecodable.</span><br>    <span class="token keyword">struct</span> <span class="token class-name">Address</span><span class="token punctuation">:</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> street<span class="token punctuation">:</span> <span class="token class-name">String</span><br>        <span class="token keyword">let</span> city<span class="token punctuation">:</span> <span class="token class-name">String</span><br>        <span class="token keyword">let</span> state<span class="token punctuation">:</span> <span class="token class-name">String</span><br>        <span class="token keyword">let</span> zip<span class="token punctuation">:</span> <span class="token class-name">Int</span><br>    <span class="token punctuation">}</span><br><br>    app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"address"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token operator">-></span> <span class="token class-name">Address</span> <span class="token keyword">in</span><br>        <span class="token class-name">Address</span><span class="token punctuation">(</span><br>            street<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"123 Some Lane"</span></span><span class="token punctuation">,</span><br>            city<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Somewhere"</span></span><span class="token punctuation">,</span><br>            state<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"CA"</span></span><span class="token punctuation">,</span><br>            zip<span class="token punctuation">:</span> <span class="token number">12345</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"addresses"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token class-name">Address</span><span class="token punctuation">]</span> <span class="token keyword">in</span><br>        <span class="token keyword">let</span> a1 <span class="token operator">=</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><br>            street<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"123 Some Lane"</span></span><span class="token punctuation">,</span><br>            city<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Somewhere"</span></span><span class="token punctuation">,</span><br>            state<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"CA"</span></span><span class="token punctuation">,</span><br>            zip<span class="token punctuation">:</span> <span class="token number">12345</span><br>        <span class="token punctuation">)</span><br>        <span class="token keyword">let</span> a2 <span class="token operator">=</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><br>            street<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"456 Some Street"</span></span><span class="token punctuation">,</span><br>            city<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Nowhere"</span></span><span class="token punctuation">,</span><br>            state<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"CA"</span></span><span class="token punctuation">,</span><br>            zip<span class="token punctuation">:</span> <span class="token number">98765</span><br>        <span class="token punctuation">)</span><br>        <span class="token keyword">return</span> <span class="token punctuation">[</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2 id="database-support" tabindex="-1">Database Support</h2><p>Routes can perform CRUD operations on databases. The supported databases are MongoDB, MySQL, PostgreSQL, and SQLite.</p><p>Object Relational Mapper (ORM) support is provided by the <a href="https://docs.vapor.codes/fluent/overview/?v=1.1.0" rel="noopener" target="_blank">Fluent</a> framework.</p><h2 id="html-generation" tabindex="-1">HTML Generation</h2><p>Routes can return server-rendered HTML using the <a href="https://docs.vapor.codes/leaf/getting-started/?v=1.1.0" rel="noopener" target="_blank">Leaf</a> templating language.</p><h2 id="request-validation" tabindex="-1">Request Validation</h2><p>Routes can validate the HTTP requests sent to them using the <a href="https://docs.vapor.codes/basics/validation/?v=1.1.0" rel="noopener" target="_blank">Validation</a> API. It can validate query parameters and request bodies.</p><p>One motivation for using this is that it provides human-readable error messages.</p><h2 id="sending-http-requests" tabindex="-1">Sending HTTP Requests</h2><p>Routes can send HTTP requests to endpoints on other servers using the <a href="https://docs.vapor.codes/basics/client/?v=1.1.0" rel="noopener" target="_blank">Client</a> API. This is built on the <a href="https://swift-server.github.io/async-http-client/docs/current/AsyncHTTPClient/index.html?v=1.1.0" rel="noopener" target="_blank">AsyncHTTPClient</a> package which can also be used in Swift client apps. However, the code is not any simpler than using <a href="https://developer.apple.com/documentation/foundation/urlsession?v=1.1.0" rel="noopener" target="_blank">URLSession</a>.</p><h2 id="environments" tabindex="-1">Environments</h2><p>Routes can use the <a href="https://docs.vapor.codes/basics/environment/?v=1.1.0" rel="noopener" target="_blank">Environment</a> API to modifier their behavior based on the current environment such as production, development, or testing. One use is to select the database instance that is accessed.</p></article>