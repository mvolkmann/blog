<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Concurrency</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#issues">Issues</a></li><li><a href="#other-approaches">Other Approaches</a><ol><li><a href="#posix-threads-(pthreads)">POSIX Threads (pthreads)</a></li><li><a href="#nsthreads">NSThreads</a></li><li><a href="#grand-central-dispatch-(gcd)">Grand Central Dispatch (GCD)</a></li><li><a href="#nsoperation-apis">NSOperation APIs</a></li></ol></li><li><a href="#async%2Fawait-keywords">async/await keywords</a></li><li><a href="#continuations">Continuations</a></li><li><a href="#structured-concurrency">Structured Concurrency</a><ol><li><a href="#async-let">async let</a></li><li><a href="#task-groups">Task Groups</a></li></ol></li><li><a href="#unstructured-concurrency">Unstructured Concurrency</a><ol><li><a href="#task">Task</a></li><li><a href="#task-tree">Task Tree</a></li></ol></li><li><a href="#actors">Actors</a></li><li><a href="#sendable-types">Sendable Types</a></li><li><a href="#main-actor">Main Actor</a></li><li><a href="#asyncsequence">AsyncSequence</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p>Apple added the async/await system to Swift in 2021. This removes most needs to use low-level concurrency mechanisms such as mutexes and semaphores. It also removes the need to use completion handlers (aka callbacks) and some uses of the delegate pattern.</p><h2 id="issues" tabindex="-1">Issues</h2><p>Common issues encountered when writing code involving concurrency include:</p><ul><li><p>Deadlocks</p><p>This occurs when two processes are waiting each other to finish so neither can finish. This is typically solved by using mutexes of semaphores.</p><p>Mutex is short for &quot;MUTually EXclusive lock&quot;. Each mutex is owned by one process at a time. Processes that wish to access a resource that is protected by such a lock cannot do so until they acquire the lock.</p><p>A semaphore is similar to mutex, but can protect access to a code path.</p></li><li><p>Starvation</p><p>A thread is starved when it waits forever to gain access to a resource.</p></li><li><p>Race Condition</p><p>A race condition occurs when multiple processes update a resource at the same time. This results in unpredictable results in the best case and data corruption in the worst case.</p></li><li><p>Livelocks</p><p>Livelocks occur when resources give up the locks they hold too frequently. This can result in processes taking too long to complete or never completing because they do not hold locks long enough to do so.</p></li></ul><h2 id="other-approaches" tabindex="-1">Other Approaches</h2><p>The following libraries and frameworks for managing concurrency predate the async/await system.</p><h3 id="posix-threads-(pthreads)" tabindex="-1">POSIX Threads (pthreads)</h3><p><a href="https://man7.org/linux/man-pages/man7/pthreads.7.html?v=1.0.20" rel="noopener" target="_blank">pthreads</a> are not specific to Apple operating systems and are available in many operating systems. They are implemented in C and have a steep learning curve. Using pthreads requires manual thread management and use locks such as mutexes and semaphores.</p><h3 id="nsthreads" tabindex="-1">NSThreads</h3><p>The <a href="https://developer.apple.com/documentation/foundation/nsthread?v=1.0.20" rel="noopener" target="_blank">NSThread</a> class is part of the Apple Foundation framework. It provides another low-level approach to managing concurrency, but is somewhat easier to use than pthreads. This class can be accessed from Objective-C instead of C.</p><h3 id="grand-central-dispatch-(gcd)" tabindex="-1">Grand Central Dispatch (GCD)</h3><p>The <a href="https://developer.apple.com/documentation/DISPATCH?v=1.0.20" rel="noopener" target="_blank">Dispatch</a> framework (aka Grand Central Dispatch) is specific to Apple operating systems. It offers a higher level API than NSThreads and pthreads.</p><p>While GCD has many features, the most common use is to run code that updates the UI on the main thread. For example:</p><pre class="language-swift"><code class="language-swift"><span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span><br>    <span class="token comment">// UI updating code goes here.</span><br><span class="token punctuation">}</span></code></pre><h3 id="nsoperation-apis" tabindex="-1">NSOperation APIs</h3><p>The <a href="https://developer.apple.com/documentation/foundation/nsoperation?v=1.0.20" rel="noopener" target="_blank">NSOperation</a> class is part of the Apple Foundation framework. To use this:</p><ul><li>Create an instance of <code>OperationQueue</code>.</li><li>Create one instance of <code>BlockOperation</code> for each concurrent operation.</li><li>Add each <code>BlockOperation</code> instance to the <code>OperationQueue</code> by passing it to the <code>addOperation</code> method of the <code>OperationQueue</code>.</li><li>Wait for all the operations to complete by calling the <code>waitUntilAllOperationsAreFinished</code> method of the <code>OperationQueue</code>.</li></ul><h2 id="async%2Fawait-keywords" tabindex="-1">async/await keywords</h2><p>The <code>async</code> and <code>await</code> keywords free developers from the low-level details of thread management. They allow concurrent code to be written in a manner similar to procedural programming, resulting in code that is easier to write and read.</p><p>Unlike concurrent code that uses completion handlers (aka callbacks), using <code>async</code> and <code>await</code> does not result in deeply nested code.</p><p>To use this approach, add the <code>async</code> keyword after the parameter list and before the return type of all functions that run asynchronously. Inside the function, add the <code>await</code> keyword before all calls to other asynchronous functions. For example:</p><pre class="language-swift"><code class="language-swift">function <span class="token function">getCurrentCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> coordinates <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCurrentCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// implemented elsewhere</span><br>    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAddress</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> coordinates<span class="token punctuation">)</span> <span class="token comment">// implemented elsewhere</span><br>    <span class="token keyword">return</span> address<span class="token punctuation">.</span>city<br><span class="token punctuation">}</span></code></pre><p>All <code>async</code> functions must be called from a concurrent context. All <code>async</code> functions run in a concurrent context, so they can call other <code>async</code> functions. Another way to create a concurrent context is by creating a <a href="https://developer.apple.com/documentation/swift/task?v=1.0.20" rel="noopener" target="_blank">Task</a> object. For example:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">SwiftUI</span><br><br><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> city <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> isShowingError <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br><br>    <span class="token keyword">var</span> body<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Get City"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Task</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">do</span> <span class="token punctuation">{</span><br>                        <span class="token keyword">let</span> currentCity <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">getCurrentCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                        <span class="token comment">// This updates the UI on the main thread</span><br>                        <span class="token comment">// and will be explained more later.</span><br>                        <span class="token keyword">await</span> <span class="token class-name">MainActor</span><span class="token punctuation">.</span>run <span class="token punctuation">{</span> city <span class="token operator">=</span> currentCity <span class="token punctuation">}</span><br>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>                        message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"Error getting city: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><br>                        isShowingError <span class="token operator">=</span> <span class="token boolean">true</span><br>                    <span class="token punctuation">}</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"City: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">city</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><br>            <span class="token string-literal"><span class="token string">"Error"</span></span><span class="token punctuation">,</span><br>            isPresented<span class="token punctuation">:</span> $isShowingAlert<span class="token punctuation">,</span><br>            actions<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>            message<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>The <code>await</code> keyword can choose to suspend execution of the current function. This allows the thread that was executing the function to perform other work. The code after the function call that uses <code>await</code> (the suspension point) is referred to as a &quot;continuation&quot;. When the function is resumed later, the continuation is executed, possibly in a different thread than the one in which function execution began.</p><p>In iOS 15 and above, all Apple provided functions that take a completion handler also have an <code>async</code> version. This means there is no longer a need to pass completion handlers to Apple's APIs, resulting in code that is easier to write and read. For example, <a href="https://developer.apple.com/documentation/foundation/urlsession?v=1.0.20" rel="noopener" target="_blank">URLSession</a> has many async methods.</p><p>The following code demonstrates using the <code>async</code> and <code>await</code> keywords with the <code>URLSession</code> class.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">SwiftUI</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Activity</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> activity<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> type<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> participants<span class="token punctuation">:</span> <span class="token class-name">Int</span><br>    <span class="token keyword">let</span> price<span class="token punctuation">:</span> <span class="token class-name">Double</span><br>    <span class="token keyword">let</span> link<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> key<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> accessibility<span class="token punctuation">:</span> <span class="token class-name">Double</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> activity<span class="token punctuation">:</span> <span class="token class-name">Activity</span><span class="token operator">?</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> fetching <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br><br>    <span class="token keyword">let</span> apiURL <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"https://www.boredapi.com/api/activity"</span></span><span class="token punctuation">)</span><span class="token operator">!</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span><br>        fetching <span class="token operator">=</span> <span class="token boolean">true</span><br>        message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            <span class="token comment">// The data method returns a tuple.</span><br>            <span class="token comment">// The type of response is URLResponse.</span><br>            <span class="token comment">// Cast it to HTTPURLResponse to get information from it.</span><br>            <span class="token keyword">let</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=</span><br>                <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> apiURL<span class="token punctuation">)</span><br>            <span class="token keyword">if</span> <span class="token keyword">let</span> res <span class="token operator">=</span> response <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">HTTPURLResponse</span> <span class="token punctuation">{</span><br>                <span class="token keyword">if</span> res<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span> <span class="token punctuation">{</span><br>                    activity <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                        <span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"bad status </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">res<span class="token punctuation">.</span>statusCode</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"bad response type"</span></span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"error: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><br>        <span class="token punctuation">}</span><br><br>        fetching <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> body<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Are you bored?"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">font</span><span class="token punctuation">(</span><span class="token punctuation">.</span>largeTitle<span class="token punctuation">)</span><br>            <span class="token keyword">if</span> fetching <span class="token punctuation">{</span><br>                <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Waiting for suggestion ..."</span></span><span class="token punctuation">)</span><br>                <span class="token class-name">ProgressView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Get Suggested Activity"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token class-name">Task</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> <span class="token function">fetchActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>                <span class="token punctuation">}</span><br>                <span class="token punctuation">.</span><span class="token function">buttonStyle</span><span class="token punctuation">(</span><span class="token punctuation">.</span>borderedProminent<span class="token punctuation">)</span><br><br>                <span class="token keyword">if</span> <span class="token keyword">let</span> activity <span class="token punctuation">{</span><br>                    <span class="token class-name">Text</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span>activity <span class="token operator">+</span> <span class="token string-literal"><span class="token string">"."</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">font</span><span class="token punctuation">(</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token keyword">if</span> <span class="token operator">!</span>message<span class="token punctuation">.</span>isEmpty <span class="token punctuation">{</span><br>                <span class="token class-name">Text</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foregroundColor</span><span class="token punctuation">(</span><span class="token punctuation">.</span>red<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token comment">// This is a view modifier that is similar to onAppear,</span><br>        <span class="token comment">// but runs the closure passed to it in an async context.</span><br>        <span class="token punctuation">.</span>task <span class="token punctuation">{</span><br>            <span class="token keyword">await</span> <span class="token function">fetchActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2 id="continuations" tabindex="-1">Continuations</h2><p>Functions that take a completion handler (aka callback) can be wrapped in a new <code>async</code> function that does not take a callback in order to simplify their use.</p><p>In iOS 15 and above, all Apple provided functions that take a completion handler also have an <code>async</code> version. So it is not necessary to wrap the versions that take a completion handler. However, functions in non-Apple frameworks may still use completion handlers and these benefit from wrapping.</p><p>Suppose Apple had not provided an <code>async</code> method in <code>URLSession</code> for retrieving data from a <code>URL</code>. We could modify the code in the previous example as shown below. While the <code>fetchActivityWithContinuation</code> function below is somewhat complicated, calling it does not require passing a completion handler. This simplifies the code in callers.</p><pre class="language-swift"><code class="language-swift">    <span class="token comment">// This custom error type is passed to</span><br>    <span class="token comment">// `completion.resume(throwing: ...)` below.</span><br>    <span class="token keyword">enum</span> <span class="token class-name">MyError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> badResponseType<span class="token punctuation">,</span> badStatus<span class="token punctuation">,</span> noData<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// This replaces the `fetchActivity function in the previous example</span><br>    <span class="token comment">// with one that calls the wrapping function</span><br>    <span class="token comment">// `fetchActivityWithContinuation`.</span><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span><br>        fetching <span class="token operator">=</span> <span class="token boolean">true</span><br>        message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            activity <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">fetchActivityWithContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            message <span class="token operator">=</span> error<span class="token punctuation">.</span>localizedDescription<br>        <span class="token punctuation">}</span><br><br>        fetching <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchActivityWithContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span><br>        <span class="token comment">// The closure passed to `withCheckedThrowingContinuation`</span><br>        <span class="token comment">// is passed a `CheckedContinuation` object.</span><br>        <span class="token comment">// This has a `resume` method that must be called</span><br>        <span class="token comment">// when data is available or when an error occurs.</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> withCheckedThrowingContinuation <span class="token punctuation">{</span> completion <span class="token keyword">in</span><br>            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">dataTask</span><span class="token punctuation">(</span><br>                with<span class="token punctuation">:</span> apiURL<br>            <span class="token punctuation">)</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span><br>                <span class="token comment">// The type of response is URLResponse.</span><br>                <span class="token comment">// Cast it to HTTPURLResponse to get information from it.</span><br>                <span class="token keyword">guard</span> <span class="token keyword">let</span> response <span class="token operator">=</span> response <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">HTTPURLResponse</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>badResponseType<span class="token punctuation">)</span><br>                    <span class="token keyword">return</span><br>                <span class="token punctuation">}</span><br><br>                <span class="token keyword">guard</span> response<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>badStatus<span class="token punctuation">)</span><br>                    <span class="token keyword">return</span><br>                <span class="token punctuation">}</span><br><br>                <span class="token keyword">guard</span> <span class="token keyword">let</span> data <span class="token operator">=</span> data <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>noData<span class="token punctuation">)</span><br>                    <span class="token keyword">return</span><br>                <span class="token punctuation">}</span><br><br>                <span class="token keyword">do</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">let</span> activity <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><br>                        <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span><br>                        from<span class="token punctuation">:</span> data<br>                    <span class="token punctuation">)</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>returning<span class="token punctuation">:</span> activity<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> error<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br><br>            task<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span></code></pre><p>The example above demonstrates using the <a href="https://developer.apple.com/documentation/swift/withcheckedthrowingcontinuation(function:_:)?v=1.0.20" rel="noopener" target="_blank">withCheckedThrowingContinuation</a> function. If <code>completion.resume</code> is never called, the runtime error &quot;SWIFT TASK CONTINUATION MISUSE: ... leaked its continuation!&quot; will be triggered. If <code>completion.resume</code> is called more than once, the runtime error &quot;SWIFT TASK CONTINUATION MISUSE: ... tried to resume its continuation more than once&quot; will be triggered.</p><p>There are three other similar functions that can be used.</p><ul><li><p><a href="https://developer.apple.com/documentation/swift/withcheckedcontinuation(function:_:)?v=1.0.20" rel="noopener" target="_blank">withCheckedContinuation</a> is like <code>withCheckedThrowingContinuation</code>, but does not throw and the compiler will not allow calling <code>completion.resume(throwing: someError)</code>.</p></li><li><p><a href="https://developer.apple.com/documentation/swift/withunsafecontinuation(_:)?v=1.0.20" rel="noopener" target="_blank">withUnsafeContinuation</a> is like <code>withCheckedContinuation</code> but does not perform runtime checks to ensure that <code>completion.resume</code> is called exactly once. This makes it slightly faster.</p></li><li><p><a href="https://developer.apple.com/documentation/swift/withunsafethrowingcontinuation(_:)?v=1.0.20" rel="noopener" target="_blank">withUnsafeThrowingContinuation</a> is like <code>withCheckedThrowingContinuation</code> but does not perform runtime checks to ensure that <code>completion.resume</code> is called exactly once. This makes it slightly faster.</p></li></ul><p>Use of the unsafe versions is generally not recommended.</p><h2 id="structured-concurrency" tabindex="-1">Structured Concurrency</h2><p>Structured concurrency provides a way to execute multiple tasks at the same time AND write code in the order in which it is expected to run. The async/await system provides two ways to do this, <code>async let</code> and task groups.</p><h3 id="async-let" tabindex="-1">async let</h3><p>An <code>async let</code> statement is a special kind of variable declaration whose value is computed asynchronously. This kind of statement must be used inside an async context (either a closure passed to <code>Task</code> or an <code>async</code> function).</p><p>The <code>await</code> keyword must be used to get the value of the variable.</p><pre class="language-swift"><code class="language-swift"></code></pre><h3 id="task-groups" tabindex="-1">Task Groups</h3><h2 id="unstructured-concurrency" tabindex="-1">Unstructured Concurrency</h2><h3 id="task" tabindex="-1">Task</h3><h3 id="task-tree" tabindex="-1">Task Tree</h3><h2 id="actors" tabindex="-1">Actors</h2><h2 id="sendable-types" tabindex="-1">Sendable Types</h2><h2 id="main-actor" tabindex="-1">Main Actor</h2><h2 id="asyncsequence" tabindex="-1">AsyncSequence</h2></article>