<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Concurrency</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#resources">Resources</a></li><li><a href="#issues">Issues</a></li><li><a href="#other-approaches">Other Approaches</a><ol><li><a href="#posix-threads-(pthreads)">POSIX Threads (pthreads)</a></li><li><a href="#nsthreads">NSThreads</a></li><li><a href="#grand-central-dispatch-(gcd)">Grand Central Dispatch (GCD)</a></li><li><a href="#nsoperation-apis">NSOperation APIs</a></li></ol></li><li><a href="#tasks%2C-queues%2C-and-threads">Tasks, Queues, and Threads</a></li><li><a href="#async%2Fawait-keywords">async/await keywords</a></li><li><a href="#continuations">Continuations</a></li><li><a href="#structured-concurrency">Structured Concurrency</a><ol><li><a href="#async-let">async let</a></li><li><a href="#task-groups">Task Groups</a></li></ol></li><li><a href="#unstructured-concurrency">Unstructured Concurrency</a><ol><li><a href="#task">Task</a></li><li><a href="#task-tree">Task Tree</a></li></ol></li><li><a href="#actors">Actors</a></li><li><a href="#sendable-types">Sendable Types</a></li><li><a href="#main-actor">Main Actor</a></li><li><a href="#custom-global-actors">Custom Global Actors</a></li><li><a href="#asyncsequence">AsyncSequence</a></li><li><a href="#task-local-variables">Task Local Variables</a></li><li><a href="#thread-sanitizer">Thread Sanitizer</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p>Apple added the async/await system to Swift in 2021. This removes most needs to use lower level concurrency mechanisms and Grand Central Dispatch (GCD). It also removes the need to use completion handlers (aka callbacks) and some uses of the delegate pattern.</p><h2 id="resources" tabindex="-1">Resources</h2><p>See the Apple documentation on <a href="https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html?v=1.0.20" rel="noopener" target="_blank">Concurrency</a>.</p><p>In addition, the book <a href="https://swiftasyncbook.com?v=1.0.20" rel="noopener" target="_blank">Modern Concurrency on Apple Platforms</a> by Andrés Ibañez Kautsch is an excellent resource!</p><h2 id="issues" tabindex="-1">Issues</h2><p>Common issues encountered when writing code involving concurrency include:</p><ul><li><p>Deadlocks</p><p>This occurs when two processes are waiting each other to finish so neither can finish. This is typically solved by using mutexes of semaphores.</p><p>Mutex is short for &quot;MUTually EXclusive lock&quot;. Each mutex is owned by one process at a time. Processes that wish to access a resource that is protected by such a lock cannot do so until they acquire the lock.</p><p>A semaphore is similar to mutex, but can protect access to a code path. The Dispatch framework provides the <a href="https://developer.apple.com/documentation/dispatch/dispatchsemaphore?v=1.0.20" rel="noopener" target="_blank">DispatchSemaphore</a> class. It does not provide a mutex implementation.</p></li><li><p>Starvation</p><p>A thread is starved when it waits forever to gain access to a resource.</p></li><li><p>Race Condition</p><p>A race condition occurs when multiple processes update a resource at the same time. This can produce unpredictable results in the best case and data corruption in the worst case.</p></li><li><p>Livelocks</p><p>Livelocks occur when resources give up the locks they hold too frequently. This can result in processes taking too long to complete or never completing because they do not hold locks long enough to do so.</p></li></ul><h2 id="other-approaches" tabindex="-1">Other Approaches</h2><p>The following libraries and frameworks for managing concurrency predate the async/await system. They are now rarely needed, but can be useful in very specific circumstances.</p><h3 id="posix-threads-(pthreads)" tabindex="-1">POSIX Threads (pthreads)</h3><p><a href="https://man7.org/linux/man-pages/man7/pthreads.7.html?v=1.0.20" rel="noopener" target="_blank">pthreads</a> are not specific to Apple operating systems and are available in many operating systems. They are implemented in C and have a steep learning curve. Using pthreads requires manual thread management and use of locks such as mutexes and semaphores.</p><h3 id="nsthreads" tabindex="-1">NSThreads</h3><p>The <a href="https://developer.apple.com/documentation/foundation/nsthread?v=1.0.20" rel="noopener" target="_blank">NSThread</a> class is part of the Apple Foundation framework. It provides another low-level approach to managing concurrency, but is somewhat easier to use than pthreads. This class can be accessed from Objective-C instead of C.</p><h3 id="grand-central-dispatch-(gcd)" tabindex="-1">Grand Central Dispatch (GCD)</h3><p>The <a href="https://developer.apple.com/documentation/DISPATCH?v=1.0.20" rel="noopener" target="_blank">Dispatch</a> framework (aka Grand Central Dispatch) is specific to Apple operating systems. It offers a higher level API than NSThreads and pthreads.</p><p>While GCD has many features, the most common use is to run code that updates the UI on the main thread. For example:</p><pre class="language-swift"><code class="language-swift"><span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Code to update the UI goes here.</span><br><span class="token punctuation">}</span></code></pre><h3 id="nsoperation-apis" tabindex="-1">NSOperation APIs</h3><p>The <a href="https://developer.apple.com/documentation/foundation/nsoperation?v=1.0.20" rel="noopener" target="_blank">NSOperation</a> class is part of the Apple Foundation framework. To use this:</p><ul><li>Create an instance of the <a href="https://developer.apple.com/documentation/foundation/nsoperationqueue?v=1.0.20" rel="noopener" target="_blank">NSOperationQueue</a> class.</li><li>Create one instance of <a href="https://developer.apple.com/documentation/foundation/nsblockoperation?v=1.0.20" rel="noopener" target="_blank">NSBlockOperation</a> for each concurrent operation.</li><li>Add each <code>NSBlockOperation</code> instance to the <code>NSOperationQueue</code> by passing it to the <code>addOperation</code> method of the <code>NSOperationQueue</code>.</li><li>Wait for all the operations to complete by calling the <code>waitUntilAllOperationsAreFinished</code> method of the <code>NSOperationQueue</code>.</li></ul><h2 id="tasks%2C-queues%2C-and-threads" tabindex="-1">Tasks, Queues, and Threads</h2><p>Tasks (also referred to as &quot;work items&quot;) represent a body of work to be performed. To schedule the work, a <code>Task</code> is added to a queue in either a blocking fashion (runs synchronously) or a non-blocking fashion (runs asynchronously).</p><p>A queue is responsible for determining when its tasks will run and the threads on which they will run. Each queue is either &quot;serial&quot; or &quot;concurrent&quot;. Both kinds execute their tasks in the order in which they were added.</p><p>Serial queues execute one task at a time and each task can run on a different thread. One use of a serial queue is to synchronize access to shared resources.</p><p>Concurrent queues can execute multiple tasks at the same time which requires multiple threads. The number of tasks executed simultaneously at any point in time can vary based on conditions in the application and the number of CPU cores in the device. Tasks run on concurrent queues can finish in a different order than they were started since each task can have a different duration.</p><p>Each queue collects tasks to be run at a given priority or quality of service (QoS). Applications can create any number of queues. There are five &quot;global queues&quot; that are typically used instead of custom queues.</p><p>While it is possible to write code that explicitly runs a task on a specific thread, doing so is discouraged because it removes the ability of the system to manage thread usage. When using queues, the system can optimize the use of threads based of the number of CPU cores in the current device. The system can decide the number of threads to use and when each task should run.</p><p>The user interface should only be updated on the main thread. This is achieved by adding such tasks to the main queue. which only runs tasks on the main thread. If the UI is updated on a thread other than the main thread, it may have no effect or the application may crash. TODO: Does it sometimes work? The Swift compiler provides warnings when it detects code that attempts to update the UI outside of the main thread.</p><p>There are five provided global queues that correspond to the six QoS levels, listed here in order from highest to lowest priority.</p><ul><li><p><code>userInteractive</code></p><p>This is the same as the main queue which is the only provided serial queue. All other provided queues are concurrent.</p></li><li><p><code>userInitiated</code></p><p>This is the same as the concurrent high priority queue.</p></li><li><p><code>default</code></p><p>This is a concurrent queue.</p></li><li><p><code>utility</code> and <code>unspecified</code></p><p>These are the same as the concurrent low priority queue.</p></li><li><p><code>background</code></p><p>This is a concurrent queue.</p></li></ul><p>Additional queues using any of the QoS values can be created, but typically only the provided queues are used.</p><p>To obtain a reference to a global queue for a given QoS using one of the enum cases at <a href="https://developer.apple.com/documentation/dispatch/dispatchqos/qosclass?v=1.0.20" rel="noopener" target="_blank">DispatchQoS.QoSClass</a>:</p><pre class="language-swift"><code class="language-swift"><span class="token comment">// If qos is omitted, it defaults to `.default`.</span><br><span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span>qos<span class="token punctuation">)</span></code></pre><p>To create a new queue:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> mySerialQueue <span class="token operator">=</span> <span class="token class-name">DispatchQueue</span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"my-queue-name"</span></span><span class="token punctuation">)</span><br><br><span class="token keyword">let</span> myConcurrentQueue <span class="token operator">=</span><br>    <span class="token class-name">DispatchQueue</span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"my-queue-name"</span></span><span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token punctuation">.</span>concurrent<span class="token punctuation">)</span></code></pre><p>To submit a task to a queue to run synchronously, which blocks the caller until the task completes, pass a closure to the <code>sync</code> method of the queue.</p><p>To submit a task to a queue to run asynchronously, which does not wait for the task to complete and does not blocks the caller, pass a closure to the <code>async</code> method of the queue.</p><h2 id="async%2Fawait-keywords" tabindex="-1">async/await keywords</h2><p>The <code>async</code> and <code>await</code> keywords free developers from the low-level details of thread management. They allow concurrent code to be written in a manner similar to procedural programming, resulting in code that is easier to write and read.</p><p>Unlike concurrent code that uses completion handlers (aka callbacks), using <code>async</code> and <code>await</code> does not result in deeply nested code.</p><p>Add the <code>async</code> keyword after the parameter list and before the return type of all functions that run asynchronously. Inside the function, add the <code>await</code> keyword before all calls to other asynchronous functions. For example:</p><pre class="language-swift"><code class="language-swift">function <span class="token function">getCurrentCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> coordinates <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCurrentCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// implemented elsewhere</span><br>    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAddress</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> coordinates<span class="token punctuation">)</span> <span class="token comment">// implemented elsewhere</span><br>    <span class="token keyword">return</span> address<span class="token punctuation">.</span>city<br><span class="token punctuation">}</span></code></pre><p>All <code>async</code> functions:</p><ul><li>must be called from a &quot;concurrent context&quot; (aka asynchronous context)</li><li>run in a concurrent context, so they can call other <code>async</code> functions</li></ul><p>The <code>await</code> keyword can choose to suspend execution of the current function. This allows the thread executing the function to perform other work. When the <code>await</code> keyword is applied to a function call, it creates a &quot;suspension point&quot;. The code after the call is referred to as the &quot;continuation&quot;. When the function is resumed later, the continuation is executed, possibly in a different thread than the one in which function execution began.</p><p>In iOS 15 and above, all Apple provided functions that take a completion handler also have an <code>async</code> version. This means there is no longer a need to pass completion handlers to Apple's APIs. For example, <a href="https://developer.apple.com/documentation/foundation/urlsession?v=1.0.20" rel="noopener" target="_blank">URLSession</a> has many async methods. The resulting code is easier to write and read.</p><p>One way to create a concurrent context is it create a <a href="https://developer.apple.com/documentation/swift/task?v=1.0.20" rel="noopener" target="_blank">Task</a> object.</p><p>The following sample app gets random jokes from a free, public API. It uses the <code>async</code> and <code>await</code> keywords. It also creates tasks in two ways, using the <code>Task</code> initializer and the <code>task</code> view modifier.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">SwiftUI</span><br><br><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>    <span class="token keyword">enum</span> <span class="token class-name">MyError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> badResponseType<span class="token punctuation">,</span> badStatus<span class="token punctuation">,</span> noData<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">struct</span> <span class="token class-name">Joke</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> setup<span class="token punctuation">:</span> <span class="token class-name">String</span><br>        <span class="token keyword">let</span> punchline<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> isShowingError <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> joke<span class="token punctuation">:</span> <span class="token class-name">Joke</span><span class="token operator">?</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br><br>    <span class="token keyword">private</span> <span class="token keyword">let</span> apiURL <span class="token operator">=</span><br>        <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"https://official-joke-api.appspot.com/random_joke"</span></span><span class="token punctuation">)</span><span class="token operator">!</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">getJoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-></span> <span class="token class-name">Joke</span><span class="token operator">?</span> <span class="token punctuation">{</span><br>        message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            <span class="token comment">// The data method returns a tuple.</span><br>            <span class="token comment">// The type of response is URLResponse.</span><br>            <span class="token comment">// Cast it to HTTPURLResponse to get information from it.</span><br>            <span class="token keyword">let</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=</span><br>                <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> apiURL<span class="token punctuation">)</span><br>            <span class="token keyword">guard</span> <span class="token keyword">let</span> response <span class="token operator">=</span> response <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">HTTPURLResponse</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                <span class="token keyword">throw</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>badResponseType<br>            <span class="token punctuation">}</span><br>            <span class="token keyword">guard</span> response<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                <span class="token keyword">throw</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>badStatus<br>            <span class="token punctuation">}</span><br>            <span class="token keyword">let</span> joke <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><br>                <span class="token class-name">Joke</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span><br>                from<span class="token punctuation">:</span> data<br>            <span class="token punctuation">)</span><br>            <span class="token keyword">return</span> joke<br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            message <span class="token operator">=</span> error<span class="token punctuation">.</span>localizedDescription<br>            isShowingError <span class="token operator">=</span> <span class="token boolean">true</span><br>            <span class="token keyword">return</span> <span class="token nil constant">nil</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> body<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Jokester"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">font</span><span class="token punctuation">(</span><span class="token punctuation">.</span>largeTitle<span class="token punctuation">)</span><br>            <span class="token class-name">Spacer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">if</span> <span class="token keyword">let</span> joke <span class="token punctuation">{</span><br>                <span class="token class-name">Text</span><span class="token punctuation">(</span>joke<span class="token punctuation">.</span>setup<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">font</span><span class="token punctuation">(</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foregroundColor</span><span class="token punctuation">(</span><span class="token punctuation">.</span>green<span class="token punctuation">)</span><br>                <span class="token class-name">Text</span><span class="token punctuation">(</span>joke<span class="token punctuation">.</span>punchline<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">font</span><span class="token punctuation">(</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foregroundColor</span><span class="token punctuation">(</span><span class="token punctuation">.</span>red<span class="token punctuation">)</span><br>                    <span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">.</span>top<span class="token punctuation">)</span><br>                <span class="token class-name">Spacer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Next"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token class-name">Task</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>joke <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>                <span class="token punctuation">}</span><br>                <span class="token punctuation">.</span><span class="token function">buttonStyle</span><span class="token punctuation">(</span><span class="token punctuation">.</span>borderedProminent<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token comment">// This is a view modifier that is similar to onAppear,</span><br>        <span class="token comment">// but runs the closure passed to it in a `Task`</span><br>        <span class="token comment">// which provides an concurrent context.</span><br>        <span class="token comment">// If the view is removed, the `Task` is cancelled.</span><br>        <span class="token punctuation">.</span>task <span class="token punctuation">{</span><br>            joke <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><br>            <span class="token string-literal"><span class="token string">"Error"</span></span><span class="token punctuation">,</span><br>            isPresented<span class="token punctuation">:</span> $isShowingError<span class="token punctuation">,</span><br>            actions<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>            message<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Another free, public API that can be used in the code example above provides a suggested activity. To use this API:</p><ul><li>change the API URL to <code>https://www.boredapi.com/api/activity</code></li><li>replace the <code>Joke</code> struct with the <code>Activity</code> struct below</li><li>replace references to <code>Joke</code> with <code>Activity</code></li><li>replace references to <code>joke</code> with <code>activity</code></li><li>display the value of <code>activity.activity</code> in place of <code>joke.setup</code> and <code>joke.punchline</code>.</li></ul><pre class="language-swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">Activity</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> activity<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> type<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> participants<span class="token punctuation">:</span> <span class="token class-name">Int</span><br>    <span class="token keyword">let</span> price<span class="token punctuation">:</span> <span class="token class-name">Double</span><br>    <span class="token keyword">let</span> link<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> key<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> accessibility<span class="token punctuation">:</span> <span class="token class-name">Double</span><br><span class="token punctuation">}</span></code></pre><h2 id="continuations" tabindex="-1">Continuations</h2><p>Functions that take a completion handler (aka callback) can be wrapped in a new <code>async</code> function that does not take a callback in order to simplify their use.</p><p>In iOS 15 and above, all Apple provided functions that take a completion handler also have an <code>async</code> version. So it is not necessary to wrap the versions that take a completion handler. However, functions in non-Apple frameworks may still use completion handlers and these benefit from wrapping.</p><p>Suppose Apple had not provided an <code>async</code> method in <code>URLSession</code> for retrieving data from a <code>URL</code>. We could modify the code in the previous example as shown below. While the <code>fetchActivityWithContinuation</code> function below is somewhat complicated, calling it does not require passing a completion handler. This simplifies the code in callers.</p><pre class="language-swift"><code class="language-swift">    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">getJoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-></span> <span class="token class-name">Joke</span><span class="token operator">?</span> <span class="token punctuation">{</span><br>        message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> joke <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">fetchActivityWithContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">return</span> joke<br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            message <span class="token operator">=</span> error<span class="token punctuation">.</span>localizedDescription<br>            <span class="token keyword">return</span> <span class="token nil constant">nil</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchActivityWithContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">Joke</span> <span class="token punctuation">{</span><br>        <span class="token comment">// The closure passed to `withCheckedThrowingContinuation`</span><br>        <span class="token comment">// is passed a `CheckedContinuation` object.</span><br>        <span class="token comment">// This has a `resume` method that must be called</span><br>        <span class="token comment">// when data is available or when an error occurs.</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> withCheckedThrowingContinuation <span class="token punctuation">{</span> completion <span class="token keyword">in</span><br>            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">dataTask</span><span class="token punctuation">(</span><br>                with<span class="token punctuation">:</span> apiURL<br>            <span class="token punctuation">)</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span><br>                <span class="token comment">// The type of response is URLResponse.</span><br>                <span class="token comment">// Cast it to HTTPURLResponse to get information from it.</span><br>                <span class="token keyword">guard</span> <span class="token keyword">let</span> response <span class="token operator">=</span> response <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">HTTPURLResponse</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>badResponseType<span class="token punctuation">)</span><br>                    <span class="token keyword">return</span><br>                <span class="token punctuation">}</span><br>                <span class="token keyword">guard</span> response<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>badStatus<span class="token punctuation">)</span><br>                    <span class="token keyword">return</span><br>                <span class="token punctuation">}</span><br>                <span class="token keyword">guard</span> <span class="token keyword">let</span> data <span class="token operator">=</span> data <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>noData<span class="token punctuation">)</span><br>                    <span class="token keyword">return</span><br>                <span class="token punctuation">}</span><br>                <span class="token keyword">do</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">let</span> joke <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Joke</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token punctuation">)</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>returning<span class="token punctuation">:</span> joke<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> error<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br><br>            task<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span></code></pre><p>The example above demonstrates using the <a href="https://developer.apple.com/documentation/swift/withcheckedthrowingcontinuation(function:_:)?v=1.0.20" rel="noopener" target="_blank">withCheckedThrowingContinuation</a> function. If <code>completion.resume</code> is never called, the runtime error &quot;SWIFT TASK CONTINUATION MISUSE: ... leaked its continuation!&quot; will be triggered. If <code>completion.resume</code> is called more than once, the runtime error &quot;SWIFT TASK CONTINUATION MISUSE: ... tried to resume its continuation more than once&quot; will be triggered.</p><p>There are three other similar functions that can be used.</p><ul><li><p><a href="https://developer.apple.com/documentation/swift/withcheckedcontinuation(function:_:)?v=1.0.20" rel="noopener" target="_blank">withCheckedContinuation</a> is like <code>withCheckedThrowingContinuation</code>, but does not throw and the compiler will not allow calling <code>completion.resume(throwing: someError)</code>.</p></li><li><p><a href="https://developer.apple.com/documentation/swift/withunsafecontinuation(_:)?v=1.0.20" rel="noopener" target="_blank">withUnsafeContinuation</a> is like <code>withCheckedContinuation</code> but does not perform runtime checks to ensure that <code>completion.resume</code> is called exactly once. This makes it slightly faster.</p></li><li><p><a href="https://developer.apple.com/documentation/swift/withunsafethrowingcontinuation(_:)?v=1.0.20" rel="noopener" target="_blank">withUnsafeThrowingContinuation</a> is like <code>withCheckedThrowingContinuation</code> but does not perform runtime checks to ensure that <code>completion.resume</code> is called exactly once. This makes it slightly faster.</p></li></ul><p>Use of the unsafe versions is generally not recommended.</p><h2 id="structured-concurrency" tabindex="-1">Structured Concurrency</h2><p>Structured concurrency provides a way to execute multiple tasks at the same time AND write code in the order in which it is expected to run. The async/await system provides two ways to do this, <code>async let</code> and task groups.</p><h3 id="async-let" tabindex="-1">async let</h3><p>An <code>async let</code> statement is a special variable declaration whose value is computed asynchronously in a new, implicit child task. These statements must be used inside a concurrent context (either a closure passed to <code>Task</code> or an <code>async</code> function).</p><p>The work to compute the value of each <code>async let</code> variable begins immediately and may occur in different threads. The threads used are determined by the operating system and cannot be dictated in code.</p><p>The <code>await</code> keyword must be used to get the values of these variables. A single <code>await</code> can be used to wait for multiple values to be computed. For example:</p><pre class="language-swift"><code class="language-swift">    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> activity<span class="token punctuation">:</span> <span class="token class-name">Activity</span><span class="token operator">?</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> dogImage<span class="token punctuation">:</span> <span class="token class-name">DogImage</span><span class="token operator">?</span><br>    <span class="token operator">...</span><br>    <span class="token comment">// This could use the API at https://www.boredapi.com/api/activity.</span><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// This could use the API at https://dog.ceo/api/breeds/image/random.</span><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">getDogImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">DogImage</span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span><br>    <span class="token punctuation">}</span><br>    <span class="token operator">...</span><br>    <span class="token class-name">Task</span> <span class="token punctuation">{</span><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            <span class="token keyword">async</span> <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>            <span class="token comment">// getDogImage can begin executing before getActivity completes.</span><br>            <span class="token keyword">async</span> <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token function">getDogImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>            <span class="token comment">// This waits for both getActivity and getDogImage to complete.</span><br>            <span class="token punctuation">(</span>activity<span class="token punctuation">,</span> dogImage<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> d<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            message <span class="token operator">=</span> error<span class="token punctuation">.</span>localizedDescription<br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span></code></pre><h3 id="task-groups" tabindex="-1">Task Groups</h3><p>Task groups enable computing a variable number of values concurrently.</p><p>In the previous example we only needed to compute two values concurrently, an activity and a dog image.</p><p>Suppose we wanted to fetch a random number of dog images. We can do one of the following:</p><ul><li>If the tasks cannot throw, call <a href="https://developer.apple.com/documentation/swift/withtaskgroup(of:returning:body:)?v=1.0.20" rel="noopener" target="_blank">withTaskGroup</a> which creates a <a href="https://developer.apple.com/documentation/swift/taskgroup?v=1.0.20" rel="noopener" target="_blank">TaskGroup</a>.</li><li>If the tasks can throw, call <a href="https://developer.apple.com/documentation/swift/withthrowingtaskgroup(of:returning:body:)?v=1.0.20" rel="noopener" target="_blank">withThrowingTaskGroup</a> which creates a <a href="https://developer.apple.com/documentation/swift/throwingtaskgroup?v=1.0.20" rel="noopener" target="_blank">ThrowingTaskGroup</a>.</li></ul><p>Each these take a closure that is passed the created group. Inside the closure, call the <code>addTask</code> method of the group once for each value to be computed.</p><p>The system will decided how many of the tasks to run concurrently. Excess tasks will wait for running tasks to complete before they begin.</p><p>Tasks are not guaranteed to run in the order in which they were added to the group.</p><p>Both the <code>TaskGroup</code> and <code>ThrowingTaskGroup</code> structs conform to the <a href="https://developer.apple.com/documentation/swift/asyncsequence?v=1.0.20" rel="noopener" target="_blank">AsyncSequence</a> protocol described later. This means that the values of the tasks added to the group can be obtained using a <code>for await</code> loop when the tasks cannot throw or a <code>for try await</code> loop when the tasks can throw.</p><p>The following code demonstrates the downloading a random number (1 to 5) of dog image URLs.</p><pre class="language-swift"><code class="language-swift">    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">getDogImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token class-name">DogImage</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> dogImages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">DogImage</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>        <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token class-name">Int</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">...</span> <span class="token number">5</span><span class="token punctuation">)</span><br><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">withThrowingTaskGroup</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token class-name">DogImage</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> group <span class="token keyword">in</span><br>            <span class="token comment">// Add tasks to the group.</span><br>            <span class="token keyword">for</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token number">0</span> <span class="token operator">..&lt;</span> count <span class="token punctuation">{</span><br>                <span class="token comment">// Each task *can* begin executing</span><br>                <span class="token comment">// as soon is it is added to the group.</span><br>                <span class="token comment">// .userInitiated is the highest priority.</span><br>                <span class="token comment">// If the priority argument is omitted,</span><br>                <span class="token comment">// it uses the `default` global queue.</span><br>                group<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>priority<span class="token punctuation">:</span> <span class="token punctuation">.</span>userInitiated<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">let</span> dogImage <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token function">getDogImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                    <span class="token keyword">return</span> dogImage<br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token comment">// Wait for each task in the group to finish.</span><br>            <span class="token comment">// Results are delivered to this for loop</span><br>            <span class="token comment">// in the order in which their task finished,</span><br>            <span class="token comment">// not in the order in which the tasks were added to the group.</span><br>            <span class="token keyword">for</span> <span class="token keyword">try</span> <span class="token keyword">await</span> dogImage <span class="token keyword">in</span> group <span class="token punctuation">{</span><br>                dogImages<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dogImage<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Return the results of all the tasks.</span><br>        <span class="token keyword">return</span> dogImages<br>    <span class="token punctuation">}</span></code></pre><h2 id="unstructured-concurrency" tabindex="-1">Unstructured Concurrency</h2><p>Unstructured concurrency, like structured concurrency, provides a way to execute multiple tasks at the same time. However, it does not emphasize writing code in the order in which it is expected to run.</p><h3 id="task" tabindex="-1">Task</h3><p>Unstructured concurrency relies on creating <a href="https://developer.apple.com/documentation/swift/task?v=1.0.20" rel="noopener" target="_blank">Task</a> objects which are passed a closure that runs in a concurrent context. The system typically runs the <code>Task</code> immediately, but can choose to defer execution based on the number of tasks that are already running.</p><p><code>Task</code> is a generic struct. When creating an instance, specify the <code>Success</code> type which is the type of the value it can hold and the <code>Error</code> type which is the type of error it can hold. If a <code>Task</code> never throws, specify <code>Never</code> for the <code>Error</code> type.</p><p>The <code>Task</code> initializer can be passed the priority under which it should run. When no priority is specified, the priority of the parent <code>Task</code> is used. The available priorities from highest to lowest are:</p><ul><li><code>.high</code> or <code>.userInitiated</code></li><li><code>.medium</code> or <code>.utility</code></li><li><code>.low</code> or <code>.background</code></li></ul><p>Another way to create a <code>Task</code> is to apply the <a href="https://developer.apple.com/documentation/swiftui/view/task(priority:_:)?v=1.0.20" rel="noopener" target="_blank">task</a> view modifier which takes an optional priority (defaults to <code>userInitiated</code>) and a closure to execute inside a new <code>Task</code>. This is similar to the <a href="https://developer.apple.com/documentation/swiftui/view/onappear(perform:)?v=1.0.20" rel="noopener" target="_blank">onAppear</a> view modifier in that the closure passed to it is executed before the view on which is applied appears.</p><p>A second <a href="https://developer.apple.com/documentation/swiftui/view/task(id:priority:_:)?v=1.0.20" rel="noopener" target="_blank">task</a> view modifier also takes an <code>id</code> argument which is a value of any type. Like the other <code>task</code> view modifier, the closure passed to it is executed before the view on which is applied appears. It is re-executed every time the <code>id</code> value changes. This can be useful in scenarios where the <code>id</code> represents a query to be performed which provides new data to be displayed.</p><p>When a <code>Task</code> is saved in a variable:</p><ul><li>its value can be obtained using <code>let taskValue = await myTask.value</code></li><li>it can be notified that it is intended to be cancelled by calling <code>myTask.cancel()</code></li></ul><p>When a <code>Task</code> might be cancelled, it is responsible for verifying whether it has been cancelled. This can be done by testing the static <code>Bool</code> property <code>Task.isCancelled</code>. When this is <code>true</code> the <code>Task</code> should gracefully stop the work it is doing. Alternatively, a <code>Task</code> can call <code>try Task.checkCancellation()</code> to throw a <code>CancellationError</code> if it has been cancelled. If neither of these is done, cancelling the <code>Task</code> will have no effect.</p><p>The <code>Task</code> static property <code>isCancelled</code> and the static method <code>checkCancellation</code> apply to the <code>Task</code> inside which they are used.</p><p>Many <code>async</code> methods in Apple frameworks check for cancellation and stop their work gracefully. One example is methods in the <a href="https://developer.apple.com/documentation/foundation/urlsession?v=1.0.20" rel="noopener" target="_blank">URLSession</a> class.</p><p>A <code>Task</code> inherits the following things from the <code>Task</code> that started it:</p><ul><li>running on the same actor</li><li>running at the same priority</li><li>cancellation status</li><li><a href="#task-local-variables">task local variables</a> (described later)</li></ul><p>In some cases it is desirable to start a new <code>Task</code> that does not inherit from its parent <code>Task</code>. To do this, call the static method <code>Task.detached</code> instead of calling the <code>Task</code> initializer.</p><p>The following code demonstrates creating a <code>Task</code> and cancelling it if it runs for too long.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">SwiftUI</span><br><br><span class="token comment">// The following structs describe the JSON returned by</span><br><span class="token comment">// the API endpoint https://randomuser.me/api/.</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Location</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> street<span class="token punctuation">:</span> <span class="token class-name">Street</span><br>    <span class="token keyword">let</span> city<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> state<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> country<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> postcode<span class="token punctuation">:</span> <span class="token class-name">String</span><br><br>    <span class="token comment">// We need to decode this struct manually because</span><br>    <span class="token comment">// postcode can be a String or Int.</span><br>    <span class="token comment">// This requires defining the following enum.</span><br>    <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">CodingKeys</span><span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CodingKey</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> street<span class="token punctuation">,</span> city<span class="token punctuation">,</span> state<span class="token punctuation">,</span> country<span class="token punctuation">,</span> postcode<span class="token punctuation">,</span> coordinates<span class="token punctuation">,</span> timezone<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>from decoder<span class="token punctuation">:</span> <span class="token class-name">Decoder</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> container <span class="token operator">=</span> <span class="token keyword">try</span> decoder<span class="token punctuation">.</span><span class="token function">container</span><span class="token punctuation">(</span>keyedBy<span class="token punctuation">:</span> <span class="token class-name">CodingKeys</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><br>        street <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Street</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>street<span class="token punctuation">)</span><br>        city <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>city<span class="token punctuation">)</span><br>        state <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>state<span class="token punctuation">)</span><br>        country <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>country<span class="token punctuation">)</span><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            <span class="token comment">// First try decoding postcode as a String.</span><br>            postcode <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>postcode<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            <span class="token comment">// If it wasn't a String, try decoding postcode as an Int.</span><br>            postcode <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">String</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Int</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>postcode<span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Name</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> title<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> first<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> last<span class="token punctuation">:</span> <span class="token class-name">String</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Street</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> number<span class="token punctuation">:</span> <span class="token class-name">Int</span><br>    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">User</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">Name</span><br>    <span class="token keyword">let</span> location<span class="token punctuation">:</span> <span class="token class-name">Location</span><br>    <span class="token keyword">let</span> email<span class="token punctuation">:</span> <span class="token class-name">String</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Users</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> results<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">User</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>    <span class="token keyword">enum</span> <span class="token class-name">MyError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> badResponseType<br>        <span class="token keyword">case</span> <span class="token function">badStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">let</span> usersURL <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"https://randomuser.me/api/"</span></span><span class="token punctuation">)</span><span class="token operator">!</span><br><br>    <span class="token keyword">typealias</span> <span class="token class-name">UserTask</span> <span class="token operator">=</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span><br><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> isShowingError <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> userTask<span class="token punctuation">:</span> <span class="token class-name">UserTask</span><span class="token operator">?</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> user<span class="token punctuation">:</span> <span class="token class-name">User</span><span class="token operator">?</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token keyword">let</span> userTask <span class="token punctuation">{</span><br>            userTask<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">self</span><span class="token punctuation">.</span>userTask <span class="token operator">=</span> <span class="token nil constant">nil</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span><br>        user <span class="token operator">=</span> <span class="token nil constant">nil</span><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            userTask <span class="token operator">=</span> <span class="token class-name">UserTask</span> <span class="token punctuation">{</span><br>                <span class="token comment">// Simulate a long running task by sleeping for 1 second.</span><br>                <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>nanoseconds<span class="token punctuation">:</span> <span class="token number">1_000_000_000</span><span class="token punctuation">)</span><br><br>                <span class="token comment">// If `userTask` is cancelled before the `data` method</span><br>                <span class="token comment">// completes, it will throw a "cancelled" error.</span><br>                <span class="token keyword">let</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=</span><br>                    <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> usersURL<span class="token punctuation">)</span><br>                <span class="token keyword">guard</span> <span class="token keyword">let</span> res <span class="token operator">=</span> response <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">HTTPURLResponse</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">throw</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span>badResponseType<br>                <span class="token punctuation">}</span><br>                <span class="token keyword">guard</span> res<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">throw</span> <span class="token class-name">MyError</span><span class="token punctuation">.</span><span class="token function">badStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> res<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br><br>                <span class="token comment">// We need to check whether this task has been cancelled</span><br>                <span class="token comment">// before doing more work.</span><br>                <span class="token comment">// Is so, one option is to return nil.</span><br>                <span class="token comment">// guard !Task.isCancelled else { return nil }</span><br><br>                <span class="token comment">// Another option is to throw a CancellationError.</span><br>                <span class="token keyword">try</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token function">checkCancellation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                <span class="token keyword">let</span> users <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Users</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token punctuation">)</span><br>                <span class="token keyword">return</span> users<span class="token punctuation">.</span>results<span class="token punctuation">.</span>first<br>            <span class="token punctuation">}</span><br><br>            <span class="token comment">// This Task cancels `userTask` if runs for more than 1.2 seconds.</span><br>            <span class="token class-name">Task</span> <span class="token punctuation">{</span><br>                <span class="token keyword">let</span> seconds <span class="token operator">=</span> <span class="token number">1.2</span><br>                <span class="token keyword">let</span> nanoseconds <span class="token operator">=</span> seconds <span class="token operator">*</span> <span class="token number">1_000_000_000</span><br>                <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>nanoseconds<span class="token punctuation">:</span> <span class="token class-name">UInt64</span><span class="token punctuation">(</span>nanoseconds<span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token comment">// If `userTask` has been cancelled, the value will be `nil`.</span><br>            user <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> userTask<span class="token operator">?</span><span class="token punctuation">.</span>value<br>            message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span><br><br>            <span class="token comment">// Once we get the value from the task, clear it</span><br>            <span class="token comment">// as an indication that it is no longer running.</span><br>            userTask <span class="token operator">=</span> <span class="token nil constant">nil</span><br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            message <span class="token operator">=</span> error<span class="token punctuation">.</span>localizedDescription<br>            isShowingError <span class="token operator">=</span> <span class="token boolean">true</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> <span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span><span class="token punctuation">(</span>alignment<span class="token punctuation">:</span> <span class="token punctuation">.</span>leading<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> name <span class="token operator">=</span> user<span class="token punctuation">.</span>name<br>            <span class="token keyword">let</span> location <span class="token operator">=</span> user<span class="token punctuation">.</span>location<br>            <span class="token keyword">let</span> street <span class="token operator">=</span> location<span class="token punctuation">.</span>street<br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name<span class="token punctuation">.</span>title</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name<span class="token punctuation">.</span>first</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name<span class="token punctuation">.</span>last</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token comment">// Using the String initializer prevents comma separators</span><br>            <span class="token comment">// when numbers are converted to strings.</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">(</span>street<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal"><span class="token string">" "</span></span> <span class="token operator">+</span> street<span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>city</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">, </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>state</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>country</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>postcode</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>email<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> body<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span><span class="token punctuation">(</span>spacing<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> userTask <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Get Another User"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token class-name">Task</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> <span class="token function">fetchUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>                <span class="token punctuation">}</span><br>                <span class="token punctuation">.</span><span class="token function">buttonStyle</span><span class="token punctuation">(</span><span class="token punctuation">.</span>borderedProminent<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token keyword">if</span> <span class="token keyword">let</span> user <span class="token punctuation">{</span><br>                <span class="token function">render</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> user<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> userTask <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"The task was cancelled."</span></span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Cancel"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>                <span class="token punctuation">.</span><span class="token function">buttonStyle</span><span class="token punctuation">(</span><span class="token punctuation">.</span>bordered<span class="token punctuation">)</span><br>                <span class="token class-name">ProgressView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Spacer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span>task <span class="token punctuation">{</span><br>            <span class="token keyword">await</span> <span class="token function">fetchUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><br>            <span class="token string-literal"><span class="token string">"Error"</span></span><span class="token punctuation">,</span><br>            isPresented<span class="token punctuation">:</span> $isShowingError<span class="token punctuation">,</span><br>            actions<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>            message<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h3 id="task-tree" tabindex="-1">Task Tree</h3><p>When a <code>Task</code> create other tasks, those are considered to be child tasks of their parent <code>Task</code>. This creates a &quot;task tree&quot;.</p><p>A parent <code>Task</code> is not considered finished until all of its child tasks complete.</p><p>If an error is thrown by a <code>Task</code>, the <code>Task</code> ends and the error is propagated to its parent <code>Task</code>. Sibling tasks that are running or waiting to run are cancelled.</p><h2 id="actors" tabindex="-1">Actors</h2><p>Tasks can share mutable data without danger of race conditions by using an <a href="https://developer.apple.com/documentation/swift/actor?v=1.0.20" rel="noopener" target="_blank">Actor</a>.</p><p>Actors:</p><ul><li>synchronize access to their mutable state</li><li>are a reference type like classes rather than a value type like structs</li><li>are written similar to classes, substituting the <code>actor</code> keyword for the <code>class</code> keyword</li><li>can conform to protocols, although it is difficult to implement methods that should be called in a synchronous context</li><li>can obtain additional functionality from extensions</li></ul><p>Accesses to actor properties and methods must occur in a concurrent context and be preceded by the <code>await</code> keyword.</p><p><code>Actor</code> methods that have no danger of resulting in a race condition can be marked with the <code>nonisolated</code> keyword. This removes the need to call them in a concurrent context and precede calls with the <code>await</code> keyword.</p><p>The following code demonstrates implementing a custom <code>Actor</code> that maintains an array of <code>User</code> objects and provides a method for adding a new <code>User</code> that is obtained from an API endpoint. The view model used by the UI asks the <code>Actor</code> to add a new <code>User</code> every three seconds. The UI also contains a <code>Button</code> that when tapped adds another <code>User</code>.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">SwiftUI</span><br><br><span class="token keyword">enum</span> <span class="token class-name">NetworkError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> badResponseType<br>    <span class="token keyword">case</span> <span class="token function">badStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><br>    <span class="token keyword">case</span> noData<br><span class="token punctuation">}</span><br><br><span class="token comment">// The following structs describe the JSON returned by</span><br><span class="token comment">// the API endpoint https://randomuser.me/api/.</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Address</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> title<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> first<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> last<span class="token punctuation">:</span> <span class="token class-name">String</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Location</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> street<span class="token punctuation">:</span> <span class="token class-name">Street</span><br>    <span class="token keyword">let</span> city<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> state<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> country<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> postcode<span class="token punctuation">:</span> <span class="token class-name">String</span><br><br>    <span class="token comment">// We need to decode this struct manually because</span><br>    <span class="token comment">// postcode can be a String or Int.</span><br>    <span class="token comment">// Manual decoding requires defining the following enum.</span><br>    <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">CodingKeys</span><span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CodingKey</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> street<span class="token punctuation">,</span> city<span class="token punctuation">,</span> state<span class="token punctuation">,</span> country<span class="token punctuation">,</span> postcode<span class="token punctuation">,</span> coordinates<span class="token punctuation">,</span> timezone<br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>from decoder<span class="token punctuation">:</span> <span class="token class-name">Decoder</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> container <span class="token operator">=</span> <span class="token keyword">try</span> decoder<span class="token punctuation">.</span><span class="token function">container</span><span class="token punctuation">(</span>keyedBy<span class="token punctuation">:</span> <span class="token class-name">CodingKeys</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><br>        street <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Street</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>street<span class="token punctuation">)</span><br>        city <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>city<span class="token punctuation">)</span><br>        state <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>state<span class="token punctuation">)</span><br>        country <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>country<span class="token punctuation">)</span><br>        <span class="token keyword">do</span> <span class="token punctuation">{</span><br>            <span class="token comment">// First try decoding postcode as a String.</span><br>            postcode <span class="token operator">=</span> <span class="token keyword">try</span> container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>postcode<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>            <span class="token comment">// If it wasn't a String, try decoding postcode as an Int.</span><br>            postcode <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">String</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Int</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token punctuation">.</span>postcode<span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Name</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> title<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> first<span class="token punctuation">:</span> <span class="token class-name">String</span><br>    <span class="token keyword">let</span> last<span class="token punctuation">:</span> <span class="token class-name">String</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Street</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> number<span class="token punctuation">:</span> <span class="token class-name">Int</span><br>    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">User</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span><span class="token punctuation">,</span> <span class="token class-name">Identifiable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">Name</span><br>    <span class="token keyword">let</span> location<span class="token punctuation">:</span> <span class="token class-name">Location</span><br>    <span class="token keyword">let</span> email<span class="token punctuation">:</span> <span class="token class-name">String</span><br><br>    <span class="token keyword">var</span> id<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> email <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Users</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> results<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">User</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// This actor enables multiple threads to safely</span><br><span class="token comment">// access an array of `User` objects and</span><br><span class="token comment">// call the `addUser` method to add another user.</span><br><span class="token keyword">actor</span> <span class="token class-name">UsersActor</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> usersURL <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"https://randomuser.me/api/"</span></span><span class="token punctuation">)</span><span class="token operator">!</span><br><br>    <span class="token comment">// Multiple threads can safely access this property concurrently.</span><br>    <span class="token keyword">var</span> users<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">User</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>    <span class="token comment">// Multiple threads can safely call this method concurrently.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> usersURL<span class="token punctuation">)</span><br>        <span class="token keyword">guard</span> <span class="token keyword">let</span> res <span class="token operator">=</span> response <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">HTTPURLResponse</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token class-name">NetworkError</span><span class="token punctuation">.</span>badResponseType<br>        <span class="token punctuation">}</span><br>        <span class="token keyword">guard</span> res<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token class-name">NetworkError</span><span class="token punctuation">.</span><span class="token function">badStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> res<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">let</span> decoded <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Users</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token punctuation">)</span><br>        <span class="token keyword">if</span> <span class="token keyword">let</span> user <span class="token operator">=</span> decoded<span class="token punctuation">.</span>results<span class="token punctuation">.</span>first <span class="token punctuation">{</span><br>            users<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> at<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// This view model allows the UI to access</span><br><span class="token comment">// the array of `User` objects held by the actor above.</span><br><span class="token comment">// It is not an option to make the custom actor above</span><br><span class="token comment">// inherit from `ObservableObject` and use that as the view model</span><br><span class="token comment">// because actors do not necessarily run on the main thread</span><br><span class="token comment">// and ObservableObject subclasses must run on the main thread.</span><br><span class="token attribute atrule">@MainActor</span><br><span class="token keyword">class</span> <span class="token class-name">UsersViewModel</span><span class="token punctuation">:</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span><br>    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> running <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> users<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">User</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>    <span class="token keyword">var</span> timer<span class="token punctuation">:</span> <span class="token class-name">Timer</span><span class="token operator">?</span><br>    <span class="token keyword">private</span> <span class="token keyword">let</span> usersActor<span class="token punctuation">:</span> <span class="token class-name">UsersActor</span><span class="token operator">!</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span>usersActor<span class="token punctuation">:</span> <span class="token class-name">UsersActor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">self</span><span class="token punctuation">.</span>usersActor <span class="token operator">=</span> usersActor<br><br>        <span class="token comment">// Add a new user every three seconds.</span><br>        timer <span class="token operator">=</span> <span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">scheduledTimer</span><span class="token punctuation">(</span><br>            withTimeInterval<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>            repeats<span class="token punctuation">:</span> <span class="token boolean">true</span><br>        <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span><br>            <span class="token class-name">Task</span> <span class="token punctuation">{</span><br>                <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        running <span class="token operator">=</span> <span class="token boolean">true</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> usersActor<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>        <span class="token comment">// Get all the users from UserActor.</span><br>        <span class="token keyword">let</span> actorUsers <span class="token operator">=</span> <span class="token keyword">await</span> usersActor<span class="token punctuation">.</span>users<br><br>        <span class="token comment">// Replace the array of users here</span><br>        <span class="token comment">// with the array in UsersActor.</span><br>        <span class="token comment">// This must be done on the main thread.</span><br>        <span class="token keyword">await</span> <span class="token class-name">MainActor</span><span class="token punctuation">.</span>run <span class="token punctuation">{</span><br>            users <span class="token operator">=</span> actorUsers<br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token keyword">let</span> timer <span class="token punctuation">{</span><br>            timer<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            running <span class="token operator">=</span> <span class="token boolean">false</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>    <span class="token attribute atrule">@StateObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> viewModel <span class="token operator">=</span><br>        <span class="token class-name">UsersViewModel</span><span class="token punctuation">(</span>usersActor<span class="token punctuation">:</span> <span class="token class-name">UsersActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> <span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span><span class="token punctuation">(</span>alignment<span class="token punctuation">:</span> <span class="token punctuation">.</span>leading<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> name <span class="token operator">=</span> user<span class="token punctuation">.</span>name<br>            <span class="token keyword">let</span> location <span class="token operator">=</span> user<span class="token punctuation">.</span>location<br>            <span class="token keyword">let</span> street <span class="token operator">=</span> location<span class="token punctuation">.</span>street<br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name<span class="token punctuation">.</span>title</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name<span class="token punctuation">.</span>first</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name<span class="token punctuation">.</span>last</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token comment">// Using the String initializer prevents comma separators</span><br>            <span class="token comment">// when numbers are converted to strings.</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">(</span>street<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal"><span class="token string">" "</span></span> <span class="token operator">+</span> street<span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>city</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">, </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>state</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>country</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">location<span class="token punctuation">.</span>postcode</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>email<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">.</span>top<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> body<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span> <span class="token punctuation">{</span><br>            <span class="token class-name">HStack</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Get Another User"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token class-name">Task</span> <span class="token punctuation">{</span><br>                        <span class="token keyword">try</span> <span class="token keyword">await</span> viewModel<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                    <span class="token punctuation">}</span><br>                <span class="token punctuation">}</span><br>                <span class="token punctuation">.</span><span class="token function">buttonStyle</span><span class="token punctuation">(</span><span class="token punctuation">.</span>borderedProminent<span class="token punctuation">)</span><br><br>                <span class="token keyword">if</span> viewModel<span class="token punctuation">.</span>running <span class="token punctuation">{</span><br>                    <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Cancel"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                        viewModel<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                    <span class="token punctuation">}</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token class-name">List</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">.</span>users<span class="token punctuation">)</span> <span class="token punctuation">{</span> user <span class="token keyword">in</span><br>                <span class="token function">render</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> user<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2 id="sendable-types" tabindex="-1">Sendable Types</h2><p>In order to pass data from one <code>Task</code> to another, the data must be thread-safe. This is achieved by using data types that conform to the <a href="https://developer.apple.com/documentation/swift/sendable?v=1.0.20" rel="noopener" target="_blank">Sendable</a> protocol.</p><p>Passing data from one <code>Task</code> to another is not common.</p><p>The following types are <code>Sendable</code>:</p><ul><li>all <code>struct</code> and <code>enum</code> types unless they have properties that are not sendable.</li><li>all <code>actor</code> types</li><li><code>class</code> types that explicitly conform to <code>Sendable</code>, are marked as <code>final</code> (other classes cannot inherit from it), and have no mutable properties</li><li>methods and closures that are marked with the <code>@Sendable</code> attribute (Such closures can only capture sendable types.)</li></ul><h2 id="main-actor" tabindex="-1">Main Actor</h2><p><a href="https://developer.apple.com/documentation/swift/mainactor?v=1.0.20" rel="noopener" target="_blank">MainActor</a> is a system-provided global actor that performs its work on the main thread.</p><p>One way to ensure that code runs in the main thread is to mark it with the <code>@MainActor</code> attribute. Most types in SwiftUI and UIKit are marked with this. It is recommend that all custom classes that inherit from <code>ObservableObject</code> should do the same.</p><p><code>@MainActor</code> can be applied to:</p><ul><li>type declarations for a <code>class</code>, <code>struct</code>, or <code>enum</code> (This causes all of their properties to be accessed on the main thread and all of their methods to execute on the main thread.)</li><li>properties of a type</li><li>methods of a type</li><li>functions</li><li>closures</li></ul><p>Functions that are running in the context of a different actor can call functions that will run in the <code>MainActor</code> context, but they must call them asynchronously using <code>await</code> or <code>async let</code>.</p><p>When a function that is running on the main thread calls an <code>async</code> method that returns a value, it may run on a different thread, but the assignment of the result to a local variable will occur in the main thread.</p><p>Methods in a type to which <code>@MainActor</code> is applied can be marked with <code>nonisolated</code> to allow it to be called from any concurrent context. This can improve their performance. However, such methods cannot return the value of a property in the type or a value computed from the properties.</p><p>To apply <code>@MainActor</code> to a closure, add it before the parameter list. This is typically only done for closures that update the UI. For example:</p><pre class="language-swift"><code class="language-swift"><span class="token class-name">Task</span> <span class="token punctuation">{</span> <span class="token attribute atrule">@MainActor</span> p1<span class="token punctuation">,</span> p2 <span class="token keyword">in</span><br>    <span class="token operator">...</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// This closure has no parameters.</span><br><span class="token class-name">Task</span> <span class="token punctuation">{</span> <span class="token attribute atrule">@MainActor</span> <span class="token keyword">in</span><br>    <span class="token operator">...</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// This is a longer alternative that does the same thing.</span><br><span class="token class-name">Task</span> <span class="token punctuation">{</span><br>    <span class="token keyword">await</span> <span class="token class-name">MainActor</span><span class="token punctuation">.</span>run <span class="token punctuation">{</span><br>        <span class="token operator">...</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// This is an even longer alternative that does the same thing.</span><br><span class="token comment">// that was the approach before the async/await system was introduced.</span><br><span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><br><span class="token punctuation">}</span></code></pre><h2 id="custom-global-actors" tabindex="-1">Custom Global Actors</h2><p>Recall that the purpose of an actor is to enable tasks to share mutable data without danger of race conditions. To simplify accessing a custom actor from many functions, define a custom global actor. To do so, apply the <code>@globalActor</code> attribute to a struct that contains an <code>actor</code> definition and makes an instance available through a <code>static</code> property named <code>shared</code>. Then mark the types and functions that should run in the context of that actor with an attribute that uses the global actor name.</p><p>For example:</p><pre class="language-swift"><code class="language-swift"><span class="token attribute atrule">@globalActor</span><br><span class="token keyword">struct</span> <span class="token class-name">MyGlobalActor</span> <span class="token punctuation">{</span><br>    <span class="token keyword">actor</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">static</span> <span class="token keyword">let</span> shared<span class="token punctuation">:</span> <span class="token class-name">MyActor</span> <span class="token operator">=</span> <span class="token class-name">MyActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token attribute atrule">@MyGlobalActor</span><br><span class="token keyword">struct</span> <span class="token class-name">MyStruct</span> <span class="token punctuation">{</span><br>    <span class="token comment">// All accesses to properties defined here</span><br>    <span class="token comment">// and all calls to methods defined here</span><br>    <span class="token comment">// will occur in the context of the `MyGlobalActor` actor.</span><br>    <span class="token operator">...</span><br><span class="token punctuation">}</span></code></pre><h2 id="asyncsequence" tabindex="-1">AsyncSequence</h2><p>An <a href="https://developer.apple.com/documentation/swift/asyncsequence?v=1.0.20" rel="noopener" target="_blank">AsyncSequence</a> supports iterating over a sequence of values that are obtained asynchronously. Unlike a <a href="https://developer.apple.com/documentation/swift/sequence?v=1.0.20" rel="noopener" target="_blank">Sequence</a> which holds a collection of values, an <code>AsyncSequence</code> just provides a way to access values.</p><p>A <code>TaskGroup</code> uses an <code>AsyncSequence</code> to provided its results. The following line of code from the <a href="#task-groups">Task Groups</a> section above takes advantage of this:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">for</span> <span class="token keyword">try</span> <span class="token keyword">await</span> dogImage <span class="token keyword">in</span> group <span class="token punctuation">{</span></code></pre><p>Instances of <code>AsyncSequence</code> support many of the same methods found in the <code>Sequence</code> protocol such as <code>map</code>, <code>filter</code>, and <code>reduce</code>. These return a new <code>AsyncSequence</code> instance which enables method calls to be chained. Some <code>Sequence</code> methods such as <code>dropFirst</code> are not supported by <code>AsyncSequence</code>.</p><p>The work of retrieving values from an <code>AsyncSequence</code> does not begin until it is used in a <code>for await</code> or <code>for try await</code> loop. Chaining methods like <code>map</code>, <code>filter</code>, and <code>reduce</code> only configure the processing that will occur when code begins asking for values.</p><p>An <code>AsyncSequence</code> is always executed only one time and the results are cached. If an <code>AsyncSequence</code> is iterated over again, the cached results are returned. TODO: Does it cache all the values even if it is a very long sequence? TODO: See <a href="https://github.com/AndyIbanez/modern-concurrency-on-apple-platforms-book-code/issues/2">https://github.com/AndyIbanez/modern-concurrency-on-apple-platforms-book-code/issues/2</a>.</p><p>It is not possible to ask an <code>AsyncSequence</code> for its count.</p><p>The <a href="https://developer.apple.com/documentation/foundation/url?v=1.0.20" rel="noopener" target="_blank">URL</a> struct has a <a href="https://developer.apple.com/documentation/foundation/url/3767315-lines?v=1.0.20" rel="noopener" target="_blank">lines</a> property whose type is <code>AsyncLineSequence&lt;URL.AsyncBytes&gt;</code>. This enables iterating over the lines found at a URL asynchronously.</p><p>The following code demonstrates reading the lines in a CSV file found at a <code>URL</code>. Each row of the CSV data provides information about a city. There are ten columns in each row. The last column holds a state abbreviation. The <code>await</code> keyword must be used to wait for each line to be delivered. The lines are filtered to only get data for cities in a certain state.</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> citiesURL <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"https://people.sc.fsu.edu/~jburkardt/data/csv/cities.csv"</span></span><br><span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> citiesURL<span class="token punctuation">)</span><span class="token operator">!</span><br><span class="token keyword">let</span> citiesInMissouri <span class="token operator">=</span> url<span class="token punctuation">.</span>lines<span class="token punctuation">.</span>filter <span class="token punctuation">{</span> line <span class="token keyword">in</span><br>    <span class="token keyword">let</span> columns <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">components</span><span class="token punctuation">(</span>separatedBy<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">","</span></span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> state <span class="token operator">=</span> columns<span class="token punctuation">.</span>last<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">trimmingCharacters</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>whitespaces<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> state <span class="token operator">==</span> <span class="token string-literal"><span class="token string">"MO"</span></span><br><span class="token punctuation">}</span><br><span class="token keyword">for</span> <span class="token keyword">try</span> <span class="token keyword">await</span> line <span class="token keyword">in</span> citiesInMissouri <span class="token punctuation">{</span><br>    <span class="token function">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>Other standard API methods that return an <code>AsyncSequence</code> include:</p><ul><li><a href="https://developer.apple.com/documentation/foundation/filehandle/asyncbytes/3766668-lines?v=1.0.20" rel="noopener" target="_blank">FileHandle.standardInput.bytes.lines</a></li><li><a href="https://developer.apple.com/documentation/foundation/url/3767316-resourcebytes?v=1.0.20" rel="noopener" target="_blank">URL.resourceBytes</a></li><li><a href="https://developer.apple.com/documentation/foundation/urlsession/3767351-bytes?v=1.0.20" rel="noopener" target="_blank">URLSession.bytes</a></li><li><a href="https://developer.apple.com/documentation/foundation/notificationcenter/3813137-notifications?v=1.0.20" rel="noopener" target="_blank">NotificationCenter.notifications</a></li></ul><p>Just like in synchronous <code>for</code> loops, the <code>continue</code> and <code>break</code> keywords can be used in <code>for await</code> and <code>for try await</code> loops.</p><h2 id="task-local-variables" tabindex="-1">Task Local Variables</h2><p>The <code>@TaskLocal</code> attribute can be applied to <code>static</code> property declarations in a type definition. This allows data, referred to as &quot;task local variables&quot;, to be shared across tasks in the task tree. These properties must be given a default value or have an optional type.</p><p>Task local variables in type instances that are created in a task can be read and modified by any descendant tasks in the task tree.</p><p>To read the value of a task local variable, precede its name with the <code>await</code> keyword. For example:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token class-name">SomeClass</span><span class="token punctuation">.</span>someTaskLocalVariable</code></pre><p>To modify the value of a task local variable, call the <a href="https://developer.apple.com/documentation/swift/tasklocal/withvalue(_:operation:file:line:)-79atg?v=1.0.20" rel="noopener" target="_blank">withValue</a> method on a binding to the property, passing it a new value. For example:</p><pre class="language-swift"><code class="language-swift"><span class="token class-name">SomeClass</span><span class="token punctuation">.</span>$someTaskLocalVariable<span class="token punctuation">.</span><span class="token function">withValue</span><span class="token punctuation">(</span>someNewValue<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span> code to execute <span class="token operator">...</span><br><span class="token punctuation">}</span></code></pre><p>The new value is only available in non-detached tasks that are spawned by the closure passed to the <code>withValue</code> method.</p><p><code>SomeClass</code> in the examples above can be replaced by <code>Self</code> when inside the same class that defines the task local variable.</p><h2 id="thread-sanitizer" tabindex="-1">Thread Sanitizer</h2><p>A data race can occur when multiple concurrently running threads access the same memory and at least one is modifying the memory. This can cause unpredictable results, data corruption, and application crashes.</p><p>Typically using actors and serial queues prevents data races. But they can still occur when using concurrent queues. The &quot;Thread Sanitizer&quot; (aka TSan) is a tool built into Xcode that aids in detecting and debugging data races. It is supported on all 64-bit platforms. However, the app must be run in the Simulator rather than on a device.</p><p>To use the Thread Sanitizer in Xcode:</p><ul><li>Select &quot;Edit Scheme...&quot; from the dropdown menu to the left of the device dropdown which appears at the top center of the Xcode window.</li><li>Select the &quot;Run&quot; category in the left nav.</li><li>Select the &quot;Diagnostics&quot; tab.</li><li>Check the &quot;Thread Sanitizer&quot; checkbox.</li><li>Click the &quot;Close&quot; button.</li><li>Rebuild the app. This will add code around all memory accesses to log them.</li><li>Run the app in the Simulator. This will decrease the performance of the app, running up to 20 times slower.</li><li>See warnings about data races in the &quot;Issue Navigator&quot; and on specific lines of code in code editor panels.</li></ul><pre><code>
</code></pre></article>