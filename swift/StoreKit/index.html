<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>StoreKit</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#resources">Resources</a></li><li><a href="#usage">Usage</a></li><li><a href="#displaying-products">Displaying Products</a></li><li><a href="#testing-from-xcode">Testing from Xcode</a></li><li><a href="#example-project">Example Project</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://developer.apple.com/documentation/storekit?v=1.1.0" rel="noopener" target="_blank">StoreKit</a> is an Apple framework that supports in-app purchases, ad network attribution, Apple Music integration, and enabling app ratings and reviews.</p><h2 id="resources" tabindex="-1">Resources</h2><ul><li>WWDC 2022 video <a href="https://developer.apple.com/videos/play/wwdc2022/10007/?v=1.1.0" rel="noopener" target="_blank">What's new with in-app purchase</a></li><li>WWDC 2022 video <a href="https://developer.apple.com/videos/play/wwdc2022/110404/?v=1.1.0" rel="noopener" target="_blank">Implement proactive in-app purchase restore</a></li><li>WWDC 2022 video <a href="https://developer.apple.com/videos/play/wwdc2022/10039/?v=1.1.0" rel="noopener" target="_blank">What's new in StoreKit testing</a></li><li>WWDC 2023 video <a href="https://developer.apple.com/wwdc23/10013?v=1.1.0" rel="noopener" target="_blank">Meet StoreKit for SwiftUI</a></li></ul><h2 id="usage" tabindex="-1">Usage</h2><p>To use StoreKit in an app:</p><ol><li><p>Select File ... New ... File... or press cmd-n.</p></li><li><p>Scroll the &quot;Other&quot; category.</p></li><li><p>Select &quot;StoreKit Configuration File&quot;.</p></li><li><p>A file name can be entered, but the default name of &quot;Configuration.storekit&quot; is fine.</p></li><li><p>Click the &quot;+&quot; in the lower-left of the editor and select a type. For one-time purchases, select &quot;Add Non-Consumable In-App Purchase&quot;.</p></li><li><p>Enter a &quot;Reference Name&quot;. This can be the app name. To find this, click the top entry in the Navigator, select the &quot;General&quot; tab, and note the value of Identity ... Display Name.</p></li><li><p>Enter a &quot;Product ID&quot;. This can be the project bundle identifier. To find this, click the top entry in the Navigator, select the &quot;General&quot; tab, and note the value of Identity ... Bundle Identifier.</p></li><li><p>Enter a price.</p></li><li><p>Under &quot;Localizations&quot;, double-click an option such as &quot;English (U.S.)&quot;.</p></li><li><p>Enter a &quot;Display Name&quot;. This can be the same as the Reference Name entered above.</p></li><li><p>Enter a &quot;Description&quot; of the purchasable item.</p></li><li><p>Click &quot;+&quot; under &quot;Localizations&quot; to add more supported locales.</p></li><li><p>Repeat steps 5-12 for each additional non-consumable that can be purchased.</p></li><li><p>Create a new Swift file. A good name is <code>StoreKit.swift</code>.</p></li><li><p>Add the following in <code>StoreKitStore.swift</code>:</p><pre class="language-swift"><code class="language-swift"> <span class="token keyword">import</span> <span class="token class-name">StoreKit</span><br><br> <span class="token keyword">class</span> <span class="token class-name">StoreKitStore</span><span class="token punctuation">:</span> <span class="token class-name">NSObject</span><span class="token punctuation">,</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span><br>     <span class="token comment">// This is a Set of purchasable product ids.</span><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> allProductIdentifiers <span class="token operator">=</span><br>         <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"r.mark.volkmann.gmail.com.GiftTrack"</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> productsRequest<span class="token punctuation">:</span> <span class="token class-name">SKProductsRequest</span><span class="token operator">?</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> fetchedProducts<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">SKProduct</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>     <span class="token keyword">typealias</span> <span class="token class-name">CompletionHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">SKProduct</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Void</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> completionHandler<span class="token punctuation">:</span> <span class="token class-name">CompletionHandler</span><span class="token operator">?</span><br><br>     <span class="token keyword">override</span> <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>         fetchProducts <span class="token punctuation">{</span> products <span class="token keyword">in</span><br>             <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"products ="</span></span><span class="token punctuation">,</span> products<span class="token punctuation">)</span><br>         <span class="token punctuation">}</span><br>     <span class="token punctuation">}</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchProducts</span><span class="token punctuation">(</span><br>         <span class="token omit keyword">_</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token class-name">CompletionHandler</span><br>     <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token keyword">guard</span> productsRequest <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span><br>         completionHandler <span class="token operator">=</span> completion<br>         productsRequest <span class="token operator">=</span><br>             <span class="token class-name">SKProductsRequest</span><span class="token punctuation">(</span>productIdentifiers<span class="token punctuation">:</span> allProductIdentifiers<span class="token punctuation">)</span><br>         productsRequest<span class="token operator">?</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span><br>         productsRequest<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>     <span class="token punctuation">}</span><br> <span class="token punctuation">}</span><br><br> <span class="token keyword">extension</span> <span class="token class-name">StoreKitStore</span><span class="token punctuation">:</span> <span class="token class-name">SKProductsRequestDelegate</span> <span class="token punctuation">{</span><br>     <span class="token keyword">func</span> <span class="token function-definition function">productsRequest</span><span class="token punctuation">(</span><br>         <span class="token omit keyword">_</span> request<span class="token punctuation">:</span> <span class="token class-name">SKProductsRequest</span><span class="token punctuation">,</span><br>         didReceive response<span class="token punctuation">:</span> <span class="token class-name">SKProductsResponse</span><br>     <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token keyword">let</span> loadedProducts <span class="token operator">=</span> response<span class="token punctuation">.</span>products<br>         <span class="token keyword">let</span> invalidProducts <span class="token operator">=</span> response<span class="token punctuation">.</span>invalidProductIdentifiers<br>         <span class="token keyword">guard</span> <span class="token operator">!</span>loadedProducts<span class="token punctuation">.</span>isEmpty <span class="token keyword">else</span> <span class="token punctuation">{</span><br>             <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"failed to load products"</span></span><span class="token punctuation">)</span><br>             <span class="token keyword">if</span> <span class="token operator">!</span>invalidProducts<span class="token punctuation">.</span>isEmpty <span class="token punctuation">{</span><br>                 <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"invalid products found: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">invalidProducts</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>             <span class="token punctuation">}</span><br>             productsRequest <span class="token operator">=</span> <span class="token nil constant">nil</span><br>             <span class="token keyword">return</span><br>         <span class="token punctuation">}</span><br><br>         <span class="token comment">// Cache the fetched products.</span><br>         fetchedProducts <span class="token operator">=</span> loadedProducts<br><br>         <span class="token comment">// Notify listeners of loaded products.</span><br>         <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span><br>             <span class="token keyword">self</span><span class="token punctuation">.</span>completionHandler<span class="token operator">?</span><span class="token punctuation">(</span>loadedProducts<span class="token punctuation">)</span><br>             <span class="token keyword">self</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> <span class="token nil constant">nil</span><br>             <span class="token keyword">self</span><span class="token punctuation">.</span>productsRequest <span class="token operator">=</span> <span class="token nil constant">nil</span><br>         <span class="token punctuation">}</span><br>     <span class="token punctuation">}</span><br> <span class="token punctuation">}</span></code></pre></li><li><p>In the <code>{app-name}.swift</code> file, add the following inside the struct that inherits from <code>App</code>:</p><pre class="language-swift"><code class="language-swift"><span class="token attribute atrule">@StateObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> store <span class="token operator">=</span> <span class="token class-name">StoreKitStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></li><li><p>In any views that need to access the store, add the following:</p><pre class="language-swift"><code class="language-swift"><span class="token attribute atrule">@EnvironmentObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> store<span class="token punctuation">:</span> <span class="token class-name">StoreKitStore</span></code></pre></li><li><p>In the Navigator, select <code>{app-name}.swift</code>.</p></li><li><p>In the top bar, click the project name to the left of the device drop-down and select &quot;Edit Scheme...&quot; which opens a dialog.</p></li><li><p>Click &quot;Run&quot; in the dialog left nav.</p></li><li><p>Click the &quot;Options&quot; tab.</p></li><li><p>Change the value of &quot;StoreKit Configuration&quot; from &quot;None&quot; to &quot;Configuration.storekit&quot;.</p></li><li><p>Click the &quot;Close&quot; button.</p></li></ol><h2 id="displaying-products" tabindex="-1">Displaying Products</h2><p>To display products in SwiftUI, get an array of product ids where each is a <code>String</code> and pass it to the <code>StoreView</code> view.</p><pre class="language-swift"><code class="language-swift"><span class="token class-name">StoreView</span><span class="token punctuation">(</span>ids<span class="token punctuation">:</span> productIds<span class="token punctuation">)</span></code></pre><p>This produces a UI that works on all platforms including iOS, iPadOS, macOS, and watchOS.</p><p>This is best tested in the Simulator rather than in Previews.</p><p>The <code>productViewStyle</code> view modifier can be applied to <code>StoreView</code> to change the size and layout of each product section. It takes one argument which can be <code>.regular</code> (default), <code>.large</code>, or <code>.compact</code>. The <code>.large</code> option has an issue with horizontal alignment.</p><h2 id="testing-from-xcode" tabindex="-1">Testing from Xcode</h2><p>Xcode and the Simulator can be used to test in-app purchases without the need to configure them in AppStoreConnect. See the YouTube video <a href="https://www.youtube.com/watch?v=o_YMsmmkfFc&feature=youtu.be?v=1.1.0" rel="noopener" target="_blank">How to easily test InApp Purchases in an iOS app</a> with Josh Holtz.</p><p>To create a StoreKit configuration file to be used for testing:</p><ol><li>Select File ... New ... File...</li><li>Select &quot;StoreKit Configuration File&quot; and click the &quot;Next&quot; button.</li><li>Enter a name like &quot;Test&quot;. The file will have an extension of <code>.storekit</code>.</li><li>If you have already described the products in AppStoreConnect, check the &quot;Sync this file with an app in App Store Connect&quot; checkbox.</li><li>Click the &quot;Next&quot; button.</li><li>Select the top project directory that contains the main <code>.swift</code> file.</li><li>Click the &quot;Create&quot; button.</li></ol><p>To describe products in the new StoreKit configuration file:</p><ol><li><p>In the special editor that opens for the new StoreKit configuration file, for each product to be offered by the app:</p><ol><li>Click the &quot;+&quot; in the lower-left and select a kind of product to add such as &quot;Add Non-Consumable In-App Purchase&quot;.</li><li>Enter a &quot;Reference Name&quot; that describes the product.</li><li>Enter a product ID that is unique among all of your apps. It could be the app bundle ID followed by a product-specific identifier.</li><li>Enter a price.</li><li>Optionally select &quot;On&quot; for &quot;Family Sharing&quot;.</li><li>Expand the &quot;Localizations&quot; section.</li><li>For each language to be supported, enter a &quot;Display Name&quot; and &quot;Description&quot; for the product.</li></ol></li></ol><p>To tell the Simulator to use this new <code>.storekit</code> configuration file:</p><ol><li>Click the dropdown to the left of the device dropdown at the top of the Xcode window.</li><li>Select &quot;Edit Scheme...&quot;</li><li>In the left nav, select &quot;Run&quot;.</li><li>Select the &quot;Options&quot; tab.</li><li>Change the value selected in the &quot;StoreKit Configuration&quot; dropdown to the name of the new <code>.storekit</code> configuration file.</li><li>Click the &quot;Close&quot; button.</li></ol><p>To test an in-app purchase:</p><ol><li>Run the app in the Simulator and make an in-app purchase.</li><li>If the products do not appear in the app, try running it again.</li><li>In Xcode, select Debug ... StoreKit ... Manage Transactions... to see a history of all the in-app purchase transactions.</li><li>Right-click a transaction to get a menu with the options &quot;Approve Transaction&quot;, &quot;Decline Transaction&quot;, &quot;Refund Purchase&quot;, &quot;Resolve Issue&quot;, &quot;Request Price Increase Consent&quot;, and &quot;Delete Transaction&quot;.</li><li>For subscriptions, click the &quot;Subscription Options&quot; button below a transaction to get a dialog where the subscription can be cancelled.</li></ol><h2 id="example-project" tabindex="-1">Example Project</h2><p>See <a href="https://github.com/mvolkmann/StoreKitDemo?v=1.1.0" rel="noopener" target="_blank">StoreKitDemo</a> which is not yet fully functional. StoreKit still seems difficult to correctly configure and use!</p></article>