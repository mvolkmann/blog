<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>StoreKit</h2><aside><nav class="toc"><ol><li><a href="#storekit">StoreKit</a></li></ol></nav></aside><article><h2 id="storekit" tabindex="-1">StoreKit</h2><p><a href="https://developer.apple.com/documentation/storekit?v=1.0.20" rel="noopener" target="_blank">StoreKit</a> is an Apple framework that supports in-app purchases, ad network attribution, Apple Music integration, and enabling app ratings and reviews.</p><p>To use StoreKit in an app:</p><ol><li><p>Create a new file.</p></li><li><p>Scroll the &quot;Other&quot; category.</p></li><li><p>Select &quot;StoreKit Configuration File&quot;.</p></li><li><p>A file name can be entered, but the default name of &quot;Configuration.storekit&quot; is fine.</p></li><li><p>Click the &quot;+&quot; in the lower-left of the editor and select a type. For one-time purchases, select &quot;Add Non-Consumable In-App Purchase&quot;.</p></li><li><p>Enter a &quot;Reference Name&quot;. This can be the app name. To find this, click the top entry in the Navigator, select the &quot;General&quot; tab, and note the value of Identity ... Display Name.</p></li><li><p>Enter a &quot;Product ID&quot;. This can be the project bundle identifier. To find this, click the top entry in the Navigator, select the &quot;General&quot; tab, and note the value of Identity ... Bundle Identifier.</p></li><li><p>Enter a price.</p></li><li><p>Under &quot;Localizations&quot;, double-click an option such as &quot;English (U.S.)&quot;.</p></li><li><p>Enter a &quot;Display Name&quot;. This can be the same as the Reference Name entered above.</p></li><li><p>Enter a &quot;Description&quot; of the purchasable item.</p></li><li><p>Click &quot;+&quot; under &quot;Localizations&quot; to add more supported locales.</p></li><li><p>Repeat steps 5-12 for each additional non-consumable that can be purchased.</p></li><li><p>Create a new Swift file. A good name is <code>StoreKit.svelte</code>.</p></li><li><p>Add the following in <code>StoreKitStore.svelte</code>:</p><pre class="language-swift"><code class="language-swift"> <span class="token keyword">import</span> <span class="token class-name">StoreKit</span><br><br> <span class="token keyword">class</span> <span class="token class-name">StoreKitStore</span><span class="token punctuation">:</span> <span class="token class-name">NSObject</span><span class="token punctuation">,</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span><br>     <span class="token comment">// This is a Set of purchasable product ids.</span><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> allProductIdentifiers <span class="token operator">=</span><br>         <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"r.mark.volkmann.gmail.com.GiftTrack"</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> productsRequest<span class="token punctuation">:</span> <span class="token class-name">SKProductsRequest</span><span class="token operator">?</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> fetchedProducts<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">SKProduct</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>     <span class="token keyword">typealias</span> <span class="token class-name">CompletionHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">SKProduct</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Void</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">var</span> completionHandler<span class="token punctuation">:</span> <span class="token class-name">CompletionHandler</span><span class="token operator">?</span><br><br>     <span class="token keyword">override</span> <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>         fetchProducts <span class="token punctuation">{</span> products <span class="token keyword">in</span><br>             <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"products ="</span></span><span class="token punctuation">,</span> products<span class="token punctuation">)</span><br>         <span class="token punctuation">}</span><br>     <span class="token punctuation">}</span><br><br>     <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchProducts</span><span class="token punctuation">(</span><br>         <span class="token omit keyword">_</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token class-name">CompletionHandler</span><br>     <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token keyword">guard</span> productsRequest <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span><br>         completionHandler <span class="token operator">=</span> completion<br>         productsRequest <span class="token operator">=</span><br>             <span class="token class-name">SKProductsRequest</span><span class="token punctuation">(</span>productIdentifiers<span class="token punctuation">:</span> allProductIdentifiers<span class="token punctuation">)</span><br>         productsRequest<span class="token operator">?</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span><br>         productsRequest<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>     <span class="token punctuation">}</span><br> <span class="token punctuation">}</span><br><br> <span class="token keyword">extension</span> <span class="token class-name">StoreKitStore</span><span class="token punctuation">:</span> <span class="token class-name">SKProductsRequestDelegate</span> <span class="token punctuation">{</span><br>     <span class="token keyword">func</span> <span class="token function-definition function">productsRequest</span><span class="token punctuation">(</span><br>         <span class="token omit keyword">_</span> request<span class="token punctuation">:</span> <span class="token class-name">SKProductsRequest</span><span class="token punctuation">,</span><br>         didReceive response<span class="token punctuation">:</span> <span class="token class-name">SKProductsResponse</span><br>     <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token keyword">let</span> loadedProducts <span class="token operator">=</span> response<span class="token punctuation">.</span>products<br>         <span class="token keyword">let</span> invalidProducts <span class="token operator">=</span> response<span class="token punctuation">.</span>invalidProductIdentifiers<br>         <span class="token keyword">guard</span> <span class="token operator">!</span>loadedProducts<span class="token punctuation">.</span>isEmpty <span class="token keyword">else</span> <span class="token punctuation">{</span><br>             <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"failed to load products"</span></span><span class="token punctuation">)</span><br>             <span class="token keyword">if</span> <span class="token operator">!</span>invalidProducts<span class="token punctuation">.</span>isEmpty <span class="token punctuation">{</span><br>                 <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"invalid products found: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">invalidProducts</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>             <span class="token punctuation">}</span><br>             productsRequest <span class="token operator">=</span> <span class="token nil constant">nil</span><br>             <span class="token keyword">return</span><br>         <span class="token punctuation">}</span><br><br>         <span class="token comment">// Cache the fetched products.</span><br>         fetchedProducts <span class="token operator">=</span> loadedProducts<br><br>         <span class="token comment">// Notify listeners of loaded products.</span><br>         <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span><br>             <span class="token keyword">self</span><span class="token punctuation">.</span>completionHandler<span class="token operator">?</span><span class="token punctuation">(</span>loadedProducts<span class="token punctuation">)</span><br>             <span class="token keyword">self</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> <span class="token nil constant">nil</span><br>             <span class="token keyword">self</span><span class="token punctuation">.</span>productsRequest <span class="token operator">=</span> <span class="token nil constant">nil</span><br>         <span class="token punctuation">}</span><br>     <span class="token punctuation">}</span><br> <span class="token punctuation">}</span></code></pre></li><li><p>In the <code>{app-name}.swift</code> file, add the following inside the struct that inherits from <code>App</code>:</p><pre class="language-swift"><code class="language-swift"><span class="token attribute atrule">@StateObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> store <span class="token operator">=</span> <span class="token class-name">StoreKitStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></li><li><p>In any views that need to access the store, add the following:</p><pre class="language-swift"><code class="language-swift"><span class="token attribute atrule">@EnvironmentObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> store<span class="token punctuation">:</span> <span class="token class-name">StoreKitStore</span></code></pre></li><li><p>In the Navigator, select <code>{app-name}.swift</code>.</p></li><li><p>In the top bar, click the project name to the left of the device drop-down and select &quot;Edit Scheme...&quot; which opens a dialog.</p></li><li><p>Click &quot;Run&quot; in the dialog left nav.</p></li><li><p>Click the &quot;Options&quot; tab.</p></li><li><p>Change the value of &quot;StoreKit Configuration&quot; from &quot;None&quot; to &quot;Configuration.storekit&quot;.</p></li><li><p>Click the &quot;Close&quot; button.</p></li></ol></article>