<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Fastlane</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#installing">Installing</a></li><li><a href="#configuring">Configuring</a></li><li><a href="#generating-screenshots">Generating Screenshots</a></li><li><a href="#running-tests">Running Tests</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://fastlane.tools/?v=1.0.20" rel="noopener" target="_blank">Fastlane</a> is a command-line tool that simplifies Android and iOS mobile app deployment. It can run tests, generate screenshots, deploy iOS apps to TestFlight, deploy iOS apps to the App Store, and more.</p><p>Fastlane is primarily implemented in Ruby.</p><p>Fastlane workflows can be customized with actions and plugins.</p><p>This page focuses on usage for iOS apps.</p><h2 id="installing" tabindex="-1">Installing</h2><p>Option #1 - using homebrew</p><p>Enter <code>brew install fastlane</code></p><p>Option #2 - manual</p><ol><li><p>Verify that Ruby 2.5 or newer is installed by entering <code>ruby --version</code>.</p></li><li><p>Install Bundler by entering <code>sudo gem install bundler</code>.</p></li><li><p>Create the file <code>Gemfile</code> in the root directory of a project containing the following:</p><pre class="language-ruby"><code class="language-ruby">source <span class="token string-literal"><span class="token string">"https://rubygems.org"</span></span><br>gem <span class="token string-literal"><span class="token string">"fastlane"</span></span></code></pre></li><li><p>Enter <code>sudo gem update --system 3.2.3</code></p></li><li><p>Enter <code>sudo bundle update</code></p></li><li><p>Enter <code>git add Gemfile Gemfile.lock</code></p></li><li><p>Enter <code>git commit</code></p></li></ol><p>Additional steps:</p><ol><li>Enter <code>sudo gem pristine ffi --version 1.12.2</code> This fails!</li></ol><h2 id="configuring" tabindex="-1">Configuring</h2><ol><li><p>Enter <code>fastlane init</code>.</p></li><li><p>Select one of the following options:</p><ul><li>Automate screenshots</li><li>Automate beta distribution to TestFlight</li><li>Automate App Store distribution</li><li>Manual setup</li></ul></li><li><p>Answer many more questions including your Apple ID and password and whether fastlane should upload screenshots to AppStoreConnect.</p></li><li><p>This results in a new directory named <code>fastlane</code>. When the option &quot;Automate screenshots&quot; is selected, this directory will contain the files <code>Appfile</code>, <code>Fastfile</code>, <code>Snapfile</code>, and <code>SnapshotHelper.swift</code>. Add the <code>fastlane</code> directory to the Xcode project and to the git repository.</p></li><li><p>Edit the <code>fastlane/Snapfile</code> file.</p></li><li><p>Uncomment lines so it indicates the devices and languages to use for creating screenshots. For example:</p><pre class="language-ruby"><code class="language-ruby">devices<span class="token punctuation">(</span><span class="token punctuation">[</span><br>  <span class="token string-literal"><span class="token string">"iPhone 8 Plus"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPhone 11 Plus"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPad Pro (12.9-inch)"</span></span><br><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>languages<span class="token punctuation">(</span><span class="token punctuation">[</span><br>  <span class="token string-literal"><span class="token string">"en-US"</span></span><span class="token punctuation">,</span> <span class="token comment"># English USA</span><br>  <span class="token string-literal"><span class="token string">"fr-FR"</span></span><span class="token punctuation">,</span> <span class="token comment"># French France</span><br>  <span class="token string-literal"><span class="token string">"es-ES"</span></span> <span class="token comment"># Spanish Spain</span><br><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></li><li><p>Uncomment the line that calls the <code>scheme</code> function and change it to <code>scheme(&quot;SnapshotTests&quot;)</code>.</p></li><li><p>Uncomment the line <code>clear_previous_screenshots(true)</code>.</p></li><li><p>Uncomment the line <code>override_status_bar(true)</code>.</p></li><li><p>Follow the steps in the instructions that are printed which guide you to:</p><ul><li>Open the project in Xcode.</li><li>Create a new UI Test target named &quot;ScreenshotTests&quot; that is specifically for creating screenshots as described in my XCTest blog page. Verify that the &quot;Shared&quot; checkbox is checked. This should be separate from the target that runs the real UI tests.</li><li>Move the <code>fastlane/SnapshotHelper.swift</code> into the new target directory.</li><li>Edit the file <code>ScreenshotTests/ScreenshotTests.swift</code>.</li><li>In the <code>setupWithError</code> method, add the following:<pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token class-name">XCUIApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token function">setupSnapshot</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><br>app<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></li><li>Implement a test that visits each screen in the app.</li><li>After the code that visiting each screen, call <code>snapshot(&quot;{screenshot-file-name}&quot;)</code>.</li></ul></li></ol><p>For more information, see <a href="https://docs.fastlane.tools/getting-started/ios/screenshots/?v=1.0.20" rel="noopener" target="_blank">fastlane screenshots</a>.</p><h2 id="generating-screenshots" tabindex="-1">Generating Screenshots</h2><p>From the <code>fastlane</code> subdirectory enter <code>fastlane screenshots</code>. This generates a lot of output and takes about n minutes to complete. I see many red messages that says &quot;Caught error... 66&quot;! Screenshot .png files are added to the <code>fastlane/screenshots</code> directory.</p><h2 id="running-tests" tabindex="-1">Running Tests</h2><p>Tests run much faster in Xcode than they do from fastlane.</p><p>To run both unit tests and UI tests from fastlane:</p><ol><li><p>Modify the file <code>fastlane/Fastfile</code> to contain the following:</p><pre class="language-ruby"><code class="language-ruby">platform <span class="token symbol">:ios</span> <span class="token keyword">do</span><br>  desc <span class="token string-literal"><span class="token string">"Run tests"</span></span><br>  lane <span class="token symbol">:tests</span> <span class="token keyword">do</span><br>    run_tests<span class="token punctuation">(</span><span class="token symbol">scheme</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"{scheme-name}"</span></span><span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span></code></pre></li><li><p>From the <code>fastlane</code> subdirectory enter <code>bundle exec fastlane tests</code>.</p></li></ol><p>TODO: Can you skip editing <code>Fastfile</code> and run the tests with <code>fastlane scan</code>?</p></article>