<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Fastlane</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#installing">Installing</a></li><li><a href="#configuring">Configuring</a></li><li><a href="#generating-screenshots">Generating Screenshots</a></li><li><a href="#running-tests">Running Tests</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://fastlane.tools/?v=1.0.20" rel="noopener" target="_blank">Fastlane</a> is an open source platform that automates many tasks related to Android and iOS mobile app deployment. This includes running tests, generating screenshots, deploying iOS apps to TestFlight, deploying iOS apps to the App Store, and more. Fastlane actions can be run from the command line or by CI/CD servers.</p><p>Fastlane is primarily implemented in Ruby.</p><p>Fastlane workflows can be customized with actions and plugins.</p><p>The file <code>Fastfile</code> defines &quot;lanes&quot; which each automate a specific task such as running tests, generating screenshots, deploying to TestFlight, or deploying to the App Store.</p><p>This page focuses on usage for iOS apps.</p><h2 id="installing" tabindex="-1">Installing</h2><p>Option #1 - using homebrew</p><p>Enter <code>brew install fastlane</code></p><p>Option #2 - manual</p><ol><li><p>Verify that Ruby 2.5 or newer is installed by entering <code>ruby --version</code>.</p></li><li><p>Install Bundler by entering <code>sudo gem install bundler</code>.</p></li><li><p>Create the file <code>Gemfile</code> in the root directory of a project containing the following:</p><pre class="language-ruby"><code class="language-ruby">source <span class="token string-literal"><span class="token string">"https://rubygems.org"</span></span><br>gem <span class="token string-literal"><span class="token string">"fastlane"</span></span></code></pre></li><li><p>Enter <code>sudo gem update --system 3.2.3</code></p></li><li><p>Enter <code>sudo bundle update</code></p></li><li><p>Enter <code>git add Gemfile Gemfile.lock</code></p></li><li><p>Enter <code>git commit</code></p></li></ol><p>Additional steps:</p><ol><li>Enter <code>sudo gem pristine ffi --version 1.12.2</code> This fails!</li></ol><h2 id="configuring" tabindex="-1">Configuring</h2><ol><li><p>Open a Terminal window and cd to the root project directory.</p></li><li><p>Enter <code>fastlane init</code>.</p></li><li><p>Select one of the following options:</p><ul><li>Automate screenshots</li><li>Automate beta distribution to TestFlight</li><li>Automate App Store distribution</li><li>Manual setup</li></ul></li><li><p>Answer many more questions including your Apple ID and password and whether fastlane should upload screenshots to AppStoreConnect.</p></li><li><p>This results in a new directory named <code>fastlane</code>. When the option &quot;Automate screenshots&quot; is selected, this directory will contain the files <code>Appfile</code>, <code>Fastfile</code>, <code>Snapfile</code>, and <code>SnapshotHelper.swift</code>. Add the <code>fastlane</code> directory to the Xcode project and to the git repository.</p></li><li><p>Edit the <code>fastlane/Snapfile</code> file.</p></li><li><p>Uncomment lines so it indicates the devices and languages to use for creating screenshots. For example:</p><pre class="language-ruby"><code class="language-ruby">devices<span class="token punctuation">(</span><span class="token punctuation">[</span><br>  <span class="token string-literal"><span class="token string">"iPhone 8 Plus"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPhone 13 Pro Max"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPad Pro (12.9-inch) (2nd generation)"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPad Pro (12.9-inch) (5th generation)"</span></span><br><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>languages<span class="token punctuation">(</span><span class="token punctuation">[</span><br>  <span class="token string-literal"><span class="token string">"en-US"</span></span><span class="token punctuation">,</span> <span class="token comment"># English USA</span><br>  <span class="token string-literal"><span class="token string">"fr-FR"</span></span><span class="token punctuation">,</span> <span class="token comment"># French France</span><br>  <span class="token string-literal"><span class="token string">"es-ES"</span></span> <span class="token comment"># Spanish Spain</span><br><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></li><li><p>Uncomment the line that calls the <code>scheme</code> function and change it to <code>scheme(&quot;ScreenshotTests&quot;)</code>.</p></li><li><p>Uncomment the line <code>output_directory(&quot;./screenshots&quot;)</code> and change the path to <code>./fastlane/screenshots</code>.</p></li><li><p>Uncomment the line <code>clear_previous_screenshots(true)</code>. This deletes all the <code>.png</code> files in the <code>fastlane/screenshots</code> directory.</p></li><li><p>Uncomment the line <code>override_status_bar(true)</code>.</p></li><li><p>Add the line <code>headless(false)</code>. Tests that need to wait for elements to appear seem to fail without this.</p></li><li><p>Edit the file <code>fastlane/Fastfile</code>.</p></li><li><p>Change the the contents to the following:</p><pre class="language-ruby"><code class="language-ruby">default_platform<span class="token punctuation">(</span><span class="token symbol">:ios</span><span class="token punctuation">)</span><br><br>platform <span class="token symbol">:ios</span> <span class="token keyword">do</span><br>  desc <span class="token string-literal"><span class="token string">"Generate localized screenshots"</span></span><br>  lane <span class="token symbol">:screenshots</span> <span class="token keyword">do</span><br>    capture_screenshots<span class="token punctuation">(</span><span class="token symbol">scheme</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"ScreenshotTests"</span></span><span class="token punctuation">)</span> <span class="token comment"># main change</span><br>    <span class="token comment"># The "update" step is optional.</span><br>    <span class="token comment"># upload_to_app_store(skip_binary_upload: true, skip_metadata: true)</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span></code></pre></li><li><p>Follow the steps in the instructions that are printed which guide you to:</p><ul><li>Open the project in Xcode.</li><li>Create a new UI Test target named &quot;ScreenshotTests&quot; that is specifically for creating screenshots as described in my XCTest blog page. This should be separate from the target that runs the real UI tests.</li><li>Delete the file <code>ScreenshotTests/ScreenshotTestsLaunchTests.swift</code>. This isn't needed for capturing screenshots.</li><li>Move the <code>fastlane/SnapshotHelper.swift</code> into the new target directory.</li><li>Edit the file <code>ScreenshotTests/ScreenshotTests.swift</code>.</li><li>In the <code>setupWithError</code> method, add the following:<pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token class-name">XCUIApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token function">setupSnapshot</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><br>app<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></li><li>Rename the test method <code>testExample</code> to <code>testScreenshots</code>.</li><li>Replace the code in this method with code that visits each screen in the app.</li><li>After the code that visiting each screen, call <code>snapshot(&quot;{screenshot-file-name}&quot;)</code>. The actual file name will begin with the device name (ex. &quot;iPhone 14-&quot;) and end with &quot;.png&quot;. This works in simulators, but does nothing when running on a real device.</li><li>Delete the method definition for <code>testLaunchPerformance</code>.</li></ul></li><li><p>Click the scheme dropdown at the top and select &quot;New Scheme...&quot;.</p></li><li><p>Enter &quot;ScreenshotTests&quot; for the name</p></li><li><p>Click the &quot;OK&quot; button.</p></li><li><p>Click the scheme dropdown at the top again and select &quot;Edit Scheme...&quot;.</p></li><li><p>In the dialog that appears, verify that the &quot;Shared&quot; checkbox at the bottom is checked.</p></li><li><p>Select &quot;Test&quot; in the left nav.</p></li><li><p>Click &quot;+&quot; at the bottom and add the &quot;ScreenshotTests&quot; target.</p></li><li><p>In the dialog that appears, select the &quot;ScreenshotTests&quot; target and click the &quot;Add&quot; button.</p></li><li><p>Click the &quot;Close&quot; button.</p></li></ol><p>For more information, see <a href="https://docs.fastlane.tools/getting-started/ios/screenshots/?v=1.0.20" rel="noopener" target="_blank">fastlane screenshots</a>.</p><h2 id="generating-screenshots" tabindex="-1">Generating Screenshots</h2><ol><li><p>From the <code>fastlane</code> subdirectory enter <code>bundle exec fastlane screenshots</code>. This runs faster than just entering <code>fastlane screenshots</code>. This generates a lot of output and takes several minutes to complete.</p></li><li><p>The produced screenshot <code>.png</code> files will be in <code>fastlane/screenshots</code> directory.</p></li><li><p>An HTML file that displays all the screenshots will open in your default web browser. For me this page does not display any of the screenshots even though they are created in the <code>fastline/screenshots</code> directory. To skip this, add the following in <code>fastlane/Snapfile</code>:</p><pre class="language-ruby"><code class="language-ruby">skip_open_summary<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></li></ol><h2 id="running-tests" tabindex="-1">Running Tests</h2><p>Tests run much faster in Xcode than they do from fastlane.</p><p>To run both unit tests and UI tests from fastlane:</p><ol><li><p>Modify the file <code>fastlane/Fastfile</code> to contain the following:</p><pre class="language-ruby"><code class="language-ruby">platform <span class="token symbol">:ios</span> <span class="token keyword">do</span><br>  desc <span class="token string-literal"><span class="token string">"Run tests"</span></span><br>  lane <span class="token symbol">:tests</span> <span class="token keyword">do</span><br>    run_tests<span class="token punctuation">(</span><span class="token symbol">scheme</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"{main-scheme-name}"</span></span><span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span></code></pre></li><li><p>From the <code>fastlane</code> subdirectory enter <code>bundle exec fastlane tests</code>.</p></li></ol><p>TODO: Can you skip editing <code>Fastfile</code> and run the tests with <code>fastlane scan</code>?</p></article>