<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Fastlane</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#resources">Resources</a></li><li><a href="#provisioning-profiles-and-code-signing">Provisioning Profiles and Code Signing</a></li><li><a href="#installing">Installing</a><ol><li><a href="#ruby">Ruby</a></li><li><a href="#fastlane">Fastlane</a></li></ol></li><li><a href="#configuring">Configuring</a><ol><li><a href="#authentication">Authentication</a></li><li><a href="#appfile">Appfile</a></li><li><a href="#snapfile">Snapfile</a></li></ol></li><li><a href="#registering-an-app">Registering an App</a></li><li><a href="#lanes">Lanes</a></li><li><a href="#running-tests">Running Tests</a></li><li><a href="#creating-a-signing-certificate">Creating a Signing Certificate</a></li><li><a href="#creating-a-provisioning-profile">Creating a Provisioning Profile</a></li><li><a href="#team-development">Team Development</a></li><li><a href="#building-an-app-archive">Building an App Archive</a></li><li><a href="#registering-beta-testers">Registering Beta Testers</a></li><li><a href="#deploying-testflight.">Deploying TestFlight.</a></li><li><a href="#.gitignore">.gitignore</a></li><li><a href="#creating-screenshots">Creating Screenshots</a></li><li><a href="#adding-device-frames-to-screenshots">Adding Device Frames to Screenshots</a></li><li><a href="#uploading-to-app-store">Uploading to App Store</a></li><li><a href="#other-actions">Other Actions</a></li><li><a href="#listing-lanes">Listing Lanes</a></li><li><a href="#ruby-vs.-swift">Ruby vs. Swift</a></li><li><a href="#complete-fastfile">Complete Fastfile</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://fastlane.tools/?v=1.0.20" rel="noopener" target="_blank">Fastlane</a> is an open source platform managed by Google that automates many tasks related to iOS and Android mobile app deployment. These include running tests, generating screenshots, deploying iOS apps to TestFlight, deploying iOS apps to the App Store, and more.</p><p>Management of the Fastlane project may be moving from Google to the <a href="https://mobilenativefoundation.org?v=1.0.20" rel="noopener" target="_blank">Mobile Native Foundation</a> soon. This is seen as a positive move since Google has not devoted time to Fastlane development lately.</p><p>This page focuses on usage for iOS apps.</p><p>Some tasks require interacting with the <a href="https://developer.apple.com/?v=1.0.20" rel="noopener" target="_blank">Apple Developer Portal</a> and <a href="https://appstoreconnect.apple.com/?v=1.0.20" rel="noopener" target="_blank">App Store Connect</a>. Fastlane provides a way to do this from the command line.</p><p>Fastlane is primarily implemented in Ruby.</p><p>Deploying apps to TestFlight and the App Store requires enrolling in the Apple Developer Program which is currently $99/year USD.</p><p>Many of the sections below describe how to accomplish a specific task using a &quot;lane&quot;. The final section pulls it all together into a complete <code>Fastfile</code>.</p><h2 id="resources" tabindex="-1">Resources</h2><ul><li><a href="https://fastlane.tools?v=1.0.20" rel="noopener" target="_blank">Fastline home page</a></li><li><a href="https://www.runway.team/blog/how-to-build-the-perfect-fastlane-pipeline-for-ios?v=1.0.20" rel="noopener" target="_blank">How to build the perfect fastlane pipeline for iOS</a></li></ul><h2 id="provisioning-profiles-and-code-signing" tabindex="-1">Provisioning Profiles and Code Signing</h2><p>For details on &quot;code signing&quot; and &quot;provisioning profiles&quot;, see the Apple Tech Note <a href="https://developer.apple.com/documentation/technotes/tn3125-inside-code-signing-provisioning-profiles?v=1.0.20" rel="noopener" target="_blank">TN3125: Inside Code Signing: Provisioning Profiles</a>. This document says the following:</p><blockquote><p>Apple platforms, except macOS, won't run arbitrary third-party code. All execution of third-party code must be authorized by Apple. This authorization comes in the form of a provisioning profile, which ties together five criteria:</p><ul><li>Who is allowed to sign code? (which developers)</li><li>What apps are they allowed to sign? (typically a single app id, but can use a wildcard to match multiple apps)</li><li>Where can those apps run? (platforms such as iOS)</li><li>When can those apps run? (expiration date after which the profile becomes invalid)</li><li>How can those apps be entitled? (what apps are entitled to do)</li></ul><p>The exact format of provisioning profiles isn't documented and could change at any time.</p></blockquote><p>Provisioning profiles include signing certificates, device identifiers, and a bundle ID. They are cryptographically signed.</p><h2 id="installing" tabindex="-1">Installing</h2><h3 id="ruby" tabindex="-1">Ruby</h3><p>Ruby must be installed in order to use Fastlane. There are often issues with using the version of Ruby that comes with macOS. To avoid these issues, install a new version of Ruby using Homebrew.</p><ol><li><p>Enter <code>brew install ruby</code>.</p></li><li><p>Modify your shell configuration file.</p><p>Add <code>/opt/homebrew/opt/ruby/bin</code> to the beginning of the <code>PATH</code> environment variable value. When using zsh, the file to edit is <code>.zshrc</code> and the line to add is:</p><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"/opt/homebrew/opt/ruby/bin"</span> <span class="token variable">$path</span><span class="token punctuation">)</span></code></pre></li><li><p>Start a new shell session.</p></li><li><p>Enter <code>which ruby</code> and verify that it outputs <code>/opt/homebrew/opt/ruby/bin/ruby</code>.</p></li><li><p>Enter <code>gem install bundler</code>.</p></li></ol><h3 id="fastlane" tabindex="-1">Fastlane</h3><ol><li>Install fastlane by entering <code>brew install fastlane</code>.</li><li>If git is not already installed, enter <code>brew install git</code>.</li><li>If the Xcode Command Line Tools are not already installed:<ol><li>Enter <code>xcode-select --install</code>.</li><li>In the dialog that appears, click the &quot;Install&quot; button.</li><li>Agree to the terms.</li><li>Wait about 10 minutes for the download and install to complete.</li></ol></li></ol><h2 id="configuring" tabindex="-1">Configuring</h2><ol><li><p>Add the following environment variables in your shell configuration file such as <code>.zshrc</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>en_US.UTF-8<br><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">LC_ALL</span></span><span class="token operator">=</span>en_US.UTF-8</code></pre></li><li><p>Open a Terminal window and cd to the project root directory.</p></li><li><p>Enter <code>fastlane init</code>.</p></li><li><p>This will pause several times after outputting tips. After each tip, press the return key to continue.</p></li><li><p>Select one of the following options:</p><ul><li>Automate screenshots (recommended)</li><li>Automate beta distribution to TestFlight</li><li>Automate App Store distribution</li><li>Manual setup (for implementing multiple lanes)</li></ul></li><li><p>Answer many more questions including your Apple ID and password.</p><ul><li>For the UI testing scheme, choose the default scheme.</li><li>For &quot;Enable automatic upload&quot;, choose &quot;n&quot;.</li></ul></li><li><p>This results in a new directory named <code>fastlane</code>. When the option &quot;Manual&quot; is selected, this directory will contain the files <code>Appfile</code> and <code>Fastfile</code>. When the option &quot;Automate screenshots&quot; is selected, this directory will also contain the files <code>Snapfile</code>, and <code>SnapshotHelper.swift</code>.</p></li><li><p>Add the <code>fastlane</code> directory to the Xcode project and to the git repository.</p></li></ol><h3 id="authentication" tabindex="-1">Authentication</h3><p>TODO: It's not clear if anything in this section is actually needed. Many actions require authenticating against your App Store Connect account. To configure this:</p><ol><li>Browse <a href="https://appstoreconnect.apple.com?v=1.0.20" rel="noopener" target="_blank">App Store Connect</a>.</li><li>Login</li><li>Click the &quot;Users and Access&quot; button.</li><li>Select the &quot;Keys&quot; tab.</li><li>Click the &quot;Request Access&quot; button.</li><li>Check the checkbox to agree to terms.</li><li>Click the &quot;Submit&quot; button.</li><li>Click the &quot;Generate API Key&quot; button.</li><li>Enter a key name such as &quot;fastlane key&quot;.</li><li>Select an access role such as &quot;App Manager&quot;.</li><li>Click the &quot;Generate&quot; button.</li><li>Click &quot;Download API Key&quot;.</li><li>Click the &quot;Download&quot; button.</li><li>Move the downloaded <code>.p8</code> file to the project <code>fastlane</code> directory.</li></ol><p>To get base64 encoded key content enter <code>cat {key-name}.p8 | base64</code>.</p><p>In the file <code>Fastfile</code> add the following before any action that requires authentication:</p><pre class="language-ruby"><code class="language-ruby">app_store_connect_api_key<span class="token punctuation">(</span><br>  <span class="token symbol">key_id</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"{key-id}"</span></span><span class="token punctuation">,</span> <span class="token comment"># from downloaded key file name</span><br>  <span class="token symbol">issuer_id</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"{issuer-id}"</span></span><span class="token punctuation">,</span> <span class="token comment"># How can this be determined?</span><br>  <span class="token symbol">key_content</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"{base64-encoded-key}"</span></span><span class="token punctuation">,</span> <span class="token comment"># from base64 command above</span><br>  <span class="token symbol">is_key_content_base64</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>  <span class="token symbol">in_house</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment"># indicates whether the team is Enterprise</span><br><span class="token punctuation">)</span></code></pre><p>Alternatively, set the following environment variables and just use <code>app_store_connect_api_key()</code>:</p><ul><li>key_id: APP_STORE_CONNECT_API_KEY_KEY_ID</li><li>issuer_id: APP_STORE_CONNECT_API_KEY_ISSUER_ID</li><li>key_content: APP_STORE_CONNECT_API_KEY_KEY</li><li>in_house: APP_STORE_CONNECT_API_KEY_IN_HOUSE</li></ul><p>Calling <code>app_store_connect_api_key()</code> with or without arguments sets a shared variable that can be used to get the API key in any lane. For example:</p><pre class="language-ruby"><code class="language-ruby">api_key <span class="token operator">=</span> lane_context<span class="token punctuation">[</span>SharedValues<span class="token double-colon punctuation">::</span><span class="token constant">APP_STORE_CONNECT_API_KEY</span><span class="token punctuation">]</span><br><span class="token comment"># Pass api_key to any action.</span></code></pre><h3 id="appfile" tabindex="-1">Appfile</h3><p>This is a Ruby source file found in the <code>fastlane</code> directory that defines values used in the <code>Fastfile</code> file. It can contain code like the following:</p><pre class="language-ruby"><code class="language-ruby">app_identifier <span class="token string-literal"><span class="token string">"{app-bundle-identifier}"</span></span><br>apple_id <span class="token string-literal"><span class="token string">"{my-apple-id}"</span></span><br><br>itc_team_id <span class="token string-literal"><span class="token string">"{app-store-connect-team-id}"</span></span> <span class="token comment"># 9-digit number</span><br>team_id <span class="token string-literal"><span class="token string">"{developer-portal-team-id}"</span></span> <span class="token comment"># 10 characters</span></code></pre><p>For more information about the file <code>Appfile</code>, see the fastlane docs on <a href="https://docs.fastlane.tools/advanced/#appfile?v=1.0.20" rel="noopener" target="_blank">Appfile</a>.</p><h3 id="snapfile" tabindex="-1">Snapfile</h3><p>This is a Ruby source file found in the <code>fastlane</code> directory that defines the supported device types and languages. It is used to determine the variations of screenshots that should be created.</p><ol><li><p>Edit the <code>fastlane/Snapfile</code> file.</p></li><li><p>Uncomment lines so it indicates the devices and languages to use for creating screenshots. For example:</p></li></ol><pre class="language-ruby"><code class="language-ruby">devices<span class="token punctuation">(</span><span class="token punctuation">[</span><br>  <span class="token string-literal"><span class="token string">"iPhone 8 Plus"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPhone 13 Pro Max"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPad Pro (12.9-inch) (2nd generation)"</span></span><span class="token punctuation">,</span><br>  <span class="token string-literal"><span class="token string">"iPad Pro (12.9-inch) (6th generation)"</span></span><br><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>languages<span class="token punctuation">(</span><span class="token punctuation">[</span><br>  <span class="token comment"># These are five most used languages in the world</span><br>  <span class="token comment"># in order from most to least used</span><br>  <span class="token comment"># including the region in which they are most used.</span><br>  <span class="token string-literal"><span class="token string">"en-US"</span></span><span class="token punctuation">,</span> <span class="token comment"># English - USA</span><br>  <span class="token string-literal"><span class="token string">"zh-CN"</span></span><span class="token punctuation">,</span> <span class="token comment"># Chinese Simplified - China</span><br>  <span class="token string-literal"><span class="token string">"hi-IN"</span></span><span class="token punctuation">,</span> <span class="token comment"># Hindi - India</span><br>  <span class="token string-literal"><span class="token string">"es-ES"</span></span><span class="token punctuation">,</span> <span class="token comment"># Spanish - Spain</span><br>  <span class="token string-literal"><span class="token string">"fr-FR"</span></span> <span class="token comment"># French - France</span><br><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><ol><li><p>Uncomment the line that calls the <code>scheme</code> function and change it to <code>scheme(&quot;ScreenshotTests&quot;)</code>.</p></li><li><p>Uncomment the line <code>output_directory(&quot;./screenshots&quot;)</code> and change the path to <code>./fastlane/screenshots</code>.</p></li><li><p>Uncomment the line <code>clear_previous_screenshots(true)</code>. This deletes all the <code>.png</code> files in the <code>fastlane/screenshots</code> directory. Perhaps this isn't always desirable!</p></li><li><p>Uncomment the line <code>override_status_bar(true)</code> to set the status bar to Tuesday January 9th at 9:41AM with full battery and reception.</p></li><li><p>Add the line <code>headless(false)</code>. Tests that need to wait for elements to appear seem to fail without this.</p></li></ol><h2 id="registering-an-app" tabindex="-1">Registering an App</h2><p>To register the app to be managed on the Apple Developer Portal and App Store Connect, see <a href="/blog/swift/TestFlight">TestFlight</a>.</p><p>The fastlane action <a href="https://docs.fastlane.tools/actions/produce/?v=1.0.20" rel="noopener" target="_blank">produce</a> which is an alias for <code>create_app_online</code> can be used to automate this process. Since new apps are not created frequently, it may be better to do this manually.</p><h2 id="lanes" tabindex="-1">Lanes</h2><p>The file <code>Fastfile</code> defines &quot;lanes&quot; which are sequences of actions that automate a specific task. Lanes can be run from the command line or by CI/CD servers. A lane can be specific to a given platform (ex. ios or mac) or it can be platform independent.</p><p>The <code>fastlane</code> command can be passed the name of an action or a lane to run. The syntax to enter is <code>fastlane {platform} {action-or-lane}</code>. For example, <code>fastlane ios screenshots</code>.</p><p>If a default platform is specified in the <code>Fastfile</code> using <code>default_platform :ios</code> then lanes for that platform can be executed without providing the platform. For example if <code>ios</code> is the default platform then the previous command can be executed with <code>fastlane screenshots</code>.</p><h2 id="running-tests" tabindex="-1">Running Tests</h2><p>To run all the automated unit and UI tests in the project, use the fastlane tool <a href="https://docs.fastlane.tools/actions/scan/?v=1.0.20" rel="noopener" target="_blank">scan</a> which is an alias for <code>run_tests</code>. The tests run in a Simulator or on a connected device. They run much faster in Xcode than they do from fastlane.</p><p>Modify the file <code>fastlane/Fastfile</code> to contain the following:</p><pre class="language-ruby"><code class="language-ruby">platform <span class="token symbol">:ios</span> <span class="token keyword">do</span><br>  desc <span class="token string-literal"><span class="token string">"Run tests"</span></span><br>  lane <span class="token symbol">:tests</span> <span class="token keyword">do</span><br>    run_tests<span class="token punctuation">(</span><span class="token symbol">scheme</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"{scheme-name}"</span></span><span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span></code></pre><p>From the project root directory enter <code>fastlane tests</code>.</p><h2 id="creating-a-signing-certificate" tabindex="-1">Creating a Signing Certificate</h2><p>To create a signing certificate, use the fastlane action <a href="https://docs.fastlane.tools/actions/cert/?v=1.0.20" rel="noopener" target="_blank">cert</a> which is an alias for <code>get_certificates</code>. This determines if a new signing certificate is needed. If so it:</p><ul><li>creates a new private key</li><li>creates a new signing request</li><li>generates, downloads, and installs the certificate</li><li>imports all the generated files into the Keychain app</li></ul><p>The types of certificates can be created include <code>development</code>, <code>adhoc</code>, and <code>appstore</code>.</p><p>A <code>.cer</code> file file is created in the project root directory.</p><p>This can be combined with the next step.</p><p>To see all your certificates, browse <a href="https://developer.apple.com?v=1.0.20" rel="noopener" target="_blank">developer.apple.com</a>, click &quot;Account&quot;, sign in, and click &quot;Certificates&quot; under the &quot;Certificates, Identifiers &amp; Profiles&quot; section.</p><h2 id="creating-a-provisioning-profile" tabindex="-1">Creating a Provisioning Profile</h2><p>To create a provisioning profile, use the fastlane action <a href="https://docs.fastlane.tools/actions/sigh/?v=1.0.20" rel="noopener" target="_blank">sigh</a> which is an alias for <code>get_provisioning_profile</code>. This can create, renew, download, and repair provisioning profiles.</p><p>Add the following lane in <code>fastlane/Fastfile</code>:</p><pre class="language-ruby"><code class="language-ruby">desc <span class="token string-literal"><span class="token string">"Creates a signing certificate and provisioning profile"</span></span><br>lane <span class="token symbol">:certs</span> <span class="token keyword">do</span><br>  get_certificates<span class="token punctuation">(</span><span class="token symbol">development</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br>  get_provisioning_profile<span class="token punctuation">(</span><span class="token symbol">development</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br><span class="token keyword">end</span></code></pre><p>From the project root directory enter <code>fastlane certs</code>.</p><p>A <code>.mobileprovision</code> file is created in the project root directory.</p><h2 id="team-development" tabindex="-1">Team Development</h2><p>To configure Fastlane for use by a development team, use the fastlane action <a href="https://docs.fastlane.tools/actions/match/?v=1.0.20" rel="noopener" target="_blank">match</a> which is an alias for <code>sync_code_signing</code>. This combines the functionality of <code>cert</code> and <code>sigh</code>. In addition, it stores the certificates and provisioning profiles in a separate private git repository (or another supported location) so a team of developers can share them.</p><p>It is recommended to use <code>match</code> in place of <code>cert</code> and <code>sigh</code> when an app is being developed by more than one person.</p><p>This is the most complex fastlane action and I have not used it yet.</p><h2 id="building-an-app-archive" tabindex="-1">Building an App Archive</h2><p>To build an app archive file (.ipa), use the fastlane tool <a href="https://docs.fastlane.tools/actions/gym/?v=1.0.20" rel="noopener" target="_blank">gym</a> which is an alias for <code>build_app</code>. This builds and packages an app, creating a signed <code>.ipa</code> or <code>.app</code> file.</p><p>To configure the ability to use this fastlane action:</p><ol><li><p>Verify project build settings.</p><ol><li>Open the project in Xcode.</li><li>Select the top entry in the Project Navigator.</li><li>Select the main target.</li><li>Select the &quot;Build Settings&quot; tab.</li><li>Scroll down to the &quot;Versioning&quot; section.</li><li>Verify that &quot;Versioning System&quot; is set to &quot;Apple Generic&quot; (default).</li></ol></li><li><p>Verify that the scheme to be used is &quot;shared&quot;.</p><ol><li>Open the project in Xcode.</li><li>Select the main scheme from the dropdown to the left of the device dropdown at the top.</li><li>Click the scheme dropdown again.</li><li>Select &quot;Edit Scheme...&quot;.</li><li>In the dialog that appears, verify that &quot;Shared&quot; checkbox at the bottom is checked.</li></ol></li><li><p>From the project root directory, enter <code>fastlane gym init</code> to create the file <code>fastlane/Gymfile</code>.</p></li><li><p>Edit the file <code>fastlane/Gymfile</code> and replace the contents with the following:</p><pre class="language-ruby"><code class="language-ruby">scheme<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"{scheme-name}"</span></span><span class="token punctuation">)</span><br>export_options<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token symbol">method</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"app-store"</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>output_directory<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"./fastlane/builds"</span></span><span class="token punctuation">)</span></code></pre></li><li><p>Add the following lane in <code>fastlane/Fastfile</code>:</p><pre class="language-ruby"><code class="language-ruby">lane <span class="token symbol">:build</span> <span class="token keyword">do</span><br>  build_app<br><span class="token keyword">end</span></code></pre></li><li><p>Update the project version with the following steps:</p><ol><li>In Xcode, select the top entry in the Project Navigator.</li><li>Select the main target.</li><li>Select the General tab.</li><li>In the &quot;Identity&quot; section, update the &quot;Version&quot; and &quot;Build&quot; numbers. The version number should be a semantic version like 1.2.3. The build number should be a sequential integer number like 7.</li></ol></li><li><p>From the project root directory, enter <code>fastlane build</code>.</p><p>This creates the files <code>{scheme-name}.app.dSYM.zip</code> and <code>{scheme-name}.ipa</code> in the <code>fastlane/builds</code> directory.</p></li></ol><h2 id="registering-beta-testers" tabindex="-1">Registering Beta Testers</h2><p>To register beta testers in TestFlight:</p><ol><li>Browse <a href="https://appstoreconnect.apple.com?v=1.0.20" rel="noopener" target="_blank">App Store Connect</a>.</li><li>Click the &quot;My Apps&quot; button.</li><li>Click the button for the app to be tested.</li><li>Click the &quot;TestFlight&quot; tab.</li><li>Create a group of testers by clicking the &quot;+&quot; button after either &quot;Internal Testers&quot; or &quot;External Testers&quot;.</li><li>Enter a group name.</li><li>For each tester to be added, click the &quot;+&quot; after &quot;Testers&quot; and enter their email address and name.</li></ol><h2 id="deploying-testflight." tabindex="-1">Deploying TestFlight.</h2><p>To deploy the app to TestFlight, use the fastlane tool <a href="https://docs.fastlane.tools/actions/pilot/?v=1.0.20" rel="noopener" target="_blank">pilot</a> which is an alias for <code>upload_to_testflight</code>. This can upload a build to TestFlight, add or remove testers, get information about testers and devices, and import or export data describing all the testers.</p><p>This requires an app-specific password. To get one:</p><ol><li>Browse <a href="https://appleid.apple.com/account/manage?v=1.0.20" rel="noopener" target="_blank">appleid.apple.com</a>.</li><li>Click the &quot;Sign In&quot; button and sign in.</li><li>Click &quot;App-Specific Passwords&quot;.</li><li>Click the &quot;Generate an app-specific password&quot; button.</li><li>Enter the app name.</li><li>Click the &quot;Create&quot; button.</li><li>Confirm your Apple ID password.</li><li>Copy the generated password so it can be passed in the file described next.</li></ol><p>Create the file <code>fastlane/.env.default</code> with the following contents:</p><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">FASTLANE_USER</span><span class="token operator">=</span><span class="token punctuation">{</span>apple-id<span class="token punctuation">}</span><br><span class="token assign-left variable">FASTLANE_PASSWORD</span><span class="token operator">=</span><span class="token punctuation">{</span>apple-password<span class="token punctuation">}</span><br><span class="token assign-left variable">FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD</span><span class="token operator">=</span><span class="token punctuation">{</span>app-specific-password<span class="token punctuation">}</span></code></pre><p>Add the following lane in <code>fastlane/Fastfile</code>:</p><pre class="language-ruby"><code class="language-ruby">lane <span class="token symbol">:beta</span> <span class="token keyword">do</span><br>  <span class="token comment"># I prefer to update the Version and Build numbers manually in Xcode.</span><br>  <span class="token comment"># increment_build_number</span><br>  <span class="token comment"># increment_version_number(bump_type: "patch")</span><br>  upload_to_testflight<span class="token punctuation">(</span><br>    <span class="token symbol">ipa</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'./fastlane/builds/WeatherKitDemo.ipa'</span></span><span class="token punctuation">,</span><br>    <span class="token comment"># I prefer to submit manually on the App Store Connect web page</span><br>    <span class="token comment"># so I can enter a description of what changed in this version.</span><br>    <span class="token symbol">skip_submission</span><span class="token operator">:</span> <span class="token boolean">true</span><br>  <span class="token punctuation">)</span><br><span class="token keyword">end</span></code></pre><p>From the project root directory, enter <code>fastlane beta</code>. This waits for processing to complete which takes around four minutes.</p><h2 id=".gitignore" tabindex="-1">.gitignore</h2><p>The following Fastlane-related files should be listed in the <code>.gitignore</code> file, either because they contain sensitive information or because they contain data that changes frequently and just doesn't need to be persisted.</p><pre class="language-text"><code class="language-text">fastlane/report.xml<br>fastlane/Preview.html<br>fastlane/screenshots/**/*.png<br>fastlane/test_output<br>fastlane/AuthKey_*.p8<br>fastlane/.env.default</code></pre><h2 id="creating-screenshots" tabindex="-1">Creating Screenshots</h2><p>To create localized screenshots for each screen in the app, use the fastlane tool <a href="https://docs.fastlane.tools/actions/snapshot/?v=1.0.20" rel="noopener" target="_blank">snapshot</a> which is an alias for <code>capture_screenshots</code> which is an alias for <code>capture_ios_screenshots</code>. This automates generating screenshots for each screen navigated to in a UI Test. It repeats this for each supported device size and language.</p><p>The following steps assume that &quot;Automate screenshots&quot; was selected when the <code>fastlane init</code> command was run.</p><ol><li><p>Add the <code>fastlane</code> directory and the files <code>Gemfile</code> and <code>Gemfile.lock</code> to the Xcode project.</p><ol><li>Select File ... Add Files to &quot;{project-name}&quot;...</li><li>Select the <code>fastlane</code> directory.</li><li>Click the &quot;Add&quot; button.</li></ol></li><li><p>Add the <code>fastlane</code> directory and the files <code>Gemfile</code> and <code>Gemfile.lock</code> to the git repository.</p></li><li><p>Create a new target.</p><ol><li><p>Select the topmost entry in the Project Navigator.</p></li><li><p>Click the &quot;+&quot; button at the bottom of the left nav to create another target that is separate from the main unit and UI test targets.</p></li><li><p>Enter &quot;test&quot; to filter the set of templates displayed.</p></li><li><p>Select &quot;UI Testing Bundle&quot;.</p></li><li><p>Click the &quot;Next&quot; button.</p></li><li><p>Change the &quot;Product Name&quot; to &quot;ScreenshotTests&quot;.</p></li><li><p>Click the &quot;Finish&quot; button.</p><p>This creates a new folder that appears in the Project Navigator whose name is &quot;ScreenshotTests&quot;. The new folder contains a <code>.swift</code> file with the same name containing starter test code.</p></li></ol></li><li><p>Delete the file <code>ScreenshotTests/ScreenshotTestsLaunchTests.swift</code>. This isn't needed for capturing screenshots.</p></li><li><p>Create a new scheme.</p><ol><li>Click the scheme dropdown at the top and select &quot;New Scheme...&quot;.</li><li>Enter &quot;ScreenshotTests&quot; for the name.</li><li>Click the &quot;OK&quot; button.</li><li>Click the scheme dropdown at the top again and select &quot;Edit Scheme...&quot;.</li><li>In the dialog that appears, verify that the &quot;Shared&quot; checkbox at the bottom is checked.</li><li>Select &quot;Test&quot; in the left nav.</li><li>Click &quot;+&quot; at the bottom.</li><li>In the dialog that appears, select the &quot;ScreenshotTests&quot; target and click the &quot;Add&quot; button.</li><li>Click the &quot;Close&quot; button.</li></ol></li><li><p>Implement the UI test.</p><ol><li><p>Move the <code>fastlane/SnapshotHelper.swift</code> into the new target directory.</p></li><li><p>Edit the file <code>ScreenshotTests/ScreenshotTests.swift</code>.</p></li><li><p>In the <code>setupWithError</code> method, add the following:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token class-name">XCUIApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token function">setupSnapshot</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><br>app<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></li><li><p>Delete the method definition for <code>testLaunchPerformance</code>.</p></li><li><p>Rename the test method <code>testExample</code> to <code>testScreenshots</code>.</p></li><li><p>Replace the code in this method with code that visits each screen in the app.</p></li><li><p>After the code that visiting each screen, call <code>snapshot(&quot;{sequence-number}-{screen-name}&quot;)</code>. The sequence numbers keep the screenshots in the intended order. The actual file name will begin with the device name (ex. &quot;iPhone 14-&quot;) and end with &quot;.png&quot;. Screenshots will only be captured when running in a simulator. The <code>snapshot</code> function does nothing when running on a real device.</p></li></ol></li><li><p>Add or modify the following lane in <code>fastlane/Fastfile</code>:</p></li></ol><pre class="language-ruby"><code class="language-ruby">desc <span class="token string-literal"><span class="token string">"Generates localized screenshots"</span></span><br>lane <span class="token symbol">:screenshots</span> <span class="token keyword">do</span><br>  capture_screenshots<span class="token punctuation">(</span><span class="token symbol">scheme</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"{screenshot-scheme-name}"</span></span><span class="token punctuation">)</span><br><span class="token keyword">end</span></code></pre><ol><li><p>Verify that all the Simulators to be used are in the expected light/dark mode. Many seem to default to dark mode.</p><ol><li>Open Xcode.</li><li>Select Xcode ... Open Developer Tool ... Simulator.</li><li>For each device<ul><li>In the Simulator app, select File ... Open Simulator ... iOS {version} ... {device-type}.</li><li>In the device simulator<ul><li>Open the Settings app.</li><li>Select &quot;Developer&quot;.</li><li>Toggle &quot;Dark Appearance&quot; to the desired setting.</li></ul></li></ul></li></ol></li><li><p>From the project root directory, enter <code>fastlane screenshots</code>. This generates <code>.png</code> files in the <code>fastlane/screenshots</code> directory.</p></li><li><p>An HTML file that displays all the screenshots will open in your default web browser. To skip this, add the following to the <code>screenshots</code> lane definition:</p><pre class="language-ruby"><code class="language-ruby">skip_open_summary<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></li></ol><p>For more information, see <a href="https://docs.fastlane.tools/getting-started/ios/screenshots/?v=1.0.20" rel="noopener" target="_blank">fastlane screenshots</a>.</p><h2 id="adding-device-frames-to-screenshots" tabindex="-1">Adding Device Frames to Screenshots</h2><p>To add device frames around screenshots, use the fastlane tool &quot;frameit&quot; <a href="https://docs.fastlane.tools/actions/frameit/?v=1.0.20" rel="noopener" target="_blank">frameit</a> which is an alias for <code>frame_screenshots</code>.</p><p>Before running this, enter <code>brew install imagemagick</code>.</p><p>This action creates new <code>.png</code> files below the <code>fastlane/screenshots</code> directory that have <code>_framed</code> appended to their names. The framed screenshots are beautiful, but they are all larger than the originals and are incompatible with the sizes the App Store accepts. See this <a href="https://github.com/fastlane/fastlane/issues/21067?v=1.0.20" rel="noopener" target="_blank">issue</a>.</p><h2 id="uploading-to-app-store" tabindex="-1">Uploading to App Store</h2><p>To upload the app to the App Store, use the fastlane tool <a href="https://docs.fastlane.tools/actions/deliver/?v=1.0.20" rel="noopener" target="_blank">deliver</a> which is an alias for <code>upload_to_app_store</code>. This can upload screenshots, metadata, and binaries to App Store Connect. It can also update the app version number and submit the app for review.</p><p>There are many parameters whose names begin with <code>skip_</code> that control what the action does. TODO: Will it upload framed screenshots and not the unframed versions?</p><p>I have not used this yet and may prefer to do it manually since releasing new versions to the App Store is done less frequently than releasing new versions to TestFlight.</p><h2 id="other-actions" tabindex="-1">Other Actions</h2><p>All the actions supported by fastlane are listed at <a href="https://docs.fastlane.tools/actions/?v=1.0.20" rel="noopener" target="_blank">fastlane actions</a>. There are many more than were described above!</p><p>In addition to the actions already described, consider using these:</p><ul><li><p>The <a href="https://docs.fastlane.tools/actions/get_version_number/?v=1.0.20" rel="noopener" target="_blank">get_version_number</a> and <a href="https://docs.fastlane.tools/actions/get_build_number/?v=1.0.20" rel="noopener" target="_blank">get_build_number</a> actions return values. They can be combined in a lane like the following:</p><pre class="language-ruby"><code class="language-ruby">desc <span class="token string-literal"><span class="token string">"Prints the version and build number"</span></span><br>lane <span class="token symbol">:version</span> <span class="token keyword">do</span><br>  version <span class="token operator">=</span> get_version_number<br>  build <span class="token operator">=</span> get_build_number<br>  puts <span class="token string-literal"><span class="token string">"version </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">version</span><span class="token delimiter punctuation">}</span></span><span class="token string">, build </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">build</span><span class="token delimiter punctuation">}</span></span><span class="token string">"</span></span><br><span class="token keyword">end</span></code></pre></li><li><p>The <a href="https://docs.fastlane.tools/actions/notification/?v=1.0.20" rel="noopener" target="_blank">notification</a> displays a macOS notification. The first time this is used, the System Settings app will open. To enable &quot;terminal-notifier&quot; to display notifications, toggle &quot;Allow Notifications&quot; to on and select &quot;Alerts&quot;.</p><p>I tried the following, but haven't gotten it to work yet.</p><pre class="language-ruby"><code class="language-ruby">notification<span class="token punctuation">(</span><br>  <span class="token symbol">title</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"Morning Greeting"</span></span><span class="token punctuation">,</span><br>  <span class="token symbol">subtitle</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"Daily Advice"</span></span><span class="token punctuation">,</span><br>  <span class="token symbol">message</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"Good morning Mark! Learn something today."</span></span><br><span class="token punctuation">)</span></code></pre></li><li><p>The <a href="https://docs.fastlane.tools/actions/puts/?v=1.0.20" rel="noopener" target="_blank">puts</a> prints given text to stdout. <code>echo</code> is an alias for this.</p></li><li><p>The <a href="https://docs.fastlane.tools/actions/say/?v=1.0.20" rel="noopener" target="_blank">say</a> action speaks given text. It is useful for announcing when a lane completes.</p></li><li><p>The <a href="https://docs.fastlane.tools/actions/sh/?v=1.0.20" rel="noopener" target="_blank">sh</a> to execute a shell command.</p></li><li><p>The <a href="https://docs.fastlane.tools/actions/slather/?v=1.0.20" rel="noopener" target="_blank">slather</a> action generates a code coverage report.</p></li><li><p>The <a href="https://docs.fastlane.tools/actions/swiftlint/?v=1.0.20" rel="noopener" target="_blank">swiftlint</a> action performs code validation using SwiftLint.</p></li></ul><h2 id="listing-lanes" tabindex="-1">Listing Lanes</h2><p>To list the lanes implemented for a given project, enter <code>fastlane lanes</code>.</p><p>To list the lanes in a table and optionally select one to execute, enter <code>fastlane</code>. To execute one of the lanes, enter its number. To exit without executing a lane, enter 0 or press ctrl-c.</p><h2 id="ruby-vs.-swift" tabindex="-1">Ruby vs. Swift</h2><p>By default <code>Fastfile</code> contains code written in the Ruby programming language. There is a option to use code written in the Swift programming language, but that executes more slowly because it still interacts with Ruby.</p><h2 id="complete-fastfile" tabindex="-1">Complete Fastfile</h2><p>This is the <code>Fastfile</code> for my WeatherKitDemo a project.</p><pre class="language-ruby"><code class="language-ruby">default_platform <span class="token symbol">:ios</span><br><br>platform <span class="token symbol">:ios</span> <span class="token keyword">do</span><br>  desc <span class="token string-literal"><span class="token string">"Creates a signing certificate and provisioning profile"</span></span><br>  lane <span class="token symbol">:certs</span> <span class="token keyword">do</span><br>    get_certificates<span class="token punctuation">(</span><span class="token symbol">development</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br>    get_provisioning_profile<span class="token punctuation">(</span><span class="token symbol">development</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><br>  desc <span class="token string-literal"><span class="token string">"Runs all unit and UI tests"</span></span><br>  <span class="token comment"># This works despite warnings that say</span><br>  <span class="token comment"># "deviceType from ... was NULL when -platform called".</span><br>  lane <span class="token symbol">:tests</span> <span class="token keyword">do</span><br>    run_tests<span class="token punctuation">(</span><br>      <span class="token symbol">devices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"iPhone 14 Pro"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token symbol">scheme</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"WeatherKitDemo"</span></span><br>    <span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><br>  desc <span class="token string-literal"><span class="token string">"Generates localized screenshots"</span></span><br>  lane <span class="token symbol">:screenshots</span> <span class="token keyword">do</span><br>    capture_screenshots<span class="token punctuation">(</span><span class="token symbol">scheme</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"ScreenshotTests"</span></span><span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><br>  desc <span class="token string-literal"><span class="token string">"Creates new screenshots from existing ones that have device frames"</span></span><br>  <span class="token comment"># The PNG files this produces have sizes that App Store doesn't accept!</span><br>  <span class="token comment"># See https://github.com/fastlane/fastlane/issues/21067.</span><br>  lane <span class="token symbol">:frames</span> <span class="token keyword">do</span><br>    frame_screenshots<span class="token punctuation">(</span><span class="token symbol">is_complex_framing_mode</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><br>  desc <span class="token string-literal"><span class="token string">"Uploads localized screenshots to App Store"</span></span><br>  <span class="token comment"># I needed to rename the "hi-IN" directory to "hi"</span><br>  <span class="token comment"># and the "zh-CN" directory to "zh-Hans".</span><br>  lane <span class="token symbol">:upload</span> <span class="token keyword">do</span><br>    <span class="token comment"># Only uploading screenshots.</span><br>    upload_to_app_store<span class="token punctuation">(</span><br>      <span class="token symbol">skip_app_version_update</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>      <span class="token symbol">skip_binary_upload</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>      <span class="token symbol">skip_metadata</span><span class="token operator">:</span> <span class="token boolean">true</span><br>    <span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><br>  desc <span class="token string-literal"><span class="token string">"Builds the app and produces symbol and ipa files."</span></span><br>  lane <span class="token symbol">:build</span> <span class="token keyword">do</span><br>    build_app<br>  <span class="token keyword">end</span><br><br>  desc <span class="token string-literal"><span class="token string">"Deploys app to TestFlight"</span></span><br>  lane <span class="token symbol">:beta</span> <span class="token keyword">do</span><br>    <span class="token comment"># I prefer to update the Version and Build numbers manually in Xcode.</span><br>    <span class="token comment"># increment_build_number</span><br>    <span class="token comment"># increment_version_number(bump_type: "patch")</span><br>    upload_to_testflight<span class="token punctuation">(</span><br>      <span class="token symbol">ipa</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'./fastlane/builds/WeatherKitDemo.ipa'</span></span><span class="token punctuation">,</span><br>      <span class="token comment"># I prefer to submit manually on the App Store Connect web page</span><br>      <span class="token comment"># so I can enter a description of what changed in this version.</span><br>      <span class="token symbol">skip_submission</span><span class="token operator">:</span> <span class="token boolean">true</span><br>    <span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span></code></pre></article>