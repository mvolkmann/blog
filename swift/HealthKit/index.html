<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>HealthKit</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#flutter">Flutter</a></li><li><a href="#available-data">Available Data</a></li><li><a href="#steps-to-use">Steps to Use</a></li><li><a href="#background-delivery">Background Delivery</a></li><li><a href="#permissions">Permissions</a></li><li><a href="#class-hierarchy">Class Hierarchy</a></li><li><a href="#reading-data">Reading Data</a></li><li><a href="#writing-data">Writing Data</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p><a href="https://developer.apple.com/documentation/healthkit?v=1.0.20" rel="noopener" target="_blank">HealthKit</a> is a library from Apple to &quot;Access and share health and fitness data while maintaining the user’s privacy and control.&quot;</p><p>It supports three categories of tasks:</p><ol><li>collect and store health and fitness data</li><li>analyze and visualize the data</li><li>enable social interactions</li></ol><p>&quot;Because health data may contain sensitive, personal information, apps must receive permission from the user to read data from or write data to the HealthKit store.&quot;</p><h2 id="flutter" tabindex="-1">Flutter</h2><p>The Flutter pub.dev package <a href="https://pub.dev/packages/health?v=1.0.20" rel="noopener" target="_blank">health</a> can access data from both Apple HealthKit and Android &quot;Google Fit&quot;.</p><p>See my project flutter_health which is not yet working.</p><h2 id="available-data" tabindex="-1">Available Data</h2><p>The data available in HealthKit includes:</p><ul><li><p>Activity (<code>HKQuantityType</code>)</p><ul><li><code>activeEnergyBurned</code></li><li><code>appleExerciseTime</code></li><li><code>appleMoveTime</code></li><li><code>appleStandHour</code> (<code>HKCategoryTypeIdentifier</code>)</li><li><code>appleStandTime</code></li><li><code>basalEnergyBurned</code></li><li><code>distanceCycling</code></li><li><code>distanceDownhillSnowSports</code></li><li><code>distanceSwimming</code></li><li><code>distanceWalkingRunning</code></li><li><code>distanceWheelchair</code></li><li><code>flightsClimbed</code> (stairs)</li><li><code>lowCardioFitnessEvent</code> (<code>HKCategoryTypeIdentifier</code>)</li><li><code>nikeFuel</code> (points earned)</li><li><code>pushCount</code> (wheelchair)</li><li><code>stepCount</code></li><li><code>swimmingStrokeCount</code></li><li><code>vo2Max</code></li><li><code>walkingSpeed</code></li><li><code>walkingStepLength</code></li></ul></li><li><p>Blood (<code>HKQuantityType</code>)</p><ul><li><code>bloodAlcoholContent</code></li><li><code>bloodGlucose</code></li><li><code>bloodPressureDiastolic</code></li><li><code>bloodPressureSystolic</code></li><li><code>oxygenSaturation</code></li></ul></li><li><p>Body Measurements (<code>HKQuantityType</code>)</p><ul><li><code>bodyFatPercentage</code></li><li><code>bodyMass</code></li><li><code>bodyMassIndex</code></li><li><code>height</code></li><li><code>leanBodyMass</code></li><li><code>waistCircumference</code></li></ul></li><li><p>Breathing (<code>HKQuantityType</code>)</p><ul><li><code>forcedExpiratoryVolume1</code></li><li><code>inhalerUsage</code></li><li><code>peakExpiratoryFlowRate</code></li><li><code>respiratoryRate</code></li></ul></li><li><p>Characteristics (<code>HKCharacteristicType</code>)</p><ul><li><code>activityMoveMode</code> (TODO: What is this?)</li><li><code>biologicalSex</code></li><li><code>bloodType</code></li><li><code>dateOfBirth</code></li><li><code>fitzpatrickSkinType</code></li><li><code>wheelchairUse</code></li></ul></li><li><p>Dietary (<code>HKQuantityType</code>)</p><ul><li><code>dietaryBiotin</code></li><li><code>dietaryCaffeine</code></li><li><code>dietaryCalcium</code></li><li><code>dietaryCarbohydrates</code></li><li><code>dietaryChloride</code></li><li><code>dietaryCholesterol</code></li><li><code>dietaryChromium</code></li><li><code>dietaryCopper</code></li><li><code>dietaryEnergyConsumed</code></li><li><code>dietaryFatMonounsaturated</code></li><li><code>dietaryFatPolyunsaturated</code></li><li><code>dietaryFatSaturated</code></li><li><code>dietaryFatTotal</code></li><li><code>dietaryFiber</code></li><li><code>dietaryFolate</code></li><li><code>dietaryIodine</code></li><li><code>dietaryIron</code></li><li><code>dietaryMagnesium</code></li><li><code>dietaryManganese</code></li><li><code>dietaryMolybdenum</code></li><li><code>dietaryNiacin</code></li><li><code>dietaryPantothenicAcid</code></li><li><code>dietaryPhosphorus</code></li><li><code>dietaryPotassium</code></li><li><code>dietaryProtein</code></li><li><code>dietaryRiboflavin</code></li><li><code>dietarySelenium</code></li><li><code>dietarySodium</code></li><li><code>dietarySugar</code></li><li><code>dietaryThiamin</code></li><li><code>dietaryVitaminA</code></li><li><code>dietaryVitaminB12</code></li><li><code>dietaryVitaminB6</code></li><li><code>dietaryVitaminC</code></li><li><code>dietaryVitaminD</code></li><li><code>dietaryVitaminE</code></li><li><code>dietaryVitaminA</code></li><li><code>dietaryVitaminK</code></li><li><code>dietaryWater</code></li><li><code>dietaryZinc</code></li></ul></li><li><p>Hearing (<code>HKQuantityType</code>)</p><ul><li><p><code>environmentalAudioExposure</code></p></li><li><p><code>environmentalAudioExposureEvent</code> (<code>HKCategoryTypeIdentifier</code>)</p><p>&quot;sent when the average sound level reaches or exceeds a specified threshold for three minutes&quot;</p></li><li><p><code>headphoneAudioExposure</code></p></li><li><p><code>headphoneAudioExposureEvent</code> (<code>HKCategoryTypeIdentifier</code>)</p><p>&quot;when the device generates a notification about loud headphone audio&quot;</p></li></ul></li><li><p>Heart (<code>HKQuantityType</code>)</p><ul><li><p>heartbeat series</p><p>See <a href="https://developer.apple.com/documentation/healthkit/hkheartbeatseriesquery?v=1.0.20" rel="noopener" target="_blank">HKHeartbeatSeriesQuery</a>.</p></li><li><p><code>heartRate</code></p></li><li><p><code>heartRateVariabilitySDNN</code></p></li><li><p><code>highHeartRateEvent</code> (<code>HKCategoryTypeIdentifier</code>)</p><p>For example, &quot;Your heart rate rose above 120 BPM while you seemed to be inactive for 10 minutes starting at 10:06 AM.&quot;</p></li><li><p><code>irregularHeartRhythmEvent</code> (<code>HKCategoryTypeIdentifier</code>)</p><p>&quot;might be suggestive of atrial fibrillation (AFib)&quot;</p></li><li><p><code>lowHeartRateEvent</code> (<code>HKCategoryTypeIdentifier</code>)</p><p>This is similar to a <code>highHeartRateEvent</code>.</p></li><li><p><code>restingHeartRate</code></p></li><li><p><code>walkingHeartRateAverage</code></p></li></ul></li><li><p>Reproductive Health (<code>HKCategoryTypeIdentifier</code>)</p><ul><li><code>basalBodyTemperature</code> (<code>HKQuantityType</code>)</li><li><code>cervicalMucusQuality</code></li><li><code>contraceptive</code></li><li><code>intermenstrualBleeding</code></li><li><code>lactation</code></li><li><code>menstrualFlow</code></li><li><code>ovulationTestResult</code></li><li><code>pregnancy</code></li><li><code>pregnancyTestResult</code></li><li><code>progesteroneTestResult</code></li><li><code>sexualActivity</code></li></ul></li><li><p>Vital Signs (<code>HKQuantityType</code>)</p><ul><li><p><code>bodyTemperature</code></p></li><li><p>electrocardiogram data</p><p>See <a href="https://developer.apple.com/documentation/healthkit/hkelectrocardiogramquery?v=1.0.20" rel="noopener" target="_blank">HKElectrocardiogramQuery</a>.</p></li><li><p><code>forcedVitalCapacity</code></p><p>This is the standard deviation of <a href="https://hexoskin.zendesk.com/hc/en-us/articles/360045123314-Difference-between-RR-interval-and-NN-interval?v=1.0.20" rel="noopener" target="_blank">NN intervals</a>.</p></li></ul></li><li><p>Other (<code>HKQuantityType</code>)</p><ul><li><p><code>appleWalkingSteadiness</code></p></li><li><p><code>appleWalkingSteadinessEvent</code> (<code>HKCategoryTypeIdentifier</code>)</p><p>&quot;an incident where the user showed a reduced score for their gait's steadiness&quot;</p></li><li><p><code>electrodermalActivity</code></p></li><li><p><code>insulinDelivery</code></p></li><li><p><code>numberOfAlcoholicBeverages</code></p></li><li><p><code>numberOfTimesFallen</code></p></li><li><p><code>peripheralPerfusionIndex</code></p></li><li><p><code>sixMinuteWalkTestDistance</code></p></li><li><p><code>stairAscentSpeed</code></p></li><li><p><code>stairDescentSpeed</code></p></li><li><p><code>uvExposure</code></p></li><li><p><code>walkingAsymmetryPercentage</code></p></li><li><p><code>walkingDoubleSupportPercentage</code></p></li></ul></li></ul><h2 id="steps-to-use" tabindex="-1">Steps to Use</h2><ol><li>Create a new iOS App project in Xcode.</li><li>Click the top entry in the Navigator.</li><li>Select TARGETS ... {app-name} ... Info.</li><li>Hover over one the entries and click the &quot;+&quot; button to add one.</li><li>Add the key &quot;Privacy - Health Share Usage Description&quot;</li><li>Enter a value like &quot;This app needs to access your health data.&quot;</li><li>Hover over one the entries and click the &quot;+&quot; button to add another.</li><li>Add the key &quot;Privacy - Health Update Usage Description&quot;</li><li>Enter a value like &quot;This app needs to update your health data.&quot;</li><li>Click the target under &quot;TARGETS&quot; which has the same name as the app.</li><li>Click the &quot;Signing &amp; Capabilities&quot; tab.</li><li>Click &quot;+ Capability&quot;.</li><li>Type &quot;h&quot; and double-click &quot;HealthKit&quot;.</li></ol><p>HealthKit cannot be used in the Simulator, so the app must be run on a real device.</p><h2 id="background-delivery" tabindex="-1">Background Delivery</h2><p>To enable background delivery of HealthKit events:</p><ol><li>Navigate to the &quot;Signing &amp; Capabilities&quot; tab for the Target.</li><li>Add a provisioning profile (see separate post)</li><li>In the HealthKit section, check the &quot;Background Delivery&quot; checkbox</li></ol><h2 id="permissions" tabindex="-1">Permissions</h2><p>The first time a user runs an app that uses HealthKit it will prompt for permission to access health data. Separate toggle switches are displayed for each kind of data to be written and each kind of data to be read. For example, a user can grant access to read their weight (a.k.a. bodyMass), but deny permission to write their weight.</p><p>If the user denies permission to access a particular kind of data and the app is run again later, it will not prompt the user for permission again.</p><p>To grant permission later:</p><ol><li>Launch the Health app.</li><li>Tap the &quot;Sharing&quot; button at the bottom.</li><li>Tap &quot;Apps&quot;.</li><li>Tap the name of an app that wants permissions.</li><li>Enable/disable specific permissions or tap &quot;Turn on all&quot;.</li></ol><p>An error is thrown if an app attempts to write data for which the user has not granted permission.</p><p>Apps do not crash or throw an error if they attempt to read data for which the user has not granted permission. If the query is for a single value, ? is returned. If the query is for a sequence of data, an empty Array is returned.</p><h2 id="class-hierarchy" tabindex="-1">Class Hierarchy</h2><ul><li><p><a href="https://developer.apple.com/documentation/healthkit/hkhealthstore?v=1.0.20" rel="noopener" target="_blank">HKHealthStore</a></p><p>&quot;The access point for all data managed by HealthKit.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkobject?v=1.0.20" rel="noopener" target="_blank">HKObject</a></p><p>&quot;A piece of data that can be stored inside the HealthKit store.&quot;</p><p>This stores a UUID for the value (<code>uuid</code>), the device that generated the data (<code>device</code>), the app that created the object (<code>sourceRevision</code>), and metadata in a map with <code>String</code> keys (<code>metadata</code>).</p><ul><li><p><a href="https://developer.apple.com/documentation/healthkit/hksample?v=1.0.20" rel="noopener" target="_blank">HKSample</a></p><p>&quot;A HealthKit sample represents a piece of data associated with a start and end time.&quot;</p><ul><li><p><a href="https://developer.apple.com/documentation/healthkit/hkcategorysample?v=1.0.20" rel="noopener" target="_blank">HKCategorySample</a></p><p>&quot;A sample with values from a short list of possible values.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkcorrelation?v=1.0.20" rel="noopener" target="_blank">HKCorrelation</a></p><p>&quot;A sample that groups multiple related samples into a single entry.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkquantitysample?v=1.0.20" rel="noopener" target="_blank">HKQuantitySample</a></p><p>&quot;A sample that represents a quantity, including the value and the units.&quot;</p><ul><li><p><a href="https://developer.apple.com/documentation/healthkit/hkcumulativequantitysample?v=1.0.20" rel="noopener" target="_blank">HKCummulativeQuantitySample</a></p><p>&quot;A sample that represents a cumulative quantity.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkdiscretequantitysample?v=1.0.20" rel="noopener" target="_blank">HKDiscreteQuantitySample</a></p><p>&quot;A sample that represents a discrete quantity.&quot;</p></li></ul></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkworkout?v=1.0.20" rel="noopener" target="_blank">HKWorkout</a></p><p>&quot;A workout sample that stores information about a single physical activity.&quot;</p><p>This can include multiple values with different units such as meters run, flights of stairs climbed, and calories burned.</p></li></ul></li></ul></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkobjecttype?v=1.0.20" rel="noopener" target="_blank">HKObjectType</a></p><p>&quot;An abstract superclass with subclasses that identify a specific type of data for the HealthKit store.&quot;</p><ul><li><p><a href="https://developer.apple.com/documentation/healthkit/hkactivitysummarytype?v=1.0.20" rel="noopener" target="_blank">HKActivitySummaryType</a></p><p>&quot;A type that identifies activity summary objects.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkcharacteristictype?v=1.0.20" rel="noopener" target="_blank">HKCharacteristicType</a></p><p>&quot;A type that represents data that doesn’t typically change over time.&quot;</p><p>Examples include birthday and blood type.</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hksampletype?v=1.0.20" rel="noopener" target="_blank">HKSampleType</a></p><p>&quot;An abstract superclass for all classes that identify a specific type of sample when working with the HealthKit store.&quot;</p><ul><li><p><a href="https://developer.apple.com/documentation/healthkit/hkaudiogramsampletype?v=1.0.20" rel="noopener" target="_blank">HKAudiogramSampleType</a></p><p>&quot;An abstract superclass for all classes that identify a specific type of sample when working with the HealthKit store.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkcategorytype?v=1.0.20" rel="noopener" target="_blank">HKCategoryType</a></p><p>&quot;A type that identifies samples that contain a value from a small set of possible values.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkclinicaltype?v=1.0.20" rel="noopener" target="_blank">HKClinicalType</a></p><p>&quot;A type that identifies samples that contain clinical record data.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkcorrelationtype?v=1.0.20" rel="noopener" target="_blank">HKCorrelationType</a></p><p>&quot;A type that identifies samples that group multiple subsamples.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkdocumenttype?v=1.0.20" rel="noopener" target="_blank">HKDocumentType</a></p><p>&quot;A sample type used to create queries for documents.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkelectrocardiogramtype?v=1.0.20" rel="noopener" target="_blank">HKElectrocardiogramType</a></p><p>&quot;A type that identifies samples containing electrocardiogram data.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkquantitytype?v=1.0.20" rel="noopener" target="_blank">HKQuantityType</a></p><p>&quot;A type that identifies samples that store numerical values.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkseriestype?v=1.0.20" rel="noopener" target="_blank">HKSeriesType</a></p><p>&quot;A type that indicates the data stored in a series sample.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkworkouttype?v=1.0.20" rel="noopener" target="_blank">HKWorkoutType</a></p><p>&quot;A type that identifies samples that store information about a workout.&quot;</p></li></ul></li></ul></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkquantity?v=1.0.20" rel="noopener" target="_blank">HKQuantity</a></p><p>&quot;An object that stores a value for a given unit.&quot;</p><p>The numeric value and unit this stores cannot be directly accessed. Instead call the <code>doubleValue</code> method which returns the value after converting it to a specified unit. For example, the value may be stored in meters, but can be retrieved in miles. There is no need to writing code to do unit conversions.</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkquery?v=1.0.20" rel="noopener" target="_blank">HKQuery</a></p><p>&quot;An abstract class for all the query classes in HealthKit.&quot;</p><ul><li><p><a href="https://developer.apple.com/documentation/healthkit/hkactivitysummaryquery?v=1.0.20" rel="noopener" target="_blank">HKActivitySummaryQuery</a></p><p>&quot;A query for reading activity summary objects from the HealthKit store.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkanchoredobjectquery?v=1.0.20" rel="noopener" target="_blank">HKAnchoredObjectQuery</a></p><p>&quot;A query that returns changes to the HealthKit store, including a snapshot of new changes and continuous monitoring as a long-running query.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkcorrelationquery?v=1.0.20" rel="noopener" target="_blank">HKCorrelationQuery</a></p><p>&quot;A query that performs complex searches based on the correlation’s contents, and returns a snapshot of all matching samples.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkdocumentquery?v=1.0.20" rel="noopener" target="_blank">HKDocumentQuery</a></p><p>&quot;A query that returns a snapshot of all matching documents currently saved in the HealthKit store.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkelectrocardiogramquery?v=1.0.20" rel="noopener" target="_blank">HKElectrocardiogramQuery</a></p><p>&quot;A query that returns the underlying voltage measurements for an electrocardiogram sample.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkheartbeatseriesquery?v=1.0.20" rel="noopener" target="_blank">HKHeartbeatSeriesQuery</a></p><p>&quot;A query that returns the heartbeat data contained in a heartbeat series sample.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkobserverquery?v=1.0.20" rel="noopener" target="_blank">HKObserverQuery</a></p><p>&quot;A long-running query that monitors the HealthKit store and updates your app when the HealthKit store saves or deletes a matching sample.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkquantityseriessamplequery?v=1.0.20" rel="noopener" target="_blank">HKQuantitySeriesSampleQuery</a></p><p>&quot;A query that accesses the series data associated with a quantity sample.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hksamplequery?v=1.0.20" rel="noopener" target="_blank">HKSampleQuery</a></p><p>&quot;A general query that returns a snapshot of all the matching samples currently saved in the HealthKit store.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hksourcequery?v=1.0.20" rel="noopener" target="_blank">HKSourceQuery</a></p><p>&quot;A query that returns a list of sources, such as apps and devices, that have saved matching queries to the HealthKit store.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkstatisticscollectionquery?v=1.0.20" rel="noopener" target="_blank">HKStatisticsCollectionQuery</a></p><p>&quot;A query that performs multiple statistics queries over a series of fixed-length time intervals.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkstatisticsquery?v=1.0.20" rel="noopener" target="_blank">HKStatisticsQuery</a></p><p>&quot;A query that performs statistical calculations over a set of matching quantity samples, and returns the results. You can use statistical queries to calculate the minimum, maximum, or average value of a set of discrete quantities, or use them to calculate the sum for cumulative quantities.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkverifiableclinicalrecordquery?v=1.0.20" rel="noopener" target="_blank">HKVerifiableClinicalRecordQuery</a></p><p>&quot;A query for one-time access to a SMART Health Card.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkworkoutroutequery?v=1.0.20" rel="noopener" target="_blank">HKWorkoutRouteQuery</a></p><p>&quot;A query to access the location data stored in a workout route.&quot;</p></li></ul></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkquerydescriptor?v=1.0.20" rel="noopener" target="_blank">HKQueryDescriptor</a></p><p>&quot;A descriptor that specifies a set of samples based on the data type and a predicate.&quot;</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkstatistics?v=1.0.20" rel="noopener" target="_blank">HKStatistics</a></p><p>&quot;An object that represents the result of calculating the minimum, maximum, average, or sum over a set of samples from the HealthKit store.&quot;</p><p>Properties include <code>startDate</code>, <code>endDate</code>, <code>quantityType</code>, and <code>sources</code>. Methods include <code>averageQuantity</code>, <code>duration</code>, <code>maximumQuantity</code>, <code>minimumQuantity</code>, <code>mostRecentQuantity</code>, <code>mostRecentQuantityDateInterval</code>, and <code>sumQuantity</code>.</p></li><li><p><a href="https://developer.apple.com/documentation/healthkit/hkstatisticscollection?v=1.0.20" rel="noopener" target="_blank">HKStatisticsCollection</a></p><p>&quot;An object that manages a collection of statistics, representing the results calculated over separate time intervals.&quot;</p><p>Duplicate data collected from multiple devices can be automatically ignored.</p></li></ul><h2 id="reading-data" tabindex="-1">Reading Data</h2><p>In order to access HealthKit, add the capability in the &quot;Signing &amp; Capabilities&quot; tab of the main target.</p><p>Add the key &quot;Privacy - Health Share Usage Description&quot; in the &quot;Info&quot; tab of the main target with a description like &quot;To read health data&quot;.</p><p>The following code demonstrates retrieving data from HealthKit and display it. For the full iOS project, see this <a href="https://github.com/mvolkmann/Workouts?v=1.0.20" rel="noopener" target="_blank">GitHub repository</a>.</p><pre class="language-swift"><code class="language-swift"><span class="token comment">// ContentView.swift</span><br><span class="token keyword">import</span> <span class="token class-name">SwiftUI</span><br><br><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>    <span class="token attribute atrule">@StateObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> viewModel <span class="token operator">=</span> <span class="token class-name">HealthKitViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">labelledValue</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> label<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> value<span class="token punctuation">:</span> <span class="token class-name">Double</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">label</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token class-name">String</span><span class="token punctuation">(</span>format<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"%.0f"</span></span><span class="token punctuation">,</span> value<span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">var</span> body<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>        <span class="token class-name">VStack</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Health Statistics for Past 7 Days"</span></span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">font</span><span class="token punctuation">(</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span><br>            <span class="token function">labelledValue</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Average Heart Rate"</span></span><span class="token punctuation">,</span> viewModel<span class="token punctuation">.</span>heartRate<span class="token punctuation">)</span><br>            <span class="token function">labelledValue</span><span class="token punctuation">(</span><br>                <span class="token string-literal"><span class="token string">"Average Resting Heart Rate"</span></span><span class="token punctuation">,</span><br>                viewModel<span class="token punctuation">.</span>restingHeartRate<br>            <span class="token punctuation">)</span><br>            <span class="token function">labelledValue</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Total Steps"</span></span><span class="token punctuation">,</span> viewModel<span class="token punctuation">.</span>steps<span class="token punctuation">)</span><br>            <span class="token function">labelledValue</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Total Calories Burned"</span></span><span class="token punctuation">,</span> viewModel<span class="token punctuation">.</span>activeEnergyBurned<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><pre class="language-swift"><code class="language-swift"><span class="token comment">// HealthKitViewModel.swift</span><br><span class="token keyword">import</span> <span class="token class-name">HealthKit</span><br><br><span class="token attribute atrule">@MainActor</span><br><span class="token keyword">class</span> <span class="token class-name">HealthKitViewModel</span><span class="token punctuation">:</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span><br>    <span class="token attribute atrule">@Published</span> <span class="token keyword">private</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token keyword">var</span> activeEnergyBurned<span class="token punctuation">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> <span class="token number">0</span><br>    <span class="token attribute atrule">@Published</span> <span class="token keyword">private</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token keyword">var</span> heartRate<span class="token punctuation">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> <span class="token number">0</span><br>    <span class="token attribute atrule">@Published</span> <span class="token keyword">private</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token keyword">var</span> restingHeartRate<span class="token punctuation">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> <span class="token number">0</span><br>    <span class="token attribute atrule">@Published</span> <span class="token keyword">private</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token keyword">var</span> steps<span class="token punctuation">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> <span class="token number">0</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token class-name">Task</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> healthManager <span class="token operator">=</span> <span class="token class-name">HealthManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">do</span> <span class="token punctuation">{</span><br>                <span class="token keyword">try</span> <span class="token keyword">await</span> healthManager<span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span>identifiers<span class="token punctuation">:</span> <span class="token punctuation">[</span><br>                    <span class="token punctuation">.</span>activeEnergyBurned<span class="token punctuation">,</span><br>                    <span class="token punctuation">.</span>heartRate<span class="token punctuation">,</span><br>                    <span class="token punctuation">.</span>restingHeartRate<span class="token punctuation">,</span><br>                    <span class="token punctuation">.</span>stepCount<br>                <span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>                <span class="token keyword">let</span> endDate <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span>now<br>                <span class="token keyword">let</span> startDate <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><br>                    byAdding<span class="token punctuation">:</span> <span class="token class-name">DateComponents</span><span class="token punctuation">(</span>day<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                    to<span class="token punctuation">:</span> endDate<span class="token punctuation">,</span><br>                    wrappingComponents<span class="token punctuation">:</span> <span class="token boolean">false</span><br>                <span class="token punctuation">)</span><span class="token operator">!</span><br><br>                activeEnergyBurned <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> healthManager<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><br>                    identifier<span class="token punctuation">:</span> <span class="token punctuation">.</span>activeEnergyBurned<span class="token punctuation">,</span><br>                    unit<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">kilocalorie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                    startDate<span class="token punctuation">:</span> startDate<span class="token punctuation">,</span><br>                    endDate<span class="token punctuation">:</span> endDate<br>                <span class="token punctuation">)</span><br>                heartRate <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> healthManager<span class="token punctuation">.</span><span class="token function">average</span><span class="token punctuation">(</span><br>                    identifier<span class="token punctuation">:</span> <span class="token punctuation">.</span>heartRate<span class="token punctuation">,</span><br>                    unit<span class="token punctuation">:</span> <span class="token class-name">HKUnit</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"count/min"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                    startDate<span class="token punctuation">:</span> startDate<span class="token punctuation">,</span><br>                    endDate<span class="token punctuation">:</span> endDate<br>                <span class="token punctuation">)</span><br>                restingHeartRate <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> healthManager<span class="token punctuation">.</span><span class="token function">average</span><span class="token punctuation">(</span><br>                    identifier<span class="token punctuation">:</span> <span class="token punctuation">.</span>restingHeartRate<span class="token punctuation">,</span><br>                    unit<span class="token punctuation">:</span> <span class="token class-name">HKUnit</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"count/min"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                    startDate<span class="token punctuation">:</span> startDate<span class="token punctuation">,</span><br>                    endDate<span class="token punctuation">:</span> endDate<br>                <span class="token punctuation">)</span><br>                steps <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">await</span> healthManager<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><br>                    identifier<span class="token punctuation">:</span> <span class="token punctuation">.</span>stepCount<span class="token punctuation">,</span><br>                    unit<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                    startDate<span class="token punctuation">:</span> startDate<span class="token punctuation">,</span><br>                    endDate<span class="token punctuation">:</span> endDate<br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>                <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"error getting health data: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><pre class="language-swift"><code class="language-swift"><span class="token comment">// HealthManager.swift</span><br><span class="token keyword">import</span> <span class="token class-name">HealthKit</span><br><br><span class="token attribute atrule">@MainActor</span><br><span class="token keyword">class</span> <span class="token class-name">HealthManager</span><span class="token punctuation">:</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span><br>    <span class="token keyword">private</span> <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token class-name">HKHealthStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">authorize</span><span class="token punctuation">(</span>identifiers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">HKQuantityTypeIdentifier</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> typeSet<span class="token punctuation">:</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">HKQuantityType</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><br>            identifiers<span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token function">quantityType</span><span class="token punctuation">(</span>forIdentifier<span class="token punctuation">:</span> <span class="token short-argument">$0</span><span class="token punctuation">)</span><span class="token operator">!</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">requestAuthorization</span><span class="token punctuation">(</span>toShare<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> read<span class="token punctuation">:</span> typeSet<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">average</span><span class="token punctuation">(</span><br>        identifier<span class="token punctuation">:</span> <span class="token class-name">HKQuantityTypeIdentifier</span><span class="token punctuation">,</span><br>        unit<span class="token punctuation">:</span> <span class="token class-name">HKUnit</span><span class="token punctuation">,</span><br>        startDate<span class="token punctuation">:</span> <span class="token class-name">Date</span><span class="token punctuation">,</span><br>        endDate<span class="token punctuation">:</span> <span class="token class-name">Date</span><br>    <span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">Double</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> withCheckedThrowingContinuation <span class="token punctuation">{</span> completion <span class="token keyword">in</span><br>            <span class="token keyword">let</span> quantityType <span class="token operator">=</span> <span class="token class-name">HKQuantityType</span><span class="token punctuation">.</span><span class="token function">quantityType</span><span class="token punctuation">(</span><br>                forIdentifier<span class="token punctuation">:</span> identifier<br>            <span class="token punctuation">)</span><span class="token operator">!</span><br>            <span class="token keyword">let</span> predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token class-name">HKQuery</span><span class="token punctuation">.</span><span class="token function">predicateForSamples</span><span class="token punctuation">(</span><br>                withStart<span class="token punctuation">:</span> startDate<span class="token punctuation">,</span><br>                end<span class="token punctuation">:</span> endDate<span class="token punctuation">,</span><br>                <span class="token comment">// This option means the values must occur at date where</span><br>                <span class="token comment">// stateDate &lt;= date &lt; endDate.</span><br>                options<span class="token punctuation">:</span> <span class="token class-name">HKQueryOptions</span><span class="token punctuation">.</span>strictEndDate<br>            <span class="token punctuation">)</span><br>            <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token class-name">HKStatisticsQuery</span><span class="token punctuation">(</span><br>                quantityType<span class="token punctuation">:</span> quantityType<span class="token punctuation">,</span><br>                quantitySamplePredicate<span class="token punctuation">:</span> predicate<span class="token punctuation">,</span><br>                options<span class="token punctuation">:</span> <span class="token punctuation">.</span>discreteAverage<br>            <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span><span class="token punctuation">:</span> <span class="token class-name">HKStatisticsQuery</span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> <span class="token class-name">HKStatistics</span><span class="token operator">?</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token class-name">Error</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token keyword">in</span><br>                <span class="token keyword">if</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> error<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">let</span> quantity<span class="token punctuation">:</span> <span class="token class-name">HKQuantity</span><span class="token operator">?</span> <span class="token operator">=</span> result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">averageQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                    <span class="token keyword">let</span> result <span class="token operator">=</span> quantity<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> unit<span class="token punctuation">)</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>returning<span class="token punctuation">:</span> result <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            store<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">func</span> <span class="token function-definition function">sum</span><span class="token punctuation">(</span><br>        identifier<span class="token punctuation">:</span> <span class="token class-name">HKQuantityTypeIdentifier</span><span class="token punctuation">,</span><br>        unit<span class="token punctuation">:</span> <span class="token class-name">HKUnit</span><span class="token punctuation">,</span><br>        startDate<span class="token punctuation">:</span> <span class="token class-name">Date</span><span class="token punctuation">,</span><br>        endDate<span class="token punctuation">:</span> <span class="token class-name">Date</span><br>    <span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">Double</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> withCheckedThrowingContinuation <span class="token punctuation">{</span> completion <span class="token keyword">in</span><br>            <span class="token keyword">let</span> quantityType <span class="token operator">=</span> <span class="token class-name">HKQuantityType</span><span class="token punctuation">.</span><span class="token function">quantityType</span><span class="token punctuation">(</span><br>                forIdentifier<span class="token punctuation">:</span> identifier<br>            <span class="token punctuation">)</span><span class="token operator">!</span><br>            <span class="token keyword">let</span> predicate<span class="token punctuation">:</span> <span class="token class-name">NSPredicate</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token class-name">HKQuery</span><span class="token punctuation">.</span><span class="token function">predicateForSamples</span><span class="token punctuation">(</span><br>                withStart<span class="token punctuation">:</span> startDate<span class="token punctuation">,</span><br>                end<span class="token punctuation">:</span> endDate<span class="token punctuation">,</span><br>                <span class="token comment">// This option means the values must occur at date where</span><br>                <span class="token comment">// stateDate &lt;= date &lt; endDate.</span><br>                options<span class="token punctuation">:</span> <span class="token class-name">HKQueryOptions</span><span class="token punctuation">.</span>strictEndDate<br>            <span class="token punctuation">)</span><br>            <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token class-name">HKStatisticsQuery</span><span class="token punctuation">(</span><br>                quantityType<span class="token punctuation">:</span> quantityType<span class="token punctuation">,</span><br>                quantitySamplePredicate<span class="token punctuation">:</span> predicate<span class="token punctuation">,</span><br>                options<span class="token punctuation">:</span> <span class="token punctuation">.</span>cumulativeSum<br>            <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span><span class="token punctuation">:</span> <span class="token class-name">HKStatisticsQuery</span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> <span class="token class-name">HKStatistics</span><span class="token operator">?</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token class-name">Error</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token keyword">in</span><br>                <span class="token keyword">if</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>throwing<span class="token punctuation">:</span> error<span class="token punctuation">)</span><br>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">let</span> quantity<span class="token punctuation">:</span> <span class="token class-name">HKQuantity</span><span class="token operator">?</span> <span class="token operator">=</span> result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">sumQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                    <span class="token keyword">let</span> result <span class="token operator">=</span> quantity<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> unit<span class="token punctuation">)</span><br>                    completion<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>returning<span class="token punctuation">:</span> result <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">)</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            store<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2 id="writing-data" tabindex="-1">Writing Data</h2><p>In order to access HealthKit, add the capability in the &quot;Signing &amp; Capabilities&quot; tab of the main target.</p><p>Add the key &quot;Privacy - Health Update Usage Description&quot; in the &quot;Info&quot; tab of the main target with a description like &quot;To write workout data&quot;.</p><p>The following code demonstrates writing data to HealthKit.</p><pre class="language-swift"><code class="language-swift"><span class="token comment">// ContentView.swift</span><br><span class="token keyword">import</span> <span class="token class-name">SwiftUI</span><br><br><span class="token comment">// Code for this struct appears in the previous section.</span><br><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><br><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> caloriesBurned <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"850"</span></span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> cyclingMiles <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"20.0"</span></span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> endTime <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// adjusted in init</span><br>    <span class="token attribute atrule">@State</span> <span class="token keyword">private</span> <span class="token keyword">var</span> startTime <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// adjusted in init</span><br><br>    <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Remove seconds from the end time.</span><br>        <span class="token keyword">let</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span>current<br>        <span class="token keyword">let</span> endSeconds <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">.</span>second<span class="token punctuation">,</span> from<span class="token punctuation">:</span> endTime<span class="token punctuation">)</span><br>        <span class="token keyword">let</span> secondsCleared <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><br>            byAdding<span class="token punctuation">:</span> <span class="token punctuation">.</span>second<span class="token punctuation">,</span><br>            value<span class="token punctuation">:</span> <span class="token operator">-</span>endSeconds<span class="token punctuation">,</span><br>            to<span class="token punctuation">:</span> endTime<br>        <span class="token punctuation">)</span><span class="token operator">!</span><br>        _endTime <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">:</span> secondsCleared<span class="token punctuation">)</span><br><br>        <span class="token comment">// Set start time to one hour before the end time.</span><br>        <span class="token keyword">let</span> oneHourBefore <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><br>            byAdding<span class="token punctuation">:</span> <span class="token punctuation">.</span>hour<span class="token punctuation">,</span><br>            value<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><br>            to<span class="token punctuation">:</span> endTime<br>        <span class="token punctuation">)</span><span class="token operator">!</span><br>        _startTime <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">:</span> oneHourBefore<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Add this method and call it when a Button is tapped.</span><br>    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">addWorkout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token class-name">Task</span> <span class="token punctuation">{</span><br>            <span class="token keyword">do</span> <span class="token punctuation">{</span><br>                <span class="token comment">// HealthKit seems to round down to the nearest tenth.</span><br>                <span class="token comment">// For example, 20.39 becomes 20.3.</span><br>                <span class="token comment">// Adding 0.05 causes it to round to the nearest tenth.</span><br>                <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token punctuation">(</span>cyclingMiles <span class="token keyword">as</span> <span class="token class-name">NSString</span><span class="token punctuation">)</span><span class="token punctuation">.</span>doubleValue <span class="token operator">+</span> <span class="token number">0.05</span><br>                <span class="token keyword">let</span> calories <span class="token operator">=</span> <span class="token punctuation">(</span>caloriesBurned <span class="token keyword">as</span> <span class="token class-name">NSString</span><span class="token punctuation">)</span><span class="token punctuation">.</span>intValue<br>                <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">HealthKitManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addCyclingWorkout</span><span class="token punctuation">(</span><br>                    startTime<span class="token punctuation">:</span> startTime<span class="token punctuation">,</span><br>                    endTime<span class="token punctuation">:</span> endTime<span class="token punctuation">,</span><br>                    distance<span class="token punctuation">:</span> distance<span class="token punctuation">,</span><br>                    calories<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>calories<span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>                <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Error adding workout: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><pre class="language-swift"><code class="language-swift"><span class="token comment">// HealthManager.swift</span><br><span class="token keyword">import</span> <span class="token class-name">HealthKit</span><br><br><span class="token comment">// Code for this class appears in the previous section.</span><br><span class="token attribute atrule">@MainActor</span><br><span class="token keyword">class</span> <span class="token class-name">HealthManager</span><span class="token punctuation">:</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><br><br>    <span class="token comment">// Add this method.</span><br>    <span class="token keyword">func</span> <span class="token function-definition function">addCyclingWorkout</span><span class="token punctuation">(</span><br>        startTime<span class="token punctuation">:</span> <span class="token class-name">Date</span><span class="token punctuation">,</span><br>        endTime<span class="token punctuation">:</span> <span class="token class-name">Date</span><span class="token punctuation">,</span><br>        distance<span class="token punctuation">:</span> <span class="token class-name">Double</span><span class="token punctuation">,</span><br>        calories<span class="token punctuation">:</span> <span class="token class-name">Int</span><br>    <span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> workout <span class="token operator">=</span> <span class="token class-name">HKWorkout</span><span class="token punctuation">(</span><br>            activityType<span class="token punctuation">:</span> <span class="token class-name">HKWorkoutActivityType</span><span class="token punctuation">.</span>cycling<span class="token punctuation">,</span><br>            start<span class="token punctuation">:</span> startTime<span class="token punctuation">,</span><br>            end<span class="token punctuation">:</span> endTime<span class="token punctuation">,</span><br>            duration<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// compute from start and end data</span><br>            totalEnergyBurned<span class="token punctuation">:</span> <span class="token class-name">HKQuantity</span><span class="token punctuation">(</span><br>                unit<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">kilocalorie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                doubleValue<span class="token punctuation">:</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>calories<span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><span class="token punctuation">,</span><br>            totalDistance<span class="token punctuation">:</span> <span class="token class-name">HKQuantity</span><span class="token punctuation">(</span>unit<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">mile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doubleValue<span class="token punctuation">:</span> distance<span class="token punctuation">)</span><span class="token punctuation">,</span><br>            metadata<span class="token punctuation">:</span> <span class="token nil constant">nil</span><br>        <span class="token punctuation">)</span><br>        <span class="token keyword">try</span> <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>workout<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br></code></pre></article>