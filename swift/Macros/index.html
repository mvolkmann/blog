<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>Macros</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#defining-macros">Defining Macros</a></li><li><a href="#freestanding-macros">Freestanding Macros</a></li><li><a href="#attached-macros">Attached Macros</a></li><li><a href="#invoking-macros">Invoking Macros</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p>Swift macros &quot;allow you to generate repetitive code at compile-time.&quot;</p><p>Unlike C macros which are applied before compile-time, Swift macros are type-checked by the compiler before they are applied.</p><p>Macros are implemented in Swift and defined in compiler plugins.</p><h2 id="defining-macros" tabindex="-1">Defining Macros</h2><p>The steps to define a new macro are:</p><ol><li>Open Xcode.</li><li>Select New ... File ... Package</li><li>Select the &quot;Swift Macro&quot; template.</li><li>Click the &quot;Next&quot; button.</li><li>Enter a package name.</li><li>Select the directory where it will be saved.</li><li>Click the &quot;Create&quot; button.</li></ol><p>The generated file structure will contain the following:</p><ul><li><p><code>{package-name}</code> directory</p><ul><li><p><code>Package.swift</code></p><p>This describes the platforms on which the macro can run, its dependencies, and the targets it can create (definining library, client example, and unit tests).</p></li><li><p><code>Sources</code> directory</p><ul><li><p><code>{package-name}</code> directory</p><ul><li><p><code>{package-name}.swift</code></p><p>This file contains the definition of the <code>stringify</code> macro which serves as an example. Add new macro definitions in this file and optionally delete the definition for the <code>stringify</code> macro.</p><pre class="language-swift"><code class="language-swift"><span class="token attribute atrule">@freestanding</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><br><span class="token keyword">public</span> macro stringify<span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token omit keyword">_</span> value<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">=</span><br>    <span class="token other-directive property">#externalMacro</span><span class="token punctuation">(</span><br>        <span class="token comment">// This refers to a Swift file below.</span><br>        module<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"MyFirstMacroMacros"</span></span><span class="token punctuation">,</span><br>        <span class="token comment">// This refers to the name of an ExpressionMacro subtype</span><br>        <span class="token comment">// define in the Swift file.</span><br>        type<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"StringifyMacro"</span></span><br>    <span class="token punctuation">)</span></code></pre></li></ul></li><li><p><code>{package-name}Client</code></p><ul><li><p><code>main.swift</code></p><p>This file contains an example of using the <code>stringify</code> macro. To see the definition (not implementation) of a given macro invocation, right-click it and select &quot;Jump to Definition&quot;. To run this, ???</p></li></ul></li><li><p><code>{package-name}Macros</code></p><ul><li><p><code>{package-name}Macro.swift</code></p><p>This file contains the implementation of the <code>stringify</code> macro. Add new macro implementations in this file and optionally delete the implementation for the <code>stringify</code> macro.</p><p>The following code is the stringify macro implementation with comments added:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">StringifyMacro</span><span class="token punctuation">:</span> <span class="token class-name">ExpressionMacro</span> <span class="token punctuation">{</span><br>    <span class="token comment">// This method is required by the ExpressionMacro protocol.</span><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">expansion</span><span class="token punctuation">(</span><br>        <span class="token comment">// This argument is the AST of the passed expression.</span><br>        of node<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">FreestandingMacroExpansionSyntax</span><span class="token punctuation">,</span><br>        <span class="token comment">// This argument provides access to surrounding data.</span><br>        <span class="token keyword">in</span> context<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">MacroExpansionContext</span><br>    <span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ExprSyntax</span> <span class="token punctuation">{</span><br>        <span class="token comment">// This evaluates the expression passed in</span><br>        <span class="token comment">// which was defined to be an Int.</span><br>        <span class="token keyword">guard</span> <span class="token keyword">let</span> argument <span class="token operator">=</span> node<span class="token punctuation">.</span>argumentList<span class="token punctuation">.</span>first<span class="token operator">?</span><span class="token punctuation">.</span>expression <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"compiler bug: the macro does not have any arguments"</span></span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// The string expression returned here</span><br>        <span class="token comment">// is automatically parsed into an AST.</span><br>        <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">argument</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">, </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">literal<span class="token punctuation">:</span> argument<span class="token punctuation">.</span>description</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></li></ul></li></ul></li><li><p><code>Tests</code> directory</p><ul><li><p><code>{package-name}Tests</code> directory</p><ul><li><p><code>{package-name}Tests.swift</code></p><p>This file contains unit tests for the macros. Each test function calls <code>assertMacroExpansion</code>, passing it a string that invokes a macro, the expected result, and a <code>macros</code> argument whose value is a <code>Dictionary</code> where the keys are macro names and the values are the corresponding macro definitions.</p><p>To run all the tests, select Product ... Test or press cmd-u.</p></li></ul></li></ul></li></ul></li></ul><p>Macro definitions are similar to function definitions. They begin with the <code>macro</code> keyword and are followed by a name, parameter list, and return type.</p><h2 id="freestanding-macros" tabindex="-1">Freestanding Macros</h2><p>Freestanding macro definitions begin with <code>@freestanding(expression)</code> and can be applied to any expression.</p><p>The source code of the expression is made available to the macro in an abstract syntax tree (AST).</p><p>The macro can transform the AST to provide the result AST which is used to generate source code that is then passed to the compiler.</p><h2 id="attached-macros" tabindex="-1">Attached Macros</h2><p>Attached macros augument Swift declarations for entities they decorate such as variables, functions, enums, structs, and classes.</p><h2 id="invoking-macros" tabindex="-1">Invoking Macros</h2><p>A macro is invoked by preceding its name with a pound sign (<code>#</code>).</p></article>