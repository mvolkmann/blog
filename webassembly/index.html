<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>WebAssembly</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a><ol><li><a href="#variable-instructions">Variable Instructions</a></li></ol></li><li><a href="#vs-code">VS Code</a></li><li><a href="#only-numbers">Only Numbers</a></li><li><a href="#wasm-text-format">WASM Text Format</a></li><li><a href="#tools">Tools</a></li><li><a href="#tests">Tests</a></li><li><a href="#wasm-functions">WASM Functions</a></li><li><a href="#wasm-instructions">WASM Instructions</a></li></ol></nav></aside><article><h2 id="overview">Overview</h2><p>WebAssembly (abbreviated WASM) is a binary instruction format for a stack-based virtual machine. Other popular stack-based virtual machines include the Java Virtual Machine (JVM) and the .NET Common Language Runtime (CLR).</p><p>WASM code can be run in modern web browsers including Chrome (including Android), Edge, Firefox (including Android), Safari (including iOS), Opera, and Android Browser, but not Internet Explorer. It can also be run outside of web browsers using tools such as <a href="https://wasmtime.dev?v=1.0.10" rel="noopener" target="_blank">Wasmtime</a>, <a href="https://github.com/wasm3/wasm3?v=1.0.10" rel="noopener" target="_blank">WASM3</a>, <a href="https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.10" rel="noopener" target="_blank">WebAssembly Micro Runtime (WAMR)</a>.</p><p>There are two primary reasons to run WASM code in a web browser. The first is that it typically executes much faster than equivalent code written in JavaScript. The second is that it enables writing some of the code in any language that can be compiled to WASM as an alternative to JavaScript.</p><p>There are also two primary reasons to run WASM code outside a web browser. The first is that it enables targeting any platform that supports WASM. This is similar to the rationale for using Java, whose virtual machine is supported by many platforms. The second is that it is secure by default. WASM code does not have access to the environment, the file system, or network resources. The only way it can access those things is if the code that invokes it passes in functions that have those capabilities. This is referred to as capability-based security&quot;.</p><p>where access to resources such as the file system and network are restricted. Actually, WASM itself has no access to these and only gains it through the <a href="https://wasi.dev?v=1.0.10" rel="noopener" target="_blank">WebAssembly System Interface (WASI)</a>.</p><p>WASM code can also be compiled to native executables that run on x86 and ARM processors.</p><h2 id="vs-code">VS Code</h2><p>VS Code has several extensions for working with WASM code. The most popular is &quot;WebAssembly&quot; with the description &quot;WebAssembly Toolkit for VSCode&quot;.</p><h2 id="only-numbers">Only Numbers</h2><p>Currently WASM only supports the four data types <code>i32</code>, <code>i64</code>, <code>f32</code>, and <code>f64</code>. These match number types from Rust. Other types such as strings and structs must be serialized into these number types and deserialized from them using linear memory. Tools such as wasm_bindgen for Rust generate code that does this.</p><p>The <a href="https://github.com/WebAssembly/interface-types?v=1.0.10" rel="noopener" target="_blank">Interface Types proposal</a> seeks to change this. It &quot;adds a new set of interface types to WebAssembly that describe high-level values&quot;. These can be implemented using linear memory and the standard WASM numeric types. Added types include additional integer types, characters, lists, records (structs), and variants (enumerated types). Strings are represented as lists of characters. Supported programming languages will be able to serialize and deserialize these additional data types. Each language will be able to use its own representation of the data types.</p><p>WASM doesn't assume that number values are signed. However, specific instructions performed on them do. For example, the instruction to add two i64 signed values is <code>i64.add</code> and for unsigned values is <code>i64.add_u</code>.</p><h2 id="wasm-text-format">WASM Text Format</h2><p>While code from many programming languages can be compiled to WASM, it is also possible to directly implement the code.</p><p>WASM has a binary format and a text (intermediate form) format. Files in the binary format have the extension <code>.wasm</code>. Details about this format are provided later. Files in the text format have the extension <code>.wat</code>.</p><p>The text format has two styles, linear (or plain) and S-expressions (or folded). The linear format places instructions on separate lines. The S-expression format uses parentheses, similar to LISP, representing a tree of nodes. The first value in each expression indicates the node type. The remaining values are attributes or child nodes.</p><p>Every <code>.wat</code> file contains a single, top-level S-expression that defines a module. It is not possible to define more than one module in a source file. The module instruction does not support assigning a name.</p><p>Non-WASM runtimes such as web browsers, Rust, Node.js, Deno, and Python can import multiple WASM modules, but a WASM module cannot import another WASM module.</p><p>Modules can define many kinds of things including:</p><ul><li>imports from other modules</li><li>exports other modules can import</li><li>function type definitions</li><li>function definitions,</li><li>tables to implement function pointers</li><li>linear memory for storing arbitrary data</li><li>data to be placed in linear memory</li><li>global variables available throughout the module</li></ul><h2 id="tools">Tools</h2><p>The <a href="https://github.com/WebAssembly/wabt?v=1.0.10" rel="noopener" target="_blank">WebAssembly Binary Toolkit (WABT)</a> includes a set of command line tools including <code>wat2wasm</code>, <code>wasm2wat</code>, <code>wasm-validate</code>, and <code>wasm-interp</code>. In macOS these can be installed by installing <a href="https://brew.sh?v=1.0.10" rel="noopener" target="_blank">Homebrew</a> and entering <code>brew install wabt</code>.</p><p>The <code>wat2wasm</code> tool compiles a <code>.wat</code> file to a <code>.wasm</code> file. The <code>wasm2wat</code> tool de-compiles a <code>.wasm</code> file to a <code>.wat</code> file that uses the linear style. Also see <code>.wast</code> files that are for writing tests.</p><p>The <code>wasm-nm</code> tool outputs the symbols that are export from and imported into a <code>.wasm</code> file. To install this tool, enter <code>cargo install wasm-nm</code>. To run it, enter <code>wasm-nm {file-path}.wasm</code>. The names of exported symbols are preceded by &quot;e &quot; and the names of imported symbols are preceded by &quot;i &quot;.</p><h2 id="tests">Tests</h2><p>One way to write unit tests for WASM functions is to use the WABT tools <code>wast2json</code> and <code>spectest-interp</code>. For example, the following code defines an <code>add</code> function and unit tests for it. To run this, enter <code>wast2json demo.wat &amp;&amp; spectest-interp demo.json</code>.</p><p>Here is the contents of <code>demo.wat</code> which defines a function to be tested and its tests.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token variable">$main</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token variable">$main</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token variable">$main</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token variable">$main</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token comment">;; This test is expected to fail.</span><br><span class="token comment">;; It's purpose to show how failures are reported.</span><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token variable">$main</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>The output is:</p><pre class="language-text"><code class="language-text">demo.wast:12: mismatch in result 0 of assert_return: expected i32:6, got i32:7<br>3/4 tests passed.</code></pre><h2 id="wasm-functions">WASM Functions</h2><p>Modules can define functions. Functions that are exported can be called from JavaScript. These definitions have the syntax <code>(func {signature} {locals} {body})</code>. The signature defines the function name, its parameter types, and its return type. In functions that do not return a value, the return type is omitted. Locals defines local variable names and their types. The body is a list of instructions that implement the function.</p><p>Parameters and local variables are accessed by their position in the signature using zero-based indexes. The text format also allows functions, parameters, and local variables to have names that start with <code>$</code>. These can be referenced by name, but the names are compiled away in favor of indexes.</p><p>WASM functions can be named or unnamed. Any function can be called by its position (zero-based index) within the module. Named functions call also be called using their name.</p><p>The following code is in the file <code>demo.wat</code>.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token comment">;; anonymous function at index 0 that just returns 19</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">19</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token comment">;; named function at index 1 that just returns 21</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$second</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">21</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callFirst"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token number">0</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callSecond"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token variable">$second</span><br>    <span class="token comment">;; same as call 1</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this code to a <code>.wasm</code> file by entering <code>wat2wasm demo.wat</code>.</p><p>The following JavaScript code is in the file <code>demo.js</code>. It instantiates the WASM code above and calls its exported functions:</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>callFirst<span class="token punctuation">,</span> callSecond<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'first ='</span><span class="token punctuation">,</span> <span class="token function">callFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 19</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'second ='</span><span class="token punctuation">,</span> <span class="token function">callSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 21</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Function parameters can also be named or unnamed. Unnamed functions are referred to by their position (zero-based index) within the parameter list. Parameters are declared using the <code>param</code> instruction. Typically each parameter is described separately so each can be given a name and type. Alternatively all of their types can be described with a single <code>param</code> instruction, but in that case they cannot be given names. Functions have a fixed number of parameters and cannot accept a variable number of them. For example:</p><pre class="language-wasm"><code class="language-wasm">  <span class="token comment">;; Declaring each parameter separately</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"percent"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$amount</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$total</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f32</span><span class="token punctuation">)</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$amount</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$total</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>div</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">100.0</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>mul</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token comment">;; Using on param instruction</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"percent2"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f32</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f32</span><span class="token punctuation">)</span><br>    <span class="token keyword">local</span>.get <span class="token number">0</span><br>    <span class="token keyword">local</span>.get <span class="token number">1</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>div</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">100.0</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>mul</span><br>  <span class="token punctuation">)</span></code></pre><p>Functions that return a value must specify its type with <code>(return {type})</code>. This is omitted for functions that do not return a value.</p><p>Exporting a function makes it available outside its module, such as in JavaScript. There are two ways to export a function. It can be given both a WASM name and an exported name. This allows it to be called from both WASM code and outside code. For example:</p><pre class="language-wasm"><code class="language-wasm">  <span class="token comment">;; This function cannot be called by name in this WASM module.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"subtract"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span></code></pre><p>It call also be given only an exported name. In this case it can still be called from WASM code, but only by its position within the module.</p><pre class="language-wasm"><code class="language-wasm">  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"subtract"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span></code></pre><p>Instructions get their arguments from the top values on the stack. The <code>local.get {index | name}</code> instruction (old name was <code>get_local</code>) gets the value of a parameter of local variable and places it on the stack. The <code>local.set {index | name} {value}</code> instruction (old name was <code>set_local</code>) sets value of a local variable. The <code>{type}.const {value}</code> instruction pushes a constant value on the stack. When a function exists, its return value is the top value on the stack.</p><p>Single line comments begin with <code>;;</code> and extend to the end of the line. Multi-line comments begin with <code>(;</code> and end with <code>;)</code>. This makes it easy to comment out an S-expression because <code>;</code> characters just need to be added inside the opening and closing parentheses. It also means that a winking smiley face is the closing delimiter!</p><p>Here are examples of functions. The first takes two numbers and returns their sum. The rest compute the distance between two points using the formula <code>sqrt(dx**2 + dy**2)</code>. Three versions are presented to show different approaches. This code is available in the GitHub repo <a href="https://github.com/mvolkmann/wasm-demo/?v=1.0.10" rel="noopener" target="_blank">wasm-demo</a>.</p><ol><li>Create the file <code>math.wat</code> containing the following:</li></ol><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sum</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$lhs</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$rhs</span><br>    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"sum"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses the "linear" format.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">local</span>.get <span class="token variable">$x1</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$x2</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>    <span class="token keyword">local</span>.tee <span class="token variable">$x1</span> <span class="token comment">;; reusing $x1 to hold temporary dx value</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$x1</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token keyword">local</span>.get <span class="token variable">$y1</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$y2</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>    <span class="token keyword">local</span>.tee <span class="token variable">$y1</span> <span class="token comment">;; reusing $y1 to hold temporary dy value</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$y1</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses S-expressions.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance2</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dx</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dy</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dx</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x2</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dy</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y2</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token comment">;; There is no instruction to duplicate the value at</span><br>          <span class="token comment">;; the top of the stack, so we have to do this twice.</span><br>          <span class="token comment">;; See https://github.com/WebAssembly/design/issues/1365.</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance2"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses even more S-expressions.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance3</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$x1</span> <span class="token comment">;; reusing $x1 to hold temporary dx value</span><br>            <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x1</span><span class="token punctuation">)</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x2</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>          <span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$y1</span> <span class="token comment">;; reusing $y1 to hold temporary dy value</span><br>            <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y1</span><span class="token punctuation">)</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y2</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>          <span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance3"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><ol><li><p>Install the <a href="https://github.com/WebAssembly/wabt?v=1.0.10" rel="noopener" target="_blank">WebAssembly Binary Toolkit (WABT)</a>. This includes a set of command line tools including wat2wasm, wasm2wat, wasm-validate, and wasm-interp. In macOS this can be installed using Homebrew by entering <code>brew install wabt</code>.</p></li><li><p>Enter <code>wat2wasm math.mat</code> to create the binary file <code>math.wasm</code>.</p></li><li><p>Create the JavaScript file <code>index.js</code> that loads the <code>add.wasm</code> and calls the function it defines:</p><pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'math.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>distance<span class="token punctuation">,</span> distance2<span class="token punctuation">,</span> distance3<span class="token punctuation">,</span> sum<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'distance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance1 ='</span><span class="token punctuation">,</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance2 ='</span><span class="token punctuation">,</span> <span class="token function">distance2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance3 ='</span><span class="token punctuation">,</span> <span class="token function">distance3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Create the HTML file <code>index.html</code> that includes <code>index.js</code>:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>sum = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sum<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>distance = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>distance<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server. One approach is to install <a href="https://deno.land/">Deno</a> and then enter these commands:</p><pre class="language-bash"><code class="language-bash">deno <span class="token function">install</span> --allow-net --allow-read https://deno.land/std@0.87.0/http/file_server.ts<br>file_server <span class="token builtin class-name">.</span></code></pre></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output.</p></li></ol><h2 id="wasm-instructions">WASM Instructions</h2><p>TODO: Consider deleting this table if it just duplicates what is explained later.</p><table><thead><tr><th>Operation</th><th>Instruction Syntax</th></tr></thead><tbody><tr><td>define function</td><td><code>func [{name}] {parameters} {return-type} {body}</code></td></tr><tr><td>define a function parameter</td><td><code>param {name} {type}</code></td></tr><tr><td>define a function return type</td><td><code>result {type}</code></td></tr><tr><td>export function to make it available in JS</td><td><code>export {js-name} (func {name})</code></td></tr><tr><td>call function</td><td><code>call {fn-name}</code></td></tr><tr><td>declare local variable</td><td><code>local {name} {type}</code> (cannot initialize)</td></tr><tr><td>set local variable</td><td><code>local.set {name} {value}</code></td></tr><tr><td>get local variable</td><td><code>local.get {name}</code></td></tr><tr><td>declare global variable</td><td><code>global {name} {type} [{value}]</code> (can initialize)</td></tr><tr><td>set global variable</td><td><code>global.set {name} {value}</code> (must be mutable)</td></tr><tr><td>get global variable</td><td><code>global.get {name}</code></td></tr><tr><td>conditional logic</td><td><code>if (result {type}) {condition} (then {body}) (else {body}))</code></td></tr><tr><td>select value based on condition</td><td><code>select {non-zero-value} {zero-value} {condition}</code></td></tr><tr><td>define a block</td><td><code>block {body}</code></td></tr><tr><td>loop</td><td><code>loop {body}</code> (defines a block)</td></tr><tr><td>break out of block</td><td><code>br {depth}</code></td></tr><tr><td>compare values</td><td>see &quot;Comparison Instructions&quot; below</td></tr><tr><td>set data in linear memory</td><td><code>{type}.store{bits} {value}</code> (ex. <code>i32.store8</code>)</td></tr><tr><td>get data from linear memory</td><td><code>{type}.load{bits}</code> (ex. <code>i32.load8_u</code>)</td></tr><tr><td>grow linear memory</td><td><code>memory.grow {pages}</code></td></tr><tr><td>shrink linear memory?</td><td>not currently supported, but being discussed (1)</td></tr></tbody></table><p>(1) <a href="https://github.com/WebAssembly/design/issues/1397?v=1.0.10" rel="noopener" target="_blank">memory management issue</a></p><p>The tables below summarize the currently supported WASM instructions. Understanding these is only necessary when directly writing WASM code in text format or to understand what compilers for higher level languages like Rust generate.</p><p>For more detail, see the <a href="https://github.com/sunfishcode/wasm-reference-manual/blob/master/WebAssembly.md?v=1.0.10" rel="noopener" target="_blank">WASM Reference Manual</a>.</p><p>The tables below use the following abbreviations for substitutions in instruction names:</p><ul><li><code>mm</code> and <code>nn</code> can be <code>32</code> bits or <code>64</code> bits</li><li><code>sx</code> can be <code>u</code> (unsigned) or <code>s</code> (signed)</li></ul><p>As mentioned earlier, there is no instruction for duplicating the top value on the stack. Adding this has been proposed. Thomas Lively provided rationale on why this has not been done.</p><blockquote><blockquote><blockquote><p>&quot;It takes a surprising amount of work and time to spec new instructions and get them implemented in every tool and engine out there. So generally only changes with significant benefits get all the way through the process. Unfortunately that means that there are a lot of &quot;nice to have&quot; proposals, even tiny ones like adding a single dup instruction, that don't make the cut. I'm not saying we'll never add dup, but if we do it will because it solves an important problem so lots of folks agree it's important to add and will be motivated to implement and maintain it throughout the ecosystem.</p><p>This is one of the costs of standards-based work. If WASM were controlled by a single party, it would be easy to add a single instruction like dup. Since it's not, you first have to get a lot of different people with different priorities and opinions to agree that adding dup is both a good idea and worth their time and effort. Because of this extra consensus-building work, the community can have more confidence in the robustness and benefits of the proposals that do make it through the process.&quot;</p></blockquote></blockquote></blockquote><p>Many WASM instruction names follow the format <code>{kind-of-thing}.{operation}</code> where kinds of things include:</p><ul><li>variables: <code>local</code> and <code>global</code></li><li>integers: <code>i32</code> and <code>i64</code></li><li>floating point numbers: <code>f32</code> and <code>f64</code></li></ul><p>Some kind-specific operations include:</p><ul><li><code>get</code> and <code>set</code> to get and set the value of a variable</li><li><code>const</code> to place the value of a constant on the stack</li><li><code>store</code> and <code>load</code> to copy data into memory and retrieve it</li></ul><p>WASM instructions get their arguments from literal values specified after the instruction (referred to as &quot;static immediate arguments&quot;) and/or from the stack (referred to as &quot;dynamic operands&quot;). Some instructions use only one of these sources, while others use both. The columns in the tables below include the following columns to provide this information for each instruction:</p><ul><li>I: number of immediate arguments</li><li>Si: number of arguments popped from the stack (input)</li><li>So: number of values pushed onto the stack (output)</li></ul><h3 id="variable-instructions">Variable Instructions</h3><p>Global variables are declared at the module level, not inside functions. They are immutable by default. To declare a global variable to be mutable, specify its type as <code>(mut {type})</code>.</p><p>Local variables are declared inside functions and the declarations must appear at the beginning of the function before any other instructions. Local variables cannot be initialized when they are declared, so they are always mutable.</p><p>The instructions in the table below declare, get, and set local and global variables.</p><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>local</code></td><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>declares a local variable name and type</td></tr><tr><td><code>local.get</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>push local variable onto stack</td></tr><tr><td><code>local.set</code></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>set local variable from stack and pop</td></tr><tr><td><code>local.tee</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>set local variable from stack and leave on stack</td></tr><tr><td><code>global</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>declares a global variable name, type, and initial value</td></tr><tr><td><code>global.get</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>push global variable onto stack</td></tr><tr><td><code>global.set</code></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>set global variable from stack and pop</td></tr></tbody></table><p>The two immediate arguments of the <code>local</code> instruction are its name and type. Local variables default to zero and cannot be initialized to a different value. See the <code>$l1</code> example below.</p><p>Older code examples use the deprecated names <code>get_local</code>, <code>set_local</code>, <code>tee_local</code>, <code>get_global</code>, and <code>set_global</code>.</p><p>All of these instructions take an immediate argument that identifies the variable on which to operate by index or name. The <code>set</code> instructions get the new value from the stack.</p><p>The file <code>demo.wat</code> below demonstrates of using these instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token comment">;; Import a global variable named gFromJS from JavaScript,</span><br>  <span class="token comment">;; give it the WASM name $g_from_js,</span><br>  <span class="token comment">;; and declare it to hold an immutable i32 value.</span><br>  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$g_from_js</span> <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"gFromJS"</span><span class="token punctuation">)</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; Define a global variable named $g_here that</span><br>  <span class="token comment">;; holds a mutable i32 value and is initialized to 19.</span><br>  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$g_here</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; Define a function that has no parameters and returns a f64 value and</span><br>  <span class="token comment">;; export it with the name "demo" so it can be called from JavaScript.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"demo"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token comment">;; Define a local variable named $l1 that holds a f64 value.</span><br>    <span class="token comment">;; The value cannot be initialized in this instruction.</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$l1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token comment">;; Set the local variable to 3.14.</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$l1</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token comment">;; Get the value of $l1, placing it on the stack.</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$l1</span><br><br>    <span class="token comment">;; Do it again so two copies are on the stack.</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$l1</span><br><br>    <span class="token comment">;; Multiply $l1 by itself and place the f64 result on the stack.</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token comment">;; Add 1 to $g_here so the value becomes 20.</span><br>    <span class="token punctuation">(</span><span class="token keyword">global</span>.set <span class="token variable">$g_here</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$g_here</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token comment">;; Get the value of $g_here, placing it on the stack.</span><br>    <span class="token keyword">global</span>.get <span class="token variable">$g_here</span><br><br>    <span class="token comment">;; Convert the i32 value to f64.</span><br>    <span class="token keyword">f64</span>.convert_i32_s<br><br>    <span class="token comment">;; Add $g_here to the previous result from f64.mul.</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br><br>    <span class="token comment">;; Get the value of $g_from_js.</span><br>    <span class="token keyword">global</span>.get <span class="token variable">$g_from_js</span><br><br>    <span class="token comment">;; Convert the i32 value to f64.</span><br>    <span class="token keyword">f64</span>.convert_i32_s<br><br>    <span class="token comment">;; Add $g_from_js to the previous result and</span><br>    <span class="token comment">;; use this as the return value of the function.</span><br>    <span class="token comment">;; The result is 3.14 * 3.14 + (19 + 1) + 20 = 49.8596.</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {<br>    js: {<br>      gFromJS: new WebAssembly.Global<span class="token punctuation">(</span>{value: '<span class="token keyword">i32</span>'}, <span class="token number">20</span><span class="token punctuation">)</span>,<br>    }<br>  };<br><br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {demo} = m.instance.exports;<br>  console.log<span class="token punctuation">(</span>'<span class="token keyword">result</span> =', demo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>;<br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>### Numeric Instructions<br><br>These instructions are prefixed by one of the four supported number types.<br>For example, the instruction to add two `<span class="token keyword">f32</span>` values is `<span class="token keyword">f32<span class="token punctuation">.</span>add</span>`.<br><br>| Name       |  I  | Si  | So  | Description                     |<br>| ---------- | :-: | :-: | :-: | ------------------------------- |<br>| `abs`      |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | absolute value                  |<br>| `add`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | add                             |<br>| `ceil`     |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | ceiling                         |<br>| `copysign` |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | copy sign                       |<br>| `div_{sx}` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | integer divide                  |<br>| `div`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | floating point divide           |<br>| `floor`    |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | floor                           |<br>| `max`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | maximum                         |<br>| `min`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | minimum                         |<br>| `mul`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | multiply                        |<br>| `ne`       |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | not equal                       |<br>| `nearest`  |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | round floating point to integer |<br>| `neg`      |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | negate                          |<br>| `rem_{sx}` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | remainder                       |<br>| `sqrt`     |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | square root                     |<br>| `sub`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">1</span>  | subtract                        |<br>| `trunc`    |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | truncate                        |<br><br>We saw examples of using the `add` and `mul` instructions<br>in the <span class="token string">"Variable Instructions"</span> section.<br><br>All of these instructions require a <span class="token keyword">type</span> prefix.<br>For example, `<span class="token keyword">f64<span class="token punctuation">.</span>max</span>` is used in the file `demo.wat` below<br>which demonstrates using some of these instructions.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"max"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>max</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"min"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>min</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {};<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {max, min} = m.instance.exports;<br><br>  const pi = Math.PI; // <span class="token number">3.14159</span><br>  const e = Math.E; // <span class="token number">2.71828</span><br><br>  console.log<span class="token punctuation">(</span>max<span class="token punctuation">(</span>pi, e<span class="token punctuation">)</span><span class="token punctuation">)</span>; // pi<br>  console.log<span class="token punctuation">(</span>max<span class="token punctuation">(</span>e, pi<span class="token punctuation">)</span><span class="token punctuation">)</span>; // pi<br>  console.log<span class="token punctuation">(</span>min<span class="token punctuation">(</span>pi, e<span class="token punctuation">)</span><span class="token punctuation">)</span>; // e<br>  console.log<span class="token punctuation">(</span>min<span class="token punctuation">(</span>e, pi<span class="token punctuation">)</span><span class="token punctuation">)</span>; // e<br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>Many math functions, such as `sin`, `cos`, `tan`, and `log` are missing in WASM.<br>One way to get these is to <span class="token keyword">import</span> them from JavaScript as shown below.<br><br>The file `demo.js` below provides math functions to `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {<br>    js: {<br>      sin: Math.sin,<br>      cos: Math.cos,<br>      tan: Math.tan,<br>      log: Math.log<br>    }<br>  };<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {demo} = m.instance.exports;<br>  console.log<span class="token punctuation">(</span>'<span class="token keyword">result</span> =', demo<span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">0.811529</span><br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>The file `demo.wat` below demonstrates using functions imported from JavaScript.<br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token comment">;; This shows describing a function signature inline.</span><br>  <span class="token comment">;;(import "js" "sin" (func $sin (param f64) (result f64)))</span><br><br>  <span class="token comment">;; This shows assigning a name to a function signature</span><br>  <span class="token comment">;; and reusing it.</span><br>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"sin"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sin</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"cos"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$cos</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"tan"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$tan</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This returns log(sin($radians) + cos($radians) + tan($radians)).</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"demo"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$radians</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$sin</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$radians</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$cos</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$radians</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>    <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$tan</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$radians</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>    <span class="token keyword">call</span> <span class="token variable">$log</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>### Bitwise Instructions<br><br>| Name       |  I  | Si  | So  | Description                    |<br>| ---------- | :-: | :-: | :-: | ------------------------------ |<br>| `clz`      |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | count leading zeros            |<br>| `ctz`      |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | count trailing zeros           |<br>| `popcnt`   |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | population count <span class="token punctuation">(</span># of <span class="token number">1</span> bits<span class="token punctuation">)</span> |<br>| `rotl`     |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | rotate left                    |<br>| `rotr`     |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | rotate right                   |<br>| `shl`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | shift left                     |<br>| `shr_{sx}` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | shift right                    |<br><br>All of these instructions require a <span class="token keyword">type</span> prefix.<br>For example, `<span class="token keyword">i32<span class="token punctuation">.</span>clz</span>` is used in the file `demo.wat` below<br>which demonstrates using some of these instructions.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"leadingZeros"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>clz</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"trailingZeros"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>ctz</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"population"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>popcnt</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"rotateLeft"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>rotl</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"rotateRight"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>rotr</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"shiftLeft"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"shiftRight"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token comment">;; shr_u is for unsigned.</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shr_u</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {};<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {<br>    leadingZeros,<br>    population,<br>    rotateLeft,<br>    rotateRight,<br>    shiftLeft,<br>    shiftRight,<br>    trailingZeros<br>  } = m.instance.exports;<br><br>  // <span class="token number">52</span> in one byte of binary is <span class="token number">00110100</span>.<br>  const value = <span class="token number">52</span>;<br><br>  // In four bytes there are <span class="token number">3</span>*<span class="token number">8</span> + <span class="token number">2</span> leading zeros.<br>  console.log<span class="token punctuation">(</span>'leading zeros =', leadingZeros<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">26</span><br>  console.log<span class="token punctuation">(</span>'trailing zeros =', trailingZeros<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">2</span><br>  console.log<span class="token punctuation">(</span>'population =', population<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">3</span> <span class="token number">1</span>-bits<br>  console.log<span class="token punctuation">(</span>'shiftRight =', shiftRight<span class="token punctuation">(</span>value, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">26</span><br>  console.log<span class="token punctuation">(</span>'shiftLeft =', shiftLeft<span class="token punctuation">(</span>value, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">104</span><br><br>  // Could use shiftRight here instead since no bits are wrapping around.<br>  console.log<span class="token punctuation">(</span>'rotateRight =', rotateRight<span class="token punctuation">(</span>value, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">13</span><br><br>  // Could use shiftLeft here instead since no bits are wrapping around.<br>  console.log<span class="token punctuation">(</span>'rotateLeft =', rotateLeft<span class="token punctuation">(</span>value, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">208</span><br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>### Logical Instructions<br><br>| Name  |  I  | Si  | So  | Description  |<br>| ----- | :-: | :-: | :-: | ------------ |<br>| `and` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | and          |<br>| `or`  |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | or           |<br>| `xor` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | exclusive or |<br><br>All of these instructions require a <span class="token keyword">type</span> prefix.<br>For example, `<span class="token keyword">i32<span class="token punctuation">.</span>and</span>` is used in the file `demo.wat` below<br>which demonstrates using some of these instructions.<br><br>The file `demo.wat` below demonstrates using each of these instructions.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"and"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>and</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"or"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>or</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"xor"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>xor</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {};<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {and, or, xor} = m.instance.exports;<br><br>  // <span class="token number">52</span> in one byte of binary is <span class="token number">00110100</span>.<br>  const v1 = <span class="token number">52</span>;<br><br>  // <span class="token number">21</span> in one byte of binary is <span class="token number">00010101</span>.<br>  const v2 = <span class="token number">21</span>;<br><br>  console.log<span class="token punctuation">(</span>'and =', and<span class="token punctuation">(</span>v1, v2<span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">00010100</span> = <span class="token number">20</span><br>  console.log<span class="token punctuation">(</span>'or =', or<span class="token punctuation">(</span>v1, v2<span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">00110101</span> = <span class="token number">53</span><br>  console.log<span class="token punctuation">(</span>'xor =', xor<span class="token punctuation">(</span>v1, v2<span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">00100001</span> = <span class="token number">33</span><br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>### Comparison Instructions<br><br>| Name      |  I  | Si  | So  | Description                          |<br>| --------- | :-: | :-: | :-: | ------------------------------------ |<br>| `eq`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | equal                                |<br>| `eqz`     |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | equal to zero                        |<br>| `ge_{sx}` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | integer greater than or equal        |<br>| `ge`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | floating point greater than or equal |<br>| `gt_{sx}` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | integer greater than                 |<br>| `gt`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | floating point greater than          |<br>| `le_{sx}` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | integer less than or equal           |<br>| `le`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | floating point less than or equal    |<br>| `lt_{sx}` |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | integer less than                    |<br>| `lt`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | floating point less than             |<br><br>All of these instructions require a <span class="token keyword">type</span> prefix.<br>For example, `<span class="token keyword">f64<span class="token punctuation">.</span>ge</span>` is used in the file `demo.wat` below<br>which demonstrates using some of these instructions.<br>We saw an easier way to implement these functions<br>in the <span class="token string">"Numeric Instructions"</span> section.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"max"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>ge</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"min"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>le</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {};<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {max, min} = m.instance.exports;<br><br>  const pi = Math.PI; // <span class="token number">3.14159</span><br>  const e = Math.E; // <span class="token number">2.71828</span><br><br>  console.log<span class="token punctuation">(</span>max<span class="token punctuation">(</span>pi, e<span class="token punctuation">)</span><span class="token punctuation">)</span>; // pi<br>  console.log<span class="token punctuation">(</span>max<span class="token punctuation">(</span>e, pi<span class="token punctuation">)</span><span class="token punctuation">)</span>; // pi<br>  console.log<span class="token punctuation">(</span>min<span class="token punctuation">(</span>pi, e<span class="token punctuation">)</span><span class="token punctuation">)</span>; // e<br>  console.log<span class="token punctuation">(</span>min<span class="token punctuation">(</span>e, pi<span class="token punctuation">)</span><span class="token punctuation">)</span>; // e<br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>### Conversion Instructions<br><br>| Name          |  I  | Si  | So  | Description                                                         |<br>| ------------- | :-: | :-: | :-: | ------------------------------------------------------------------- |<br>| `convert`     |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | convert integer to floating point                                   |<br>| `demote`      |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | convert <span class="token keyword">f64</span> to <span class="token keyword">f32</span>                                                  |<br>| `extend`      |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | convert <span class="token keyword">i32</span> to <span class="token keyword">i64</span>                                                  |<br>| `promote`     |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | convert <span class="token keyword">f32</span> to <span class="token keyword">f64</span>                                                  |<br>| `reinterpret` |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | convert from integer to floating point or floating point to integer |<br>| `trunc`       |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | truncate, discarding the least significant bits                     |<br>| `wrap`        |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | converts <span class="token keyword">i32</span> to <span class="token keyword">i64</span>, discarding the most significant bits           |<br><br>All of these instructions require a <span class="token keyword">type</span> prefix.<br>We saw examples of using the `<span class="token keyword">f64</span>.convert_i32s` instruction<br>in the <span class="token string">"Variable Instructions"</span> section above.<br>The <span class="token keyword">type</span> prefix specifies the output <span class="token keyword">type</span> and the<br>instruction suffix <span class="token punctuation">(</span>`_32s` in this case<span class="token punctuation">)</span> specifies the input <span class="token keyword">type</span>.<br><br>### Control Instructions<br><br>These instructions are expressions, not statements.<br>They <span class="token keyword">result</span> in placing a value on the stack.<br><br>| Name                               |  I  | Si  | So  | Description                                                                    |<br>| ---------------------------------- | :-: | :-: | :-: | ------------------------------------------------------------------------------ |<br>| `<span class="token keyword">block</span> [{name}]`                   |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | creates a group of instructions                                                |<br>| `<span class="token keyword">loop</span> [{name}]`                    |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | creates a special <span class="token keyword">block</span> for implementing a <span class="token keyword">loop</span>                                |<br>| `<span class="token keyword">if</span> {condition}`                   |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | creates a conditional with at `<span class="token keyword">then</span>` part and an optional `<span class="token keyword">else</span>` part          |<br>| `<span class="token keyword">then</span>`                             |  <span class="token number">0</span>  |  <span class="token number">0</span>  |  <span class="token number">0</span>  | denotes the false <span class="token keyword">block</span> of a conditional                                       |<br>| `<span class="token keyword">else</span>`                             |  <span class="token number">0</span>  |  <span class="token number">0</span>  |  <span class="token number">0</span>  | denotes the false <span class="token keyword">block</span> of a conditional                                       |<br>| `<span class="token keyword">end</span>`                              |  <span class="token number">0</span>  |  <span class="token number">0</span>  |  <span class="token number">0</span>  | marks the <span class="token keyword">end</span> of a <span class="token keyword">block</span> for `<span class="token keyword">block</span>`, `<span class="token keyword">if</span>`, `<span class="token keyword">else</span>`, `<span class="token keyword">loop</span>`, or `function`      |<br>| `<span class="token keyword">br</span> {depth}`                       |  <span class="token number">1</span>  |  <span class="token number">0</span>  |  <span class="token number">0</span>  | unconditional branch                                                           |<br>| `<span class="token keyword">br_if</span> {depth} {condition}`        |  <span class="token number">1</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | conditional branch                                                             |<br>| `<span class="token keyword">br_table</span> {list-of-depths}`        |  <span class="token number">2</span>+ |  <span class="token number">1</span>  |  <span class="token number">0</span>  | branch to a depth from a list of them based on the index at the top of the stack |<br>| `<span class="token keyword">return</span>`                           |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">0</span>  | <span class="token keyword">return</span> from function, optionally specifying a <span class="token keyword">return</span> value                     |<br>| `<span class="token keyword">unreachable</span>`                      |  <span class="token number">0</span>  |  <span class="token number">0</span>  |  <span class="token number">0</span>  | signals an error <span class="token punctuation">(</span>trap<span class="token punctuation">)</span> <span class="token keyword">if</span> reached                                             |<br><br>Even control flow instructions operate on the stack.<br>For example, the `<span class="token keyword">if</span>` instruction executes its branch<br><span class="token keyword">if</span> the value at the top of the stack evaluates to true.<br><br>The `<span class="token keyword">block</span>` instruction creates the equivalent of<br>an immediately invoked inline function.<br>It has a <span class="token keyword">result</span> <span class="token keyword">type</span> and a set of instructions.<br>When in a `<span class="token keyword">block</span>`, branching to depth `<span class="token number">0</span>` exits the `<span class="token keyword">block</span>`.<br><br>The `<span class="token keyword">loop</span>` instruction creates a different kind of `<span class="token keyword">block</span>`<br>where branching to depth `<span class="token number">0</span>` goes to the beginning of the <span class="token keyword">loop</span><br>for another iteration rather than branching out of the <span class="token keyword">block</span>.<br><br>The `<span class="token keyword">block</span>` and `<span class="token keyword">loop</span>` instructions can specify a <span class="token keyword">block</span> name<br>that branch instructions can refer to instead of specifying a depth.<br><br>The file `demo.wat` below demonstrates using some of these instructions.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$factorial</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">if</span><br>      <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>le_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">else</span><br>        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$factorial</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; recursive</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"factorial"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$factorial</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"sumRange"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> $<span class="token keyword">start</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> $<span class="token keyword">end</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$sum</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$n</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">start</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">loop</span><br>      <span class="token comment">;; Add $n to $sum.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$sum</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$sum</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Add 1 to $n.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$n</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Go to top of the loop if $end not reached</span><br>      <span class="token comment">;; by branching to block level zero.</span><br>      <span class="token comment">;; Otherwise drop out of loop.</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>le_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$sum</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"blockWithoutResult"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> $<span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">block</span> <span class="token comment">;; This block has no result.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">result</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token comment">;; Inside a block, branching to depth zero exits the block.</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">result</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">result</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">result</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"blockWithResult"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">block</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token comment">;; This block has a result.</span><br>      <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><br>      <span class="token comment">;; Inside a block, branching to depth zero exits the block.</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; This is needed so there will only be one value</span><br>      <span class="token comment">;; on the stack at the end of this function.</span><br>      <span class="token keyword">drop</span><br>      <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; This is needed so there will only be one value</span><br>      <span class="token comment">;; on the stack at the end of this function.</span><br>      <span class="token keyword">drop</span><br>      <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"usingReturn"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {};<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {<br>    blockWithoutResult,<br>    blockWithResult,<br>    factorial,<br>    returnDemo,<br>    sumRange,<br>    usingReturn<br>  } = m.instance.exports;<br><br>  console.log<span class="token punctuation">(</span>factorial<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">1</span> * <span class="token number">2</span> * <span class="token number">3</span> = <span class="token number">6</span><br>  console.log<span class="token punctuation">(</span>factorial<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">1</span> * <span class="token number">2</span> * <span class="token number">3</span> * <span class="token number">4</span> * <span class="token number">5</span> = <span class="token number">120</span><br><br>  console.log<span class="token punctuation">(</span>sumRange<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">3</span> + <span class="token number">4</span> + <span class="token number">5</span> + <span class="token number">6</span> = <span class="token number">18</span><br><br>  console.log<span class="token punctuation">(</span>blockWithoutResult<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">1</span><br>  console.log<span class="token punctuation">(</span>blockWithoutResult<span class="token punctuation">(</span><span class="token number">142</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">2</span><br>  console.log<span class="token punctuation">(</span>blockWithoutResult<span class="token punctuation">(</span><span class="token number">728</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">3</span><br><br>  console.log<span class="token punctuation">(</span>blockWithResult<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">1</span><br>  console.log<span class="token punctuation">(</span>blockWithResult<span class="token punctuation">(</span><span class="token number">142</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">2</span><br>  console.log<span class="token punctuation">(</span>blockWithResult<span class="token punctuation">(</span><span class="token number">728</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">3</span><br><br>  console.log<span class="token punctuation">(</span>usingReturn<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">1</span><br>  console.log<span class="token punctuation">(</span>usingReturn<span class="token punctuation">(</span><span class="token number">142</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">2</span><br>  console.log<span class="token punctuation">(</span>usingReturn<span class="token punctuation">(</span><span class="token number">728</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">3</span><br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>### Memory Instructions<br><br>WASM <span class="token keyword">memory</span> is a contiguous array of bytes.<br>When it is allocated, it is given an initial size in pages <span class="token punctuation">(</span><span class="token number">64</span> KB each<span class="token punctuation">)</span><br>and optionally a maximum size which cannot exceed <span class="token number">4</span> GB.<br>The allocated size can be increased later using the `<span class="token keyword">memory<span class="token punctuation">.</span>grow</span>` instruction<br>up to the maximum size.<br><br>Each WASM <span class="token keyword">module</span> can have only one array of linear <span class="token keyword">memory</span>.<br>But JavaScript can instantiate more than one WASM <span class="token keyword">module</span><br>in order to access multiple instances of linear <span class="token keyword">memory</span>.<br><br>The `load` instructions load <span class="token keyword">data</span> from the default linear <span class="token keyword">memory</span>.<br>The `store` instructions store <span class="token keyword">data</span> into the default linear <span class="token keyword">memory</span>.<br>These instructions are prefixed by the number <span class="token keyword">type</span> to be loaded or stored.<br>In the <span class="token keyword">table</span> below, `mem` is a <span class="token keyword">memory</span> <span class="token keyword">offset</span>.<br><br>| Name                      |  I  | Si  | So  | Description                                    |<br>| ------------------------- | :-: | :-: | :-: | ---------------------------------------------- |<br>| `i{nn}.load {mem}`        |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | reads integer value into matching size         |<br>| `i{nn}.load8_{sx} {mem}`  |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | reads integer value into <span class="token number">8</span> bits                |<br>| `i{nn}.load16_{sx} {mem}` |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | reads integer value into <span class="token number">16</span> bits               |<br>| `<span class="token keyword">i64</span>.load32_{sx} {mem}`   |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | reads <span class="token keyword">i64</span> value into <span class="token number">32</span> bits                   |<br>| `f{nn}.load {mem}`        |  <span class="token number">0</span>  |  <span class="token number">1</span>  |  <span class="token number">1</span>  | reads floating point value                     |<br>| `i{nn}.store {mem}`       |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | writes integer value into matching size        |<br>| `i{nn}.store8 {mem}`      |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | writes integer value into <span class="token number">8</span> bits               |<br>| `i{nn}.store16 {mem}`     |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | writes integer value into <span class="token number">16</span> bits              |<br>| `<span class="token keyword">i64<span class="token punctuation">.</span>store32</span> {mem}`       |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | writes <span class="token keyword">i64</span> value into <span class="token number">32</span> bits                  |<br>| `f{nn}.store {mem}`       |  <span class="token number">0</span>  |  <span class="token number">2</span>  |  <span class="token number">0</span>  | writes floating point value into matching size |<br>| `<span class="token keyword">memory</span> {initial-pages} [{max-pages}]` | <span class="token number">1</span>|<span class="token number">2</span> |  <span class="token number">0</span>  |  <span class="token number">0</span>  | allocates linear <span class="token keyword">memory</span>                           |<br>| `<span class="token keyword">memory<span class="token punctuation">.</span>grow</span>`             |  <span class="token number">1</span>  |  <span class="token number">0</span>  |  <span class="token number">1</span>  | increases size of linear <span class="token keyword">memory</span> in pages and returns previous size |<br>| `<span class="token keyword">memory<span class="token punctuation">.</span>size</span>`             |  <span class="token number">0</span>  |  <span class="token number">0</span>  |  <span class="token number">1</span>  | returns the size of default linear <span class="token keyword">memory</span>      |<br><br>The file `demo.wat` below demonstrates using some of these instructions.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"myMemory"</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">;; initial size 1 page; maximum not specified</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$translate</span> <span class="token punctuation">(</span><span class="token keyword">param</span> $<span class="token keyword">offset</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$delta</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>store</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>load</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$delta</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"translatePoints"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$length</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$dx</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$dy</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> $<span class="token keyword">offset</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token comment">;; starts at zero</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$lastOffset</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$lastOffset</span><br>      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>mul</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token comment">;; number of points</span><br>        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">;; 8 bytes for x + 8 bytes for y</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">loop</span><br>      <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$translate</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Advance $offset to get next y value.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">offset</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Translate y value by $dy.</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>store</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>          <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>load</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br><br>      <span class="token comment">;; Advance $offset to get next x value.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">offset</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$lastOffset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {};<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {myMemory, translatePoints} = m.instance.exports;<br><br>  const points = [<br>    {x: <span class="token number">1.2</span>, y: <span class="token number">2.3</span>},<br>    {x: <span class="token number">3.4</span>, y: <span class="token number">4.5</span>},<br>    {x: <span class="token number">5.6</span>, y: <span class="token number">6.7</span>}<br>  ];<br><br>  // Copy the point <span class="token keyword">data</span> into linear <span class="token keyword">memory</span> shared with WASM code.<br>  const <span class="token keyword">offset</span> = <span class="token number">0</span>;<br>  const length = points.length * <span class="token number">2</span>;<br>  const array = new Float64Array<span class="token punctuation">(</span>myMemory.buffer, <span class="token keyword">offset</span>, length<span class="token punctuation">)</span>;<br>  let index = <span class="token number">0</span>;<br>  for <span class="token punctuation">(</span>const point of points<span class="token punctuation">)</span> {<br>    array[index++] = point.x;<br>    array[index++] = point.y;<br>  }<br><br>  console.log<span class="token punctuation">(</span>'untranslated points =', array<span class="token punctuation">)</span>;<br>  translatePoints<span class="token punctuation">(</span>points.length, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">)</span>;<br>  console.log<span class="token punctuation">(</span>'translated points =', array<span class="token punctuation">)</span>;<br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>### Other Instructions<br><br>| Name            |  I  | Si  | So  | Description                                                            |<br>| --------------- | :-: | :-: | :-: | ---------------------------------------------------------------------- |<br>| `<span class="token keyword">call</span>`          |  <span class="token number">1</span>  |  *  |  <span class="token number">1</span>  | calls a function                                                       |<br>| `<span class="token keyword">call_indirect</span>` |  <span class="token number">0</span>  |  *  |  <span class="token number">1</span>  | calls a function at an index in the default <span class="token keyword">table</span>                      |<br>| `const`         |  <span class="token number">1</span>  |  <span class="token number">0</span>  |  <span class="token number">1</span>  | pushes a constant value onto the stack                                 |<br>| `<span class="token keyword">drop</span>`          |  <span class="token number">0</span>  |  <span class="token number">0</span>  |  <span class="token number">0</span>  | pops top value from stack and does nothing with it                     |<br>| `<span class="token keyword">nop</span>`           |  <span class="token number">0</span>  |  <span class="token number">0</span>  |  <span class="token number">0</span>  | no operation                                                           |<br>| `<span class="token keyword">select</span>`        |  <span class="token number">0</span>  |  <span class="token number">3</span>  |  <span class="token number">1</span>  | takes two values and a condition; returns 1st <span class="token keyword">if</span> true and 2nd <span class="token keyword">if</span> false |<br><br>The number of stack values used by `<span class="token keyword">call</span>` and `<span class="token keyword">call_indirect</span>` matches<br>the number of parameters in the signature of the function being called.<br><br>We saw an example of using the `<span class="token keyword">call</span>` instruction in the<br>`factorial` function defined in the <span class="token string">"Control Instructions"</span> section.<br><br>We have seen many examples of using the `const` instruction<br>to push a constant value onto the stack.<br><br>We saw an example of using the `<span class="token keyword">drop</span>` instruction<br>in the `blockWithResult` function<br>defined in the <span class="token string">"Control Instructions"</span> section.<br><br>We saw an example of using the `<span class="token keyword">select</span>` instruction<br>in the `max` and `min` functions<br>defined in the <span class="token string">"Comparison Instructions"</span> section.<br><br>The `<span class="token keyword">call_indirect</span>` instruction is used in the file `demo.wat` below.<br>It works in conjunction with the `<span class="token keyword">table</span>` and `<span class="token keyword">elem</span>` instructions.<br><br>```wasm<br><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$double</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$half</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>div</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$triple</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token comment">;; Create a table of function references named $transforms</span><br>  <span class="token comment">;; that holds at most three elements.</span><br>  <span class="token comment">;; Note that this is at the module level, not inside a function.</span><br>  <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token variable">$transforms</span> <span class="token number">3</span> funcref<span class="token punctuation">)</span><br><br>  <span class="token comment">;; Set elements in the table starting at offset zero.</span><br>  <span class="token comment">;; Note that this is at the module level, not inside a function.</span><br>  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token variable">$half</span> <span class="token variable">$double</span> <span class="token variable">$triple</span><span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"transform"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$fnIndex</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$fnIndex</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br>```<br><br>Compile this file to `demo.wasm` by entering `wat2wasm demo.wat`.<br><br>The file `demo.js` below uses `demo.wasm`.<br><br>```js<br>async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>  const imports = {};<br>  const m = await WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'demo.wasm'<span class="token punctuation">)</span>, imports<span class="token punctuation">)</span>;<br>  const {transform} = m.instance.exports;<br><br>  const n = <span class="token number">3.14</span>;<br>  console.log<span class="token punctuation">(</span>'half =', transform<span class="token punctuation">(</span>n, <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // using <span class="token variable">$half</span> function; <span class="token number">1.57</span><br>  console.log<span class="token punctuation">(</span>'double =', transform<span class="token punctuation">(</span>n, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // using <span class="token variable">$double</span> function; <span class="token number">6.28</span><br>  console.log<span class="token punctuation">(</span>'triple =', transform<span class="token punctuation">(</span>n, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // using <span class="token variable">$triple</span> function; <span class="token number">9.42</span><br>}<br><br>run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>```<br><br>## Higher Level Languages<br><br>Code from many programming languages can be compiled to WASM.<br>Currently full support is only available for C, C++, and Rust.<br>Experimental support is available for C#, Go, Java, Kotlin, Python,<br>Swift, TypeScript, and a few other less commonly used languages.<br><br>In order to run WASM code that was compiled from another language,<br>the runtime of the language must be included.<br>Rust is a great choice for targeting WASM because it has a very small runtime<br>compared to options like Python, so it loads faster.<br>One reason Rust is able to ship a small runtime is that<br>it does not need to include code to perform garbage collection.<br><br>A reason to prefer Rust over languages like C and C++<br>is that the Rust compiler makes certain kinds of error impossible,<br>such as those related to <span class="token keyword">memory</span> management and access.<br><br>Tools for compiling Rust code to WebAssembly include<br>&lt;a href=<span class="token string">"https://rustwasm.github.io/wasm-pack/?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>wasm-pack&lt;/a> and<br>&lt;a href=<span class="token string">"https://www.secondstate.io/articles/ssvmup/?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>ssvmup&lt;/a><br>The ssvmup tool was inspired by wasm-pack and has explicit support for Deno.<br>Also see the support for Rust in the<br>&lt;a href=<span class="token string">"https://parceljs.org/rust.html?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>Parcel bundler&lt;/a>!<br><br>## Rust With Numbers<br><br>Rust functions that only use numbers<br>can be compiled to WASM and called from JavaScript<br>without using tools like wasm-pack or wasm-bindgen.<br><br>Let's implement the same `sum` and `distance` functions<br>we saw earlier, but do so using Rust instead of WAT.<br>Where are the steps assuming Rust has already been installed.<br><br><span class="token number">1</span>. `cargo new --lib rust-math`<br><br><span class="token number">1</span>. Edit `Cargo.toml` and add the following:<br><br>   ```toml<br>   [lib]<br>   crate-<span class="token keyword">type</span> = ['cdylib']<br>   ```<br><br><span class="token number">1</span>. Edit `src/lib.rs` and change the contents to the following:<br><br>   ```rust<br>   #[no_mangle]<br>   pub fn sum<span class="token punctuation">(</span>n1: <span class="token keyword">f64</span>, n2: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span> {<br>       n1 + n2<br>   }<br><br>   #[no_mangle]<br>   pub fn distance<span class="token punctuation">(</span>x1: <span class="token keyword">f64</span>, y1: <span class="token keyword">f64</span>, x2: <span class="token keyword">f64</span>, y2: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span> {<br>       <span class="token punctuation">(</span><span class="token punctuation">(</span>x1 - x2<span class="token punctuation">)</span>.powi<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> + <span class="token punctuation">(</span>y1 - y2<span class="token punctuation">)</span>.powi<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>.sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span><br>   }<br>   ```<br><br><span class="token number">1</span>. To generate a `.wasm` file from the Rust code,<br>   enter `cargo build --target wasm32-unknown-unknown`<br><br><span class="token number">1</span>. To install the `wasm-nm` tool for<br>   listing the symbols exported by a `.wasm` file,<br>   enter `cargo install wasm-nm`<br>   The symbols `sum` and `distance` will be output with an <span class="token string">"e"</span><br>   in front of them for <span class="token string">"export"</span>.<br><br><span class="token number">1</span>. To see the exported symbols,<br>   enter `wasm-nm target/wasm32-unknown-unknown/debug/rust_math.wasm`<br><br><span class="token number">1</span>. Modify the `index.js` file created earlier to pass<br>   the file path of this `.wasm` file to the fetch function which is<br>   `rust-math/target/wasm32-unknown-unknown/debug/rust_math.wasm`.<br><br><span class="token number">1</span>. Start a <span class="token keyword">local</span> HTTP file server like before.<br><br><span class="token number">1</span>. Browse localhost:{port} where port is<br>   the port on which the <span class="token keyword">local</span> server is listening.<br><br><span class="token number">1</span>. Open the DevTools console to see the `console.log` output.<br>   There be an error message saying that `distance2` is not a function<br>   which is expected because the Rust code<br>   only defines the `sum` and `distance` functions.<br><br>## Calling JavaScript functions from Rust<br><br>WASM code written in a language other than JavaScript can <span class="token keyword">call</span> custom JavaScript functions.<br>Let's look at an example.<br><br><span class="token number">1</span>. Add the following at the beginning of `index.js`:<br><br>   ```js<br>   function cube<span class="token punctuation">(</span>n<span class="token punctuation">)</span> {<br>     <span class="token keyword">return</span> n ** <span class="token number">3</span>;<br>   }<br><br>   function square<span class="token punctuation">(</span>n<span class="token punctuation">)</span> {<br>     <span class="token keyword">return</span> n \* n;<br>   }<br><br>   const importObject = {env: {cube, square}};<br>   ```<br><br><span class="token number">1</span>. Pass `importObject` as the second argument to<br>   `WebAssembly.instantiateStreaming` as follows:<br><br>   ```js<br>   WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>wasmPath<span class="token punctuation">)</span>, importObject<span class="token punctuation">)</span>.<span class="token keyword">then</span><span class="token punctuation">(</span>m => {<br>   ```<br><br><span class="token number">1</span>. Define the function signatures in `rust_math/src/lib.rs` as follows:<br><br>   ```rust<br>   extern <span class="token string">"C"</span> {<br>     fn cube<span class="token punctuation">(</span>n: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span>;<br>     fn square<span class="token punctuation">(</span>n: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span>;<br>   }<br>   ```<br><br><span class="token number">1</span>. Call these functions like normal Rust functions,<br>   but <span class="token keyword">call</span> them inside an `unsafe` <span class="token keyword">block</span> since<br>   the Rust compiler cannot guarantee that they are safe.<br>   For example:<br><br>   ```rust<br>   #[no_mangle]<br>   pub fn sum_of_square_and_cube<span class="token punctuation">(</span>n: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span> {<br>       let <span class="token keyword">result</span>;<br>       unsafe {<br>           <span class="token keyword">result</span> = square<span class="token punctuation">(</span>n<span class="token punctuation">)</span> + cube<span class="token punctuation">(</span>n<span class="token punctuation">)</span>;<br>       }<br>       <span class="token keyword">result</span><br>   }<br>   ```<br><br><span class="token number">1</span>. Rebuild the `.wasm` file by entering<br>   `cargo build --target wasm32-unknown-unknown`<br><br><span class="token number">1</span>. Verify the symbols that are imported by entering<br>   `wasm-nm target/wasm32-unknown-unknown/debug/rust_math.wasm`<br>   The symbols `cube` and `square` will be output with an <span class="token string">"i"</span><br>   in front of them for <span class="token string">"import"</span>.<br><br><span class="token number">1</span>. Start a <span class="token keyword">local</span> HTTP file server like before.<br><br><span class="token number">1</span>. Browse localhost:{port} where port is<br>   the port on which the <span class="token keyword">local</span> server is listening.<br><br><span class="token number">1</span>. Open the DevTools console to see the `console.log` output.<br><br>## Rust With More Types<br><br>The wasm-bindgen tool makes it possible to compile Rust functions<br>that use non-numeric types to WASM.<br>It also enables calling built-in JavaScript functions<br>such as `alert` and `console.log`.<br>wasm-bindgen provides a Rust library and a CLI tool.<br>The Rust library provides macros that generate the Rust code<br>required to serialize and deserialize Rust <span class="token keyword">data</span> types.<br>The CLI tool generates JavaScript code that wraps the WASM code as an ES <span class="token keyword">module</span><br>which makes it easier to consume in a web app.<br><br>Let's implement an example where non-numeric types are<br>passed from JavaScript to Rust functions and non-numeric types are returned.<br><br>The wasm-pack CLI tool makes using wasm-bindgen easier,<br>so we will also use that. This tool:<br><br>- It executes a Cargo command to compile Rust code to WASM.<br>- It calls wasm-bindgen to generate an ES <span class="token keyword">module</span><br>  that wraps usage of the WASM code.<br>- It can invoke the wasm-opt tool to optimize the WASM code.<br>- It can generate a `package.json` file needed to<br>  deploy the ES <span class="token keyword">module</span> and WASM code as an npm package.<br>- It generates TypeScript <span class="token keyword">type</span> definitions<br>  for the exported functions and types in a `.d.ts` file<br>  that can be used by calling TypeScript code to provide <span class="token keyword">type</span> checking.<br><br><span class="token number">1</span>. Install wasm-pack by entering the following command:<br><br>   ```bash<br>   curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh<br>   ```<br><br><span class="token number">1</span>. Enter `cargo new --lib wasm-bindgen-demo`<br><br><span class="token number">1</span>. Enter `cd wasm-bindgen-demo`.<br><br><span class="token number">1</span>. Edit `Cargo.toml` and add the following dependency.<br><br>   ```toml<br>   [lib]<br>   crate-<span class="token keyword">type</span> = ['cdylib']<br><br>   [dependencies]<br>   wasm-bindgen = <span class="token string">"0.2.70"</span><br>   ```<br><br><span class="token number">1</span>. Edit `src/lib.rs` and change the contents to the following:<br><br>   ```rust<br>   use wasm_bindgen::prelude::*;<br><br>   #[wasm_bindgen]<br>   extern <span class="token string">"C"</span> {<br>       fn alert<span class="token punctuation">(</span>s: &amp;str<span class="token punctuation">)</span>;<br><br>       #[wasm_bindgen<span class="token punctuation">(</span>js_namespace = console<span class="token punctuation">)</span>]<br>       pub fn log<span class="token punctuation">(</span>s: &amp;str<span class="token punctuation">)</span>;<br>   }<br><br>   // This makes functions define in JavaScript available in Rust.<br>   #[wasm_bindgen<span class="token punctuation">(</span>raw_module = <span class="token string">"/index.js"</span><span class="token punctuation">)</span>]<br>   extern <span class="token string">"C"</span> {<br>       fn cube<span class="token punctuation">(</span>n: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span>;<br>       fn square<span class="token punctuation">(</span>n: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span>;<br>   }<br><br><br>   #[wasm_bindgen]<br>   pub fn greet<span class="token punctuation">(</span>name: &amp;str<span class="token punctuation">)</span> {<br>       log<span class="token punctuation">(</span>&amp;format!<span class="token punctuation">(</span><span class="token string">"Hello, {}!"</span>, name<span class="token punctuation">)</span><span class="token punctuation">)</span>;<br>   }<br><br>   #[wasm_bindgen]<br>   #[derive<span class="token punctuation">(</span>Debug<span class="token punctuation">)</span>]<br>   pub struct Color {<br>       pub red: u8,<br>       pub green: u8,<br>       pub blue: u8,<br>   }<br><br>   #[wasm_bindgen<span class="token punctuation">(</span>js_name = getColor<span class="token punctuation">)</span>]<br>   pub fn get_color<span class="token punctuation">(</span><span class="token punctuation">)</span> -> Color {<br>       let color = Color {<br>           red: <span class="token number">1</span>,<br>           green: <span class="token number">2</span>,<br>           blue: <span class="token number">3</span>,<br>       };<br>       log<span class="token punctuation">(</span>&amp;format!<span class="token punctuation">(</span><span class="token string">"color = {:?}"</span>, color<span class="token punctuation">)</span><span class="token punctuation">)</span>;<br>       color<br>   }<br><br>   #[wasm_bindgen<span class="token punctuation">(</span>js_name = getPowers<span class="token punctuation">)</span>]<br>   pub fn get_powers<span class="token punctuation">(</span>n: u32<span class="token punctuation">)</span> -> Vec&lt;u32> {<br>       alert<span class="token punctuation">(</span>&amp;format!<span class="token punctuation">(</span><span class="token string">"Getting powers of {} ..."</span>, n<span class="token punctuation">)</span><span class="token punctuation">)</span>;<br>       vec![n, n.pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>, n.pow<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>]<br>   }<br><br><br>   // This Rust function calls custom JavaScript functions.<br>   #[wasm_bindgen<span class="token punctuation">(</span>js_name = sumOfSquareAndCube<span class="token punctuation">)</span>]<br>   pub fn sum_of_square_and_cube<span class="token punctuation">(</span>n: <span class="token keyword">f64</span><span class="token punctuation">)</span> -> <span class="token keyword">f64</span> {<br>       square<span class="token punctuation">(</span>n<span class="token punctuation">)</span> * cube<span class="token punctuation">(</span>n<span class="token punctuation">)</span><br>   }<br>   ```<br><br><span class="token number">1</span>. Enter `wasm-pack build --dev --target web`<br><br><span class="token number">1</span>. Create `index.js` with the following content:<br><br>   ```js<br>   <span class="token keyword">import</span> init, {<br>     Color,<br>     getColor,<br>     getPowers,<br>     greet<br>   } from './pkg/wasm_bindgen_demo.js';<br><br>   <span class="token keyword">export</span> function square<span class="token punctuation">(</span>n<span class="token punctuation">)</span> {<br>     <span class="token keyword">return</span> n * n;<br>   }<br><br>   <span class="token keyword">export</span> function cube<span class="token punctuation">(</span>n<span class="token punctuation">)</span> {<br>     <span class="token keyword">return</span> n ** <span class="token number">3</span>;<br>   }<br><br>   async function run<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>     await init<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>     greet<span class="token punctuation">(</span>'World'<span class="token punctuation">)</span>;<br><br>     const color = getColor<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>     console.log<span class="token punctuation">(</span>'color =', color<span class="token punctuation">)</span>;<br>     console.log<span class="token punctuation">(</span>'color instanceof Color?', color instanceof Color<span class="token punctuation">)</span>; // true<br>     console.log<span class="token punctuation">(</span>'color.red =', color.red<span class="token punctuation">)</span>; // <span class="token number">1</span><br>     console.log<span class="token punctuation">(</span>'color.green =', color.green<span class="token punctuation">)</span>; // <span class="token number">2</span><br>     console.log<span class="token punctuation">(</span>'color.blue =', color.blue<span class="token punctuation">)</span>; // <span class="token number">3</span><br><br>     const powers = getPowers<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>; // a UIntArray<br>     console.log<span class="token punctuation">(</span>'powers =', powers<span class="token punctuation">)</span>; // [<span class="token number">3</span>, <span class="token number">9</span>, <span class="token number">27</span>]<br><br>     console.log<span class="token punctuation">(</span>'square + cube =', sumOfSquareAndCube<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token number">12</span><br>   }<br><br>   run<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>   ```<br><br><span class="token number">1</span>. Create `index.html` with the following content:<br><br>   ```html<br>   &lt;!DOCTYPE html><br>   &lt;html><br>     &lt;head><br>       &lt;script <span class="token keyword">type</span>=<span class="token string">"module"</span> src=<span class="token string">"index.js"</span>>&lt;/script><br>     &lt;/head><br>     &lt;body><br>       &lt;div>See the console.&lt;/div><br>     &lt;/body><br>   &lt;/html><br>   ```<br><br><span class="token number">1</span>. Start a <span class="token keyword">local</span> HTTP file server like before.<br><br><span class="token number">1</span>. Browse localhost:{port} where port is<br>   the port on which the <span class="token keyword">local</span> server is listening.<br><br><span class="token number">1</span>. Open the DevTools console to see the `console.log` output.<br><br>TODO: How can Rust <span class="token keyword">call</span> custom JavaScript functions when using wasm-bindgen<br>TODO: instead of `WebAssembly.instantiateStreaming`?<br>TODO: See https://rustwasm.github.io/docs/wasm-bindgen/examples/<span class="token keyword">import</span>-js.html!<br><br>## Linear Memory<br><br>TODO: Resume here<br><br><span class="token string">"Linear memory"</span> can be used to share <span class="token keyword">data</span> across programming languages<br>without the overhead of copying values.<br>Linear <span class="token keyword">memory</span> is also used by libraries such as wasm-bindgen<br>to enable passing non-numeric values to functions<br>and returning non-numeric values from them.<br><br>From &lt;a href=<span class="token string">"https://rustwasm.github.io/book/game-of-life/implementing.html?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>Implementing Conway's Game of Life&lt;/a>,<br><span class="token string">"As a general rule of thumb, a good JavaScript/WebAssembly interface design<br>is often one where large, long-lived data structures are implemented as<br>Rust types that live in the WebAssembly linear memory,<br>and are exposed to JavaScript as opaque handles.<br>JavaScript calls exported WebAssembly functions that take these opaque handles,<br>transform their data, perform heavy computations, query the data,<br>and ultimately return a small, copy-able result.<br>By only returning the small result of the computation,<br>we avoid copying and/or serializing everything back and forth between<br>the JavaScript garbage-collected heap and the WebAssembly linear memory."</span><br><br>To use this approach, WASM code allocates space and provides functions that<br><span class="token keyword">return</span> a pointer to the space and the size of the space.<br>Languages that wish to use the space <span class="token keyword">call</span> these functions<br>and map their own <span class="token keyword">data</span> to it.<br>For example, JavaScript code can create a typed array such as `Float64Array`<br>that uses the same space.<br>It can <span class="token keyword">then</span> set and get elements in the array to write and read<br>the linear <span class="token keyword">memory</span> that is available in the WASM code.<br>Note that it is not possible to allocate space outside the WASM code<br>and get WASM code to share it.<br><br>Let's walk through an example that demonstrates this.<br>The code is available in the GitHub repo &lt;a href=<span class="token string">"https://github.com/mvolkmann/wasm-rust-linear-memory?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>wasm-rust-linear-<span class="token keyword">memory</span>&lt;/a>.<br>TODO: Why did you need to use wasm-bindgen in this example<br>TODO: since it only uses numbers?<br><br>## Updating DOM from Rust<br><br>See https://github.com/mvolkmann/wasm-bind-demo/blob/main/src/lib.rs<br>which uses the web-sys crate.<br><br>## Parallel WASM<br><br>TODO: Show how to run multiple WASM functions in parallel in a web browser<br>TODO: using WebWorkers.<br><br>TODO: Can they update the same linear <span class="token keyword">memory</span> in order to divide a large task<br>TODO: like rotating points?<br><br>## WASM Binary Format<br><br>WASM binary files have the extension `.wasm`.<br>They begin with four bytes that identify the file as WASM.<br>The hex values are `0061736d` which is zero<br>followed by the ASCII characters <span class="token string">"asm"</span>.<br>This is followed by a four byte integer in little endian format<br>that specifies the WASM version which is currently `<span class="token number">01000000</span>` for version <span class="token number">1</span>.<br><br>The remainder of the file is divided into <span class="token number">12</span> sections.<br><br>| Section Name | Description                                                                                                  |<br>| ------------ | ------------------------------------------------------------------------------------------------------------ |<br>| <span class="token keyword">type</span>         | describes function signatures <span class="token punctuation">(</span>parameter and <span class="token keyword">return</span> types<span class="token punctuation">)</span>                                                   |<br>| <span class="token keyword">import</span>       | describes imports from other modules including functions, tables, <span class="token keyword">memory</span>, and <span class="token keyword">global</span> variables               |<br>| <span class="token keyword">func</span>         | stores a list of indexes into the <span class="token keyword">type</span> section for each function defined in this <span class="token keyword">module</span>                      |<br>| <span class="token keyword">table</span>        | used by the `<span class="token keyword">call_indirect</span>` instruction for function pointers                                                |<br>| mem          | holds the lower and upper limits on the number of 64KB pages of linear <span class="token keyword">memory</span> that will be used              |<br>| <span class="token keyword">global</span>       | holds the <span class="token keyword">type</span>, mutability, and initial value of all <span class="token keyword">global</span> variables                                        |<br>| <span class="token keyword">export</span>       | describes all the functions, tables, <span class="token keyword">memory</span>, and <span class="token keyword">global</span> variables that are exported for other modules to use |<br>| <span class="token keyword">start</span>        | holds the index of the main/starting function <span class="token keyword">if</span> there is one <span class="token punctuation">(</span>for running outside web browsers<span class="token punctuation">)</span>             |<br>| <span class="token keyword">elem</span>         | holds <span class="token keyword">data</span> used to <span class="token keyword">select</span> a function from a <span class="token keyword">table</span> by the `<span class="token keyword">call_indirect</span>` instruction                         |<br>| code         | holds the <span class="token keyword">local</span> variables and code for each function defined in the <span class="token keyword">module</span>                                   |<br>| <span class="token keyword">data</span>         | holds <span class="token keyword">data</span> used to initialize the linear <span class="token keyword">memory</span> used by the <span class="token keyword">module</span>                                           |<br>| custom       | can store arbitrary <span class="token keyword">data</span> such a debugging information and <span class="token keyword">data</span> used by third party extensions                |<br><br>## AssemblyScript<br><br>&lt;a href=<span class="token string">"https://www.assemblyscript.org?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>AssemblyScript&lt;/a><br>is a programming language designed to compile to WASM.<br><br>AssemblyScript is a variant of TypeScript.<br>Its source files use the `.ts` file extension.<br>Semicolons at the ends of statements are optional.<br><br>AssemblyScript includes<br><span class="token string">"a relatively small memory management and garbage collection runtime."</span><br><br>The only supported types are:<br><br>- boolean `bool`<br>- signed integer types `i8`, `i16`, `<span class="token keyword">i32</span>` and `<span class="token keyword">i64</span>`<br>- unsigned integer types `u8`, `u16`, `u32` and `u64`<br>- floating point types `<span class="token keyword">f32</span>` and `<span class="token keyword">f64</span>`.<br>- platform-specific integers `isize` and `usize`<br>- <span class="token number">128</span>-bit vector `v128`<br>- opaque host reference `anyref`<br>- `void` for functions with no <span class="token keyword">return</span> value <span class="token punctuation">(</span>cannot omit <span class="token keyword">return</span> <span class="token keyword">type</span><span class="token punctuation">)</span><br>- `Array`<br>- `ArrayBuffer`<br>- `DataView`<br>- `Map`<br>- `Math`<br>- `Set`<br>- `string`?<br>- `String`<br>- typed arrays `Int{size}Array`, `UInt{size}Array`, and `Float{size}Array`<br><br>Macro types<br><br>- `indexof&lt;T>`<br>- `native&lt;T>`<br>- `returnof&lt;T>`<br>- `valueof&lt;T>`<br><br>Supported math instructions are described &lt;a href=<span class="token string">"https://www.assemblyscript.org/stdlib/math.html?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>here&lt;/a>.<br><br>To install the AssemblyScript compiler, install Node.js<br>and enter `npm install -g assemblyscript`.<br><br>To compile an AssemblyScript source file to a `.wat` file:<br><br>```bash<br>asc {file-path}.ts -t {file-path}.wat<br>```<br><br>To compile an AssemblyScript source file to a `.wasm` file:<br><br>```bash<br>asc {file-path}.ts -b {file-path}.wasm -O3<br>```<br><br>Here are the steps to implement a `distance` function in AssemblyScript<br>that computes the distance between two points and <span class="token keyword">call</span> it from JavaScript:<br><br><span class="token number">1</span>. Create the file `math.ts` containing the following:<br><br>   ```ts<br>   <span class="token keyword">export</span> function distance<span class="token punctuation">(</span>x1: <span class="token keyword">f64</span>, y1: <span class="token keyword">f64</span>, x2: <span class="token keyword">f64</span>, y2: <span class="token keyword">f64</span><span class="token punctuation">)</span>: <span class="token keyword">f64</span> {<br>     <span class="token keyword">return</span> Math.sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>x1 - x2<span class="token punctuation">)</span> ** <span class="token number">2</span> + <span class="token punctuation">(</span>y1 - y2<span class="token punctuation">)</span> ** <span class="token number">2</span><span class="token punctuation">)</span>;<br>   }<br>   ```<br><br><span class="token number">1</span>. Compile this to WASM by entering `asc math.ts -b math.wasm -O3`<br><br><span class="token number">1</span>. Create the file `index.js` containing the following:<br><br>   ```js<br>   WebAssembly.instantiateStreaming<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>'math.wasm'<span class="token punctuation">)</span><span class="token punctuation">)</span>.<span class="token keyword">then</span><span class="token punctuation">(</span>m => {<br>     const {distance} = m.instance.exports;<br>     document.getElementById<span class="token punctuation">(</span>'<span class="token keyword">result</span>'<span class="token punctuation">)</span>.textContent = distance<span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">3</span>, <span class="token number">5</span>, <span class="token number">7</span><span class="token punctuation">)</span>;<br>   }<span class="token punctuation">)</span>;<br>   ```<br><br><span class="token number">1</span>. Create the file `index.html` containing the following:<br><br>   ```html<br>   &lt;!DOCTYPE html><br>   &lt;html><br>     &lt;head><br>       &lt;script src=<span class="token string">"index.js"</span>>&lt;/script><br>     &lt;/head><br>     &lt;body><br>       &lt;div><span class="token keyword">result</span> = &lt;span id=<span class="token string">"result"</span>>&lt;/span>&lt;/div><br>     &lt;/body><br>   &lt;/html><br>   ```<br><br><span class="token number">1</span>. Start a <span class="token keyword">local</span> HTTP file server like before.<br><br><span class="token number">1</span>. Browse localhost:{port} where port is<br>   the port on which the <span class="token keyword">local</span> server is listening.<br><br>## WebAssembly System Interface <span class="token punctuation">(</span>WASI<span class="token punctuation">)</span><br><br>The &lt;a href=<span class="token string">"https://wasi.dev?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>WebAssembly System Interface <span class="token punctuation">(</span>WASI<span class="token punctuation">)</span>&lt;/a><br>defines a way to communicate with the system<br>that focuses on portability and security.<br>This includes things like stdout/stdin, the file system, and network resources.<br><br>Adding these features makes WASM useful outside of web browsers.<br>Motivations for using WASM in this way include performance, safety, and the<br>ability to combine code compiled from many higher-level programming languages.<br><br>WASM code using WASI is portable across operating systems.<br><br>Implementations of WASI include<br>&lt;a href=<span class="token string">"https://wasmtime.dev?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>Wasmtime&lt;/a> <span class="token punctuation">(</span>developed at Mozilla<span class="token punctuation">)</span> and<br>&lt;a href=<span class="token string">"https://bytecodealliance.github.io/lucet/?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>Lucet&lt;/a><br><span class="token punctuation">(</span>developed at Fastly<span class="token punctuation">)</span>.<br>There is a &lt;a href=<span class="token string">"https://github.com/bytecodealliance/lucet/issues/607?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>plan&lt;/a><br>to merge Lucet with Wasmtime.<br><br>Rust code compiled to WASM can use WASI features<br>because WASI capabilities are included in Rust standard libraries.<br>For example, the `println!` macro can be used.<br>To compile a Rust project to WASM with WASI support,<br>enter `cargo build --target wasm32-unknown-wasi`.<br>TODO: What are the options for the three parts of the target string?<br><br>TODO: Try reading and writing files using Wasmtime.<br>TODO: Try sending an HTTP GET request using Wasmtime.<br><br>C/C++ code compiled to WASM can use WASI features because it will use<br>wasi-sysroot which is a wasi-core implementation of the libc library.<br><br>WASM code using WASI can also be run in web browsers using polyfills.<br>For example, such a polyfill would turn the WASI version of a Rust `println!`<br>into a <span class="token keyword">call</span> to `console.log`.<br><br>Security in WASI is implemented with sandboxing, similar to Deno.<br>Perhaps Deno modeled their security after WASI.<br>When running WASM code that uses WASI features,<br>file system and network resources to be accessed must be specified.<br>Access to unspecified resources are not permitted.<br>This is referred to as <span class="token string">"Capability Space Security"</span>.<br><br>Platform-specific versions of tools like Wasmtime<br>can execute platform-independent WASM code that uses WASI features.<br>They handle translation into platform-specific calls.<br><br>WASI functions are made available to WASM binaries<br>through imports that are passed in.<br>This allows passing in platform-specific versions of these functions.<br>It also supports limiting what the WASM code can do<br>by not passing in every function.<br><br>Security is also controlled at the <span class="token keyword">module</span> level<br>by passing allowed functions and file descriptors between them.<br><br>Remaining work on WASI includes defining support for<br>asynchronous I/O, file watching, and file locking.<br><br>## Running WASM Outside Browsers<br><br>There are currently three tools for running WASM code outside a web browser.<br>Each is described below.<br><br>### &lt;a href=<span class="token string">"https://github.com/wasm3/wasm3?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>WASM3&lt;/a><br><br>To install this in macOS, install Homebrew and enter `brew install wasm3`.<br>Installing for other platforms is more complicated.<br>For details, visit the WASM3 site linked above.<br><br>To <span class="token keyword">call</span> functions defined in a `.wasm` file from a REPL,<br>enter `wasm3 --repl {path-to-wasm-file}`.<br>Then enter function names followed by arguments.<br><br>To <span class="token keyword">call</span> functions directly, not using a REPL,<br>enter `wasm3 --<span class="token keyword">func</span> {function-name} {path-to-wasm-file} {arguments}`.<br><br>TODO: I can't get either of these approaches to work on a `.wasm` file<br>TODO: I created from a Rust programing using<br>TODO: `rustc {path-to-rust-file} --target wasm32-wasi`!<br><br>### &lt;a href=<span class="token string">"https://wasmtime.dev?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>Wasmtime&lt;/a><br><br>To install this in Linux or macOS:<br><br><span class="token number">1</span>. Enter `curl https://wasmtime.dev/install.sh -sSf | bash`<br><span class="token number">1</span>. Open a new terminal that will have `wasmtime` in `PATH`.<br><br>Visit the Wasmtime site linked above for instructions to install in Windows.<br><br>One way to demonstrate running this is to compile Rust code to<br>&lt;a href=<span class="token string">"https://wasi.dev?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>WebAssembly System Interface <span class="token punctuation">(</span>WASI<span class="token punctuation">)</span>&lt;/a>.<br>To do so, enter `rustc {path-to-rust-file} --target wasm32-wasi`.<br>This produces a `.wasm` file.<br>The Rust code can use features such as the `println!` macro to produce output.<br>For example:<br><br>```rust<br>fn main<span class="token punctuation">(</span><span class="token punctuation">)</span> {<br>    println!<span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>;<br>}<br>```<br><br>To execute a `.wasm` file, enter `wasmtime {path-to-wasm-file}`.<br><br>To execute a `.wast` test file, enter `wasmtime wast {path-to-wast-file}`.<br><br>Unlike wasm3, Wasmtime does not provide a REPL or<br>support running a specific function from the command-line.<br><br>### &lt;a href=<span class="token string">"https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>WebAssembly Micro Runtime <span class="token punctuation">(</span>WAMR<span class="token punctuation">)</span>&lt;/a><br><br>Instructions for installing this tool on various platforms can be found at<br>&lt;a href=<span class="token string">"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/build_wamr.md?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>build_wamr.md&lt;/a>.<br><br>To install this in macOS:<br><br>- Browse &lt;a href=<span class="token string">"https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>wasm-micro-runtime&lt;/a>.<br>- Click the <span class="token string">"Code"</span> button and <span class="token string">"Download ZIP"</span>.<br>- Unzip the downloaded file.<br>- cd into its directory and into `product-mini/platforms/darwin`.<br>- Install the `cmake` command with `brew install cmake`.<br>- Enter `mkdir build`<br>- Enter `cd build`<br>- Enter `cmake ..`<br>- Enter `make` to create the executable `iwasm` in the current directory.<br>- Copy `iwasm` to a directory listed in the `PATH` environment variable.<br><br>To run a `.wasm` file, enter `.iwasm {path-to-wasm-file}`<br><br>## Demos<br><br>- &lt;https://github.com/mvolkmann/wasm-bind-demo><br>- &lt;https://github.com/mvolkmann/wasm-demo><br>- &lt;https://github.com/mvolkmann/wasm-rust-linear-<span class="token keyword">memory</span>><br><br>## wasm-pack<br><br>To install wasm-pack in Linux or macOS, enter the following:<br><br>```bash<br>cargo install wasm-pack<br>```<br><br>To create a project that uses wasm-pack::<br><br><span class="token number">1</span>. `wasm-pack new my-wasm`<br><br>   TODO: Describe what this puts in Cargo.toml.<br><br><span class="token number">1</span>. `cd my-wasm`<br><br><span class="token number">1</span>. `wasm-pack build --target web`<br><br>   TODO: Describe the files this produces.<br><br><span class="token number">1</span>. Create the following `index.html` file:<br><br>   ```html<br>   &lt;html><br>     &lt;head><br>       &lt;meta charset=<span class="token string">"utf-8"</span> /><br>       &lt;title>WASM Demo&lt;/title><br>     &lt;/head><br>     &lt;body><br>       &lt;script <span class="token keyword">type</span>=<span class="token string">"module"</span>><br>         <span class="token keyword">import</span> {default as wasm, greet} from './pkg/my_wasm.js';<br>         wasm<span class="token punctuation">(</span><span class="token punctuation">)</span>.<span class="token keyword">then</span><span class="token punctuation">(</span><span class="token keyword">module</span> => {<br>           greet<span class="token punctuation">(</span><span class="token punctuation">)</span>;<br>         }<span class="token punctuation">)</span>;<br>       &lt;/script><br>     &lt;/body><br>   &lt;/html><br>   ```<br><br><span class="token number">1</span>. Start a <span class="token keyword">local</span> HTTP file server.<br>   There are many ways to do this, including using Deno.<br>   TODO: Is there any reason to use wasm-server instead because it supports the WASM MIME <span class="token keyword">type</span>?<br>   TODO: Maybe this is no longer an issue.<br>   To run a simple Deno HTTP file server:<br><br>   <span class="token number">1</span>. Install &lt;a href=<span class="token string">"https://deno.land/#installation?v=1.0.10"</span> rel=<span class="token string">"noopener"</span> target=<span class="token string">"_blank"</span>>Deno&lt;/a>.<br>   <span class="token number">1</span>. Enter `deno install --allow-net --allow-read https://deno.land/std@<span class="token number">0.83</span>.<span class="token number">0</span>/http/file_server.ts`<br>   <span class="token number">1</span>. Enter `file_server .`<br>   <span class="token number">1</span>. Browse `localhost:<span class="token number">4507</span>`<br><br>## ssvmup<br><br>To compile a `.rs` file to WebAssembly:<br><br><span class="token number">1</span>. Install ssvmup by entering the following command <span class="token punctuation">(</span>one time only<span class="token punctuation">)</span>:<br><br>   ```bash<br>   curl https://raw.githubusercontent.com/second-state/ssvmup/master/installer/init.sh -sSf | sh<br>   ```<br><br><span class="token number">1</span>. Create a new Rust library <span class="token punctuation">(</span>referred to as a <span class="token string">"crate"</span><span class="token punctuation">)</span><br>   by entering `cargo new --lib my-crate`<br><br><span class="token number">1</span>. `cd my-crate`<br><br><span class="token number">1</span>. Edit `src/lib.rs` and add code there.<br>   For example:<br><br>   ```rust<br>   use wasm_bindgen::prelude::*;<br><br>   #[wasm_bindgen]<br>   pub fn factorial<span class="token punctuation">(</span>x: u64<span class="token punctuation">)</span> -> u64 {<br>       match x {<br>           <span class="token number">0</span> | <span class="token number">1</span> => <span class="token number">1</span>,<br>           _ => x * factorial<span class="token punctuation">(</span>x - <span class="token number">1</span><span class="token punctuation">)</span>,<br>       }<br>   }<br>   ```<br><br><span class="token number">1</span>. Edit the generated `Cargo.toml` file<br>   which is similar to a Node.js `package.json` file.<br>   For example:<br><br>   ```toml<br>   [package]<br>   name = <span class="token string">"my-crate"</span><br>   version = <span class="token string">"0.1.0"</span><br>   authors = [<span class="token string">"R. Mark Volkmann &lt;me@gmail.com>"</span>]<br>   edition = <span class="token string">"2018"</span><br>   description = <span class="token string">"sample project using ssvmup"</span><br>   license = <span class="token string">"MIT/Apache-2.0"</span><br>   #repository = <span class="token string">"https://github.com/mvolkmann/my-crate"</span><br><br>   [lib]<br>   # cdylib exports a C-style interface for a Rust dynamic library.<br>   crate-<span class="token keyword">type</span> = [<span class="token string">"cdylib"</span>]<br><br>   [dependencies]<br>   wasm-bindgen = <span class="token string">"=0.2.61"</span><br>   ```<br><br><span class="token number">1</span>. Enter `ssvmup build --target deno`<br>   This creates a `pkg` directory containing<br>   `package.json`, a `.wasm` file, and a `.js` file that<br>   reads the `.wasm` file and prepares it for use in JavaScript code.<br><br><span class="token number">1</span>. Copy the generated `pkg` directory to the directory<br>   containing the Deno code that wishes to use it.<br><br><span class="token number">1</span>. Import the exported functions with a line like the following:<br><br>   ```js<br>   <span class="token keyword">import</span> {factorial} from './pkg/my_crate.js';<br>   ```<br><br><span class="token number">1</span>. Call the imported functions.<br><br>   ```js<br>   console.log<span class="token punctuation">(</span>factorial<span class="token punctuation">(</span>4n<span class="token punctuation">)</span><span class="token punctuation">)</span>; // <span class="token string">"n"</span> suffix makes it BitInt<br>   ```<br><br>TODO: Invent a programming language that translated to WAT<br>TODO: more directly than a language like Rust.</code></pre></article>