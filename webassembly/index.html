<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>WebAssembly</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#resources">Resources</a></li><li><a href="#vs-code">VS Code</a></li><li><a href="#only-numbers">Only Numbers</a></li><li><a href="#wasm-text-format">WASM Text Format</a></li><li><a href="#tools">Tools</a></li><li><a href="#tests">Tests</a></li><li><a href="#wasm-functions">WASM Functions</a></li><li><a href="#wasm-instructions">WASM Instructions</a><ol><li><a href="#variable-instructions">Variable Instructions</a></li><li><a href="#numeric-instructions">Numeric Instructions</a></li><li><a href="#bitwise-instructions">Bitwise Instructions</a></li><li><a href="#logical-instructions">Logical Instructions</a></li><li><a href="#comparison-instructions">Comparison Instructions</a></li><li><a href="#conversion-instructions">Conversion Instructions</a></li><li><a href="#control-instructions">Control Instructions</a></li><li><a href="#memory-instructions">Memory Instructions</a></li><li><a href="#other-instructions">Other Instructions</a></li></ol></li><li><a href="#higher-level-languages">Higher Level Languages</a></li><li><a href="#rust-with-numbers">Rust With Numbers</a></li><li><a href="#calling-javascript-functions-from-rust">Calling JavaScript functions from Rust</a></li><li><a href="#rust-with-more-types">Rust With More Types</a></li><li><a href="#c-with-emscripten">C With Emscripten</a></li><li><a href="#linear-memory">Linear Memory</a></li><li><a href="#updating-dom-from-rust">Updating DOM from Rust</a></li><li><a href="#parallel-wasm">Parallel WASM</a></li><li><a href="#wasm-binary-format">WASM Binary Format</a></li><li><a href="#assemblyscript">AssemblyScript</a></li><li><a href="#webassembly-system-interface-(wasi)">WebAssembly System Interface (WASI)</a></li><li><a href="#running-wasm-outside-browsers">Running WASM Outside Browsers</a><ol><li><a href="#wasm3">WASM3</a></li><li><a href="#wasmtime">Wasmtime</a></li><li><a href="#webassembly-micro-runtime-(wamr)">WebAssembly Micro Runtime (WAMR)</a></li></ol></li><li><a href="#demos">Demos</a></li><li><a href="#wasm-pack">wasm-pack</a></li><li><a href="#ssvmup">ssvmup</a></li></ol></nav></aside><article><h2 id="overview">Overview</h2><p>WebAssembly (abbreviated WASM) is a binary instruction format for a stack-based virtual machine. Other popular stack-based virtual machines include the Java Virtual Machine (JVM) and the .NET Common Language Runtime (CLR).</p><p>WASM code can be run in modern web browsers including Chrome (including Android), Edge, Firefox (including Android), Safari (including iOS), Opera, and Android Browser, but not Internet Explorer. It can also be run outside of web browsers using tools such as <a href="https://wasmtime.dev?v=1.0.15" rel="noopener" target="_blank">Wasmtime</a>, <a href="https://github.com/wasm3/wasm3?v=1.0.15" rel="noopener" target="_blank">WASM3</a>, <a href="https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.15" rel="noopener" target="_blank">WebAssembly Micro Runtime (WAMR)</a>.</p><p>There are two primary reasons to run WASM code in a web browser. The first is that it typically executes much faster than equivalent code written in JavaScript, bringing near native performance to the web. The performance is also more predictable because WASM code does not introduce garbage collection pauses. The second is that it enables writing some of the code in any language that can be compiled to WASM as an alternative to JavaScript.</p><p>There are also two primary reasons to run WASM code outside a web browser. The first is that it enables targeting any platform that supports WASM. This is similar to the rationale for using Jav, whose virtual machine is supported by many platforms. The second is that it is secure by default. WASM code does not have access to the environment, the file system, or network resources. The only way it can access those things is if the code that invokes it passes in functions that have those capabilities. This is referred to as capability-based security&quot;. Actually, WASM itself has no access to these and only gains it through the <a href="https://wasi.dev?v=1.0.15" rel="noopener" target="_blank">WebAssembly System Interface (WASI)</a>.</p><p>WASM code can also be compiled to native executables that run on x86 and ARM processors.</p><h2 id="resources">Resources</h2><ul><li><p><a href="https://bytecodealliance.org?v=1.0.15" rel="noopener" target="_blank">Bytecode Alliance</a></p><p>This is &quot;an open source community dedicated to creating secure new software foundations, building on standards such as WebAssembly and WebAssembly System Interface (WASI).&quot; The founding members are Mozilla, Fastly, Intel, and Red Hat.</p></li></ul><h2 id="vs-code">VS Code</h2><p>VS Code has several extensions for working with WASM code. The most popular is &quot;WebAssembly&quot; with the description &quot;WebAssembly Toolkit for VSCode&quot;.</p><h2 id="only-numbers">Only Numbers</h2><p>Currently WASM only supports the four data types <code>i32</code>, <code>i64</code>, <code>f32</code>, and <code>f64</code>. These match number types from Rust. Other types such as strings and structs must be serialized into these number types and deserialized from them using linear memory. Tools such as <a href="https://github.com/rustwasm/wasm-bindgen?v=1.0.15" rel="noopener" target="_blank">wasm_bindgen</a> for Rust and <a href="https://emscripten.org?v=1.0.15" rel="noopener" target="_blank">Emscripten</a> for C/C++ generate code that does this.</p><p>The <a href="https://github.com/WebAssembly/interface-types?v=1.0.15" rel="noopener" target="_blank">Interface Types proposal</a> seeks to change this. It &quot;adds a new set of interface types to WebAssembly that describe high-level values&quot;. These can be implemented using linear memory and the standard WASM numeric types. Added types include additional integer types, characters, lists, records (structs), and variants (enumerated types). Strings are represented as lists of characters. Supported programming languages will be able to serialize and deserialize these additional data types. Each language will be able to use its own representation of the data types.</p><p>WASM doesn't assume that number values are signed. However, specific instructions performed on them do. For example, the instruction to add two i64 signed values is <code>i64.add</code> and for unsigned values is <code>i64.add_u</code>.</p><h2 id="wasm-text-format">WASM Text Format</h2><p>While code from many programming languages can be compiled to WASM, it is also possible to directly implement the code.</p><p>WASM has a binary format and a text (intermediate form) format. Files in the binary format have the extension <code>.wasm</code>. Details about this format are provided later. Files in the text format have the extension <code>.wat</code>.</p><p>The text format has two styles, linear (or plain) and S-expressions (or folded). The linear format places instructions on separate lines. The S-expression format uses parentheses, similar to LISP, representing a tree of nodes. The first value in each expression indicates the node type. The remaining values are attributes or child nodes.</p><p>Every <code>.wat</code> file contains a single, top-level S-expression that defines a module. It is not possible to define more than one module in a source file. The module instruction does not support assigning a name.</p><p>Non-WASM runtimes such as web browsers, Rust, Node.js, Deno, and Python can import multiple WASM modules, but a WASM module cannot import another WASM module.</p><p>Modules can define many kinds of things including:</p><ul><li>imports from other modules</li><li>exports other modules can import</li><li>function type definitions</li><li>function definitions,</li><li>tables to implement function pointers</li><li>linear memory for storing arbitrary data</li><li>data to be placed in linear memory</li><li>global variables available throughout the module</li></ul><h2 id="tools">Tools</h2><p>The <a href="https://github.com/WebAssembly/wabt?v=1.0.15" rel="noopener" target="_blank">WebAssembly Binary Toolkit (WABT)</a> includes a set of command line tools including <code>wat2wasm</code>, <code>wasm2wat</code>, <code>wasm-validate</code>, and <code>wasm-interp</code>. In macOS these can be installed by installing <a href="https://brew.sh?v=1.0.15" rel="noopener" target="_blank">Homebrew</a> and entering <code>brew install wabt</code>.</p><p>The <code>wat2wasm</code> tool compiles a <code>.wat</code> file to a <code>.wasm</code> file. The <code>wasm2wat</code> tool de-compiles a <code>.wasm</code> file to a <code>.wat</code> file that uses the linear style. Also see <code>.wast</code> files that are for writing tests.</p><p>The <code>wasm-nm</code> tool outputs the symbols that are export from and imported into a <code>.wasm</code> file. To install this tool, enter <code>cargo install wasm-nm</code>. To run it, enter <code>wasm-nm {file-path}.wasm</code>. The names of exported symbols are preceded by &quot;e &quot; and the names of imported symbols are preceded by &quot;i &quot;.</p><h2 id="tests">Tests</h2><p>One way to write unit tests for WASM functions is to use the WABT tools <code>wast2json</code> and <code>spectest-interp</code>. For example, the following code defines an <code>add</code> function and unit tests for it. To run this, enter <code>wast2json demo.wat &amp;&amp; spectest-interp demo.json</code>. This makes additional assert instructions available for implementing tests including:</p><ul><li><code>assert_exhaustion</code>: system resources were exhausted</li><li><code>assert_invalid</code>: module is invalid</li><li><code>assert_malformed</code>: module cannot be decoded</li><li><code>assert_return</code>: function returns a specific result (most common)</li><li><code>assert_trap</code>: error trap is triggered</li><li><code>assert_unlinkable</code>: module fails to link</li></ul><p>Here is the contents of <code>demo.wat</code> which defines a function and its tests.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span><br><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token comment">;; This test is expected to fail.</span><br><span class="token comment">;; It's purpose to show how failures are reported.</span><br><span class="token punctuation">(</span>assert_return <span class="token punctuation">(</span>invoke <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>The output is:</p><pre class="language-text"><code class="language-text">demo.wast:12: mismatch in result 0 of assert_return: expected i32:6, got i32:7<br>3/4 tests passed.</code></pre><h2 id="wasm-functions">WASM Functions</h2><p>Modules can define functions. Functions that are exported can be called from JavaScript. These definitions have the syntax <code>(func {signature} {locals} {body})</code>. The signature defines the function name, its parameter types, and its return type. In functions that do not return a value, the return type is omitted. Locals defines local variable names and their types. The body is a list of instructions that implement the function.</p><p>Parameters and local variables are accessed by their position in the signature using zero-based indexes. The text format also allows functions, parameters, and local variables to have names that start with <code>$</code>. These can be referenced by name, but the names are compiled away in favor of indexes.</p><p>WASM functions can be named or unnamed. Any function can be called by its position (zero-based index) within the module. Named functions call also be called using their name.</p><p>The following code is in the file <code>demo.wat</code>.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token comment">;; anonymous function at index 0 that just returns 19</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">19</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token comment">;; named function at index 1 that just returns 21</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$second</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">21</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callFirst"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token number">0</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callSecond"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token variable">$second</span><br>    <span class="token comment">;; same as call 1</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this code to a <code>.wasm</code> file by entering <code>wat2wasm demo.wat</code>.</p><p>The following JavaScript code is in the file <code>demo.js</code>. It instantiates the WASM code above and calls its exported functions:</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>callFirst<span class="token punctuation">,</span> callSecond<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'first ='</span><span class="token punctuation">,</span> <span class="token function">callFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 19</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'second ='</span><span class="token punctuation">,</span> <span class="token function">callSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 21</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Function parameters can also be named or unnamed. Unnamed functions are referred to by their position (zero-based index) within the parameter list. Parameters are declared using the <code>param</code> instruction. Typically each parameter is described separately so each can be given a name and type. Alternatively all of their types can be described with a single <code>param</code> instruction, but in that case they cannot be given names. Functions have a fixed number of parameters and cannot accept a variable number of them. For example:</p><pre class="language-wasm"><code class="language-wasm">  <span class="token comment">;; Declaring each parameter separately</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"percent"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$amount</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$total</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f32</span><span class="token punctuation">)</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$amount</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$total</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>div</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">100.0</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>mul</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token comment">;; Using on param instruction</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"percent2"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f32</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f32</span><span class="token punctuation">)</span><br>    <span class="token keyword">local</span>.get <span class="token number">0</span><br>    <span class="token keyword">local</span>.get <span class="token number">1</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>div</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">100.0</span><br>    <span class="token keyword">f32<span class="token punctuation">.</span>mul</span><br>  <span class="token punctuation">)</span></code></pre><p>Functions that return a value must specify its type with <code>(return {type})</code>. This is omitted for functions that do not return a value.</p><p>Exporting a function makes it available outside its module, such as in JavaScript. There are two ways to export a function. It can be given both a WASM name and an exported name. This allows it to be called from both WASM code and outside code. For example:</p><pre class="language-wasm"><code class="language-wasm">  <span class="token comment">;; This function cannot be called by name in this WASM module.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"subtract"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span></code></pre><p>It call also be given only an exported name. In this case it can still be called from WASM code, but only by its position within the module.</p><pre class="language-wasm"><code class="language-wasm">  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"subtract"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span></code></pre><p>Instructions get their arguments from the top values on the stack. The <code>local.get {index | name}</code> instruction (old name was <code>get_local</code>) gets the value of a parameter of local variable and places it on the stack. The <code>local.set {index | name} {value}</code> instruction (old name was <code>set_local</code>) sets value of a local variable. The <code>{type}.const {value}</code> instruction pushes a constant value on the stack. When a function exists, its return value is the top value on the stack.</p><p>Single line comments begin with <code>;;</code> and extend to the end of the line. Multi-line comments begin with <code>(;</code> and end with <code>;)</code>. This makes it easy to comment out an S-expression because <code>;</code> characters just need to be added inside the opening and closing parentheses. It also means that a winking smiley face is the closing delimiter!</p><p>Here are examples of functions. The first takes two numbers and returns their sum. The rest compute the distance between two points using the formula <code>sqrt(dx**2 + dy**2)</code>. Three versions are presented to show different approaches. This code is available in the GitHub repo <a href="https://github.com/mvolkmann/wasm-demo/?v=1.0.15" rel="noopener" target="_blank">wasm-demo</a>.</p><ol><li>Create the file <code>math.wat</code> containing the following:</li></ol><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sum</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$lhs</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$rhs</span><br>    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"sum"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses the "linear" format.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">local</span>.get <span class="token variable">$x1</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$x2</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>    <span class="token keyword">local</span>.tee <span class="token variable">$x1</span> <span class="token comment">;; reusing $x1 to hold temporary dx value</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$x1</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token keyword">local</span>.get <span class="token variable">$y1</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$y2</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>    <span class="token keyword">local</span>.tee <span class="token variable">$y1</span> <span class="token comment">;; reusing $y1 to hold temporary dy value</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$y1</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses S-expressions.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance2</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dx</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dy</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dx</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x2</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dy</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y2</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token comment">;; There is no instruction to duplicate the value at</span><br>          <span class="token comment">;; the top of the stack, so we have to do this twice.</span><br>          <span class="token comment">;; See https://github.com/WebAssembly/design/issues/1365.</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance2"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses even more S-expressions.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance3</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$x1</span> <span class="token comment">;; reusing $x1 to hold temporary dx value</span><br>            <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x1</span><span class="token punctuation">)</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x2</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>          <span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$y1</span> <span class="token comment">;; reusing $y1 to hold temporary dy value</span><br>            <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y1</span><span class="token punctuation">)</span><br>              <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y2</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>          <span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance3"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><ol><li><p>Install the <a href="https://github.com/WebAssembly/wabt?v=1.0.15" rel="noopener" target="_blank">WebAssembly Binary Toolkit (WABT)</a>. This includes a set of command line tools including wat2wasm, wasm2wat, wasm-validate, and wasm-interp. In macOS this can be installed using Homebrew by entering <code>brew install wabt</code>.</p></li><li><p>Enter <code>wat2wasm math.mat</code> to create the binary file <code>math.wasm</code>.</p></li><li><p>Create the JavaScript file <code>index.js</code> that loads the <code>add.wasm</code> and calls the function it defines:</p><pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'math.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>distance<span class="token punctuation">,</span> distance2<span class="token punctuation">,</span> distance3<span class="token punctuation">,</span> sum<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'distance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance1 ='</span><span class="token punctuation">,</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance2 ='</span><span class="token punctuation">,</span> <span class="token function">distance2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance3 ='</span><span class="token punctuation">,</span> <span class="token function">distance3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Create the HTML file <code>index.html</code> that includes <code>index.js</code>:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>sum = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sum<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>distance = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>distance<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server. One approach is to install <a href="https://deno.land/">Deno</a> and then enter these commands:</p><pre class="language-bash"><code class="language-bash">deno <span class="token function">install</span> --allow-net --allow-read https://deno.land/std@0.87.0/http/file_server.ts<br>file_server <span class="token builtin class-name">.</span></code></pre><p>Another approach is to enter <code>npx live-server</code>.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output.</p></li></ol><h2 id="wasm-instructions">WASM Instructions</h2><p>TODO: Consider deleting this table if it just duplicates what is explained later.</p><table><thead><tr><th>Operation</th><th>Instruction Syntax</th></tr></thead><tbody><tr><td>define function</td><td><code>func [{name}] {parameters} {return-type} {body}</code></td></tr><tr><td>define a function parameter</td><td><code>param {name} {type}</code></td></tr><tr><td>define a function return type</td><td><code>result {type}</code></td></tr><tr><td>export function to make it available in JS</td><td><code>export {js-name} (func {name})</code></td></tr><tr><td>call function</td><td><code>call {fn-name}</code></td></tr><tr><td>declare local variable</td><td><code>local {name} {type}</code> (cannot initialize)</td></tr><tr><td>set local variable</td><td><code>local.set {name} {value}</code></td></tr><tr><td>get local variable</td><td><code>local.get {name}</code></td></tr><tr><td>declare global variable</td><td><code>global {name} {type} [{value}]</code> (can initialize)</td></tr><tr><td>set global variable</td><td><code>global.set {name} {value}</code> (must be mutable)</td></tr><tr><td>get global variable</td><td><code>global.get {name}</code></td></tr><tr><td>conditional logic</td><td><code>if (result {type}) {condition} (then {body}) (else {body}))</code></td></tr><tr><td>select value based on condition</td><td><code>select {non-zero-value} {zero-value} {condition}</code></td></tr><tr><td>define a block</td><td><code>block {body}</code></td></tr><tr><td>loop</td><td><code>loop {body}</code> (defines a block)</td></tr><tr><td>break out of block</td><td><code>br {depth}</code></td></tr><tr><td>compare values</td><td>see &quot;Comparison Instructions&quot; below</td></tr><tr><td>set data in linear memory</td><td><code>{type}.store{bits} {value}</code> (ex. <code>i32.store8</code>)</td></tr><tr><td>get data from linear memory</td><td><code>{type}.load{bits}</code> (ex. <code>i32.load8_u</code>)</td></tr><tr><td>grow linear memory</td><td><code>memory.grow {pages}</code></td></tr><tr><td>shrink linear memory?</td><td>not currently supported, but being discussed (1)</td></tr></tbody></table><p>(1) <a href="https://github.com/WebAssembly/design/issues/1397?v=1.0.15" rel="noopener" target="_blank">memory management issue</a></p><p>The tables below summarize the currently supported WASM instructions. Understanding these is only necessary when directly writing WASM code in text format or to understand what compilers for higher level languages like Rust generate.</p><p>For more detail, see the <a href="https://github.com/sunfishcode/wasm-reference-manual/blob/master/WebAssembly.md?v=1.0.15" rel="noopener" target="_blank">WASM Reference Manual</a>.</p><p>The tables below use the following abbreviations for substitutions in instruction names:</p><ul><li><code>mm</code> and <code>nn</code> can be <code>32</code> bits or <code>64</code> bits</li><li><code>sx</code> can be <code>u</code> (unsigned) or <code>s</code> (signed)</li></ul><p>As mentioned earlier, there is no instruction for duplicating the top value on the stack. Adding this has been proposed. Thomas Lively provided rationale on why this has not been done.</p><blockquote><blockquote><blockquote><p>&quot;It takes a surprising amount of work and time to spec new instructions and get them implemented in every tool and engine out there. So generally only changes with significant benefits get all the way through the process. Unfortunately that means that there are a lot of &quot;nice to have&quot; proposals, even tiny ones like adding a single dup instruction, that don't make the cut. I'm not saying we'll never add dup, but if we do it will because it solves an important problem so lots of folks agree it's important to add and will be motivated to implement and maintain it throughout the ecosystem.</p><p>This is one of the costs of standards-based work. If WASM were controlled by a single party, it would be easy to add a single instruction like dup. Since it's not, you first have to get a lot of different people with different priorities and opinions to agree that adding dup is both a good idea and worth their time and effort. Because of this extra consensus-building work, the community can have more confidence in the robustness and benefits of the proposals that do make it through the process.&quot;</p></blockquote></blockquote></blockquote><p>Many WASM instruction names follow the format <code>{kind-of-thing}.{operation}</code> where kinds of things include:</p><ul><li>variables: <code>local</code> and <code>global</code></li><li>integers: <code>i32</code> and <code>i64</code></li><li>floating point numbers: <code>f32</code> and <code>f64</code></li></ul><p>Some kind-specific operations include:</p><ul><li><code>get</code> and <code>set</code> to get and set the value of a variable</li><li><code>const</code> to place the value of a constant on the stack</li><li><code>store</code> and <code>load</code> to copy data into memory and retrieve it</li></ul><p>WASM instructions get their arguments from literal values specified after the instruction (referred to as &quot;static immediate arguments&quot;) and/or from the stack (referred to as &quot;dynamic operands&quot;). Some instructions use only one of these sources, while others use both. The columns in the tables below include the following columns to provide this information for each instruction:</p><ul><li>I: number of immediate arguments</li><li>Si: number of arguments popped from the stack (input)</li><li>So: number of values pushed onto the stack (output)</li></ul><h3 id="variable-instructions">Variable Instructions</h3><p>Global variables are declared at the module level, not inside functions. They are immutable by default. To declare a global variable to be mutable, specify its type as <code>(mut {type})</code>.</p><p>Local variables are declared inside functions and the declarations must appear at the beginning of the function before any other instructions. Local variables cannot be initialized when they are declared, so they are always mutable.</p><p>The instructions in the table below declare, get, and set local and global variables.</p><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>local</code></td><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>declares a local variable name and type</td></tr><tr><td><code>local.get</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>push local variable onto stack</td></tr><tr><td><code>local.set</code></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>set local variable from stack and pop</td></tr><tr><td><code>local.tee</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>set local variable from stack and leave on stack</td></tr><tr><td><code>global</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>declares a global variable name, type, and initial value</td></tr><tr><td><code>global.get</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>push global variable onto stack</td></tr><tr><td><code>global.set</code></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>set global variable from stack and pop</td></tr></tbody></table><p>The two immediate arguments of the <code>local</code> instruction are its name and type. Local variables default to zero and cannot be initialized to a different value. See the <code>$l1</code> example below.</p><p>Older code examples use the deprecated names <code>get_local</code>, <code>set_local</code>, <code>tee_local</code>, <code>get_global</code>, and <code>set_global</code>.</p><p>All of these instructions take an immediate argument that identifies the variable on which to operate by index or name. The <code>set</code> instructions get the new value from the stack.</p><p>The file <code>demo.wat</code> below demonstrates of using these instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token comment">;; Import a global variable named gFromJS from JavaScript,</span><br>  <span class="token comment">;; give it the WASM name $g_from_js,</span><br>  <span class="token comment">;; and declare it to hold an immutable i32 value.</span><br>  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$g_from_js</span> <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"gFromJS"</span><span class="token punctuation">)</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; Define a global variable named $g_here that</span><br>  <span class="token comment">;; holds a mutable i32 value and is initialized to 19.</span><br>  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$g_here</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; Define a function that has no parameters and returns a f64 value and</span><br>  <span class="token comment">;; export it with the name "demo" so it can be called from JavaScript.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"demo"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token comment">;; Define a local variable named $l1 that holds a f64 value.</span><br>    <span class="token comment">;; The value cannot be initialized in this instruction.</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$l1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token comment">;; Set the local variable to 3.14.</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$l1</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token comment">;; Get the value of $l1, placing it on the stack.</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$l1</span><br><br>    <span class="token comment">;; Do it again so two copies are on the stack.</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$l1</span><br><br>    <span class="token comment">;; Multiply $l1 by itself and place the f64 result on the stack.</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token comment">;; Add 1 to $g_here so the value becomes 20.</span><br>    <span class="token punctuation">(</span><span class="token keyword">global</span>.set <span class="token variable">$g_here</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$g_here</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token comment">;; Get the value of $g_here, placing it on the stack.</span><br>    <span class="token keyword">global</span>.get <span class="token variable">$g_here</span><br><br>    <span class="token comment">;; Convert the i32 value to f64.</span><br>    <span class="token keyword">f64</span>.convert_i32_s<br><br>    <span class="token comment">;; Add $g_here to the previous result from f64.mul.</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br><br>    <span class="token comment">;; Get the value of $g_from_js.</span><br>    <span class="token keyword">global</span>.get <span class="token variable">$g_from_js</span><br><br>    <span class="token comment">;; Convert the i32 value to f64.</span><br>    <span class="token keyword">f64</span>.convert_i32_s<br><br>    <span class="token comment">;; Add $g_from_js to the previous result and</span><br>    <span class="token comment">;; use this as the return value of the function.</span><br>    <span class="token comment">;; The result is 3.14 * 3.14 + (19 + 1) + 20 = 49.8596.</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><br>    js<span class="token operator">:</span> <span class="token punctuation">{</span><br>      gFromJS<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Global</span><span class="token punctuation">(</span><span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token string">'i32'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>demo<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result ='</span><span class="token punctuation">,</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="numeric-instructions">Numeric Instructions</h3><p>These instructions are prefixed by one of the four supported number types. For example, the instruction to add two <code>f32</code> values is <code>f32.add</code>.</p><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>abs</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>absolute value</td></tr><tr><td><code>add</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>add</td></tr><tr><td><code>ceil</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>ceiling</td></tr><tr><td><code>copysign</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>copy sign</td></tr><tr><td><code>div_{sx}</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>integer divide</td></tr><tr><td><code>div</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>floating point divide</td></tr><tr><td><code>floor</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>floor</td></tr><tr><td><code>max</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>maximum</td></tr><tr><td><code>min</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>minimum</td></tr><tr><td><code>mul</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>multiply</td></tr><tr><td><code>ne</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>not equal</td></tr><tr><td><code>nearest</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>round floating point to integer</td></tr><tr><td><code>neg</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>negate</td></tr><tr><td><code>rem_{sx}</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>remainder</td></tr><tr><td><code>sqrt</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>square root</td></tr><tr><td><code>sub</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td>subtract</td></tr><tr><td><code>trunc</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td>truncate</td></tr></tbody></table><p>We saw examples of using the <code>add</code> and <code>mul</code> instructions in the &quot;Variable Instructions&quot; section.</p><p>All of these instructions require a type prefix. For example, <code>f64.max</code> is used in the file <code>demo.wat</code> below which demonstrates using some of these instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"max"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>max</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"min"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>min</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>max<span class="token punctuation">,</span> min<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> pi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">;</span> <span class="token comment">// 3.14159</span><br>  <span class="token keyword">const</span> e <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">E</span><span class="token punctuation">;</span> <span class="token comment">// 2.71828</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pi</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pi</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Many math functions, such as <code>sin</code>, <code>cos</code>, <code>tan</code>, and <code>log</code> are missing in WASM. One way to get these is to import them from JavaScript as shown below.</p><p>The file <code>demo.js</code> below provides math functions to <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><br>    js<span class="token operator">:</span> <span class="token punctuation">{</span><br>      sin<span class="token operator">:</span> Math<span class="token punctuation">.</span>sin<span class="token punctuation">,</span><br>      cos<span class="token operator">:</span> Math<span class="token punctuation">.</span>cos<span class="token punctuation">,</span><br>      tan<span class="token operator">:</span> Math<span class="token punctuation">.</span>tan<span class="token punctuation">,</span><br>      log<span class="token operator">:</span> Math<span class="token punctuation">.</span>log<br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>demo<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result ='</span><span class="token punctuation">,</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.811529</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The file <code>demo.wat</code> below demonstrates using functions imported from JavaScript. Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token comment">;; This shows describing a function signature inline.</span><br>  <span class="token comment">;;(import "js" "sin" (func $sin (param f64) (result f64)))</span><br><br>  <span class="token comment">;; This shows assigning a name to a function signature</span><br>  <span class="token comment">;; and reusing it.</span><br>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"sin"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sin</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"cos"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$cos</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"tan"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$tan</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$math_fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This returns log(sin($radians) + cos($radians) + tan($radians)).</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"demo"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$radians</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$sin</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$radians</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$cos</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$radians</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>    <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$tan</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$radians</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>    <span class="token keyword">call</span> <span class="token variable">$log</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><h3 id="bitwise-instructions">Bitwise Instructions</h3><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>clz</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>count leading zeros</td></tr><tr><td><code>ctz</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>count trailing zeros</td></tr><tr><td><code>popcnt</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>population count (# of 1 bits)</td></tr><tr><td><code>rotl</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>rotate left</td></tr><tr><td><code>rotr</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>rotate right</td></tr><tr><td><code>shl</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>shift left</td></tr><tr><td><code>shr_{sx}</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>shift right</td></tr></tbody></table><p>All of these instructions require a type prefix. For example, <code>i32.clz</code> is used in the file <code>demo.wat</code> below which demonstrates using some of these instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"leadingZeros"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>clz</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"trailingZeros"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>ctz</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"population"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>popcnt</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"rotateLeft"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>rotl</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"rotateRight"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>rotr</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"shiftLeft"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"shiftRight"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$bits</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token comment">;; shr_u is for unsigned.</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shr_u</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span><br>    leadingZeros<span class="token punctuation">,</span><br>    population<span class="token punctuation">,</span><br>    rotateLeft<span class="token punctuation">,</span><br>    rotateRight<span class="token punctuation">,</span><br>    shiftLeft<span class="token punctuation">,</span><br>    shiftRight<span class="token punctuation">,</span><br>    trailingZeros<br>  <span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  <span class="token comment">// 52 in one byte of binary is 00110100.</span><br>  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token number">52</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// In four bytes there are 3*8 + 2 leading zeros.</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'leading zeros ='</span><span class="token punctuation">,</span> <span class="token function">leadingZeros</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 26</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'trailing zeros ='</span><span class="token punctuation">,</span> <span class="token function">trailingZeros</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'population ='</span><span class="token punctuation">,</span> <span class="token function">population</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3 1-bits</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'shiftRight ='</span><span class="token punctuation">,</span> <span class="token function">shiftRight</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 26</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'shiftLeft ='</span><span class="token punctuation">,</span> <span class="token function">shiftLeft</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 104</span><br><br>  <span class="token comment">// Could use shiftRight here instead since no bits are wrapping around.</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rotateRight ='</span><span class="token punctuation">,</span> <span class="token function">rotateRight</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 13</span><br><br>  <span class="token comment">// Could use shiftLeft here instead since no bits are wrapping around.</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rotateLeft ='</span><span class="token punctuation">,</span> <span class="token function">rotateLeft</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 208</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="logical-instructions">Logical Instructions</h3><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>and</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>and</td></tr><tr><td><code>or</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>or</td></tr><tr><td><code>xor</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>exclusive or</td></tr></tbody></table><p>All of these instructions require a type prefix. For example, <code>i32.and</code> is used in the file <code>demo.wat</code> below which demonstrates using some of these instructions.</p><p>The file <code>demo.wat</code> below demonstrates using each of these instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"and"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>and</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"or"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>or</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"xor"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>xor</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>and<span class="token punctuation">,</span> or<span class="token punctuation">,</span> xor<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  <span class="token comment">// 52 in one byte of binary is 00110100.</span><br>  <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token number">52</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// 21 in one byte of binary is 00010101.</span><br>  <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'and ='</span><span class="token punctuation">,</span> <span class="token function">and</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 00010100 = 20</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'or ='</span><span class="token punctuation">,</span> <span class="token function">or</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 00110101 = 53</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xor ='</span><span class="token punctuation">,</span> <span class="token function">xor</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 00100001 = 33</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="comparison-instructions">Comparison Instructions</h3><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>eq</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>equal</td></tr><tr><td><code>eqz</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>equal to zero</td></tr><tr><td><code>ge_{sx}</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>integer greater than or equal</td></tr><tr><td><code>ge</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>floating point greater than or equal</td></tr><tr><td><code>gt_{sx}</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>integer greater than</td></tr><tr><td><code>gt</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>floating point greater than</td></tr><tr><td><code>le_{sx}</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>integer less than or equal</td></tr><tr><td><code>le</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>floating point less than or equal</td></tr><tr><td><code>lt_{sx}</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>integer less than</td></tr><tr><td><code>lt</code></td><td style="text-align:center">0</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td>floating point less than</td></tr></tbody></table><p>All of these instructions require a type prefix. For example, <code>f64.ge</code> is used in the file <code>demo.wat</code> below which demonstrates using some of these instructions. We saw an easier way to implement these functions in the &quot;Numeric Instructions&quot; section.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"max"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>ge</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"min"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>le</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>max<span class="token punctuation">,</span> min<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> pi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">;</span> <span class="token comment">// 3.14159</span><br>  <span class="token keyword">const</span> e <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">E</span><span class="token punctuation">;</span> <span class="token comment">// 2.71828</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pi</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pi</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="conversion-instructions">Conversion Instructions</h3><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>convert</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>convert integer to floating point</td></tr><tr><td><code>demote</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>convert f64 to f32</td></tr><tr><td><code>extend</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>convert i32 to i64</td></tr><tr><td><code>promote</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>convert f32 to f64</td></tr><tr><td><code>reinterpret</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>convert from integer to floating point or floating point to integer</td></tr><tr><td><code>trunc</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>truncate, discarding the least significant bits</td></tr><tr><td><code>wrap</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>converts i32 to i64, discarding the most significant bits</td></tr></tbody></table><p>All of these instructions require a type prefix. We saw examples of using the <code>f64.convert_i32s</code> instruction in the &quot;Variable Instructions&quot; section above. The type prefix specifies the output type and the instruction suffix (<code>_32s</code> in this case) specifies the input type.</p><h3 id="control-instructions">Control Instructions</h3><p>These instructions are expressions, not statements. They result in placing a value on the stack.</p><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>block [{name}]</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>creates a group of instructions</td></tr><tr><td><code>loop [{name}]</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>creates a special block for implementing a loop</td></tr><tr><td><code>if {condition}</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>creates a conditional with at <code>then</code> part and an optional <code>else</code> part</td></tr><tr><td><code>then</code></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>denotes the false block of a conditional</td></tr><tr><td><code>else</code></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>denotes the false block of a conditional</td></tr><tr><td><code>end</code></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>marks the end of a block for <code>block</code>, <code>if</code>, <code>else</code>, <code>loop</code>, or <code>function</code></td></tr><tr><td><code>br {depth}</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>unconditional branch</td></tr><tr><td><code>br_if {depth} {condition}</code></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>conditional branch</td></tr><tr><td><code>br_table {list-of-depths}</code></td><td style="text-align:center">2+</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>branch to a depth from a list of them based on the index at the top of the stack</td></tr><tr><td><code>return</code></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td>return from function, optionally specifying a return value</td></tr><tr><td><code>unreachable</code></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>signals an error (trap) if reached</td></tr></tbody></table><p>Even control flow instructions operate on the stack. For example, the <code>if</code> instruction executes its branch if the value at the top of the stack evaluates to true.</p><p>The <code>block</code> instruction creates the equivalent of an immediately invoked inline function. It has a result type and a set of instructions. When in a <code>block</code>, branching to depth <code>0</code> exits the <code>block</code>.</p><p>The <code>loop</code> instruction creates a different kind of <code>block</code> where branching to depth <code>0</code> goes to the beginning of the loop for another iteration rather than branching out of the block.</p><p>The <code>block</code> and <code>loop</code> instructions can specify a block name that branch instructions can refer to instead of specifying a depth.</p><p>The file <code>demo.wat</code> below demonstrates using some of these instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$factorial</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">if</span><br>      <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>le_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">else</span><br>        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$factorial</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; recursive</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"factorial"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$factorial</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"sumRange"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> $<span class="token keyword">start</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> $<span class="token keyword">end</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$sum</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$n</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">start</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">loop</span><br>      <span class="token comment">;; Add $n to $sum.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$sum</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$sum</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Add 1 to $n.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$n</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Go to top of the loop if $end not reached</span><br>      <span class="token comment">;; by branching to block level zero.</span><br>      <span class="token comment">;; Otherwise drop out of loop.</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>le_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$sum</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"blockWithoutResult"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> $<span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">block</span> <span class="token comment">;; This block has no result.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">result</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token comment">;; Inside a block, branching to depth zero exits the block.</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">result</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">result</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">result</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"blockWithResult"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">block</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token comment">;; This block has a result.</span><br>      <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><br>      <span class="token comment">;; Inside a block, branching to depth zero exits the block.</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; This is needed so there will only be one value</span><br>      <span class="token comment">;; on the stack at the end of this function.</span><br>      <span class="token keyword">drop</span><br>      <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; This is needed so there will only be one value</span><br>      <span class="token comment">;; on the stack at the end of this function.</span><br>      <span class="token keyword">drop</span><br>      <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"usingReturn"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$n</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$n</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span><br>    blockWithoutResult<span class="token punctuation">,</span><br>    blockWithResult<span class="token punctuation">,</span><br>    factorial<span class="token punctuation">,</span><br>    returnDemo<span class="token punctuation">,</span><br>    sumRange<span class="token punctuation">,</span><br>    usingReturn<br>  <span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 * 2 * 3 = 6</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 * 2 * 3 * 4 * 5 = 120</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sumRange</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3 + 4 + 5 + 6 = 18</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">blockWithoutResult</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">blockWithoutResult</span><span class="token punctuation">(</span><span class="token number">142</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">blockWithoutResult</span><span class="token punctuation">(</span><span class="token number">728</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">blockWithResult</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">blockWithResult</span><span class="token punctuation">(</span><span class="token number">142</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">blockWithResult</span><span class="token punctuation">(</span><span class="token number">728</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">usingReturn</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">usingReturn</span><span class="token punctuation">(</span><span class="token number">142</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">usingReturn</span><span class="token punctuation">(</span><span class="token number">728</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="memory-instructions">Memory Instructions</h3><p>WASM memory is a contiguous array of bytes. When it is allocated, it is given an initial size in pages (64 KB each) and optionally a maximum size which cannot exceed 4 GB. The allocated size can be increased later using the <code>memory.grow</code> instruction up to the maximum size.</p><p>Each WASM module can have only one array of linear memory. But JavaScript can instantiate more than one WASM module in order to access multiple instances of linear memory.</p><p>The <code>load</code> instructions load data from the default linear memory. The <code>store</code> instructions store data into the default linear memory. These instructions are prefixed by the number type to be loaded or stored. In the table below, <code>mem</code> is a memory offset.</p><p>| Name | I | Si | So | Description | | -------------------------------------- | :-: | :-: | :-: | ------------------------------------------------------------------ | ----------------------- | | <code>i{nn}.load {mem}</code> | 0 | 1 | 1 | reads integer value into matching size | | <code>i{nn}.load8_{sx} {mem}</code> | 0 | 1 | 1 | reads integer value into 8 bits | | <code>i{nn}.load16_{sx} {mem}</code> | 0 | 1 | 1 | reads integer value into 16 bits | | <code>i64.load32_{sx} {mem}</code> | 0 | 1 | 1 | reads i64 value into 32 bits | | <code>f{nn}.load {mem}</code> | 0 | 1 | 1 | reads floating point value | | <code>i{nn}.store {mem}</code> | 0 | 2 | 0 | writes integer value into matching size | | <code>i{nn}.store8 {mem}</code> | 0 | 2 | 0 | writes integer value into 8 bits | | <code>i{nn}.store16 {mem}</code> | 0 | 2 | 0 | writes integer value into 16 bits | | <code>i64.store32 {mem}</code> | 0 | 2 | 0 | writes i64 value into 32 bits | | <code>f{nn}.store {mem}</code> | 0 | 2 | 0 | writes floating point value into matching size | | <code>memory {initial-pages} [{max-pages}]</code> | 1 | 2 | 0 | 0 | allocates linear memory | | <code>memory.grow</code> | 1 | 0 | 1 | increases size of linear memory in pages and returns previous size | | <code>memory.size</code> | 0 | 0 | 1 | returns the size of default linear memory |</p><p>The file <code>demo.wat</code> below demonstrates using some of these instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"myMemory"</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">;; initial size 1 page; maximum not specified</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$translate</span> <span class="token punctuation">(</span><span class="token keyword">param</span> $<span class="token keyword">offset</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$delta</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>store</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>load</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$delta</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"translatePoints"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$length</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$dx</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$dy</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> $<span class="token keyword">offset</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token comment">;; starts at zero</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$lastOffset</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$lastOffset</span><br>      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>mul</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token comment">;; number of points</span><br>        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">;; 8 bytes for x + 8 bytes for y</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">loop</span><br>      <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$translate</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Advance $offset to get next y value.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">offset</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token comment">;; Translate y value by $dy.</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>store</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>          <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>load</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br><br>      <span class="token comment">;; Advance $offset to get next x value.</span><br>      <span class="token punctuation">(</span><span class="token keyword">local</span>.set $<span class="token keyword">offset</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get $<span class="token keyword">offset</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$lastOffset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>myMemory<span class="token punctuation">,</span> translatePoints<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">1.2</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">2.3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">3.4</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">4.5</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">5.6</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">6.7</span><span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Copy the point data into linear memory shared with WASM code.</span><br>  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> length <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>myMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> point <span class="token keyword">of</span> points<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    array<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> point<span class="token punctuation">.</span>x<span class="token punctuation">;</span><br>    array<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> point<span class="token punctuation">.</span>y<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'untranslated points ='</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">translatePoints</span><span class="token punctuation">(</span>points<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'translated points ='</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="other-instructions">Other Instructions</h3><table><thead><tr><th>Name</th><th style="text-align:center">I</th><th style="text-align:center">Si</th><th style="text-align:center">So</th><th>Description</th></tr></thead><tbody><tr><td><code>call</code></td><td style="text-align:center">1</td><td style="text-align:center">*</td><td style="text-align:center">1</td><td>calls a function</td></tr><tr><td><code>call_indirect</code></td><td style="text-align:center">0</td><td style="text-align:center">*</td><td style="text-align:center">1</td><td>calls a function at an index in the default table</td></tr><tr><td><code>const</code></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td>pushes a constant value onto the stack</td></tr><tr><td><code>drop</code></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>pops top value from stack and does nothing with it</td></tr><tr><td><code>nop</code></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td>no operation</td></tr><tr><td><code>select</code></td><td style="text-align:center">0</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td>takes two values and a condition; returns 1st if true and 2nd if false</td></tr></tbody></table><p>TODO: Are <code>module</code> and <code>type</code> considered to be instructions?</p><p>The number of stack values used by <code>call</code> and <code>call_indirect</code> matches the number of parameters in the signature of the function being called.</p><p>We saw an example of using the <code>call</code> instruction in the <code>factorial</code> function defined in the &quot;Control Instructions&quot; section.</p><p>We have seen many examples of using the <code>const</code> instruction to push a constant value onto the stack.</p><p>We saw an example of using the <code>drop</code> instruction in the <code>blockWithResult</code> function defined in the &quot;Control Instructions&quot; section.</p><p>We saw an example of using the <code>select</code> instruction in the <code>max</code> and <code>min</code> functions defined in the &quot;Comparison Instructions&quot; section.</p><p>The <code>call_indirect</code> instruction is used in the file <code>demo.wat</code> below. It works in conjunction with the <code>table</code> and <code>elem</code> instructions.</p><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$double</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$half</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>div</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$triple</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><br>  <span class="token comment">;; Create a table of function references named $transforms</span><br>  <span class="token comment">;; that holds at most three elements.</span><br>  <span class="token comment">;; Note that this is at the module level, not inside a function.</span><br>  <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token variable">$transforms</span> <span class="token number">3</span> funcref<span class="token punctuation">)</span><br><br>  <span class="token comment">;; Set elements in the table starting at offset zero.</span><br>  <span class="token comment">;; Note that this is at the module level, not inside a function.</span><br>  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token variable">$half</span> <span class="token variable">$double</span> <span class="token variable">$triple</span><span class="token punctuation">)</span><br><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"transform"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$value</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$fnIndex</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$transform</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$fnIndex</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><p>Compile this file to <code>demo.wasm</code> by entering <code>wat2wasm demo.wat</code>.</p><p>The file <code>demo.js</code> below uses <code>demo.wasm</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'demo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>transform<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'half ='</span><span class="token punctuation">,</span> <span class="token function">transform</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// using $half function; 1.57</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'double ='</span><span class="token punctuation">,</span> <span class="token function">transform</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// using $double function; 6.28</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'triple ='</span><span class="token punctuation">,</span> <span class="token function">transform</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// using $triple function; 9.42</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="higher-level-languages">Higher Level Languages</h2><p>Code from many programming languages can be compiled to WASM. Currently full support is only available for C, C++, Rust, and AssemblyScript. Experimental support is available for C#, Go, Java, Kotlin, Python, Swift, TypeScript, and a few other less commonly used languages.</p><p>In order to run WASM code that was compiled from another language, the runtime of the language must be included. Rust is a great choice for targeting WASM because it has a very small runtime compared to options like Python, so it loads faster. One reason Rust is able to ship a small runtime is that it does not need to include code to perform garbage collection.</p><p>A reason to prefer Rust over languages like C and C++ is that the Rust compiler makes certain kinds of error impossible, such as those related to memory management and access.</p><p>Tools for compiling Rust code to WebAssembly include <a href="https://rustwasm.github.io/wasm-pack/?v=1.0.15" rel="noopener" target="_blank">wasm-pack</a> and <a href="https://www.secondstate.io/articles/ssvmup/?v=1.0.15" rel="noopener" target="_blank">ssvmup</a> The ssvmup tool was inspired by wasm-pack and has explicit support for Deno. Also see the support for Rust in the <a href="https://parceljs.org/rust.html?v=1.0.15" rel="noopener" target="_blank">Parcel bundler</a>!</p><p>TODO: Demonstrate using emscripten to compile C code to WASM.</p><h2 id="rust-with-numbers">Rust With Numbers</h2><p>Rust functions that only use numbers can be compiled to WASM and called from JavaScript without using tools like wasm-pack or wasm-bindgen.</p><p>Let's implement the same <code>sum</code> and <code>distance</code> functions we saw earlier, but do so using Rust instead of WAT. Where are the steps assuming Rust has already been installed.</p><ol><li><p><code>cargo new --lib rust-math</code></p></li><li><p>Edit <code>Cargo.toml</code> and add the following:</p><pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span><br><span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">'cdylib'</span><span class="token punctuation">]</span></code></pre></li><li><p>Edit <code>src/lib.rs</code> and change the contents to the following:</p><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sum</span><span class="token punctuation">(</span>n1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> n2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    n1 <span class="token operator">+</span> n2<br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">distance</span><span class="token punctuation">(</span>x1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> y1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> x2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> y2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre></li><li><p>To generate a <code>.wasm</code> file from the Rust code, enter <code>cargo build --target wasm32-unknown-unknown</code></p></li><li><p>To install the <code>wasm-nm</code> tool for listing the symbols exported by a <code>.wasm</code> file, enter <code>cargo install wasm-nm</code> The symbols <code>sum</code> and <code>distance</code> will be output with an &quot;e&quot; in front of them for &quot;export&quot;.</p></li><li><p>To see the exported symbols, enter <code>wasm-nm target/wasm32-unknown-unknown/debug/rust_math.wasm</code></p></li><li><p>Modify the <code>index.js</code> file created earlier to pass the file path of this <code>.wasm</code> file to the fetch function which is <code>rust-math/target/wasm32-unknown-unknown/debug/rust_math.wasm</code>.</p></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output. There be an error message saying that <code>distance2</code> is not a function which is expected because the Rust code only defines the <code>sum</code> and <code>distance</code> functions.</p></li></ol><h2 id="calling-javascript-functions-from-rust">Calling JavaScript functions from Rust</h2><p>WASM code written in a language other than JavaScript can call custom JavaScript functions. Let's look at an example.</p><ol><li><p>Add the following at the beginning of <code>index.js</code>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n <span class="token operator">**</span> <span class="token number">3</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n \<span class="token operator">*</span> n<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> importObject <span class="token operator">=</span> <span class="token punctuation">{</span>env<span class="token operator">:</span> <span class="token punctuation">{</span>cube<span class="token punctuation">,</span> square<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></li><li><p>Pass <code>importObject</code> as the second argument to <code>WebAssembly.instantiateStreaming</code> as follows:</p><pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span>wasmPath<span class="token punctuation">)</span><span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code></pre></li><li><p>Define the function signatures in <code>rust_math/src/lib.rs</code> as follows:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span><br>  <span class="token keyword">fn</span> <span class="token function-definition function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br>  <span class="token keyword">fn</span> <span class="token function-definition function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Call these functions like normal Rust functions, but call them inside an <code>unsafe</code> block since the Rust compiler cannot guarantee that they are safe. For example:</p><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sum_of_square_and_cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> result<span class="token punctuation">;</span><br>    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><br>        result <span class="token operator">=</span> <span class="token function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    result<br><span class="token punctuation">}</span></code></pre></li><li><p>Rebuild the <code>.wasm</code> file by entering <code>cargo build --target wasm32-unknown-unknown</code></p></li><li><p>Verify the symbols that are imported by entering <code>wasm-nm target/wasm32-unknown-unknown/debug/rust_math.wasm</code> The symbols <code>cube</code> and <code>square</code> will be output with an &quot;i&quot; in front of them for &quot;import&quot;.</p></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output.</p></li></ol><h2 id="rust-with-more-types">Rust With More Types</h2><p>The wasm-bindgen tool makes it possible to compile Rust functions that use non-numeric types to WASM. It also enables calling built-in JavaScript functions such as <code>alert</code> and <code>console.log</code>. wasm-bindgen provides a Rust library and a CLI tool. The Rust library provides macros that generate the Rust code required to serialize and deserialize Rust data types. The CLI tool generates JavaScript code that wraps the WASM code as an ES module which makes it easier to consume in a web app.</p><p>Let's implement an example where non-numeric types are passed from JavaScript to Rust functions and non-numeric types are returned.</p><p>The wasm-pack CLI tool makes using wasm-bindgen easier, so we will also use that. This tool:</p><ul><li>It executes a Cargo command to compile Rust code to WASM.</li><li>It calls wasm-bindgen to generate an ES module that wraps usage of the WASM code.</li><li>It can invoke the wasm-opt tool to optimize the WASM code.</li><li>It can generate a <code>package.json</code> file needed to deploy the ES module and WASM code as an npm package.</li><li>It generates TypeScript type definitions for the exported functions and types in a <code>.d.ts</code> file that can be used by calling TypeScript code to provide type checking.</li></ul><ol><li><p>Install wasm-pack by entering the following command:</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf <span class="token operator">|</span> <span class="token function">sh</span></code></pre></li><li><p>Enter <code>cargo new --lib wasm-bindgen-demo</code></p></li><li><p>Enter <code>cd wasm-bindgen-demo</code>.</p></li><li><p>Edit <code>Cargo.toml</code> and add the following dependency.</p><pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span><br><span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">'cdylib'</span><span class="token punctuation">]</span><br><br><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span><br><span class="token key property">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">"0.2.70"</span></code></pre></li><li><p>Edit <code>src/lib.rs</code> and change the contents to the following:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">alert</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token attribute attr-name">#[wasm_bindgen(js_namespace = console)]</span><br>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// This makes functions define in JavaScript available in Rust.</span><br><span class="token attribute attr-name">#[wasm_bindgen(raw_module = <span class="token string">"/index.js"</span>)]</span><br><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">greet</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Hello, {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token attribute attr-name">#[derive(Debug)]</span><br><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Color</span> <span class="token punctuation">{</span><br>    <span class="token keyword">pub</span> red<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span><br>    <span class="token keyword">pub</span> green<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span><br>    <span class="token keyword">pub</span> blue<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[wasm_bindgen(js_name = getColor)]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_color</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Color</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> color <span class="token operator">=</span> <span class="token class-name">Color</span> <span class="token punctuation">{</span><br>        red<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        green<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span><br>        blue<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"color = {:?}"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    color<br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[wasm_bindgen(js_name = getPowers)]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_powers</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span> <span class="token punctuation">{</span><br>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Getting powers of {} ..."</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property">vec!</span><span class="token punctuation">[</span>n<span class="token punctuation">,</span> n<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span><br><br><br><span class="token comment">// This Rust function calls custom JavaScript functions.</span><br><span class="token attribute attr-name">#[wasm_bindgen(js_name = sumOfSquareAndCube)]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sum_of_square_and_cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    <span class="token function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Enter <code>wasm-pack build --dev --target web</code></p></li><li><p>Create <code>index.js</code> with the following content:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> init<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  Color<span class="token punctuation">,</span><br>  getColor<span class="token punctuation">,</span><br>  getPowers<span class="token punctuation">,</span><br>  greet<br><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./pkg/wasm_bindgen_demo.js'</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n <span class="token operator">**</span> <span class="token number">3</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">'World'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color ='</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color instanceof Color?'</span><span class="token punctuation">,</span> color <span class="token keyword">instanceof</span> <span class="token class-name">Color</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color.red ='</span><span class="token punctuation">,</span> color<span class="token punctuation">.</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color.green ='</span><span class="token punctuation">,</span> color<span class="token punctuation">.</span>green<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color.blue ='</span><span class="token punctuation">,</span> color<span class="token punctuation">.</span>blue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span><br><br>  <span class="token keyword">const</span> powers <span class="token operator">=</span> <span class="token function">getPowers</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a UIntArray</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'powers ='</span><span class="token punctuation">,</span> powers<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [3, 9, 27]</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'square + cube ='</span><span class="token punctuation">,</span> <span class="token function">sumOfSquareAndCube</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 12</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Create <code>index.html</code> with the following content:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>See the console.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output.</p></li></ol><p>TODO: How can Rust call custom JavaScript functions when using wasm-bindgen TODO: instead of <code>WebAssembly.instantiateStreaming</code>? TODO: See <a href="https://rustwasm.github.io/docs/wasm-bindgen/examples/import-js.html">https://rustwasm.github.io/docs/wasm-bindgen/examples/import-js.html</a>!</p><h2 id="c-with-emscripten">C With Emscripten</h2><p>To install Emscripten, browse <a href="https://emscripten.org/docs/getting_started/downloads.html?v=1.0.15" rel="noopener" target="_blank">Download and install</a> and follow the instructions for installing using emsdk. This will result in the <code>emcc</code> executable being in your <code>PATH</code>.</p><p>To compile a C source to WASM and generate JavaScript that invokes it, enter <code>emcc {name}.c -o {name}.js</code>. To run this, install Node.js and enter <code>node {name}.js</code>.</p><h2 id="linear-memory">Linear Memory</h2><p>TODO: Resume here</p><p>&quot;Linear memory&quot; can be used to share data across programming languages without the overhead of copying values. Linear memory is also used by libraries such as wasm-bindgen to enable passing non-numeric values to functions and returning non-numeric values from them.</p><p>From <a href="https://rustwasm.github.io/book/game-of-life/implementing.html?v=1.0.15" rel="noopener" target="_blank">Implementing Conway's Game of Life</a>, &quot;As a general rule of thumb, a good JavaScript/WebAssembly interface design is often one where large, long-lived data structures are implemented as Rust types that live in the WebAssembly linear memory, and are exposed to JavaScript as opaque handles. JavaScript calls exported WebAssembly functions that take these opaque handles, transform their data, perform heavy computations, query the data, and ultimately return a small, copy-able result. By only returning the small result of the computation, we avoid copying and/or serializing everything back and forth between the JavaScript garbage-collected heap and the WebAssembly linear memory.&quot;</p><p>To use this approach, WASM code allocates space and provides functions that return a pointer to the space and the size of the space. Languages that wish to use the space call these functions and map their own data to it. For example, JavaScript code can create a typed array such as <code>Float64Array</code> that uses the same space. It can then set and get elements in the array to write and read the linear memory that is available in the WASM code. Note that it is not possible to allocate space outside the WASM code and get WASM code to share it.</p><p>Let's walk through an example that demonstrates this. The code is available in the GitHub repo <a href="https://github.com/mvolkmann/wasm-rust-linear-memory?v=1.0.15" rel="noopener" target="_blank">wasm-rust-linear-memory</a>. TODO: Why did you need to use wasm-bindgen in this example TODO: since it only uses numbers?</p><h2 id="updating-dom-from-rust">Updating DOM from Rust</h2><p>See <a href="https://github.com/mvolkmann/wasm-bind-demo/blob/main/src/lib.rs">https://github.com/mvolkmann/wasm-bind-demo/blob/main/src/lib.rs</a> which uses the web-sys crate.</p><h2 id="parallel-wasm">Parallel WASM</h2><p>TODO: Show how to run multiple WASM functions in parallel in a web browser TODO: using WebWorkers.</p><p>A <code>SharedArrayBuffer</code> can be mapped to WASM linear memory and used to share data between the main thread and the web workers. This is much more efficient that message passing. See the code in wasm/wasm-web-workers. However, I was not able to get this to work in current browsers, without setting feature flags.</p><p>TODO: Can they update the same linear memory in order to divide a large task TODO: like rotating points?</p><h2 id="wasm-binary-format">WASM Binary Format</h2><p>WASM binary files have the extension <code>.wasm</code>. They begin with four bytes that identify the file as WASM. The hex values are <code>0061736d</code> which is zero followed by the ASCII characters &quot;asm&quot;. This is followed by a four byte integer in little endian format that specifies the WASM version which is currently <code>01000000</code> for version 1.</p><p>The remainder of the file is divided into 12 sections.</p><table><thead><tr><th>Section Name</th><th>Description</th></tr></thead><tbody><tr><td>type</td><td>describes function signatures (parameter and return types)</td></tr><tr><td>import</td><td>describes imports from other modules including functions, tables, memory, and global variables</td></tr><tr><td>func</td><td>stores a list of indexes into the type section for each function defined in this module</td></tr><tr><td>table</td><td>used by the <code>call_indirect</code> instruction for function pointers</td></tr><tr><td>mem</td><td>holds the lower and upper limits on the number of 64KB pages of linear memory that will be used</td></tr><tr><td>global</td><td>holds the type, mutability, and initial value of all global variables</td></tr><tr><td>export</td><td>describes all the functions, tables, memory, and global variables that are exported for other modules to use</td></tr><tr><td>start</td><td>holds the index of the main/starting function if there is one (for running outside web browsers)</td></tr><tr><td>elem</td><td>holds data used to select a function from a table by the <code>call_indirect</code> instruction</td></tr><tr><td>code</td><td>holds the local variables and code for each function defined in the module</td></tr><tr><td>data</td><td>holds data used to initialize the linear memory used by the module</td></tr><tr><td>custom</td><td>can store arbitrary data such a debugging information and data used by third party extensions</td></tr></tbody></table><h2 id="assemblyscript">AssemblyScript</h2><p><a href="https://www.assemblyscript.org?v=1.0.15" rel="noopener" target="_blank">AssemblyScript</a> is a programming language designed to compile to WASM.</p><p>AssemblyScript is a variant of TypeScript. Its source files use the <code>.ts</code> file extension. Semicolons at the ends of statements are optional.</p><p>AssemblyScript includes &quot;a relatively small memory management and garbage collection runtime.&quot;</p><p>The only supported types are:</p><ul><li>boolean <code>bool</code></li><li>signed integer types <code>i8</code>, <code>i16</code>, <code>i32</code> and <code>i64</code></li><li>unsigned integer types <code>u8</code>, <code>u16</code>, <code>u32</code> and <code>u64</code></li><li>floating point types <code>f32</code> and <code>f64</code>.</li><li>platform-specific integers <code>isize</code> and <code>usize</code></li><li>128-bit vector <code>v128</code></li><li>opaque host reference <code>anyref</code></li><li><code>void</code> for functions with no return value (cannot omit return type)</li><li><code>Array</code></li><li><code>ArrayBuffer</code></li><li><code>DataView</code></li><li><code>Map</code></li><li><code>Math</code></li><li><code>Set</code></li><li><code>string</code>?</li><li><code>String</code></li><li>typed arrays <code>Int{size}Array</code>, <code>UInt{size}Array</code>, and <code>Float{size}Array</code></li></ul><p>Macro types</p><ul><li><code>indexof&lt;T&gt;</code></li><li><code>native&lt;T&gt;</code></li><li><code>returnof&lt;T&gt;</code></li><li><code>valueof&lt;T&gt;</code></li></ul><p>Supported math instructions are described <a href="https://www.assemblyscript.org/stdlib/math.html?v=1.0.15" rel="noopener" target="_blank">here</a>.</p><p>The easiest way to create an AssemblyScript project is to:</p><ul><li>Enter <code>npx asinit {project-name}</code></li><li>Enter <code>cd {project-name}</code></li><li>Enter <code>npm install</code></li><li>Edit the implementation in <code>assembly/index.ts</code></li><li>Edit the tests in <code>tests/index.ts</code></li><li>Enter <code>npm run asbuild</code> to build the project.</li><li>Enter <code>npm test</code> to run the tests.</li></ul><p>To use the functions exported in <code>assembly/index.ts</code> in a web app:</p><ol><li><p>Create <code>index.html</code> containing the following:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>See output in the DevTools console.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Create <code>main.js</code> containing the following:</p><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><br>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'build/optimized.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    imports<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>add<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result ='</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Start a local HTTP file server.</p></li><li><p>Browse localhost:{port}.</p></li></ol><p>Alternatively, install the AssemblyScript compiler by entering <code>npm install -g assemblyscript</code>.</p><p>To compile an AssemblyScript source file to a <code>.wat</code> file:</p><pre class="language-bash"><code class="language-bash">asc <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.ts -t <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.wat</code></pre><p>To compile an AssemblyScript source file to a <code>.wasm</code> file, specifying a level of optimization:</p><pre class="language-bash"><code class="language-bash">asc <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.ts -b <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.wasm -O3</code></pre><p>Here are the steps to implement a <code>distance</code> function in AssemblyScript that computes the distance between two points and call it from JavaScript:</p><ol><li><p>Create the file <code>math.ts</code> containing the following:</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">distance</span><span class="token punctuation">(</span>x1<span class="token operator">:</span> f64<span class="token punctuation">,</span> y1<span class="token operator">:</span> f64<span class="token punctuation">,</span> x2<span class="token operator">:</span> f64<span class="token punctuation">,</span> y2<span class="token operator">:</span> f64<span class="token punctuation">)</span><span class="token operator">:</span> f64 <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Compile this to WASM by entering <code>asc math.ts -b math.wasm -O3</code></p></li><li><p>Create the file <code>index.js</code> containing the following:</p><pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'math.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>distance<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Create the file <code>index.html</code> containing the following:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>result = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse <code>localhost:{port}</code> where port is the port on which the local server is listening.</p></li></ol><p>Another approach for implementing tests of AssemblyScript functions is to use <a href="https://github.com/jtenner/as-pect?v=1.0.15" rel="noopener" target="_blank">as-pect</a> tool.</p><p>AssemblyScript can call WASI functions using the <a href="https://github.com/jedisct1/as-wasi?v=1.0.15" rel="noopener" target="_blank">as-wasi</a> library.</p><p>The memory management code added to <code>.wasm</code> files generated from AssemblyScript adds about 2K bytes. This can be removed if not needed.</p><h2 id="webassembly-system-interface-(wasi)">WebAssembly System Interface (WASI)</h2><p>The <a href="https://wasi.dev?v=1.0.15" rel="noopener" target="_blank">WebAssembly System Interface (WASI)</a> defines a way to communicate with the system that focuses on portability and security. This includes things like stdout/stdin, the file system, and network resources.</p><p>Adding these features makes WASM useful outside of web browsers. Motivations for using WASM in this way include performance, safety, and the ability to combine code compiled from many higher-level programming languages.</p><p>WASM code using WASI is portable across operating systems.</p><p>Implementations of WASI include <a href="https://wasmtime.dev?v=1.0.15" rel="noopener" target="_blank">Wasmtime</a> (developed at Mozilla) and <a href="https://bytecodealliance.github.io/lucet/?v=1.0.15" rel="noopener" target="_blank">Lucet</a> (developed at Fastly). There is a <a href="https://github.com/bytecodealliance/lucet/issues/607?v=1.0.15" rel="noopener" target="_blank">plan</a> to merge Lucet with Wasmtime.</p><p>Rust code compiled to WASM can use WASI features because WASI capabilities are included in Rust standard libraries. For example, the <code>println!</code> macro can be used. To compile a Rust project to WASM with WASI support, enter <code>cargo build --target wasm32-unknown-wasi</code>. TODO: What are the options for the three parts of the target string?</p><p>TODO: Try reading and writing files using Wasmtime. TODO: Try sending an HTTP GET request using Wasmtime.</p><p>C/C++ code compiled to WASM can use WASI features because it will use wasi-sysroot which is a wasi-core implementation of the libc library.</p><p>WASM code using WASI can also be run in web browsers using polyfills. For example, such a polyfill would turn the WASI version of a Rust <code>println!</code> into a call to <code>console.log</code>.</p><p>Security in WASI is implemented with sandboxing, similar to Deno. Perhaps Deno modeled their security after WASI. When running WASM code that uses WASI features, file system and network resources to be accessed must be specified. Access to unspecified resources are not permitted. This is referred to as &quot;Capability Space Security&quot;.</p><p>Platform-specific versions of tools like Wasmtime can execute platform-independent WASM code that uses WASI features. They handle translation into platform-specific calls.</p><p>WASI functions are made available to WASM binaries through imports that are passed in. This allows passing in platform-specific versions of these functions. It also supports limiting what the WASM code can do by not passing in every function.</p><p>Security is also controlled at the module level by passing allowed functions and file descriptors between them.</p><p>Remaining work on WASI includes defining support for asynchronous I/O, file watching, and file locking.</p><h2 id="running-wasm-outside-browsers">Running WASM Outside Browsers</h2><p>There are currently three tools for running WASM code outside a web browser. Each is described below.</p><h3 id="wasm3"><a href="https://github.com/wasm3/wasm3?v=1.0.15" rel="noopener" target="_blank">WASM3</a></h3><p>To install this in macOS, install Homebrew and enter <code>brew install wasm3</code>. Installing for other platforms is more complicated. For details, visit the WASM3 site linked above.</p><p>To call functions defined in a <code>.wasm</code> file from a REPL, enter <code>wasm3 --repl {path-to-wasm-file}</code>. Then enter function names followed by arguments.</p><p>To call functions directly, not using a REPL, enter <code>wasm3 --func {function-name} {path-to-wasm-file} {arguments}</code>.</p><p>TODO: I can't get either of these approaches to work on a <code>.wasm</code> file TODO: I created from a Rust programing using TODO: <code>rustc {path-to-rust-file} --target wasm32-wasi</code>!</p><h3 id="wasmtime"><a href="https://wasmtime.dev?v=1.0.15" rel="noopener" target="_blank">Wasmtime</a></h3><p>To install this in Linux or macOS:</p><ol><li>Enter <code>curl https://wasmtime.dev/install.sh -sSf | bash</code></li><li>Open a new terminal that will have <code>wasmtime</code> in <code>PATH</code>.</li></ol><p>Visit the Wasmtime site linked above for instructions to install in Windows.</p><p>One way to demonstrate running this is to compile Rust code to <a href="https://wasi.dev?v=1.0.15" rel="noopener" target="_blank">WebAssembly System Interface (WASI)</a>. To do so, enter <code>rustc {path-to-rust-file} --target wasm32-wasi</code>. This produces a <code>.wasm</code> file. The Rust code can use features such as the <code>println!</code> macro to produce output. For example:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>To execute a <code>.wasm</code> file, enter <code>wasmtime {path-to-wasm-file}</code>.</p><p>TODO: Is this correct! To execute a <code>.wast</code> test file, enter <code>wasmtime wast {path-to-wast-file}</code>.</p><p>Unlike wasm3, Wasmtime does not provide a REPL or support running a specific function from the command-line.</p><h3 id="webassembly-micro-runtime-(wamr)"><a href="https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.15" rel="noopener" target="_blank">WebAssembly Micro Runtime (WAMR)</a></h3><p>Instructions for installing this tool on various platforms can be found at <a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/build_wamr.md?v=1.0.15" rel="noopener" target="_blank">build_wamr.md</a>.</p><p>To install this in macOS:</p><ul><li>Browse <a href="https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.15" rel="noopener" target="_blank">wasm-micro-runtime</a>.</li><li>Click the &quot;Code&quot; button and &quot;Download ZIP&quot;.</li><li>Unzip the downloaded file.</li><li>cd into its directory and into <code>product-mini/platforms/darwin</code>.</li><li>Install the <code>cmake</code> command with <code>brew install cmake</code>.</li><li>Enter <code>mkdir build</code></li><li>Enter <code>cd build</code></li><li>Enter <code>cmake ..</code></li><li>Enter <code>make</code> to create the executable <code>iwasm</code> in the current directory.</li><li>Copy <code>iwasm</code> to a directory listed in the <code>PATH</code> environment variable.</li></ul><p>To run a <code>.wasm</code> file, enter <code>.iwasm {path-to-wasm-file}</code></p><h2 id="demos">Demos</h2><ul><li><a href="https://github.com/mvolkmann/wasm-bind-demo">https://github.com/mvolkmann/wasm-bind-demo</a></li><li><a href="https://github.com/mvolkmann/wasm-demo">https://github.com/mvolkmann/wasm-demo</a></li><li><a href="https://github.com/mvolkmann/wasm-rust-linear-memory">https://github.com/mvolkmann/wasm-rust-linear-memory</a></li></ul><h2 id="wasm-pack">wasm-pack</h2><p>To install wasm-pack in Linux or macOS, enter the following:</p><pre class="language-bash"><code class="language-bash">cargo <span class="token function">install</span> wasm-pack</code></pre><p>To create a project that uses wasm-pack::</p><ol><li><p><code>wasm-pack new my-wasm</code></p><p>TODO: Describe what this puts in Cargo.toml.</p></li><li><p><code>cd my-wasm</code></p></li><li><p><code>wasm-pack build --target web</code></p><p>TODO: Describe the files this produces.</p></li><li><p>Create the following <code>index.html</code> file:</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>WASM Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>      <span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token keyword">default</span> <span class="token keyword">as</span> wasm<span class="token punctuation">,</span> greet<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./pkg/my_wasm.js'</span><span class="token punctuation">;</span><br>      <span class="token function">wasm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server. There are many ways to do this, including using Deno. TODO: Is there any reason to use wasm-server instead because it supports the WASM MIME type? TODO: Maybe this is no longer an issue. To run a simple Deno HTTP file server:</p><ol><li>Install <a href="https://deno.land/#installation?v=1.0.15" rel="noopener" target="_blank">Deno</a>.</li><li>Enter <code>deno install --allow-net --allow-read https://deno.land/std@0.83.0/http/file_server.ts</code></li><li>Enter <code>file_server .</code></li><li>Browse <code>localhost:4507</code></li></ol></li></ol><h2 id="ssvmup">ssvmup</h2><p>To compile a <code>.rs</code> file to WebAssembly:</p><ol><li><p>Install ssvmup by entering the following command (one time only):</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> https://raw.githubusercontent.com/second-state/ssvmup/master/installer/init.sh -sSf <span class="token operator">|</span> <span class="token function">sh</span></code></pre></li><li><p>Create a new Rust library (referred to as a &quot;crate&quot;) by entering <code>cargo new --lib my-crate</code></p></li><li><p><code>cd my-crate</code></p></li><li><p>Edit <code>src/lib.rs</code> and add code there. For example:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">factorial</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u64</span> <span class="token punctuation">{</span><br>    <span class="token keyword">match</span> x <span class="token punctuation">{</span><br>        <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span><br>        _ <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Edit the generated <code>Cargo.toml</code> file which is similar to a Node.js <code>package.json</code> file. For example:</p><pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span><br><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"my-crate"</span><br><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span><br><span class="token key property">authors</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"R. Mark Volkmann &lt;me@gmail.com>"</span><span class="token punctuation">]</span><br><span class="token key property">edition</span> <span class="token punctuation">=</span> <span class="token string">"2018"</span><br><span class="token key property">description</span> <span class="token punctuation">=</span> <span class="token string">"sample project using ssvmup"</span><br><span class="token key property">license</span> <span class="token punctuation">=</span> <span class="token string">"MIT/Apache-2.0"</span><br><span class="token comment">#repository = "https://github.com/mvolkmann/my-crate"</span><br><br><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span><br><span class="token comment"># cdylib exports a C-style interface for a Rust dynamic library.</span><br><span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"cdylib"</span><span class="token punctuation">]</span><br><br><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span><br><span class="token key property">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">"=0.2.61"</span></code></pre></li><li><p>Enter <code>ssvmup build --target deno</code> This creates a <code>pkg</code> directory containing <code>package.json</code>, a <code>.wasm</code> file, and a <code>.js</code> file that reads the <code>.wasm</code> file and prepares it for use in JavaScript code.</p></li><li><p>Copy the generated <code>pkg</code> directory to the directory containing the Deno code that wishes to use it.</p></li><li><p>Import the exported functions with a line like the following:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>factorial<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./pkg/my_crate.js'</span><span class="token punctuation">;</span></code></pre></li><li><p>Call the imported functions.</p><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">4n</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "n" suffix makes it BitInt</span></code></pre></li></ol><p>TODO: Invent a programming language that translated to WAT TODO: more directly than a language like Rust.</p></article>