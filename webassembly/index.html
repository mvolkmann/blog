<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>WebAssembly</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a><ol><li><a href="#numeric-instructions">Numeric Instructions</a></li><li><a href="#bitwise-instructions">Bitwise Instructions</a></li><li><a href="#logical-instructions">Logical Instructions</a></li><li><a href="#comparison-instructions">Comparison Instructions</a></li><li><a href="#conversion-instructions">Conversion Instructions</a></li><li><a href="#basic-instructions">Basic Instructions</a></li><li><a href="#wasm3">WASM3</a></li><li><a href="#wasmtime">Wasmtime</a></li><li><a href="#webassembly-micro-runtime-(wamr)">WebAssembly Micro Runtime (WAMR)</a></li></ol></li><li><a href="#vs-code">VS Code</a></li><li><a href="#only-numbers">Only Numbers</a></li><li><a href="#implementing-directly">Implementing Directly</a></li><li><a href="#wasm-instructions">WASM Instructions</a></li><li><a href="#variable-instructions">Variable Instructions</a></li><li><a href="#control-instructions">Control Instructions</a></li><li><a href="#memory-instructions">Memory Instructions</a></li><li><a href="#higher-level-languages">Higher Level Languages</a></li><li><a href="#rust-with-numbers">Rust With Numbers</a></li><li><a href="#calling-javascript-functions-from-rust">Calling JavaScript functions from Rust</a></li><li><a href="#rust-with-more-types">Rust With More Types</a></li><li><a href="#linear-memory">Linear Memory</a></li><li><a href="#updating-dom-from-rust">Updating DOM from Rust</a></li><li><a href="#assemblyscript">AssemblyScript</a></li><li><a href="#webassembly-system-interface-(wasi)">WebAssembly System Interface (WASI)</a></li><li><a href="#running-wasm-outside-browsers">Running WASM Outside Browsers</a></li><li><a href="#demos">Demos</a></li><li><a href="#wasm-pack">wasm-pack</a></li><li><a href="#ssvmup">ssvmup</a></li></ol></nav></aside><article><h2 id="overview">Overview</h2><p>WebAssembly (abbreviated WASM) is a binary instruction format for a stack-based virtual machine. Other popular stack-based virtual machines include the Java Virtual Machine (JVM) and the .NET Common Language Runtime (CLR).</p><p>WASM code can be run in modern web browsers including Chrome, Edge, Firefox, and Safari (not Internet Explorer). It can also be run outside of web browsers using tools such as <a href="https://github.com/wasm3/wasm3?v=1.0.10" rel="noopener" target="_blank">WASM3</a>, <a href="https://wasmtime.dev?v=1.0.10" rel="noopener" target="_blank">Wasmtime</a>, <a href="https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.10" rel="noopener" target="_blank">WebAssembly Micro Runtime (WAMR)</a>.</p><p>There are two primary reasons to run WASM code from a web browser. The first is that it typically executes much faster than equivalent code written in JavaScript. The second is that it enables writing code in any language that can be compiled to WASM as an alternative to JavaScript.</p><p>The primary reason to run WASM code outside a web browser is that it enables targeting any platform that supports WASM. This is similar to the rationale for using Java, whose virtual machine is supported by many platforms.</p><p>WASM can also be compiled to native executables that run on x86 and ARM processors.</p><h2 id="vs-code">VS Code</h2><p>VS Code has several extensions for working with WASM code. The most popular is &quot;WebAssembly&quot; with the description &quot;WebAssembly Toolkit for VSCode&quot;.</p><h2 id="only-numbers">Only Numbers</h2><p>Currently WASM only supports the number types <code>i32</code>, <code>i64</code>, <code>f32</code>, and <code>f64</code>. But the <a href="https://github.com/WebAssembly/interface-types?v=1.0.10" rel="noopener" target="_blank">Interface Types proposal</a> seeks to change this. This can be accomplished by enabling supported programming languages to serialize non-numeric values to linear memory as an array of i32 values. Other supported languages can then deserialize values from the array. This enables each language to use its own representation of the data types.</p><p>WASM doesn't assume number values are signed. However, specific instructions performed on them do. For example, the instruction to add two i64 signed values is <code>i64.add</code> and the for unsigned values is <code>i64.add_u</code>.</p><h2 id="implementing-directly">Implementing Directly</h2><p>While code from many programming languages can be compiled to WASM, it is also possible to directly implement the code.</p><p>WASM has a binary format and a text (intermediate form) format. Files in the binary format have the extension <code>.wasm</code>. Files in the text format have the extension <code>.wat</code>.</p><p>The text format has two styles, linear and S-expressions. The linear format places instructions on separate lines. The S-expression format uses parentheses, similar to LISP, representing a tree of nodes. The first value in each expression indicates the node type. The remaining values are attributes or child nodes.</p><p>A <code>.wat</code> file can be compile to a <code>.wasm</code> file using the <code>wat2wasm</code> tool. A <code>.wasm</code> file can be de-compiled to a <code>.wat</code> file using the <code>wasm2wat</code> tool. Note that this outputs the linear style. Also see <code>.wast</code> files that are for writing tests.</p><p>The <code>wasm-nm</code> tool outputs the symbols that are export from and imported into a <code>.wasm</code> file. To install this tool, enter <code>cargo install wasm-nm</code>. To run it, enter <code>wasm-nm {file-path}.wasm</code>. The names of exported symbols are preceded by &quot;e &quot; and the names of imported symbols are preceded by &quot;i &quot;.</p><p>Every <code>.wat</code> file contains a single, top-level S-expression that defines a module. Modules can define functions that are callable from JavaScript. These definitions have the syntax <code>(func {signature} {locals} {body})</code>. The signature defines the function name, its parameter types, and its return type. In functions that do not return a value, the return type is omitted. Locals defines local variable names and their types. The body is a list of instructions that implement the function.</p><p>Currently only four types are supported, <code>i32</code>, <code>i64</code>, <code>f32</code>, and <code>f64</code>. These match number types from Rust. Other types such as strings and structs currently must be serialized into these number types and deserialized from them. Tools such as wasm_bindgen for Rust generate code that does this for you.</p><p>Parameters and local variables are accessed by their position in the signature using zero-based indexes. The text format also allows functions, parameters, and local variables to have names that start with <code>$</code>. These can be referenced by name, but the names are compiled away in favor of indexes.</p><p>Operations get their arguments from the top values on the stack. The <code>local.get {index | name}</code> instruction gets the value of a parameter of local variable and places it on the stack. The <code>local.set {index | name} {value}</code> instruction sets value of a local variable. The <code>{type}.const {value}</code> instruction pushes a constant value on the stack. When a function exists, its return value is the top value on the stack.</p><p>Single line comments begin with <code>;;</code> and extend to the end of the line. Multi-line comments begin with <code>(;</code> and end with <code>;)</code>. This makes it easy to comment out an S-expression because <code>;</code> characters just need to be added inside the opening and closing parentheses. It also means that a winking smiley face is the closing delimiter!</p><p>Here are examples of functions. The first takes two numbers and returns their sum. The rest compute the distance between two points using the formula <code>sqrt(dx**2 + dy**2)</code>. Three versions are presented to show different approaches. This code is available in the GitHub repo <a href="https://github.com/mvolkmann/wasm-demo/?v=1.0.10" rel="noopener" target="_blank">wasm-demo</a>.</p><ol><li>Create the file <code>math.wat</code> containing the following:</li></ol><pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sum</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$lhs</span><br>    <span class="token keyword">local</span>.get <span class="token variable">$rhs</span><br>    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"sum"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses the "linear" format.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">get_local</span> <span class="token variable">$x1</span><br>    <span class="token keyword">get_local</span> <span class="token variable">$x2</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>    <span class="token keyword">tee_local</span> <span class="token variable">$x1</span> <span class="token comment">;; reusing $x1 to hold temporary dx value</span><br>    <span class="token keyword">get_local</span> <span class="token variable">$x1</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token keyword">get_local</span> <span class="token variable">$y1</span><br>    <span class="token keyword">get_local</span> <span class="token variable">$y2</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>    <span class="token keyword">tee_local</span> <span class="token variable">$y1</span> <span class="token comment">;; reusing $y1 to hold temporary dy value</span><br>    <span class="token keyword">get_local</span> <span class="token variable">$y1</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br><br>    <span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>    <span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses S-expressions.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance2</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dx</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dy</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">set_local</span> <span class="token variable">$dx</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x2</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">set_local</span> <span class="token variable">$dy</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y2</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token comment">;; There is no instruction to duplicate the value at</span><br>          <span class="token comment">;; the top of the stack, so we have to do this twice.</span><br>          <span class="token comment">;; See https://github.com/WebAssembly/design/issues/1365.</span><br>          <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$dx</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$dx</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$dy</span><span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$dy</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance2"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">;; This uses even more S-expressions.</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance3</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y1</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$y2</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sqrt</span><br>      <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>add</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">tee_local</span> <span class="token variable">$x1</span> <span class="token comment">;; reusing $x1 to hold temporary dx value</span><br>            <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>              <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$x1</span><span class="token punctuation">)</span><br>              <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$x2</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>          <span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$x1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>        <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>mul</span><br>          <span class="token punctuation">(</span><span class="token keyword">tee_local</span> <span class="token variable">$y1</span> <span class="token comment">;; reusing $y1 to hold temporary dy value</span><br>            <span class="token punctuation">(</span><span class="token keyword">f64<span class="token punctuation">.</span>sub</span><br>              <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$y1</span><span class="token punctuation">)</span><br>              <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$y2</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>          <span class="token punctuation">)</span><br>          <span class="token punctuation">(</span><span class="token keyword">get_local</span> <span class="token variable">$y1</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"distance3"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$distance3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre><ol><li><p>Install the <a href="https://github.com/WebAssembly/wabt?v=1.0.10" rel="noopener" target="_blank">WebAssembly Binary Toolkit (WABT)</a>. This includes a set of command line tools including wat2wasm, wasm2wat, wasm-validate, and wasm-interp. In macOS this can be installed using Homebrew by entering <code>brew install wabt</code>.</p></li><li><p>Enter <code>wat2wasm math.mat</code> to create the binary file <code>math.wasm</code>.</p></li><li><p>Create the JavaScript file <code>index.js</code> that loads the <code>add.wasm</code> and calls the function it defines:</p><pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'math.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>distance<span class="token punctuation">,</span> distance2<span class="token punctuation">,</span> distance3<span class="token punctuation">,</span> sum<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'distance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance1 ='</span><span class="token punctuation">,</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance2 ='</span><span class="token punctuation">,</span> <span class="token function">distance2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'distance3 ='</span><span class="token punctuation">,</span> <span class="token function">distance3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Create the HTML file <code>index.html</code> that includes <code>index.js</code>:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>sum = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sum<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>distance = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>distance<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server. One approach is to install <a href="https://deno.land/">Deno</a> and then enter these commands:</p><pre class="language-bash"><code class="language-bash">deno <span class="token function">install</span> --allow-net --allow-read https://deno.land/std@0.87.0/http/file_server.ts<br>file_server <span class="token builtin class-name">.</span></code></pre></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output.</p></li></ol><h2 id="wasm-instructions">WASM Instructions</h2><p>The tables below summarize the currently supported WASM instructions. Understanding these is only necessary when directly writing WASM code in text format or to understand what compilers for higher level languages like Rust generate.</p><p>For more detail, see the <a href="https://github.com/sunfishcode/wasm-reference-manual/blob/master/WebAssembly.md?v=1.0.10" rel="noopener" target="_blank">WASM Reference Manual</a>.</p><p>The tables use the following abbreviations for substitutions in instruction names:</p><ul><li><code>mm</code> and <code>nn</code> can be <code>32</code> bits or <code>64</code> bits</li><li><code>sx</code> can be <code>u</code> (unsigned) or <code>s</code> (signed)</li></ul><p>As mentioned earlier, there is no instruction for duplicating the top value on the stack. Adding this has been proposed. Thomas Lively provided rationale on why this has not been done.</p><p>&quot;It takes a surprising amount of work and time to spec new instructions and get them implemented in every tool and engine out there. So generally only changes with significant benefits get all the way through the process. Unfortunately that means that there are a lot of &quot;nice to have&quot; proposals, even tiny ones like adding a single dup instruction, that don't make the cut. I'm not saying we'll never add dup, but if we do it will because it solves an important problem so lots of folks agree it's important to add and will be motivated to implement and maintain it throughout the ecosystem.</p><p>This is one of the costs of standards-based work. If WASM were controlled by a single party, it would be easy to add a single instruction like dup. Since it's not, you first have to get a lot of different people with different priorities and opinions to agree that adding dup is both a good idea and worth their time and effort. Because of this extra consensus-building work, the community can have more confidence in the robustness and benefits of the proposals that do make it through the process.&quot;</p><h3 id="numeric-instructions">Numeric Instructions</h3><p>These instructions are prefixed by one of the four supported number types. For example, the instruction to add two <code>f32</code> values is <code>f32.add</code>.</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>abs</code></td><td>absolute value</td></tr><tr><td><code>add</code></td><td>add</td></tr><tr><td><code>ceil</code></td><td>ceiling</td></tr><tr><td><code>copysign</code></td><td>copy sign</td></tr><tr><td><code>div_{sx}</code></td><td>integer divide</td></tr><tr><td><code>div</code></td><td>floating point divide</td></tr><tr><td><code>floor</code></td><td>floor</td></tr><tr><td><code>max</code></td><td>maximum</td></tr><tr><td><code>min</code></td><td>minimum</td></tr><tr><td><code>mul</code></td><td>multiply</td></tr><tr><td><code>ne</code></td><td>not equal</td></tr><tr><td><code>nearest</code></td><td>round floating point to integer</td></tr><tr><td><code>neg</code></td><td>negate</td></tr><tr><td><code>rem_{sx}</code></td><td>remainder</td></tr><tr><td><code>sqrt</code></td><td>square root</td></tr><tr><td><code>sub</code></td><td>subtract</td></tr><tr><td><code>trunc</code></td><td>truncate</td></tr></tbody></table><h3 id="bitwise-instructions">Bitwise Instructions</h3><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>clz</code></td><td>count leading zeros</td></tr><tr><td><code>ctz</code></td><td>count training zeros</td></tr><tr><td><code>popcnt</code></td><td>population count (# of 1 bits)</td></tr><tr><td><code>rotl</code></td><td>rotate left</td></tr><tr><td><code>rotr</code></td><td>rotate right</td></tr><tr><td><code>shl</code></td><td>shift left</td></tr><tr><td><code>shr_{xx}</code></td><td>shift right</td></tr></tbody></table><h3 id="logical-instructions">Logical Instructions</h3><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>and</code></td><td>and</td></tr><tr><td><code>or</code></td><td>or</td></tr><tr><td><code>xor</code></td><td>exclusive or</td></tr></tbody></table><h3 id="comparison-instructions">Comparison Instructions</h3><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>eq</code></td><td>equal</td></tr><tr><td><code>eqz</code></td><td>equal to zero</td></tr><tr><td><code>ge_{sx}</code></td><td>integer greater than or equal</td></tr><tr><td><code>ge</code></td><td>floating point greater than or equal</td></tr><tr><td><code>gt_{sx}</code></td><td>integer greater than</td></tr><tr><td><code>gt</code></td><td>floating point greater than</td></tr><tr><td><code>le_{sx}</code></td><td>integer less than or equal</td></tr><tr><td><code>le</code></td><td>floating point less than or equal</td></tr><tr><td><code>lt_{sx}</code></td><td>integer less than</td></tr><tr><td><code>lt</code></td><td>floating point less than</td></tr></tbody></table><h3 id="conversion-instructions">Conversion Instructions</h3><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>convert</code></td><td>convert integer to floating point</td></tr><tr><td><code>demote</code></td><td>convert f64 to f32</td></tr><tr><td><code>extend</code></td><td>convert i32 to i64</td></tr><tr><td><code>promote</code></td><td>convert f32 to f64</td></tr><tr><td><code>reinterpret</code></td><td>convert from integer to floating point or floating point to integer</td></tr><tr><td><code>trunc</code></td><td>truncate, discarding the least significant bits</td></tr><tr><td><code>wrap</code></td><td>converts i32 to i64, discarding the most significant bits</td></tr></tbody></table><h2 id="variable-instructions">Variable Instructions</h2><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>local.get {local-id}</code></td><td>push local variable onto stack</td></tr><tr><td><code>local.set {local-id}</code></td><td>set local variable from stack and pop</td></tr><tr><td><code>local.tee {local-id}</code></td><td>set local variable from stack and leave on stack</td></tr><tr><td><code>global.get {local-id}</code></td><td>push global variable onto stack</td></tr><tr><td><code>global.set {local-id}</code></td><td>set global variable from stack and pop</td></tr></tbody></table><h2 id="control-instructions">Control Instructions</h2><p>These instructions are expressions, not statements. They result in placing a value on the stack.</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>block {block-type} {instr}*</code></td><td>creates a block of instructions, typically in another instruction such as <code>if</code></td></tr><tr><td><code>loop {block-type} {instr}* end</code></td><td>creates a labeled block for implementing a loop</td></tr><tr><td><code>if</code></td><td>denotes the true block of a conditional</td></tr><tr><td><code>else</code></td><td>denotes the false block of a conditional</td></tr><tr><td><code>end</code></td><td>marks the end of a block for <code>block</code>, <code>if</code>, <code>else</code>, <code>loop</code>, or <code>function</code></td></tr><tr><td><code>br {depth}</code></td><td>unconditional branch; <code>br 0</code> goes to top of loop; <code>br 1</code> exits loop</td></tr><tr><td><code>br_if {depth} {condition}</code></td><td>conditional branch</td></tr><tr><td><code>br_table {table} {default-depth}</code></td><td>branch based on table entry at depth</td></tr><tr><td><code>return</code></td><td>return from function</td></tr><tr><td><code>call {function-id}</code></td><td>call function</td></tr><tr><td><code>call_indirect {type-id}</code></td><td>call function at index in table</td></tr><tr><td><code>unreachable</code></td><td>signals an error (trap) if reached</td></tr></tbody></table><p>Even control flow operates on the stack. For example, the <code>if</code> instruction executes its branch if the value at the top of the stack evaluates to true.</p><p>Here is an example of using an <code>if</code> instruction in a function that returns the largest of two values:</p><pre class="language-wasm"><code class="language-wasm">  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$max</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token comment">;; The first argument specifies the type if expression result.</span><br>    '' The second argument is the <span class="token keyword">result</span> of the condition to be tested.<br>    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>gt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$lhs</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$rhs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$lhs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$rhs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"max"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$max</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>TODO: Demonstrate all the control instructions in a <code>.wat</code> file! TODO: See <a href="https://medium.com/leaningtech/solving-the-structured-control-flow-problem-once-and-for-all-5123117b1ee2">https://medium.com/leaningtech/solving-the-structured-control-flow-problem-once-and-for-all-5123117b1ee2</a>. TODO: Maybe implement the Fibonacci function in multiple ways.</p><h3 id="basic-instructions">Basic Instructions</h3><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>call</code></td><td>calls a function</td></tr><tr><td><code>call_indirect</code></td><td>calls a function at an index in the default table</td></tr><tr><td><code>const</code></td><td>pushes a constant value onto the stack</td></tr><tr><td><code>drop</code></td><td>pops top value from stack and does nothing with it</td></tr><tr><td><code>nop</code></td><td>no operation</td></tr><tr><td><code>select</code></td><td>takes two values and a condition; returns 1st if true and 2nd if false</td></tr></tbody></table><h2 id="memory-instructions">Memory Instructions</h2><p>The <code>load</code> instructions load data from the default linear memory. The <code>store</code> instructions store data into the default linear memory. These instructions are prefixed by the number type to be loaded or stored. In the table below, <code>mem</code> is a memory offset.</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>i{nn}.load {mem}</code></td><td>reads integer value into matching size</td></tr><tr><td><code>i{nn}.load8_{sx} {mem}</code></td><td>reads integer value into 8 bits</td></tr><tr><td><code>i{nn}.load16_{sx} {mem}</code></td><td>reads integer value into 16 bits</td></tr><tr><td><code>i64.load32_{sx} {mem}</code></td><td>reads i64 value into 32 bits</td></tr><tr><td><code>f{nn}.load {mem}</code></td><td>reads floating point value</td></tr><tr><td><code>i{nn}.store {mem}</code></td><td>writes integer value into matching size</td></tr><tr><td><code>i{nn}.store8 {mem}</code></td><td>writes integer value into 8 bits</td></tr><tr><td><code>i{nn}.store16 {mem}</code></td><td>writes integer value into 16 bits</td></tr><tr><td><code>i64.store32 {mem}</code></td><td>writes i64 value into 32 bits</td></tr><tr><td><code>f{nn}.store {mem}</code></td><td>writes floating point value into matching size</td></tr><tr><td><code>memory.grow</code></td><td>increases size of default linear memory</td></tr><tr><td><code>memory.size</code></td><td>returns the size of default linear memory</td></tr></tbody></table><h2 id="higher-level-languages">Higher Level Languages</h2><p>Code from many programming languages can be compiled to WASM. Currently full support is only available for C, C++, and Rust. Experimental support is available for C#, Go, Java, Kotlin, Python, Swift, TypeScript, and a few other less commonly used languages.</p><p>In order to run WASM code that was compiled from another language, the runtime of the language must be included. Rust is a great choice for targeting WASM because it has a very small runtime compared to options like Python, so it loads faster. One reason Rust is able to ship a small runtime is that it does not need to include code to perform garbage collection.</p><p>A reason to prefer Rust over languages like C and C++ is that the Rust compiler makes certain kinds of error impossible, such as those related to memory management and access.</p><p>Tools for compiling Rust code to WebAssembly include <a href="https://rustwasm.github.io/wasm-pack/?v=1.0.10" rel="noopener" target="_blank">wasm-pack</a> and <a href="https://www.secondstate.io/articles/ssvmup/?v=1.0.10" rel="noopener" target="_blank">ssvmup</a> The ssvmup tool was inspired by wasm-pack and has explicit support for Deno. Also see the support for Rust in the <a href="https://parceljs.org/rust.html?v=1.0.10" rel="noopener" target="_blank">Parcel bundler</a>!</p><h2 id="rust-with-numbers">Rust With Numbers</h2><p>Rust functions that only use numbers can be compiled to WASM and called from JavaScript without using tools like wasm-pack or wasm-bindgen.</p><p>Let's implement the same <code>sum</code> and <code>distance</code> functions we saw earlier, but do so using Rust instead of WAT. Where are the steps assuming Rust has already been installed.</p><ol><li><p><code>cargo new --lib rust-math</code></p></li><li><p>Edit <code>Cargo.toml</code> and add the following:</p><pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span><br><span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">'cdylib'</span><span class="token punctuation">]</span></code></pre></li><li><p>Edit <code>src/lib.rs</code> and change the contents to the following:</p><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sum</span><span class="token punctuation">(</span>n1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> n2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    n1 <span class="token operator">+</span> n2<br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">distance</span><span class="token punctuation">(</span>x1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> y1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> x2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> y2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre></li><li><p>To generate a <code>.wasm</code> file from the Rust code, enter <code>cargo build --target wasm32-unknown-unknown</code></p></li><li><p>To install the <code>wasm-nm</code> tool for listing the symbols exported by a <code>.wasm</code> file, enter <code>cargo install wasm-nm</code> The symbols <code>sum</code> and <code>distance</code> will be output with an &quot;e&quot; in front of them for &quot;export&quot;.</p></li><li><p>To see the exported symbols, enter <code>wasm-nm target/wasm32-unknown-unknown/debug/rust_math.wasm</code></p></li><li><p>Modify the <code>index.js</code> file created earlier to pass the file path of this <code>.wasm</code> file to the fetch function which is <code>rust-math/target/wasm32-unknown-unknown/debug/rust_math.wasm</code>.</p></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output. There be an error message saying that <code>distance2</code> is not a function which is expected because the Rust code only defines the <code>sum</code> and <code>distance</code> functions.</p></li></ol><h2 id="calling-javascript-functions-from-rust">Calling JavaScript functions from Rust</h2><p>WASM code written in a language other than JavaScript can call custom JavaScript functions. Let's look at an example.</p><ol><li><p>Add the following at the beginning of <code>index.js</code>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n <span class="token operator">**</span> <span class="token number">3</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n \<span class="token operator">*</span> n<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> importObject <span class="token operator">=</span> <span class="token punctuation">{</span>env<span class="token operator">:</span> <span class="token punctuation">{</span>cube<span class="token punctuation">,</span> square<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></li><li><p>Pass <code>importObject</code> as the second argument to <code>WebAssembly.instantiateStreaming</code> as follows:</p><pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span>wasmPath<span class="token punctuation">)</span><span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code></pre></li><li><p>Define the function signatures in <code>rust_math/src/lib.rs</code> as follows:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span><br>  <span class="token keyword">fn</span> <span class="token function-definition function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br>  <span class="token keyword">fn</span> <span class="token function-definition function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Call these functions like normal Rust functions, but call them inside an <code>unsafe</code> block since the Rust compiler cannot guarantee that they are safe. For example:</p><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sum_of_square_and_cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> result<span class="token punctuation">;</span><br>    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><br>        result <span class="token operator">=</span> <span class="token function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    result<br><span class="token punctuation">}</span></code></pre></li><li><p>Rebuild the <code>.wasm</code> file by entering <code>cargo build --target wasm32-unknown-unknown</code></p></li><li><p>Verify the symbols that are imported by entering <code>wasm-nm target/wasm32-unknown-unknown/debug/rust_math.wasm</code> The symbols <code>cube</code> and <code>square</code> will be output with an &quot;i&quot; in front of them for &quot;import&quot;.</p></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output.</p></li></ol><h2 id="rust-with-more-types">Rust With More Types</h2><p>The wasm-bindgen tool makes it possible to compile Rust functions that use non-numeric types to WASM. It also enables calling built-in JavaScript functions such as <code>alert</code> and <code>console.log</code>. wasm-bindgen provides a Rust library and a CLI tool. The Rust library provides macros that generate the Rust code required to serialize and deserialize Rust data types. The CLI tool generates JavaScript code that wraps the WASM code as an ES module which makes it easier to consume in a web app.</p><p>Let's implement an example where non-numeric types are passed from JavaScript to Rust functions and non-numeric types are returned.</p><p>The wasm-pack CLI tool makes using wasm-bindgen easier, so we will also use that. This tool:</p><ul><li>It executes a Cargo command to compile Rust code to WASM.</li><li>It calls wasm-bindgen to generate an ES module that wraps usage of the WASM code.</li><li>It can invoke the wasm-opt tool to optimize the WASM code.</li><li>It can generate a <code>package.json</code> file needed to deploy the ES module and WASM code as an npm package.</li><li>It generates TypeScript type definitions for the exported functions and types in a <code>.d.ts</code> file that can be used by calling TypeScript code to provide type checking.</li></ul><ol><li><p>Install wasm-pack by entering the following command:</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf <span class="token operator">|</span> <span class="token function">sh</span></code></pre></li><li><p>Enter <code>cargo new --lib wasm-bindgen-demo</code></p></li><li><p>Enter <code>cd wasm-bindgen-demo</code>.</p></li><li><p>Edit <code>Cargo.toml</code> and add the following dependency.</p><pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span><br><span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">'cdylib'</span><span class="token punctuation">]</span><br><br><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span><br><span class="token key property">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">"0.2.70"</span></code></pre></li><li><p>Edit <code>src/lib.rs</code> and change the contents to the following:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">alert</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token attribute attr-name">#[wasm_bindgen(js_namespace = console)]</span><br>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// This makes functions define in JavaScript available in Rust.</span><br><span class="token attribute attr-name">#[wasm_bindgen(raw_module = <span class="token string">"/index.js"</span>)]</span><br><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">greet</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Hello, {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token attribute attr-name">#[derive(Debug)]</span><br><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Color</span> <span class="token punctuation">{</span><br>    <span class="token keyword">pub</span> red<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span><br>    <span class="token keyword">pub</span> green<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span><br>    <span class="token keyword">pub</span> blue<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[wasm_bindgen(js_name = getColor)]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_color</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Color</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> color <span class="token operator">=</span> <span class="token class-name">Color</span> <span class="token punctuation">{</span><br>        red<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        green<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span><br>        blue<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"color = {:?}"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    color<br><span class="token punctuation">}</span><br><br><span class="token attribute attr-name">#[wasm_bindgen(js_name = getPowers)]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_powers</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span> <span class="token punctuation">{</span><br>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Getting powers of {} ..."</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property">vec!</span><span class="token punctuation">[</span>n<span class="token punctuation">,</span> n<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span><br><br><br><span class="token comment">// This Rust function calls custom JavaScript functions.</span><br><span class="token attribute attr-name">#[wasm_bindgen(js_name = sumOfSquareAndCube)]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sum_of_square_and_cube</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span><br>    <span class="token function">square</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">cube</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Enter <code>wasm-pack build --dev --target web</code></p></li><li><p>Create <code>index.js</code> with the following content:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> init<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  Color<span class="token punctuation">,</span><br>  getColor<span class="token punctuation">,</span><br>  getPowers<span class="token punctuation">,</span><br>  greet<br><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./pkg/wasm_bindgen_demo.js'</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> n <span class="token operator">**</span> <span class="token number">3</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">'World'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color ='</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color instanceof Color?'</span><span class="token punctuation">,</span> color <span class="token keyword">instanceof</span> <span class="token class-name">Color</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color.red ='</span><span class="token punctuation">,</span> color<span class="token punctuation">.</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color.green ='</span><span class="token punctuation">,</span> color<span class="token punctuation">.</span>green<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'color.blue ='</span><span class="token punctuation">,</span> color<span class="token punctuation">.</span>blue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span><br><br>  <span class="token keyword">const</span> powers <span class="token operator">=</span> <span class="token function">getPowers</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a UIntArray</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'powers ='</span><span class="token punctuation">,</span> powers<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [3, 9, 27]</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'square + cube ='</span><span class="token punctuation">,</span> <span class="token function">sumOfSquareAndCube</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 12</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Create <code>index.html</code> with the following content:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>See the console.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li><li><p>Open the DevTools console to see the <code>console.log</code> output.</p></li></ol><p>TODO: How can Rust call custom JavaScript functions when using wasm-bindgen TODO: instead of <code>WebAssembly.instantiateStreaming</code>? TODO: See <a href="https://rustwasm.github.io/docs/wasm-bindgen/examples/import-js.html">https://rustwasm.github.io/docs/wasm-bindgen/examples/import-js.html</a>!</p><h2 id="linear-memory">Linear Memory</h2><p>TODO: Resume here</p><p>&quot;Linear memory&quot; can be used to share data across programming languages without the overhead of copying values. Linear memory is also used by libraries such as wasm-bindgen to enable passing non-numeric values to functions and returning non-numeric values from them.</p><p>From <a href="https://rustwasm.github.io/book/game-of-life/implementing.html?v=1.0.10" rel="noopener" target="_blank">Implementing Conway's Game of Life</a>, &quot;As a general rule of thumb, a good JavaScript/WebAssembly interface design is often one where large, long-lived data structures are implemented as Rust types that live in the WebAssembly linear memory, and are exposed to JavaScript as opaque handles. JavaScript calls exported WebAssembly functions that take these opaque handles, transform their data, perform heavy computations, query the data, and ultimately return a small, copy-able result. By only returning the small result of the computation, we avoid copying and/or serializing everything back and forth between the JavaScript garbage-collected heap and the WebAssembly linear memory.&quot;</p><p>To use this approach, WASM code allocates space and provides functions that return a pointer to the space and the size of the space. Languages that wish to use the space call these functions and map their own data to it. For example, JavaScript code can create a typed array such as <code>Float64Array</code> that uses the same space. It can then set and get elements in the array to write and read the linear memory that is available in the WASM code. Note that it is not possible to allocate space outside the WASM code and get WASM code to share it.</p><p>Let's walk through an example that demonstrates this. The code is available in the GitHub repo <a href="https://github.com/mvolkmann/wasm-rust-linear-memory?v=1.0.10" rel="noopener" target="_blank">wasm-rust-linear-memory</a>. TODO: Why did you need to use wasm-bindgen in this example TODO: since it only uses numbers?</p><h2 id="updating-dom-from-rust">Updating DOM from Rust</h2><p>See <a href="https://github.com/mvolkmann/wasm-bind-demo/blob/main/src/lib.rs">https://github.com/mvolkmann/wasm-bind-demo/blob/main/src/lib.rs</a> which uses the web-sys crate.</p><h2 id="assemblyscript">AssemblyScript</h2><p><a href="https://www.assemblyscript.org?v=1.0.10" rel="noopener" target="_blank">AssemblyScript</a> is a programming language designed to compile to WASM.</p><p>AssemblyScript is a variant of TypeScript. Its source files use the <code>.ts</code> file extension. Semicolons at the ends of statements are optional.</p><p>AssemblyScript includes &quot;a relatively small memory management and garbage collection runtime.&quot;</p><p>The only supported types are:</p><ul><li>boolean <code>bool</code></li><li>signed integer types <code>i8</code>, <code>i16</code>, <code>i32</code> and <code>i64</code></li><li>unsigned integer types <code>u8</code>, <code>u16</code>, <code>u32</code> and <code>u64</code></li><li>floating point types <code>f32</code> and <code>f64</code>.</li><li>platform-specific integers <code>isize</code> and <code>usize</code></li><li>128-bit vector <code>v128</code></li><li>opaque host reference <code>anyref</code></li><li><code>void</code> for functions with no return value (cannot omit return type)</li><li><code>Array</code></li><li><code>ArrayBuffer</code></li><li><code>DataView</code></li><li><code>Map</code></li><li><code>Math</code></li><li><code>Set</code></li><li><code>string</code>?</li><li><code>String</code></li><li>typed arrays <code>Int{size}Array</code>, <code>UInt{size}Array</code>, and <code>Float{size}Array</code></li></ul><p>Macro types</p><ul><li><code>indexof&lt;T&gt;</code></li><li><code>native&lt;T&gt;</code></li><li><code>returnof&lt;T&gt;</code></li><li><code>valueof&lt;T&gt;</code></li></ul><p>Supported math instructions are described <a href="https://www.assemblyscript.org/stdlib/math.html?v=1.0.10" rel="noopener" target="_blank">here</a>.</p><p>To install the AssemblyScript compiler, install Node.js and enter <code>npm install -g assemblyscript</code>.</p><p>To compile an AssemblyScript source file to a <code>.wat</code> file:</p><pre class="language-bash"><code class="language-bash">asc <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.ts -t <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.wat</code></pre><p>To compile an AssemblyScript source file to a <code>.wasm</code> file:</p><pre class="language-bash"><code class="language-bash">asc <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.ts -b <span class="token punctuation">{</span>file-path<span class="token punctuation">}</span>.wasm -O3</code></pre><p>Here are the steps to implement a <code>distance</code> function in AssemblyScript that computes the distance between two points and call it from JavaScript:</p><ol><li><p>Create the file <code>math.ts</code> containing the following:</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">distance</span><span class="token punctuation">(</span>x1<span class="token operator">:</span> f64<span class="token punctuation">,</span> y1<span class="token operator">:</span> f64<span class="token punctuation">,</span> x2<span class="token operator">:</span> f64<span class="token punctuation">,</span> y2<span class="token operator">:</span> f64<span class="token punctuation">)</span><span class="token operator">:</span> f64 <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Compile this to WASM by entering <code>asc math.ts -b math.wasm -O3</code></p></li><li><p>Create the file <code>index.js</code> containing the following:</p><pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'math.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>distance<span class="token punctuation">}</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Create the file <code>index.html</code> containing the following:</p><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>result = <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server like before.</p></li><li><p>Browse localhost:{port} where port is the port on which the local server is listening.</p></li></ol><h2 id="webassembly-system-interface-(wasi)">WebAssembly System Interface (WASI)</h2><p>The <a href="https://wasi.dev?v=1.0.10" rel="noopener" target="_blank">WebAssembly System Interface (WASI)</a> defines a way to communicate with the system that focuses on portability and security. This includes things like stdout/stdin, the file system, and network resources.</p><p>Adding these features makes WASM useful outside of web browsers. Motivations for using WASM in this way include performance, safety, and the ability to combine code compiled from many higher-level programming languages.</p><p>WASM code using WASI is portable across operating systems.</p><p>Implementations of WASI include <a href="https://wasmtime.dev?v=1.0.10" rel="noopener" target="_blank">Wasmtime</a> (developed at Mozila) and <a href="https://bytecodealliance.github.io/lucet/?v=1.0.10" rel="noopener" target="_blank">Lucet</a> (developed at Fastly). There is a <a href="https://github.com/bytecodealliance/lucet/issues/607?v=1.0.10" rel="noopener" target="_blank">plan</a> to merge Lucet with Wasmtime.</p><p>Rust code compiled to WASM can use WASI features because WASI capabilities are included in Rust standard libraries. For example, the <code>println!</code> macro can be used. To compile a Rust project to WASM with WASI support, enter <code>cargo build --target wasm32-unknown-wasi</code>. TODO: What are the options for the three parts of the target string?</p><p>C/C++ code compiled to WASM can use WASI features because it will use wasi-sysroot which is a wasi-core implementation of the libc library.</p><p>WASM code using WASI can also be run in web browsers using polyfills. For example, such a polyfill would turn the WASI version of a Rust <code>println!</code> into a call to <code>console.log</code>.</p><p>Security in WASI is implemented with sandboxing, similar to Deno. Perhaps Deno modeled their security after WASI. When running WASM code that uses WASI features, file system and network resources to be accessed must be specified. Access to unspecified resources are not permitted. This is referred to as &quot;Capability Space Security&quot;.</p><p>Platform-specific versions of tools like Wasmtime can execute platform-independent WASM code that uses WASI features. They handle translation into platform-specific calls.</p><p>WASI functions are made available to WASM binaries through imports that are passed in. This allows passing in platform-specific versions of these functions. It also supports limiting what the WASM code can do by not passing in every function.</p><p>Security is also controlled at the module level by passing allowed functions and file descriptors between them.</p><p>Remaining work on WASI includes defining support for asynchronous I/O, file watching, and file locking.</p><h2 id="running-wasm-outside-browsers">Running WASM Outside Browsers</h2><p>There are currently three tools for running WASM code outside a web browser. Each is described below.</p><h3 id="wasm3"><a href="https://github.com/wasm3/wasm3?v=1.0.10" rel="noopener" target="_blank">WASM3</a></h3><p>To install this in macOS, install Homebrew and enter <code>brew install wasm3</code>. Installing for other platforms is more complicated. For details, visit the WASM3 site linked above.</p><p>To call functions defined in a <code>.wasm</code> file from a REPL, enter <code>wasm3 --repl {path-to-wasm-file}</code>. Then enter function names followed by arguments.</p><p>To call functions directly, not using a REPL, enter <code>wasm3 --func {function-name} {path-to-wasm-file} {arguments}</code>.</p><p>TODO: I can't get either of these approaches to work on a <code>.wasm</code> file TODO: I created from a Rust programing using TODO: <code>rustc {path-to-rust-file} --target wasm32-wasi</code>!</p><h3 id="wasmtime"><a href="https://wasmtime.dev?v=1.0.10" rel="noopener" target="_blank">Wasmtime</a></h3><p>To install this in Linux or macOS:</p><ol><li>Enter <code>curl https://wasmtime.dev/install.sh -sSf | bash</code></li><li>Open a new terminal that will have <code>wasmtime</code> in <code>PATH</code>.</li></ol><p>Visit the Wasmtime site linked above for instructions to install in Windows.</p><p>One way to demonstrate running this is to compile Rust code to <a href="https://wasi.dev?v=1.0.10" rel="noopener" target="_blank">WebAssembly System Interface (WASI)</a>. To do so, enter <code>rustc {path-to-rust-file} --target wasm32-wasi</code>. This produces a <code>.wasm</code> file. The Rust code can use features such as the <code>println!</code> macro to produce output. For example:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>To execute a <code>.wasm</code> file, enter <code>wasmtime {path-to-wasm-file}</code>.</p><p>To execute a <code>.wast</code> test file, enter <code>wasmtime wast {path-to-wast-file}</code>.</p><p>Unlike wasm3, wasmtime does not provide a REPL or support running a specific function from the command-line.</p><h3 id="webassembly-micro-runtime-(wamr)"><a href="https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.10" rel="noopener" target="_blank">WebAssembly Micro Runtime (WAMR)</a></h3><p>Instructions for installing this tool on various platforms can be found at <a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/build_wamr.md?v=1.0.10" rel="noopener" target="_blank">build_wamr.md</a>.</p><p>To install this in macOS:</p><ul><li>Browse <a href="https://github.com/bytecodealliance/wasm-micro-runtime?v=1.0.10" rel="noopener" target="_blank">wasm-micro-runtime</a>.</li><li>Click the &quot;Code&quot; button and &quot;Download ZIP&quot;.</li><li>Unzip the downloaded file.</li><li>cd into its directory and into <code>product-mini/platforms/darwin</code>.</li><li>Install the <code>cmake</code> command with <code>brew install cmake</code>.</li><li>Enter <code>mkdir build</code></li><li>Enter <code>cd build</code></li><li>Enter <code>cmake ..</code></li><li>Enter <code>make</code> to create the executable <code>iwasm</code> in the current directory.</li><li>Copy <code>iwasm</code> to a directory listed in the <code>PATH</code> environment variable.</li></ul><p>To run a <code>.wasm</code> file, enter <code>.iwasm {path-to-wasm-file}</code></p><h2 id="demos">Demos</h2><ul><li><a href="https://github.com/mvolkmann/wasm-bind-demo">https://github.com/mvolkmann/wasm-bind-demo</a></li><li><a href="https://github.com/mvolkmann/wasm-demo">https://github.com/mvolkmann/wasm-demo</a></li><li><a href="https://github.com/mvolkmann/wasm-rust-linear-memory">https://github.com/mvolkmann/wasm-rust-linear-memory</a></li></ul><h2 id="wasm-pack">wasm-pack</h2><p>To install wasm-pack in Linux or macOS, enter the following:</p><pre class="language-bash"><code class="language-bash">cargo <span class="token function">install</span> wasm-pack</code></pre><p>To create a project that uses wasm-pack::</p><ol><li><p><code>wasm-pack new my-wasm</code></p><p>TODO: Describe what this puts in Cargo.toml.</p></li><li><p><code>cd my-wasm</code></p></li><li><p><code>wasm-pack build --target web</code></p><p>TODO: Describe the files this produces.</p></li><li><p>Create the following <code>index.html</code> file:</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>WASM Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>      <span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token keyword">default</span> <span class="token keyword">as</span> wasm<span class="token punctuation">,</span> greet<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./pkg/my_wasm.js'</span><span class="token punctuation">;</span><br>      <span class="token function">wasm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li><li><p>Start a local HTTP file server. There are many ways to do this, including using Deno. TODO: Is there any reason to use wasm-server instead because it supports the WASM MIME type? TODO: Maybe this is no longer an issue. To run a simple Deno HTTP file server:</p><ol><li>Install <a href="https://deno.land/#installation?v=1.0.10" rel="noopener" target="_blank">Deno</a>.</li><li>Enter <code>deno install --allow-net --allow-read https://deno.land/std@0.83.0/http/file_server.ts</code></li><li>Enter <code>file_server .</code></li><li>Browse <code>localhost:4507</code></li></ol></li></ol><h2 id="ssvmup">ssvmup</h2><p>To compile a <code>.rs</code> file to WebAssembly:</p><ol><li><p>Install ssvmup by entering the following command (one time only):</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> https://raw.githubusercontent.com/second-state/ssvmup/master/installer/init.sh -sSf <span class="token operator">|</span> <span class="token function">sh</span></code></pre></li><li><p>Create a new Rust library (referred to as a &quot;crate&quot;) by entering <code>cargo new --lib my-crate</code></p></li><li><p><code>cd my-crate</code></p></li><li><p>Edit <code>src/lib.rs</code> and add code there. For example:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span><br><br><span class="token attribute attr-name">#[wasm_bindgen]</span><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">factorial</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u64</span> <span class="token punctuation">{</span><br>    <span class="token keyword">match</span> x <span class="token punctuation">{</span><br>        <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span><br>        _ <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></li><li><p>Edit the generated <code>Cargo.toml</code> file which is similar to a Node.js <code>package.json</code> file. For example:</p><pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span><br><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"my-crate"</span><br><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span><br><span class="token key property">authors</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"R. Mark Volkmann &lt;me@gmail.com>"</span><span class="token punctuation">]</span><br><span class="token key property">edition</span> <span class="token punctuation">=</span> <span class="token string">"2018"</span><br><span class="token key property">description</span> <span class="token punctuation">=</span> <span class="token string">"sample project using ssvmup"</span><br><span class="token key property">license</span> <span class="token punctuation">=</span> <span class="token string">"MIT/Apache-2.0"</span><br><span class="token comment">#repository = "https://github.com/mvolkmann/my-crate"</span><br><br><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span><br><span class="token comment"># cdylib exports a C-style interface for a Rust dynamic library.</span><br><span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"cdylib"</span><span class="token punctuation">]</span><br><br><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span><br><span class="token key property">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">"=0.2.61"</span></code></pre></li><li><p>Enter <code>ssvmup build --target deno</code> This creates a <code>pkg</code> directory containing <code>package.json</code>, a <code>.wasm</code> file, and a <code>.js</code> file that reads the <code>.wasm</code> file and prepares it for use in JavaScript code.</p></li><li><p>Copy the generated <code>pkg</code> directory to the directory containing the Deno code that wishes to use it.</p></li><li><p>Import the exported functions with a line like the following:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>factorial<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./pkg/my_crate.js'</span><span class="token punctuation">;</span></code></pre></li><li><p>Call the imported functions.</p><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">4n</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "n" suffix makes it BitInt</span></code></pre></li></ol><p>TODO: Invent a programming language that translated to WAT TODO: more directly than a language like Rust.</p></article>