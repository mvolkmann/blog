<link rel="preload" as="style" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/prism-a11y.css"><link rel="stylesheet" href="/blog/assets/topic.css"><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><h2>WebSockets</h2><aside><nav class="toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#server">Server</a><ol><li><a href="#server-package.json">Server package.json</a></li><li><a href="#server.js">server.js</a></li></ol></li><li><a href="#client">Client</a><ol><li><a href="#client-package.json">Client package.json</a></li><li><a href="#index.html">index.html</a></li></ol></li><li><a href="#bun-and-hono">Bun and Hono</a></li></ol></nav></aside><article><h2 id="overview" tabindex="-1">Overview</h2><p>WebSockets are a standardized protocol for two-way communication between clients and servers using TCP. They are widely supported by web browsers.</p><p>Many WebSocket libraries for server-side programming languages/environments exist. The example below demonstrates using the highly popular Node.js library <a href="https://github.com/websockets/ws?v=1.1.1" rel="noopener" target="_blank">ws</a>. This of course requires installing <a href="https://nodejs.org/?v=1.1.1" rel="noopener" target="_blank">Node.js</a>.</p><h2 id="server" tabindex="-1">Server</h2><p>To run the server:</p><ul><li>Enter <code>npm install</code></li><li>Enter <code>npm run start</code></li></ul><p>This uses <a href="https://nodemon.io?v=1.1.1" rel="noopener" target="_blank">nodemon</a> to automatically restart the server when its code is modified, which is useful during iterative development and debugging.</p><h3 id="server-package.json" tabindex="-1">Server package.json</h3><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"server"</span><span class="token punctuation">,</span><br>  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"WebSockets demo server"</span><span class="token punctuation">,</span><br>  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"R. Mark Volkmann"</span><span class="token punctuation">,</span><br>  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span><br>  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"module"</span><span class="token punctuation">,</span><br>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"nodemon server.js"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"ws"</span><span class="token operator">:</span> <span class="token string">"^7.4.5"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"nodemon"</span><span class="token operator">:</span> <span class="token string">"^2.0.7"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h3 id="server.js" tabindex="-1">server.js</h3><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> WebSocket <span class="token keyword">from</span> <span class="token string">'ws'</span><span class="token punctuation">;</span><br><br><span class="token comment">// Create a WebSocket server.</span><br><span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">1919</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// When a client connects ...</span><br>wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token parameter">ws</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// Listen for messages from the client.</span><br>  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">message</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// Broadcast the message to all the clients.</span><br>    <span class="token comment">// wss.clients is not an Array, so you cannot use a for-of loop.</span><br>    wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> isOpen <span class="token operator">=</span> client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">;</span><br><br>      <span class="token comment">// To send to all open clients,</span><br>      <span class="token comment">// including the one that sent the message ...</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isOpen<span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token comment">// To send to all open clients</span><br>      <span class="token comment">// except the one that sent the message ...</span><br>      <span class="token comment">//const isSelf = client === ws;</span><br>      <span class="token comment">//if (isOpen &amp;&amp; !isSelf) client.send(message);</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Send an initial message to the newly connected client.</span><br>  ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'connected to WebSocket server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="client" tabindex="-1">Client</h2><p>To run the client:</p><ul><li>Enter <code>npm install</code></li><li>Enter <code>npm run start</code></li><li>Browse <code>localhost:1920</code> in multiple browser windows.</li><li>Enter a message in the &quot;Send&quot; input and press the Enter key or click the &quot;Send&quot; button to send it.</li><li>The message will appear in all connected browser windows.</li><li>Try sending multiple messages from each connected browser window.</li></ul><h3 id="client-package.json" tabindex="-1">Client package.json</h3><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"client"</span><span class="token punctuation">,</span><br>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span><br>  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"WebSockets demo client"</span><span class="token punctuation">,</span><br>  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"R. Mark Volkmann"</span><span class="token punctuation">,</span><br>  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span><br>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"http-server --port 1920"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"http-server"</span><span class="token operator">:</span> <span class="token string">"^0.12.3"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h3 id="index.html" tabindex="-1">index.html</h3><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>      window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token comment">// Find various DOM elements.</span><br>        <span class="token keyword">const</span> errorMessage <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'error-message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">const</span> form <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'form'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">const</span> receivedArea <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'received-area'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">const</span> sendInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'send-input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">const</span> status <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Open a connection to the WebSocket server.</span><br>        <span class="token keyword">let</span> wsOpen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>        <span class="token keyword">const</span> <span class="token constant">WS_URL</span> <span class="token operator">=</span> <span class="token string">'ws://localhost:1919'</span><span class="token punctuation">;</span><br>        <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token constant">WS_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// When the WebSocket connection is opened ...</span><br>        ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          wsOpen <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>          status<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'The WebSocket is open.'</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// When the WebSocket connection is closed ...</span><br>        ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          wsOpen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>          status<span class="token punctuation">.</span>textContent <span class="token operator">=</span><br>            <span class="token string">'The WebSocket is closed. '</span> <span class="token operator">+</span> <span class="token string">'Refresh when the server is ready.'</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// When a WebSocket message is received ...</span><br>        ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          <span class="token comment">// Display the message in the received area of the UI.</span><br>          <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          div<span class="token punctuation">.</span>textContent <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span><br>          receivedArea<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// When a WebSocket error occurs ...</span><br>        ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          <span class="token comment">// For security reasons, there is no</span><br>          <span class="token comment">// useful information in this event object.</span><br>          errorMessage<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to connect to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">WS_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// When the form containing a message to send is submitted ...</span><br>        form<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'submit'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">if</span> <span class="token punctuation">(</span>wsOpen<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// Send the message to the WebSocket server.</span><br>            ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>sendInput<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            sendInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            errorMessage<span class="token punctuation">.</span>textContent <span class="token operator">=</span><br>              <span class="token string">'Cannot send because the WebSocket is closed.'</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><br>      <span class="token selector">#error-message</span> <span class="token punctuation">{</span><br>        <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      <span class="token selector">#form</span> <span class="token punctuation">{</span><br>        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      <span class="token selector">input,<br>      label</span> <span class="token punctuation">{</span><br>        <span class="token property">margin-right</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      <span class="token selector">label</span> <span class="token punctuation">{</span><br>        <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>status<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error-message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>Send<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>send-input<span class="token punctuation">"</span></span> <span class="token attr-name">autofocus</span> <span class="token punctuation">/></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span>Send<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>Received<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>received-area<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h2 id="bun-and-hono" tabindex="-1">Bun and Hono</h2><p>The server code is a bit simpler when using Bun and Hono instead of Node. The client code remains the same.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>Hono<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span>Context<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span>serveStatic<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hono/bun'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">,</span> <span class="token function">serveStatic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>root<span class="token operator">:</span> <span class="token string">'./public'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/greet'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'Hello Bun!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> wsServer <span class="token operator">=</span> Bun<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token comment">// The WebSocket port defaults to 3000 which conflicts with the HTTP server.</span><br>  port<span class="token operator">:</span> <span class="token number">3001</span><span class="token punctuation">,</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Upgrade the request to support WebSockets.</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// do not return a Response</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'WebSockets upgrade failed'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>status<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  websocket<span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token function">open</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WebSocket is open.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token comment">// TODO: Wby is this never called?</span><br>    <span class="token function">drain</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WebSocket is ready to receive more data.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token function">message</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">received "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'stop'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello from server!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token comment">// See WebSocket protocol status codes at</span><br>    <span class="token comment">// https://datatracker.ietf.org/doc/html/rfc6455#section-7.4</span><br>    <span class="token comment">// 1000 is normal closure.</span><br>    <span class="token comment">// 1005 is used when the client closes the WebSocket.</span><br>    <span class="token function">close</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> code<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WebSocket closed with code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WebSocket closed with message "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WebSocket server is listening on port'</span><span class="token punctuation">,</span> wsServer<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> app<span class="token punctuation">;</span></code></pre><p>The following <code>package.json</code> file can be used to start the server.</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"bun-websockets"</span><span class="token punctuation">,</span><br>  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"module"</span><span class="token punctuation">,</span><br>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"bun run --watch src/server.ts"</span><span class="token punctuation">,</span><br>    <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"prettier --write '**/*.{css,html,js,ts,tsx}'"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"hono"</span><span class="token operator">:</span> <span class="token string">"^3.12.6"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"@types/bun"</span><span class="token operator">:</span> <span class="token string">"latest"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"peerDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"typescript"</span><span class="token operator">:</span> <span class="token string">"^5.0.0"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></article>